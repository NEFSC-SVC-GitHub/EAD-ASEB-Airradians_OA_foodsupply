---
title: "F1 Bay Scallops: High vs. Low food availability under OA conditions"
author: "Samuel Gurr"
date: "10/12/2021"
output:
  pdf_document:
    latex_engine: xelatex
---

Last updates: october 6, 2021


## Load libraries

```{r startup, include=FALSE}

library(ggplot2)
library(dplyr)
library(tidyverse)
library(car)
library(nlme)
library(multcompView)
library(agricolae)
library(Rmisc)
library(lmerTest)
library(lme4)
library(pander)
library(performance)
library(Rmisc)
library(maditr)
library(reshape2)
library(kableExtra)
library(ggpubr)
library(dplyr)
library(tidyr)

setwd("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis") # Work computer

```

## Set Path
```{r setup, include=TRUE}
# setwd("C:/Users/samjg/Documents/Github_repositories/Airradians_OA/RAnalysis") # Work computer
# setwd("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA/RAnalysis") # Work computer
length                     <-read.csv(file="C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Data/Survival_Size/Lengths_50DPF_92DPF.csv", header = TRUE)
len.dryweight.CI_1026      <-read.csv(file="C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Data/Survival_Size/20211026_lengths_dryweights.csv", header = TRUE) 
len.dryweight.CI_1202      <-read.csv(file="C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Data/Survival_Size/20211202_lengths_dryweights.csv", header = TRUE)


survival_juvenile          <-read.csv(file="C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Data/Survival_Size/Survival_50DPF_92DPF.csv", header = TRUE)

# Structure of the data - to check that variables are properly assigned to factor or variable
# str(length)

```

# regression of size metrics

```{r Condition index data, statistics, plotting, include=FALSE}

CI_1026 <- len.dryweight.CI_1026[!is.na(len.dryweight.CI_1026$CI),] %>%  
summarySE(measurevar="CI", groupvars=c("pH")) %>% 
      dplyr::mutate(pCO2 = case_when(pH == 8  ~ "500 μatm", pH == 7.5 ~ "800 μatm")) %>% # cahmber volumes on different dates with
      dplyr::mutate(Age = 92)


CI_1202 <- summarySE(len.dryweight.CI_1202, measurevar="Condition_index_drywtRatio_Walne1976", groupvars=c("pH")) %>% 
    dplyr::filter(Condition_index_drywtRatio_Walne1976 > 0) %>% 
    dplyr::mutate(pCO2 = case_when(pH == 8  ~ "500 μatm", pH == 7.5 ~ "800 μatm")) %>% # cahmber volumes on different dates with
    dplyr::rename(CI = "Condition_index_drywtRatio_Walne1976") %>% # cahmber volumes on different dates with
    dplyr::mutate(Age = 139)
    
Master_CI <- rbind(CI_1026, CI_1202)


ggplot(data=Master_CI, aes(x=Age, y=CI, color=pCO2)) +
  geom_line( stat = "identity", size=1.0)+
  geom_point(position=position_dodge(.5))+ 
  scale_color_manual(values=c("forestgreen","darkorange2"))+
  geom_errorbar(aes(ymin=CI-se, ymax=CI+se), width=.2,
                position=position_dodge(.5))+
  theme_classic() +  
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  scale_y_continuous(name ="Condition index [(Dry tissue / dry shell) *100]")+
  theme(text = element_text(size=15))



CI_1026 <- len.dryweight.CI_1026[!is.na(len.dryweight.CI_1026$CI),] %>% 
  dplyr::select(c('pH','CI','Tank_Replicate')) %>% 
  dplyr::mutate(Age = "64DPF") %>% 
   dplyr::mutate(pH_Replicate = (as.factor(paste(pH,Age, Tank_Replicate, sep ='_')))) %>% 
  dplyr::mutate(pH_Age = (as.factor(paste(pH,Age, sep = '_')))) %>% 
  dplyr::select(-Tank_Replicate)

CI_1202 <- len.dryweight.CI_1202[!is.na(len.dryweight.CI_1202$Condition_index_drywtRatio_Walne1976),] %>% 
   dplyr::select(c('pH','Condition_index_drywtRatio_Walne1976', 'pH_Replicate')) %>% 
   dplyr::rename(CI = Condition_index_drywtRatio_Walne1976) %>% 
   dplyr::mutate(Age = "139DPF") %>% 
   dplyr::mutate(pH_Age = (as.factor(paste(pH,Age, sep = '_'))))

# merge the raw data 

Master_CI_raw <- rbind(CI_1026, CI_1202) %>% dplyr::filter(CI > 0) # ommit values with negative CI (poor data due to error)
Master_CI_raw$pH <- as.factor(Master_CI_raw$pH)


# Linear mixed effects model 

# statistical approach to 20211026 (last time point of the food OA challenge BUT just the fed animals..)
LMEmod_CI_1026.DATA <- Master_CI_raw %>% dplyr::filter(Age %in% '64DPF') # filter the data from 20211026
LMEmod_CI_1026      <- lme(CI ~ pH, random=~1|pH_Replicate, data= LMEmod_CI_1026.DATA) # run the model with ranodom effect of the tank replicate within treatment
# |     &nbsp;      | numDF | denDF | F-value | p-value |
# |:---------------:|:-----:|:-----:|:-------:|:-------:|
# | **(Intercept)** |   1   |  80   |  1627   |    0    |
# |     **pH**      |   1   |   6   |  4.657  | 0.07428 | # marginal significant
pander(anova(LMEmod_CI_1026), style='rmarkdown') # print the model
kable(as.data.frame(anova(LMEmod_CI_1026))) %>%  # save the table 
  kable_styling() %>%
  save_kable(file = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Survival_size/20211026_figs_table/20211026_CI_LME_Table.png", zoom = 1.5)
pdf(paste0(filename = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Survival_size/20211026_figs_table/20211026_CI_LME_Diagnostics.pdf"))
check_model(LMEmod_CI_1026)  # model diagnostics
dev.off()
shapiro.test(residuals(LMEmod_CI_1026)) # non-normal 8.769e-07



# statistical approach to 20211026 (last time point of the food OA challenge BUT just the fed animals..)
LMEmod_CI_1202.DATA <- Master_CI_raw %>% dplyr::filter(Age %in% '139DPF') # filter the data from 20211202
LMEmod_CI_1202      <- lme(CI ~ pH, random=~1|pH_Replicate, data= LMEmod_CI_1202.DATA) # run the model with ranodom effect of the tank replicate within treatment
# |     &nbsp;      | numDF | denDF | F-value | p-value |
# |:---------------:|:-----:|:-----:|:-------:|:-------:|
# | **(Intercept)** |   1   |  68   |  426.9  |    0    |
# |     **pH**      |   1   |   6   | 0.05716 |  0.819  |
pander(anova(LMEmod_CI_1202), style='rmarkdown') # print the model
kable(as.data.frame(anova(LMEmod_CI_1202))) %>% # save the table 
  kable_styling() %>%
  save_kable(file = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Survival_size/20211026_figs_table/20211026_CI_LME_Table.png", zoom = 1.5)
pdf(paste0(filename = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Survival_size/20211026_figs_table/20211026_CI_LME_Diagnostics.pdf"))
check_model(LMEmod_CI_1202)  # model diagnostics
dev.off()
shapiro.test(residuals(LMEmod_CI_1202)) # non-normal 4.964e-05


# plot the desnity boxplot 
CI_mean <- Master_CI_raw %>% 
  dplyr::group_by(pH_Age) %>% 
  dplyr::summarize(average = mean(CI)) %>%
  dplyr::ungroup()
p.box <- ggplot(Master_CI_raw, aes(x = pH_Age, y = CI)) + geom_boxplot() + geom_point(data= CI_mean, mapping = aes(x = pH_Age, y = average),
             color="red") 
p.box.data <- layer_data(p.box) %>%
  select(x, ymin, lower, middle, upper, ymax, outliers, flipped_aes) %>%
  dplyr::rename(mean = flipped_aes) %>% 
  dplyr::mutate(mean  = CI_mean$average) %>% 
  mutate(pH_Age = factor(x, labels = levels(Master_CI_raw$pH_Age), ordered = TRUE)) %>%
  select(-x)

denisty_box_CI <-ggplot(p.box.data) +
                            # manually plot flipped boxplot
                            geom_segment(aes(x = ymin, xend = ymax, y = -0.075, yend = -0.075)) +
                            geom_rect(aes(xmin = lower, xmax = upper, ymin = -0.2, ymax = -0.05,  fill = pH_Age),color = "black") +
                            geom_point(data = . %>% unnest(outliers), aes(x = outliers, y = -0.15), color = "grey60", size = 1) +
                            # vertical lines at Q1 / Q2 / Q3
                            geom_vline(data = . %>% select(pH_Age, lower, mean, upper) %>% gather(key, value, -pH_Age), aes(xintercept = value)) +
                            # density plot
                            geom_density(data = Master_CI_raw, aes(x = CI, group=pH_Age, fill=pH_Age, ..scaled..), alpha=.4, adjust=1.5) +
                            #  theme
                            theme_classic() +
                            facet_grid(pH_Age ~ .) +
                            theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "none", plot.title = element_text(size=10))+
                            labs(title = "F1 Scallops: Condition index 20211026-20211202", 
                                 x = expression(Condition~index),
                                 y = "Scaled density") +
                            scale_fill_manual(values=c("grey40", "grey85", "grey40", "grey85"))
denisty_box_CI


pdf(paste0(filename = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Survival_size/Juvenile_CI_density_plot.pdf"), width = 5, height = 8)
denisty_box_CI # export


```


# regression of size metrics
```{r # regression of size metrics, include=FALSE}
len.dryweight.CI_1202 %>% 
   ggplot(aes(x=Dry_Shell_weight_mg, y=Shell_length_mm, color=as.factor(pH))) +
    geom_point()+ 
    theme_classic() +  
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
    scale_x_continuous(name ="Dry_Shell_weight_mg") +
    scale_y_continuous(name ="Shell_length_mm")



#First make calculations for means and standard error
REGRESSION_Length.Drytissue<- dryweight_CI %>% 
  dplyr::filter(shell.or.tissue %in% "tissue") %>%
    ggplot(aes(x=Shell.Length, y=weight, color=as.factor(pH))) +
    geom_point()+ 
    theme_classic() +  
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
    scale_x_continuous(name ="Length (µm)") +
    scale_y_continuous(name ="Tissue weight (g)")
REGRESSION_Length.Drytissue

REGRESSION_Length.Dryshell<- dryweight_CI %>% 
  dplyr::filter(shell.or.tissue %in% "shell") %>%
    ggplot(aes(x=Shell.Length, y=weight, color=as.factor(pH))) +
    geom_point()+ 
    theme_classic() +  
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
    scale_x_continuous(name ="Length (µm)") +
    scale_y_continuous(name ="Shell weight (g)")
REGRESSION_Length.Dryshell

```
# Larvae survival - Low, Mod, High pCO2  (0 - 18 dpf)

```{r, Survival plot Mean SE}
#First make calculations for means and standard error
LarvaeSurvival_Summ <- summarySE(survival_larvae, measurevar="Survival", groupvars=c("Day", "Treatment")) %>% 
    dplyr::mutate(pCO2 = case_when(Treatment == "Low"  ~ "500 μatm", Treatment == "Moderate" ~ "800 μatm", Treatment == "High" ~ "1200 μatm")) # cahmber volumes on different dates with different instruments 


#stL$Treatment <- factor(stL$trt,                 # Relevel group factor
#                         levels = c("Low OA", "Moderate OA", "High OA"))
LarvaeSurvival_Summ$pCO2 <- factor(LarvaeSurvival_Summ$pCO2, c("500 μatm","800 μatm","1200 μatm"))
## Use geom_line and geom_point to plot over time
LarvaeSurvival_Plot <-ggplot(data=LarvaeSurvival_Summ, aes(x=Day, y=Survival, color=pCO2)) +
  geom_line( stat = "identity", size=1.0)+
  geom_point()+ 
  scale_color_manual(values=c("darkorange2","forestgreen", "purple"))+
  geom_errorbar(aes(ymin=Survival-se, ymax=Survival+se), width=.2,
                position=position_dodge(.1))+
  theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  scale_x_continuous(name ="Age (days)") +
  scale_y_continuous(name ="Survival (%)")+
  theme(text = element_text(size=15))
LarvaeSurvival_Plot


# pdf(paste0("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/Survival_size/20210930_survival.pdf"))
pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/Survival_size/Larval_survival.pdf"),width=10, height=7)
LarvaeSurvival_Plot
dev.off()

```


# Food limitation x pCO2 experiment (50 - 92 dpf)

## Survival plot (all)

* Note: this experiment only included the low and moderate pCO2 due to low survivorship in the high pCO2 condition 

```{r foodxpCO2 survival mean SE plots}

#First make calculations for means and standard erro
survival_juvenile$Fed_Unfed <-  as.factor(gsub("^(?:[^_]+_){2}([^_]+).*", "\\1", survival_juvenile$trt))
levels(survival_juvenile$Fed_Unfed) <- c("High food", "Low food")


survival_juvenile$pCO2 <-  as.factor(gsub("^(?:[^_]+_){1}([^_]+).*", "\\1", survival_juvenile$trt))
levels(survival_juvenile$pCO2) <- c("800 μatm", "500 μatm")

# Survival ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

Survival_Means <- summarySE(survival_juvenile, measurevar="Survival", groupvars=c("Age_DPF", "pCO2", "Fed_Unfed")) 
Survival_Means$pCO2 <- factor(Survival_Means$pCO2, c("500 μatm","800 μatm"))

dodge <- position_dodge(.50)
## Use geom_line and geom_point to plot over time
Survival_All_plot <- ggplot(data=Survival_Means, aes(x=Age_DPF, y=Survival, color=pCO2)) +
  geom_line(aes(linetype = factor(Fed_Unfed)), size = c(0.2, 0.2,0.2, 
                                                        1,1, 1,
                                                        0.2, 0.2,0.2, 
                                                        1,1, 1)) +
  #geom_point(position = position_jitterdodge(jitter.width = 10)) +
  geom_point(position = position_dodge(width=10)) +
  #scale_color_manual(values=c("forestgreen","darkorange2")) +
  scale_color_manual(values=c("black","black")) +
  geom_errorbar(aes(ymin=Survival-se, ymax=Survival+se), width=.2,
                position=position_dodge(width=10))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  scale_x_continuous(name ="Age (days)") +
  scale_y_continuous(name ="Survival (%)")  + 
  scale_linetype_manual(values = c("High food" = "solid", "Low food" = "dashed"))  +
  theme_classic() +
  theme(legend.position="none") +
  # facet_wrap(~factor(Fed_Unfed, level = c('Low food', 'High food'))) 
  facet_wrap(~pCO2)
Survival_All_plot
pdf(paste0("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Survival_size/Juvenile_survival_FoodxOA.pdf"))
Survival_All_plot
dev.off()

```

##  Shell length plot (all)
```{r foodxpCO2 shell size  mean SE plots}
# Length ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

Length_Means <- summarySE(length, measurevar="Length_um", groupvars=c("Age_DPF", "pH", "Fed_Unfed"))
Length_Means <- Length_Means %>% 
  dplyr::mutate(pCO2 = case_when(pH == 8 ~ "500 μatm",  pH == 7.5 ~ "800 μatm")) %>% 
  dplyr::mutate(Fed_Unfed = case_when(Fed_Unfed == "fed" ~ "High food",  Fed_Unfed == "unfed" ~ "Low food"))

## Use geom_line and geom_point to plot over time
Length_All_plot <- ggplot(data=Length_Means, aes(x=Age_DPF, y=(Length_um/1000), color=pCO2)) +
  geom_line(aes(linetype = factor(Fed_Unfed)), size = 0.5) +  
  geom_point()+ 
  scale_color_manual(values=c("black","black")) +
  geom_errorbar(aes(ymin=(Length_um/1000)-(se/1000), ymax=(Length_um/1000)+(se/1000)), width=.2,
                position=position_dodge(.1))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  scale_x_continuous(name ="Age (days)") +
  scale_y_continuous(name ="Shell length (mm)")  + 
  scale_linetype_manual(values = c("High food" = "solid", "Low food" = "dashed"))  +
  theme_classic() +
  theme(legend.position="none") +
  # facet_wrap(~factor(Fed_Unfed, level = c('Low food', 'High food'))) 
  facet_wrap(~pCO2)
Length_All_plot
pdf(paste0("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Survival_size/Juvenile_length_FoodxOA.pdf"))
Length_All_plot
dev.off()

```


# Statistical analysis (survival + shell size)
* sorted by Age

### first load the necessary stats packages...
```{r, load stats packages}
# using lmer
library(lme4)
library(lmerTest)
# using lme
library(nlme)
library(car)
```


## Day 50 post-fertilization  (length only) 

* started with the same stock density per downweller - therefore no tests for survival here...

```{r, Day 50 length - no survival data started the same!}
# call the data fro 50 DPF
data_51 <- length %>%
  filter(Age_DPF=="51") %>%
  dplyr::mutate(pCO2 = case_when(pH == 8 ~ "500 μatm",  pH == 7.5 ~ "800 μatm")) %>% 
  dplyr::mutate(Fed_Unfed = case_when(Fed_Unfed == "fed" ~ "High food",  Fed_Unfed == "unfed" ~ "Low food"))
data_51$Chamber_tank <- as.factor(paste(data_51$Replicate, data_51$pH, sep = '_'))

# plot the replicates (visual diagnostics of random factor)
Length914_reps<- ggboxplot(data_51, x = "pCO2", y = "Length_um", color = "Replicate",
                              add = c("mean_se", "dotplot"),
                              palette = c("#00AFBB", "#E7B800", "brown", "grey"))
Length914_reps

# Linear mixed effects models :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
require(nlme)
# Linear mixed effects model with random effect of Replicate 
ShellLengthMod_D51 = lme(Length_um ~ pCO2, random=~1|Chamber_tank,data=data_51)
# output the model results
# |     &nbsp;      | numDF | denDF | F-value | p-value |
# |:---------------:|:-----:|:-----:|:-------:|:-------:|
# | **(Intercept)** |   1   |  629  |  1097   |    0    |
# |    **pCO2**     |   1   |   6   |  0.233  | 0.6464  |
pander(anova(ShellLengthMod_D51), style='rmarkdown') # anova table of lmer
kable(as.data.frame(anova(ShellLengthMod_D51))) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Survival_size/20210914_figs_table/20210914_length_LME_Table.png", zoom = 1.5)
# mod assumptions
pdf(paste0(filename = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Survival_size/20210914_figs_table/20210914_length_LME_Diagnostics.pdf"))
check_model(ShellLengthMod_D51) # print the model diagnostics 
dev.off()
shapiro.test(residuals(ShellLengthMod_D51)) # non normal
leveneTest(residuals(ShellLengthMod_D51) ~ data_51$pCO2)


# call the results of LMER to add to boxplot below 
DF   <- paste( (anova(ShellLengthMod_D51)[[1]])[2], (anova(ShellLengthMod_D51)[[2]])[2], sep = '/') # call DF
Fval <- (anova(ShellLengthMod_D51)[[3]])[2] # call f
pval <- (anova(ShellLengthMod_D51)[[4]])[2] # call p value

# plot
Length914 <- ggplot(data_51, aes(x = factor(pCO2, level = c('500 μatm', '800 μatm')), (Length_um/1000) , fill = pCO2)) +
                    theme(panel.grid=element_blank()) +
                    geom_boxplot(size=0.2, width=0.5, alpha=0.1, aes(fill=pCO2)) +
                    scale_fill_manual(values=c("white","grey50")) +
                    geom_point(shape = 21, size = 1, position = position_jitterdodge(jitter.width = 0.25)) +
                    theme_classic() +
                    scale_x_discrete(labels= c('~500 μatm', '~800 μatm')) +
                    ylim(0, 22) +
                    labs(title = "F1 Scallops: Shell length 50 DPF", 
                         y = expression(Shell~length~"("~mm~")"),
                         x = expression(italic(p)*CO[2]~Treatment~"("~μ*atm~")")) + 
                    theme(axis.text=element_text(size=8),
                          axis.title=element_text(size=8,face="bold")) +
                     stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white")
Length914 # print this figure...

# Export the figures to pdf
ggarrange(Length914,Length914_reps,nrow = 2) %>%
  ggexport(filename = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Survival_size/20210914_figs_table/20210914_length.pdf")
```



# Day 64 post-fertilization ( survival & length) 

```{r, Day 64 data}

# length data 
data_64_length <- length %>%
  filter(Age_DPF=="64") %>%
  dplyr::mutate(pCO2 = case_when(pH == 8 ~ "500 μatm",  pH == 7.5 ~ "800 μatm")) %>% 
  dplyr::mutate(Fed_Unfed = case_when(Fed_Unfed == "fed" ~ "High food",  Fed_Unfed == "unfed" ~ "Low food"))
data_64_length$Chamber_tank <- as.factor(paste(data_64_length$Replicate, data_64_length$pH, sep = '_'))

# Survival data 
data_64_survival <- survival_juvenile %>%
  dplyr::filter(Age_DPF=="64") %>% 
  dplyr::mutate(Fed_Unfed = as.factor(gsub("^(?:[^_]+_){2}([^_]+).*", "\\1", data_64$trt))) %>% 
  dplyr::mutate(pCO2 = as.factor(gsub("^(?:[^_]+_){1}([^_]+).*", "\\1", data_64$trt))) %>% 
  dplyr::rename(Length_um = Length)
data_64_survival$Chamber_tank <- as.factor(paste(data_64_survival$Replicate, data_64_survival$pH, sep = '_'))
levels(data_64$Fed_Unfed) <- c("High food", "Low food")
levels(data_64$pCO2) <- c("800 μatm", "500 μatm")
data_64 %>% dplyr::group_by(Fed_Unfed) %>% dplyr::summarise(mean = mean(Length))

# Linear mixed effects models :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
require(nlme)

# Length:::::::::::::::::::::::::::::::::::::::::::::::
ShellLengthMod_D64 = lme(Length_um ~ pCO2 * Fed_Unfed, random=~1|Chamber_tank,data=data_64_survival)
# output the model results
# |       &nbsp;       | numDF | denDF | F-value | p-value |
# |:------------------:|:-----:|:-----:|:-------:|:-------:|
# |  **(Intercept)**   |   1   | 1094  |  1339   |    0    |
# |      **pCO2**      |   1   |   6   | 0.0564  | 0.8202  |
# |   **Fed_Unfed**    |   1   | 1094  |  643.8  |    0    |
# | **pCO2:Fed_Unfed** |   1   | 1094  | 0.2846  | 0.5938  |
pander(anova(ShellLengthMod_D64), style='rmarkdown') # anova table of lmer
kable(as.data.frame(anova(ShellLengthMod_D64))) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Survival_size/20210930_figs_table/20210930_length_LME_Table.png", zoom = 1.5)
# mod assumptions
pdf(paste0(filename = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Survival_size/20210930_figs_table/20210930_length_LME_Diagnostics.pdf"))
check_model(ShellLengthMod_D64) # print the model diagnostics 
dev.off()
shapiro.test(residuals(ShellLengthMod_D64)) # non normal < 2.2e-16
leveneTest(residuals(ShellLengthMod_D51) ~ data_64_length$pCO2) # 0.7793
leveneTest(residuals(ShellLengthMod_D51) ~ data_64_length$Fed_Unfed) # < 2.2e-16 ***

# Survival:::::::::::::::::::::::::::::::::::::::::::::
SurvivalhMod_D64 = lm(Survival ~ pCO2 * Food, data=data_64_survival) # no replicates within the tanks a,b,c,d - linear model used here
# output the model results
# |    &nbsp;     | Df |  Sum Sq  | Mean Sq  | F value | Pr(>F) |
# |:-------------:|:--:|:--------:|:--------:|:-------:|:------:|
# |   **pCO2**    | 1  | 0.03901  | 0.03901  |  2.791  | 0.1207 |
# |   **Food**    | 1  | 0.001806 | 0.001806 | 0.1292  | 0.7255 |
# | **pCO2:Food** | 1  | 0.001406 | 0.001406 | 0.1006  | 0.7565 |
# | **Residuals** | 12 |  0.1677  | 0.01398  |   NA    |   NA   |
pander(anova(SurvivalhMod_D64), style='rmarkdown') # anova table of lmer
kable(as.data.frame(anova(SurvivalhMod_D64))) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Survival_size/20210930_figs_table/20210930_survival_LME_Table.png", zoom = 1.5)
# mod assumptions
pdf(paste0(filename = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Survival_size/20210930_figs_table/20210930_survival_LME_Diagnostics.pdf"))
check_model(SurvivalhMod_D64) # print the model diagnostics 
dev.off()
shapiro.test(residuals(SurvivalhMod_D64)) # non normal 0.002907
leveneTest(residuals(SurvivalhMod_D64) ~ data_64_survival$pCO2) # 0.07483 .
leveneTest(residuals(SurvivalhMod_D64) ~ data_64_survival$Food) # 0.2951




# plots ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# plot
Length914 <- ggplot(data_51, aes(x = factor(pCO2, level = c('500 μatm', '800 μatm')), Length_um , fill = pCO2)) +
                    theme(panel.grid=element_blank()) +
                    geom_boxplot(size=0.2, width=0.5, alpha=0.1, aes(fill=pCO2)) +
                    scale_fill_manual(values=c("white","grey50")) +
                    geom_point(shape = 21, size = 1, position = position_jitterdodge(jitter.width = 0.25)) +
                    theme_classic() +
                    scale_x_discrete(labels= c('~500 μatm', '~800 μatm')) +
                   # scale_y_continuous(expand = c(0, 0), limits = c(0, 2)) +
                    labs(title = "F1 Scallops: Shell length 50 DPF", 
                         y = expression(Shell~length~"("~μm~")"),
                         x = expression(italic(p)*CO[2]~Treatment~"("~μ*atm~")")) + 
                    theme(axis.text=element_text(size=8),
                          axis.title=element_text(size=8,face="bold")) +
                     stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white")
Length914 # print this figure...




data_64 %>% dplyr::group_by(pCO2) %>% dplyr::summarise(mean = mean(Survival))
data_64 %>% dplyr::group_by(Fed_Unfed) %>% dplyr::summarise(mean = mean(Survival), sd = sd(Survival))
data_64 %>% dplyr::group_by(trt) %>% dplyr::summarise(mean = mean(Survival))


Length_64dpf <- ggplot(data_64_length, aes(x =pCO2, (Length_um/1000),  fill = pCO2)) +
                    theme(panel.grid=element_blank()) +
                    geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
                    scale_fill_manual(values=c("grey50","white")) +
                    geom_point(shape = 21, size = 1, position = position_jitterdodge(jitter.width = 0.4)) +
                    theme_classic() +
                    ylim(0, 22) +
                    scale_x_discrete(labels=c('~500 μatm', '~800 μatm')) +
                    theme(axis.text=element_text(size=12),
                          axis.title=element_text(size=14,face="bold")) +
                    stat_summary(fun.y=mean, geom="point", shape=18, size=4) +
                    labs(title = "F1 Scallops: Shell length 64 DPF", 
                         y = expression(Shell~length~"("~mm~")"), 
                         x = expression(italic(p)*CO[2]~Treatment~"("~μ*atm~")")) + 
                    facet_wrap(~factor(Fed_Unfed, level = c('Low food', 'High food'))) 

Survival_64DPF <- ggplot(data_64_survival, aes(x =pCO2, (Survival*100) , fill = pCO2)) +
                    theme(panel.grid=element_blank()) +
                    geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
                    scale_fill_manual(values=c("white","grey50")) +
                    geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
                    theme_classic() +
                    ylim(0, 100) +
                    scale_x_discrete(labels=c('~500 μatm', '~800 μatm')) +
                    theme(axis.text=element_text(size=12),
                          axis.title=element_text(size=14,face="bold")) +
                    stat_summary(fun.y=mean, geom="point", shape=18, size=4) +
                    labs(title = "F1 Scallops: Perent survival 64 DPF", 
                         y = expression(Survival~"(%)"), 
                         x = expression(italic(p)*CO[2]~Treatment~"("~μ*atm~")")) + 
                    facet_wrap(~factor(Fed_Unfed, level = c('LowFood', 'HighFood'))) 

# Export the figures to pdf
ggarrange(Length_64dpf,Survival_64DPF,nrow = 2) %>%
  ggexport(filename = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Survival_size/20210930_figs_table/20210930_length_survival.pdf")

```

# Day 90 Analysis and plotting 

```{r, Day 92 data}


# length data 
data_92_length <- length %>%
  filter(Age_DPF=="92") %>%
  dplyr::mutate(pCO2 = case_when(pH == 8 ~ "500 μatm",  pH == 7.5 ~ "800 μatm")) %>% 
  dplyr::mutate(Fed_Unfed = case_when(Fed_Unfed == "fed" ~ "High food",  Fed_Unfed == "unfed" ~ "Low food"))
data_92_length$Chamber_tank <- as.factor(paste(data_92_length$Replicate, data_92_length$pH, sep = '_'))
data_92_length %>% dplyr::group_by(Fed_Unfed) %>% dplyr::summarise(mean = mean(Length_um))

# Survival data 
data_92_survival <- survival_juvenile %>%
  dplyr::filter(Age_DPF=="92") %>% 
  dplyr::mutate(Fed_Unfed = as.factor(gsub("^(?:[^_]+_){2}([^_]+).*", "\\1", trt))) %>% 
  dplyr::mutate(pCO2 = as.factor(gsub("^(?:[^_]+_){1}([^_]+).*", "\\1", trt))) %>% 
  dplyr::rename(Length_um = Length)
data_92_survival$Chamber_tank <- as.factor(paste(data_92_survival$Replicate, data_92_survival$pH, sep = '_'))
levels(data_92_survival$Fed_Unfed) <- c("High food", "Low food")
levels(data_92_survival$pCO2) <- c("800 μatm", "500 μatm")

# Linear mixed effects models :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
require(nlme)

# Length:::::::::::::::::::::::::::::::::::::::::::::::
ShellLengthMod_D92 = lme(Length_um ~ pCO2 * Fed_Unfed, random=~1|Chamber_tank,data=data_92_length)
# output the model results
# |       &nbsp;       | numDF | denDF | F-value | p-value |
# |:------------------:|:-----:|:-----:|:-------:|:-------:|
# |  **(Intercept)**   |   1   |  555  |  1772   |    0    |
# |      **pCO2**      |   1   |   6   | 0.1754  |  0.69   |
# |   **Fed_Unfed**    |   1   |  555  |  579.3  |    0    |
# | **pCO2:Fed_Unfed** |   1   |  555  | 0.4771  |  0.49   |
pander(anova(ShellLengthMod_D92), style='rmarkdown') # anova table of lmer
kable(as.data.frame(anova(ShellLengthMod_D92))) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Survival_size/20211026_figs_table/20211026_length_LME_Table.png", zoom = 1.5)
# mod assumptions
pdf(paste0(filename = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Survival_size/20211026_figs_table/20211026_length_LME_Diagnostics.pdf"))
check_model(ShellLengthMod_D92) # print the model diagnostics 
dev.off()
shapiro.test(residuals(ShellLengthMod_D92)) # non normal 6.026e-15
leveneTest(residuals(ShellLengthMod_D92) ~ data_92_length$pCO2) # 0.1583
leveneTest(residuals(ShellLengthMod_D92) ~ data_92_length$Fed_Unfed) # < 2.2e-16 ***

# Survival:::::::::::::::::::::::::::::::::::::::::::::
SurvivalhMod_D92 = lm(Survival ~ pCO2 * Food, data=data_92_survival) # no replicates within the tanks a,b,c,d - linear model used here
# output the model results
# |    &nbsp;     | Df |  Sum Sq   |  Mean Sq  | F value |  Pr(>F)   |
# |:-------------:|:--:|:---------:|:---------:|:-------:|:---------:|
# |   **pCO2**    | 1  | 0.0003062 | 0.0003062 | 0.07346 |   0.791   |
# |   **Food**    | 1  |  0.9851   |  0.9851   |  236.3  | 2.936e-09 |
# | **pCO2:Food** | 1  | 0.0007562 | 0.0007562 | 0.1814  |  0.6777   |
# | **Residuals** | 12 |  0.05002  | 0.004169  |   NA    |    NA     |
pander(anova(SurvivalhMod_D92), style='rmarkdown') # anova table of lmer
kable(as.data.frame(anova(SurvivalhMod_D92))) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Survival_size/20211026_figs_table/20211026_survival_LME_Table.png", zoom = 1.5)
# mod assumptions
pdf(paste0(filename = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Survival_size/20210930_figs_table/20211026_survival_LME_Diagnostics.pdf"))
check_model(SurvivalhMod_D92) # print the model diagnostics 
dev.off()
shapiro.test(residuals(SurvivalhMod_D92)) #  normal 0.1661
leveneTest(residuals(SurvivalhMod_D92) ~ data_92_survival$pCO2) # 0.5736 .
leveneTest(residuals(SurvivalhMod_D92) ~ data_92_survival$Food) # 0.1351




# plots ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

Length_92dpf <- ggplot(data_92_length, aes(x =pCO2, (Length_um/1000),  fill = pCO2)) +
                    theme(panel.grid=element_blank()) +
                    geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
                    scale_fill_manual(values=c("white","grey50")) +
                    geom_point(shape = 21, size = 1, position = position_jitterdodge(jitter.width = 0.4)) +
                    theme_classic() +
                    ylim(0, 22) +
                    scale_x_discrete(labels=c('~500 μatm', '~800 μatm')) +
                    theme(axis.text=element_text(size=12),
                          axis.title=element_text(size=14,face="bold")) +
                    stat_summary(fun.y=mean, geom="point", shape=18, size=4) +
                    labs(title = "F1 Scallops: Shell length 92 DPF", 
                         y = expression(Shell~length~"("~mm~")"), 
                         x = expression(italic(p)*CO[2]~Treatment~"("~μ*atm~")")) + 
                    facet_wrap(~factor(Fed_Unfed, level = c('Low food', 'High food'))) 

Survival_92DPF <- ggplot(data_92_survival, aes(x =pCO2, (Survival*100) , fill = pCO2)) +
                    theme(panel.grid=element_blank()) +
                    geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
                    scale_fill_manual(values=c("white","grey50")) +
                    geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
                    theme_classic() +
                    ylim(0, 100) +
                    scale_x_discrete(labels=c('~500 μatm', '~800 μatm')) +
                    theme(axis.text=element_text(size=12),
                          axis.title=element_text(size=14,face="bold")) +
                    stat_summary(fun.y=mean, geom="point", shape=18, size=4) +
                    labs(title = "F1 Scallops: Perent survival 92 DPF", 
                         y = expression(Survival~"(%)"), 
                         x = expression(italic(p)*CO[2]~Treatment~"("~μ*atm~")")) + 
                    facet_wrap(~factor(Fed_Unfed, level = c('Low food', 'High food'))) 

# Export the figures to pdf
ggarrange(Length_92dpf,Survival_92DPF,nrow = 2) %>%
  ggexport(filename = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Survival_size/20211026_figs_table/20211026_length_survival.pdf")

```

# density plot - fun visualization of data!
```{r, Day 92 density length plot }
library(dplyr)
library(tidyr)

data_92_length$pHxfood <- as.factor(paste(data_92_length$pH, data_92_length$Fed_Unfed, sep = "_"))
df_mean <- data_92_length %>% 
  dplyr::group_by(pHxfood) %>% 
  dplyr::summarize(average = mean(Length_um)) %>%
  dplyr::ungroup()
p.box <- ggplot(data_92_length, aes(x = pHxfood, y = (Length_um/1000))) + geom_boxplot() + geom_point(data= df_mean, mapping = aes(x = pHxfood, y = (average/1000)),
             color="red") 
p.box.data <- layer_data(p.box) %>%
  select(x, ymin, lower, middle, upper, ymax, outliers, flipped_aes) %>%
  dplyr::rename(mean = flipped_aes) %>% 
  dplyr::mutate(mean  = (df_mean$average/1000)) %>% 
  mutate(pHxfood = factor(x, labels = levels(data_92_length$pHxfood), ordered = TRUE)) %>%
  select(-x)

denisty_box_length_92DPF <-ggplot(p.box.data) +
                            # manually plot flipped boxplot
                            geom_segment(aes(x = ymin, xend = ymax, y = -0.2, yend = -0.2)) +
                            geom_rect(aes(xmin = lower, xmax = upper, ymin = -0.25, ymax = -0.15,  fill = pHxfood),color = "black") +
                            geom_point(data = . %>% unnest(outliers), aes(x = outliers, y = -0.2)) +
                            # vertical lines at Q1 / Q2 / Q3
                            geom_vline(data = . %>% select(pHxfood, lower, mean, upper) %>% gather(key, value, -pHxfood), aes(xintercept = value)) +
                            # density plot
                            geom_density(data = data_92_length, aes(x = (Length_um/1000), fill=pHxfood), alpha=.4) +
                            #  theme
                            theme_classic() +
                            facet_grid(pHxfood ~ .) +
                            theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "none", plot.title = element_text(size=10))+
                            labs(x = "Shell length", y = "frequency") +
                            scale_fill_discrete()


pdf(paste0(filename = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Survival_size/20211026_figs_table/20211026_length_density_plot.pdf"), width = 4, height = 8)
denisty_box_length_92DPF # print the model diagnostics 
dev.off()


```
