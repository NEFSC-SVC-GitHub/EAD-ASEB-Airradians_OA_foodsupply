---
title: "F1 Bay Scallops: High vs. Low food availability under OA conditions"
author: "Samuel Gurr"
date: "10/12/2021"
output:
  pdf_document:
    latex_engine: xelatex
---

Last updates: october 6, 2021


## Load libraries

```{r startup, include=FALSE}

library(ggplot2)
library(dplyr)
library(tidyverse)
library(car)
library(nlme)
library(multcompView)
library(agricolae)
library(Rmisc)
library(lmerTest)
library(lme4)
library(pander)
library(performance)
library(Rmisc)
library(tidyr)
library(reshape2)
library(rcompanion)
library(kableExtra)
library(ggpubr)
library(tidyr)
library(nlme)
library(car)
setwd("C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis") # Work computer
# setwd("C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis") # Work computer

```

## Set Path
```{r setup, include=TRUE}
setwd("C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis") # Work computer

# setwd("C:/Users/samjg/Documents/Github_repositories/Airradians_OA/RAnalysis") # Work computer
# setwd("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA/RAnalysis") # Work computer
length                     <-read.csv(file="Data/Survival_Size/Lengths_master.csv", header = TRUE)
len.dryweight.CI_1026      <-read.csv(file="Data/Survival_Size/20211026_lengths_dryweights.csv", header = TRUE) 
# len.dryweight.CI_1202      <-read.csv(file="Data/Survival_Size/20211202_lengths_dryweights.csv", header = TRUE)


survival_juvenile          <-read.csv(file="C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Data/Survival_Size/Survival_master.csv", header = TRUE)

# Structure of the data - to check that variables are properly assigned to factor or variable
# str(length)

```

# condition Index

* plot and statistics 

```{r Condition index data, statistics, plotting, include=FALSE}

CI_1026_means <- len.dryweight.CI_1026[!is.na(len.dryweight.CI_1026$CI),] %>%  
summarySE(measurevar="CI", groupvars=c("pH")) %>% 
      dplyr::mutate(pCO2 = case_when(pH == 8  ~ "500 μatm", pH == 7.5 ~ "800 μatm")) %>% # cahmber volumes on different dates with
      dplyr::mutate(Age = 92)
    


ggplot(data=CI_1026_means, aes(x=Age, y=CI, color=pCO2)) +
  geom_line( stat = "identity", size=1.0)+
  geom_point(position=position_dodge(.5))+ 
  scale_color_manual(values=c("forestgreen","darkorange2"))+
  geom_errorbar(aes(ymin=CI-se, ymax=CI+se), width=.2,
                position=position_dodge(.5))+
  theme_classic() +  
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  scale_y_continuous(name ="Condition index [(Dry tissue / dry shell) *100]")+
  theme(text = element_text(size=15))



CI_1026 <- len.dryweight.CI_1026[!is.na(len.dryweight.CI_1026$CI),] %>% 
  dplyr::select(c('pH','CI','Tank_Replicate', "Shell_length_mm")) %>% 
  dplyr::mutate(Age = "64DPF") %>% 
  dplyr::mutate(random_eff = (as.factor(paste(pH,Tank_Replicate, sep ='_')))) %>% 
  dplyr::mutate(pH_Age = (as.factor(paste(pH,Age, sep = '_')))) %>% 
  dplyr::select(-Tank_Replicate)


CI_1026$pH <- as.factor(CI_1026$pH)


# Prep for stats

CI_1026.DATA <- CI_1026 %>% 
  dplyr::filter(Age %in% '64DPF') %>% # filter the data from 20211026
    dplyr::mutate(pCO2 = case_when(
    pH == 8 ~ "500 μatm", 
    pH == 7.5 ~ "800 μatm"))
CI_1026.DATA$pCO2 <- as.factor(CI_1026.DATA$pCO2)
levels(CI_1026.DATA$random_eff) # should be 8 levels A B C D within 7.5 and 8 
levels(CI_1026.DATA$pCO2)
View(CI_1026.DATA)

# one-way ANOVA
AOVCI <- aov(CI ~ 
               pCO2, 
             data=CI_1026.DATA) # run mod
# check model assumptions
shapiro.test(residuals(AOVCI)) # non - normal - 8.769e-07
leveneTest(AOVCI) # homogeneity of variance (equal variance) - 0.5031
# need to run the non-parametric Kruskal Wallis
KWCI <- kruskal.test(CI ~ 
                       pCO2, 
                     data = CI_1026.DATA) # run mod
# all is good, lets see the results
pander(print(KWCI), style='rmarkdown') # table for SRH test
# | Test statistic | df |    P value    |
# |:--------------:|:--:|:-------------:|
# |     8.068      | 1  | 0.004506  * * |
CI_1026.DATA %>% summarySE(measurevar="CI", groupvars= c("pCO2"))  # view summary means 
((11.30190- 10.15005) / 11.30190) * 100 # 10.19165 % difference 


```


# Food limitation x pCO2 experiment (50 - 92 dpf)

## Survival plot (all)

* Note: this experiment only included the low and moderate pCO2 due to low survivorship in the high pCO2 condition 

```{r foodxpCO2 survival mean SE plots}

#First make calculations for means and standard erro
survival_juvenile$Fed_Unfed <-  as.factor(gsub("^(?:[^_]+_){2}([^_]+).*", "\\1", survival_juvenile$trt))
levels(survival_juvenile$Fed_Unfed) <- c("High food", "Low food")


survival_juvenile$pCO2 <-  as.factor(gsub("^(?:[^_]+_){1}([^_]+).*", "\\1", survival_juvenile$trt))
levels(survival_juvenile$pCO2) <- c("800 μatm", "500 μatm")

# Survival ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

Survival_Means <- summarySE(survival_juvenile, measurevar="Survival", groupvars=c("Age_DPF", "pCO2", "Fed_Unfed")) 
Survival_Means$pCO2 <- factor(Survival_Means$pCO2, c("500 μatm","800 μatm"))

dodge <- position_dodge(.50)
## Use geom_line and geom_point to plot over time
Survival_All_plot <- ggplot(data=Survival_Means, aes(x=Age_DPF, y=Survival, color=pCO2)) +
                        #geom_line(aes(linetype = factor(Fed_Unfed)), size = c(0.2, 0.2,0.2, 1,1, 1, 0.2, 0.2,0.2,1,1, 1)) +
                        geom_line(aes(linetype = factor(Fed_Unfed)), size = 0.5) +  
                        #geom_point(position = position_jitterdodge(jitter.width = 10)) +
                        geom_point(position = position_dodge(width=10)) +
                        #scale_color_manual(values=c("forestgreen","darkorange2")) +
                        #scale_color_manual(values=c("black","black")) +
                        scale_color_manual(values=c("forestgreen","darkorange2"))+
                        geom_errorbar(aes(ymin=Survival-se, ymax=Survival+se), width=.2,
                                      position=position_dodge(width=10))+
                        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                        scale_x_continuous(name ="Age (days)") +
                        scale_y_continuous(name ="Survival (%)")  + 
                        scale_linetype_manual(values = c("High food" = "solid", "Low food" = "dashed"))  +
                        theme_classic() +
                        theme(legend.position="none") +
                        # facet_wrap(~factor(Fed_Unfed, level = c('Low food', 'High food'))) 
                        facet_wrap(~pCO2)
Survival_All_plot
pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Survival_size/Juvenile_survival_FoodxOA.pdf"), width = 8, height = 6)
Survival_All_plot
dev.off()

```

##  Shell length plot (all)
```{r foodxpCO2 shell size  mean SE plots}
# Length ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

Length_Means <- summarySE(length, measurevar="Length_um", groupvars=c("Age_DPF", "pH", "Fed_Unfed"))
Length_Means <- Length_Means %>% 
  dplyr::mutate(pCO2 = case_when(pH == 8 ~ "500 μatm",  pH == 7.5 ~ "800 μatm")) %>% 
  dplyr::mutate(Fed_Unfed = case_when(Fed_Unfed == "fed" ~ "High food",  Fed_Unfed == "unfed" ~ "Low food"))

## Use geom_line and geom_point to plot over time
Length_All_plot <- ggplot(data=Length_Means, aes(x=Age_DPF, y=(Length_um/1000), color=pCO2)) +
  geom_line(aes(linetype = factor(Fed_Unfed)), size = 0.5) +  
  geom_point()+ 
  scale_color_manual(values=c("black","black")) +
  geom_errorbar(aes(ymin=(Length_um/1000)-(se/1000), ymax=(Length_um/1000)+(se/1000)), width=.2,
                position=position_dodge(.1))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  scale_x_continuous(name ="Age (days)") +
  scale_y_continuous(name ="Shell length (mm)")  + 
  scale_linetype_manual(values = c("High food" = "solid", "Low food" = "dashed"))  +
  theme_classic() +
  theme(legend.position="none") +
  # facet_wrap(~factor(Fed_Unfed, level = c('Low food', 'High food'))) 
  facet_wrap(~pCO2)
Length_All_plot
pdf(paste0("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Survival_size/Juvenile_length_FoodxOA.pdf"))
Length_All_plot
dev.off()

```


# Statistical analysis (survival + shell size)



# 9/14/2021 F1 juvenile scallops (50 DPF; Day 0)

**About**

- two pCO2 treatments 

- **before** we culled and started the food limitation trials

```{r, Day 50 length - no survival data started the same!}
# call the data fro 50 DPF
data_51 <- length %>%
  filter(Age_DPF=="51") %>%
  dplyr::mutate(pCO2 = case_when(pH == 8 ~ "500 μatm",  pH == 7.5 ~ "800 μatm")) %>% 
  dplyr::mutate(Fed_Unfed = 
                  case_when(Fed_Unfed == "fed" ~ "High food",  
                            Fed_Unfed == "unfed" ~ "Low food")) %>% 
  dplyr::mutate(random_fact = 
                  as.factor(paste(pCO2,Replicate, sep = "_")))

data_51_AVG <- data_51 %>%  summarySE(measurevar="Length_um", groupvars= "pCO2")
# data_51_AVG


# plot the replicates (visual diagnostics of random factor)
Length914_reps<- ggboxplot(data_51, x = "pCO2", y = "Length_um", color = "Replicate",
                              add = c("mean_se", "dotplot"),
                              palette = c("#00AFBB", "#E7B800", "brown", "grey"))
Length914_reps

# One-way ANOVA (without the random effect) 
AOV914.length <- aov(Length_um ~ 
                       pCO2, 
                     data=data_51) # run mod
# check model assumptions
shapiro.test(residuals(AOV914.length)) # non-normal - 2.706e-14
leveneTest(AOV930.bfactALL) # homogeneity of variance (equal variance) - 0.365
# so lets do the nonparametric equivalent Kruskal Wallis
library(rcompanion)
KW_914_length <- kruskal.test(Length_um ~ 
                       pCO2, 
                     data = data_51) # run mod
# all is good, lets see the results
pander(print(KW_914_length), style='rmarkdown') # table for KW test
# | Test statistic | df | P value |
# |:--------------:|:--:|:-------:|
# |     1.442      | 1  | 0.2299  | # no effect 
# all is good, lets see the results

# plot
Length914 <- ggplot(data_51, aes(x = factor(pCO2, level = c('500 μatm', '800 μatm')), (Length_um/1000) , fill = pCO2)) +
                    theme(panel.grid=element_blank()) +
                    geom_boxplot(size=0.2, width=0.5, alpha=0.1, aes(fill=pCO2)) +
                    scale_fill_manual(values=c("white","grey50")) +
                    geom_point(shape = 21, size = 1, position = position_jitterdodge(jitter.width = 0.25)) +
                    theme_classic() +
                    scale_x_discrete(labels= c('~500 μatm', '~800 μatm')) +
                    ylim(0, 22) +
                    labs(title = "F1 Scallops: Shell length 50 DPF", 
                         y = expression(Shell~length~"("~mm~")"),
                         x = expression(italic(p)*CO[2]~Treatment~"("~μ*atm~")")) + 
                    theme(axis.text=element_text(size=8),
                          axis.title=element_text(size=8,face="bold")) +
                     stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white")
Length914 # print this figure...

# Export the figures to pdf
ggarrange(Length914,Length914_reps,nrow = 2) %>%
  ggexport(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Survival_size/20210914_figs_table/20210914_length.pdf")
```



# 9/30/2021 F1 juvenile scallops (64 DPF; Day 14)

```{r, Day 64 data}


# Shell length :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# length data 
data_64_length <- length %>%
  filter(Age_DPF=="64") %>%
  dplyr::mutate(pCO2 = case_when(pH == 8 ~ "500 μatm",  pH == 7.5 ~ "800 μatm")) %>% 
  dplyr::mutate(Fed_Unfed = case_when(Fed_Unfed == "fed" ~ "High food",  Fed_Unfed == "unfed" ~ "Low food")) %>% 
  dplyr::mutate(random_fact = as.factor(paste(pCO2,Replicate,Fed_Unfed, sep = "_")))

data_64_AVG.length <- data_64_length %>%  summarySE(measurevar="Length_um", groupvars= c("pCO2", "Fed_Unfed"))  # view summary means 

# run model
AOV930.length = aov(Length_um ~ 
                           pCO2 * Fed_Unfed, 
                         data=data_64_length)
leveneTest(AOV930.length) # 0.4668

shapiro.test(resid(AOV930.length)) # < 2.2e-16
# so lets do thenonparametric equivalent Kruskal Wallis
library(rcompanion)
SRH_930_length <- scheirerRayHare(Length_um ~ 
                       pCO2 * Fed_Unfed,
                     data = data_64_length) # run mod
# all is good, lets see the results
pander(print(SRH_930_length), style='rmarkdown') # table for Schierer-Ray_Hare Test
# |       &nbsp;       |  Df  |  Sum Sq  |    H     | p.value |
# |:------------------:|:----:|:--------:|:--------:|:-------:|
# |      **pCO2**      |  1   |   9902   | 0.09741  |  0.755  |
# |   **Fed_Unfed**    |  1   | 46216498 |  454.6   |    0    |
# | **pCO2:Fed_Unfed** |  1   |  672.1   | 0.006612 | 0.9352  |
# |   **Residuals**    | 1100 | 65756253 |    NA    |   NA    |
# all is good, lets see the results
kable(unclass(print(SRH_930_length))) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Survival_size/20210930_figs_table/20210930_length_SRH_Table.png", zoom = 1.5)


# percent difference
# data_64_survival %>% dplyr::group_by(pCO2) %>% dplyr::summarise(mean = mean(Survival))
# data_64_survival %>% dplyr::group_by(trt) %>% dplyr::summarise(mean = mean(Survival))
data_64_length %>%  dplyr::mutate(Length_mm = Length_um/1000) %>% summarySE(measurevar="Length_mm", groupvars= c("Fed_Unfed"))  # view summary means 
((3612.114-2288.521) / 3612.114) * 100 # 36.64317 % greater shell length under high food availability




# Survival:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
data_64_survival <- survival_juvenile %>%
  dplyr::filter(Age_DPF=="64") %>% 
  dplyr::mutate(Fed_Unfed = as.factor(Food)) %>% 
  dplyr::mutate(pCO2 = as.factor(gsub("^(?:[^_]+_){1}([^_]+).*", "\\1", trt))) %>% 
  dplyr::rename(Length_um = Length) %>% 
  dplyr::mutate(random_fact = as.factor(paste(pCO2,Rep,Food, sep = "_")))
levels(data_64_survival$Fed_Unfed) <- c("High food", "Low food")
levels(data_64_survival$pCO2) <- c("800 μatm", "500 μatm")

data_64_AVG.survival <- data_64_survival %>%  summarySE(measurevar="Survival", groupvars= c("pCO2", "Fed_Unfed")) # summary of means

# run the model
AOV930.survival = aov(Survival ~ 
                         pCO2 * Fed_Unfed, 
                       data=data_64_survival) # no replicates within the tanks a,b,c,d - linear model used here
shapiro.test(residuals(AOV930.survival)) # non normal 0.00368
leveneTest(AOV930.survival) # 0.4668
# so lets do thenonparametric equivalent Schierer-Ray_Hare Test
SRH930.survival <- scheirerRayHare(Survival ~ 
                       pCO2 * Fed_Unfed,
                     data = data_64_survival) # run mod
# all is good, lets see the results
pander(print(SRH930.survival), style='rmarkdown') # table for KW test
# |       &nbsp;       | Df | Sum Sq |   H    | p.value |
# |:------------------:|:--:|:------:|:------:|:-------:|
# |      **pCO2**      | 1  |   4    | 0.1843 | 0.6677  |
# |   **Fed_Unfed**    | 1  | 95.06  | 4.381  | 0.03635 |
# | **pCO2:Fed_Unfed** | 1  | 3.062  | 0.1411 | 0.7072    |
# |   **Residuals**    | 12 | 223.4  |   NA   |   NA    |
kable(unclass(print(SRH930.survival))) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Survival_size/20210930_figs_table/20210930_survival_SRH_Table.png", zoom = 1.5)


# percent difference
# data_64_survival %>% dplyr::group_by(pCO2) %>% dplyr::summarise(mean = mean(Survival))
# data_64_survival %>% dplyr::group_by(trt) %>% dplyr::summarise(mean = mean(Survival))
data_64_survival %>% dplyr::mutate(PercSurv = Survival*100) %>%  summarySE(measurevar="PercSurv", groupvars= c("Fed_Unfed"))  # view summary means 
((0.98625-0.88750) / 0.98625) * 100 # 10.01267 % greater shell length under high food availability




# plots

Length_64dpf <- ggplot(data_64_length, aes(x =pCO2, (Length_um/1000),  fill = pCO2)) +
                    theme(panel.grid=element_blank()) +
                    geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
                    scale_fill_manual(values=c("grey50","white")) +
                    geom_point(shape = 21, size = 1, position = position_jitterdodge(jitter.width = 0.4)) +
                    theme_classic() +
                    ylim(0, 22) +
                    scale_x_discrete(labels=c('~500 μatm', '~800 μatm')) +
                    theme(axis.text=element_text(size=12),
                          axis.title=element_text(size=14,face="bold")) +
                    stat_summary(fun.y=mean, geom="point", shape=18, size=4) +
                    labs(title = "F1 Scallops: Shell length 64 DPF", 
                         y = expression(Shell~length~"("~mm~")"), 
                         x = expression(italic(p)*CO[2]~Treatment~"("~μ*atm~")")) + 
                    facet_wrap(~factor(Fed_Unfed, level = c('Low food', 'High food'))) 

Survival_64DPF <- ggplot(data_64_survival, aes(x =pCO2, (Survival*100) , fill = pCO2)) +
                    theme(panel.grid=element_blank()) +
                    geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
                    scale_fill_manual(values=c("white","grey50")) +
                    geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
                    theme_classic() +
                    ylim(0, 100) +
                    scale_x_discrete(labels=c('~500 μatm', '~800 μatm')) +
                    theme(axis.text=element_text(size=12),
                          axis.title=element_text(size=14,face="bold")) +
                    stat_summary(fun.y=mean, geom="point", shape=18, size=4) +
                    labs(title = "F1 Scallops: Perent survival 64 DPF", 
                         y = expression(Survival~"(%)"), 
                         x = expression(italic(p)*CO[2]~Treatment~"("~μ*atm~")")) + 
                    facet_wrap(~factor(Fed_Unfed, level = c('Low food', 'High food'))) 

# Export the figures to pdf
ggarrange(Length_64dpf,Survival_64DPF,nrow = 2) %>%
  ggexport(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Survival_size/20210930_figs_table/20210930_length_survival.pdf")

```


### density plot - Day 64


```{r, Day 64 density length plot }


data_64_length$pHxfood <- as.factor(paste(data_64_length$pH, data_64_length$Fed_Unfed, sep = "_"))
df_mean <- data_64_length %>% 
  dplyr::group_by(pHxfood) %>% 
  dplyr::summarize(average = mean(Length_um)) %>%
  dplyr::ungroup()
p.box <- ggplot(data_64_length, aes(x = pHxfood, y = (Length_um/1000))) + geom_boxplot() + geom_point(data= df_mean, mapping = aes(x = pHxfood, y = (average/1000)),
             color="red") 
p.box.data <- layer_data(p.box) %>%
  select(x, ymin, lower, middle, upper, ymax, outliers, flipped_aes) %>%
  dplyr::rename(mean = flipped_aes) %>% 
  dplyr::mutate(mean  = (df_mean$average/1000)) %>% 
  mutate(pHxfood = factor(x, labels = levels(data_64_length$pHxfood), ordered = TRUE)) %>%
  select(-x)

denisty_box_length_64DPF <-ggplot(p.box.data) +
                            # manually plot flipped boxplot
                            geom_segment(aes(x = ymin, xend = ymax, y = -0.2, yend = -0.2)) +
                            geom_rect(aes(xmin = lower, xmax = upper, ymin = -0.25, ymax = -0.15,  fill = pHxfood),color = "black") +
                            geom_point(data = . %>% unnest(outliers), aes(x = outliers, y = -0.2), color = "grey60", size = 1) +
                            # vertical lines at Q1 / Q2 / Q3
                            geom_vline(data = . %>% select(pHxfood, lower, mean, upper) %>% gather(key, value, -pHxfood), aes(xintercept = value)) +
                            # density plot
                            geom_density(data = data_64_length, aes(x = (Length_um/1000), fill=pHxfood, ..scaled..), alpha=.4) +
                            #  theme
                            theme_classic() +
                            xlim(0, 20) +
                            facet_grid(pHxfood ~ .) +
                            theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "none", plot.title = element_text(size=10))+
                            labs(x = "Shell length", y = "frequency")  +
                            scale_fill_manual(values=c("grey40", "grey40", "grey85", "grey85"))
denisty_box_length_64DPF
# export the plot
pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Survival_size/20210930_figs_table/20210930_length_density_plot.pdf"), width = 4, height = 8)
denisty_box_length_64DPF # print the model diagnostics 
dev.off()
```


# 10/26/2021 F1 juvenile scallops  (92 DPF; Day 42)

**About**

- two pCO2 treatments 

- *before* we culled and started the food limitation trials


```{r, Day 92 data}





# Shell length :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# length data 
data_92_length <- length %>%
  filter(Age_DPF=="92") %>%
  dplyr::mutate(pCO2 = case_when(pH == 8 ~ "500 μatm",  pH == 7.5 ~ "800 μatm")) %>% 
  dplyr::mutate(Fed_Unfed = case_when(Fed_Unfed == "fed" ~ "High food",  Fed_Unfed == "unfed" ~ "Low food")) %>% 
  dplyr::mutate(random_fact = as.factor(paste(pCO2,Replicate,Fed_Unfed, sep = "_")))

data_92_AVG.length <- data_92_length %>%  summarySE(measurevar="Length_um", groupvars= c("pCO2", "Fed_Unfed"))  # view summary means 

# run model
AOV930.length = aov(Length_um ~ 
                           pCO2 * Fed_Unfed, 
                         data=data_92_length)
leveneTest(AOV930.length) # 0.4668
shapiro.test(resid(AOV930.length)) #6.063e-15
# so lets do thenonparametric equivalent Kruskal Wallis
SRH_1026_length <- scheirerRayHare(Length_um ~ 
                       pCO2 * Fed_Unfed,
                     data = data_92_length) # run mod
# all is good, lets see the results
pander(print(SRH_1026_length), style='rmarkdown') # table for Schierer-Ray_Hare Test
# |       &nbsp;       | Df  | Sum Sq  |    H    | p.value |
# |:------------------:|:---:|:-------:|:-------:|:-------:|
# |      **pCO2**      |  1  |  786.8  | 0.02952 | 0.8636  |
# |   **Fed_Unfed**    |  1  | 9696560 |  363.9  |    0    |
# | **pCO2:Fed_Unfed** |  1  |  28054  |  1.053  | 0.3049  |
# |   **Residuals**    | 561 | 5301068 |   NA    |   NA    |
# all is good, lets see the results
kable(unclass(print(SRH_1026_length))) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Survival_size/20211026_figs_table/20211026_length_SRH_Table.png", zoom = 1.5)


# percent difference
# data_92_survival %>% dplyr::group_by(pCO2) %>% dplyr::summarise(mean = mean(Survival))
# data_92_survival %>% dplyr::group_by(trt) %>% dplyr::summarise(mean = mean(Survival))
data_92_length %>%  dplyr::mutate(Length_mm = Length_um/1000) %>% summarySE(measurevar="Length_mm", groupvars= c("Fed_Unfed"))  # view summary means 
((8.840188-3.167427) / 8.840188) * 100 # 64.17014 % greater shell length under high food availability




# Survival:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
data_92_survival <- survival_juvenile %>%
  dplyr::filter(Age_DPF=="92") %>% 
  dplyr::mutate(Fed_Unfed = as.factor(Food)) %>% 
  dplyr::mutate(pCO2 = as.factor(gsub("^(?:[^_]+_){1}([^_]+).*", "\\1", trt))) %>% 
  dplyr::rename(Length_um = Length) %>% 
  dplyr::mutate(random_fact = as.factor(paste(pCO2,Rep,Food, sep = "_")))
levels(data_92_survival$Fed_Unfed) <- c("High food", "Low food")
levels(data_92_survival$pCO2) <- c("800 μatm", "500 μatm")

data_92_AVG.survival <- data_92_survival %>%  summarySE(measurevar="Survival", groupvars= c("pCO2", "Fed_Unfed")) # summary of means

# run the model
AOV1026.survival = aov(Survival ~ 
                         pCO2 * Fed_Unfed, 
                       data=data_92_survival) # no replicates within the tanks a,b,c,d - linear model used here
shapiro.test(residuals(AOV1026.survival)) #  normal 0.1005
leveneTest(AOV1026.survival) # 0.3336
# all is good, lets see the results
pander(aov(AOV1026.survival), style='rmarkdown') # table for KW test
# |       &nbsp;       | Df |  Sum Sq  | Mean Sq  | F value |  Pr(>F)   |
# |:------------------:|:--:|:--------:|:--------:|:-------:|:---------:|
# |      **pCO2**      | 1  | 0.000225 | 0.000225 | 0.03404 |  0.8567   |
# |   **Fed_Unfed**    | 1  |  1.525   |  1.525   |  230.8  | 3.362e-09 |
# | **pCO2:Fed_Unfed** | 1  | 0.001156 | 0.001156 | 0.1749  |  0.6832   |
# |   **Residuals**    | 12 | 0.07931  | 0.006609 |   NA    |    NA     |
kable(unclass(print(SRH930.survival))) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Survival_size/20210930_figs_table/20210930_survival_SRH_Table.png", zoom = 1.5)


# percent difference
# data_92_survival %>% dplyr::group_by(pCO2) %>% dplyr::summarise(mean = mean(Survival))
# data_92_survival %>% dplyr::group_by(trt) %>% dplyr::summarise(mean = mean(Survival))
data_92_survival %>% dplyr::mutate(PercSurv = Survival*100) %>%  summarySE(measurevar="PercSurv", groupvars= c("Fed_Unfed"))  # view summary means 
((0.93825-0.32075) / 0.93825) * 100 # 65.81402 % greater survival under high food




# plots

Length_92dpf <- ggplot(data_92_length, aes(x =pCO2, (Length_um/1000),  fill = pCO2)) +
                    theme(panel.grid=element_blank()) +
                    geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
                    scale_fill_manual(values=c("grey50","white")) +
                    geom_point(shape = 21, size = 1, position = position_jitterdodge(jitter.width = 0.4)) +
                    theme_classic() +
                    ylim(0, 22) +
                    scale_x_discrete(labels=c('~500 μatm', '~800 μatm')) +
                    theme(axis.text=element_text(size=12),
                          axis.title=element_text(size=14,face="bold")) +
                    stat_summary(fun.y=mean, geom="point", shape=18, size=4) +
                    labs(title = "F1 Scallops: Shell length 92 DPF", 
                         y = expression(Shell~length~"("~mm~")"), 
                         x = expression(italic(p)*CO[2]~Treatment~"("~μ*atm~")")) + 
                    facet_wrap(~factor(Fed_Unfed, level = c('Low food', 'High food'))) 

Survival_92DPF <- ggplot(data_92_survival, aes(x =pCO2, (Survival*100) , fill = pCO2)) +
                    theme(panel.grid=element_blank()) +
                    geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
                    scale_fill_manual(values=c("white","grey50")) +
                    geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
                    theme_classic() +
                    ylim(0, 100) +
                    scale_x_discrete(labels=c('~500 μatm', '~800 μatm')) +
                    theme(axis.text=element_text(size=12),
                          axis.title=element_text(size=14,face="bold")) +
                    stat_summary(fun.y=mean, geom="point", shape=18, size=4) +
                    labs(title = "F1 Scallops: Perent survival 92 DPF", 
                         y = expression(Survival~"(%)"), 
                         x = expression(italic(p)*CO[2]~Treatment~"("~μ*atm~")")) + 
                    facet_wrap(~factor(Fed_Unfed, level = c('Low food', 'High food'))) 


# Export the figures to pdf
ggarrange(Length_92dpf,Survival_92DPF,nrow = 2) %>%
  ggexport(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Survival_size/20211026_figs_table/20211026_length_survival.pdf")

```

### density plot - Day 92

```{r, Day 92 density length plot }
library(dplyr)
library(tidyr)

data_92_length$pHxfood <- as.factor(paste(data_92_length$pH, data_92_length$Fed_Unfed, sep = "_"))
df_mean <- data_92_length %>% 
  dplyr::group_by(pHxfood) %>% 
  dplyr::summarize(average = mean(Length_um)) %>%
  dplyr::ungroup()
p.box <- ggplot(data_92_length, aes(x = pHxfood, y = (Length_um/1000))) + geom_boxplot() + geom_point(data= df_mean, mapping = aes(x = pHxfood, y = (average/1000)),
             color="red") 
p.box.data <- layer_data(p.box) %>%
  select(x, ymin, lower, middle, upper, ymax, outliers, flipped_aes) %>%
  dplyr::rename(mean = flipped_aes) %>% 
  dplyr::mutate(mean  = (df_mean$average/1000)) %>% 
  mutate(pHxfood = factor(x, labels = levels(data_92_length$pHxfood), ordered = TRUE)) %>%
  select(-x)

denisty_box_length_92DPF <-ggplot(p.box.data) +
                            # manually plot flipped boxplot
                            geom_segment(aes(x = ymin, xend = ymax, y = -0.2, yend = -0.2)) +
                            geom_rect(aes(xmin = lower, xmax = upper, ymin = -0.25, ymax = -0.15,  fill = pHxfood),color = "black") +
                            geom_point(data = . %>% unnest(outliers), aes(x = outliers, y = -0.2), color = "grey60", size = 1) +
                            # vertical lines at Q1 / Q2 / Q3
                            geom_vline(data = . %>% select(pHxfood, lower, mean, upper) %>% gather(key, value, -pHxfood), aes(xintercept = value)) +
                            # density plot
                            geom_density(data = data_92_length, aes(x = (Length_um/1000), fill=pHxfood, ..scaled..), alpha=.4) +
                            #  theme
                            theme_classic() +
                            xlim(0, 20) +
                            facet_grid(pHxfood ~ .) +
                            theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "none", plot.title = element_text(size=10))+
                            labs(x = "Shell length", y = "frequency")  +
                            scale_fill_manual(values=c("grey40", "grey40", "grey85", "grey85"))
denisty_box_length_92DPF
# export the plot
pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Survival_size/20211026_figs_table/20211026_length_density_plot.pdf"), width = 4, height = 8)
denisty_box_length_92DPF # print the model diagnostics 
dev.off()
```
