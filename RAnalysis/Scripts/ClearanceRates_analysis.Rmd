---
title: "ClearanceRate_Analysis foodxOA_experiment"
author: "Samuel Gurr"
date: "2/1/2023"
output: pdf_document
---

```{r setup, include=FALSE}
# Purpose: Bay Scallop Project - Feeding Rates
# analysis of respiration rate data

# Written by: Sam J Gurr (last edit 11/17/2022)

# Review Riisgard 2001 defining the clearance rate of bivalves 
# NOTE: clearance rate is defined as the volume of water cleared of suspended particles per unit time, and only equals filtration rate when 
# 100% of suspended particles are efficiently retained

# LOAD PACKAGES :::::::::::::::::::::::::::::::::::::::::::::::::::::::

library(dplyr)
library(ggplot2)
library(forcats)
library(lme4)
library(lmerTest)
library(see)
library(performance)
library(car)
library(reshape2)
library(lubridate)
library(SciViews)
library(reshape2)
library(SciViews)
library(kableExtra)
library(latex2exp)
library(pander)
library(performance)
library(ggpubr)
library(Rmisc)
library(nlme)
library(AICcmodavg)



# SET WORKING DIRECTORY :::::::::::::::::::::::::::::::::::::::::::::::

# setwd("C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis") # Work computer
setwd("C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis") # personal computer

# LOAD DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Master_data       <- read.csv(file="Data/Clearance_rates/ClearanceRates_MasterData.csv", header=T) # master data file
ClearancRates_calc  <- read.csv(file="Output/ClearanceRates/ClearanceRate_Calc.csv", header=T) # master data file

```











## 20210914 Clearance Rate data 

```{r 20210914 CR DATA SUMMARY, echo = T}


# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# One-way models (Kruskal Wallis for nonparametric if needed) ::::::::::::::::::::::::::::::::::::
# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::




# Data - simple size corrected
Ply_FR_914_df      <- ClearancRates_calc %>% 
  filter(Date %in% '20210914') %>%   
  filter(Ply_mL.hr.mmlength > 0) %>% mutate(type = 'ply') %>% 
  dplyr::rename(CR_mL.hr.mmlength = Ply_mL.hr.mmlength) %>% 
  dplyr::select(!c('Chaet_mL.hr.mmlength','Seston_mL.hr.mmlength')) %>% 
  dplyr::mutate(pH = as.factor(pH))

Chaet_FR_914_df    <-  ClearancRates_calc %>% 
  filter(Date %in% '20210914') %>%   
  filter(Chaet_mL.hr.mmlength > 0) %>% mutate(type = 'chaet') %>% 
  dplyr::rename(CR_mL.hr.mmlength = Chaet_mL.hr.mmlength) %>% 
  dplyr::select(!c('Ply_mL.hr.mmlength','Seston_mL.hr.mmlength')) %>% 
  dplyr::mutate(pH = as.factor(pH))

Seston_FR_914_df   <-  ClearancRates_calc %>% 
  filter(Date %in% '20210914') %>%   
  filter(Seston_mL.hr.mmlength > 0) %>% mutate(type = 'seston') %>% 
  dplyr::rename(CR_mL.hr.mmlength = Seston_mL.hr.mmlength) %>% 
  dplyr::select(!c('Chaet_mL.hr.mmlength','Ply_mL.hr.mmlength')) %>% 
  dplyr::mutate(pH = as.factor(pH))


pander(Ply_FR_914_df %>% summarySE(measurevar="CR_mL.hr.mmlength", groupvars=c("pCO2", "Fed_Unfed")), style='rmarkdown')
# |   pCO2   | Fed_Unfed | N  | CR_mL.hr.mmlength |  sd   |   se   |  ci   |
# |:--------:|:---------:|:--:|:-----------------:|:-----:|:------:|:-----:|
# | 500 μatm |    fed    | 6  |       4.384       | 2.509 | 1.024  | 2.634 |
# | 800 μatm |    fed    | 10 |       4.85        | 2.31  | 0.7304 | 1.652 |
pander(Chaet_FR_914_df %>% summarySE(measurevar="CR_mL.hr.mmlength", groupvars=c("pCO2", "Fed_Unfed")), style='rmarkdown')
# |   pCO2   | Fed_Unfed | N  | CR_mL.hr.mmlength |  sd   |   se   |  ci   |
# |:--------:|:---------:|:--:|:-----------------:|:-----:|:------:|:-----:|
# | 500 μatm |    fed    | 11 |       2.799       | 1.552 | 0.4681 | 1.043 |
# | 800 μatm |    fed    | 12 |       4.715       | 2.761 | 0.7969 | 1.754 |
pander(Seston_FR_914_df %>% summarySE(measurevar="CR_mL.hr.mmlength", groupvars=c("pCO2", "Fed_Unfed")), style='rmarkdown')
# |   pCO2   | Fed_Unfed | N  | CR_mL.hr.mmlength |  sd   |   se   |   ci   |
# |:--------:|:---------:|:--:|:-----------------:|:-----:|:------:|:------:|
# | 500 μatm |    fed    | 11 |       2.54        | 1.289 | 0.3886 | 0.8659 |
# | 800 μatm |    fed    | 12 |       3.59        | 2.23  | 0.6437 | 1.417  |


# Data - b factor normalized
Ply_FR_914_df.bfactor      <- ClearancRates_calc %>% 
  filter(Date %in% '20210914') %>%   
  filter(Ply_mL.hr.mmlength > 0) %>% mutate(type = 'ply') %>% 
  dplyr::rename(CR_mL.hr.bfactor = Ply_mL.hr.bfactor) %>% 
  dplyr::select(!c('Chaet_mL.hr.bfactor','Seston_mL.hr.bfactor')) %>% 
  dplyr::mutate(pH = as.factor(pH))

Chaet_FR_914_df.bfactor    <-  ClearancRates_calc %>% 
  filter(Date %in% '20210914') %>%   
  filter(Chaet_mL.hr.mmlength > 0) %>% mutate(type = 'chaet') %>% 
  dplyr::rename(CR_mL.hr.bfactor = Chaet_mL.hr.bfactor) %>% 
  dplyr::select(!c('Ply_mL.hr.bfactor','Seston_mL.hr.bfactor')) %>% 
  dplyr::mutate(pH = as.factor(pH))

Seston_FR_914_df.bfactor   <-  ClearancRates_calc %>% 
  filter(Date %in% '20210914') %>%   
  filter(Seston_mL.hr.mmlength > 0) %>% mutate(type = 'seston') %>% 
  dplyr::rename(CR_mL.hr.bfactor = Seston_mL.hr.bfactor) %>% 
  dplyr::select(!c('Chaet_mL.hr.bfactor','Ply_mL.hr.bfactor')) %>% 
  dplyr::mutate(pH = as.factor(pH))


pander(Ply_FR_914_df.bfactor %>% 
         summarySE(measurevar="CR_mL.hr.bfactor", groupvars=c("pCO2", "Fed_Unfed")), style='rmarkdown')
# |   pCO2   | Fed_Unfed | N  | CR_mL.hr.bfactor |  sd   |  se   |  ci   |
# |:--------:|:---------:|:--:|:----------------:|:-----:|:-----:|:-----:|
# | 500 μatm |    fed    | 6  |      10.92       | 6.501 | 2.654 | 6.822 |
# | 800 μatm |    fed    | 10 |      12.29       | 6.136 | 1.94  | 4.389 |
pander(Chaet_FR_914_df.bfactor %>% 
         summarySE(measurevar="CR_mL.hr.bfactor", groupvars=c("pCO2", "Fed_Unfed")), style='rmarkdown')
# |   pCO2   | Fed_Unfed | N  | CR_mL.hr.bfactor |  sd   |   se   |  ci   |
# |:--------:|:---------:|:--:|:----------------:|:-----:|:------:|:-----:|
# | 500 μatm |    fed    | 11 |      6.545       | 2.92  | 0.8804 | 1.962 |
# | 800 μatm |    fed    | 12 |      11.52       | 6.464 | 1.866  | 4.107 |
pander(Seston_FR_914_df.bfactor %>% 
         summarySE(measurevar="CR_mL.hr.bfactor", groupvars=c("pCO2", "Fed_Unfed")), style='rmarkdown')
# |   pCO2   | Fed_Unfed | N  | CR_mL.hr.bfactor |  sd   |   se   |  ci   |
# |:--------:|:---------:|:--:|:----------------:|:-----:|:------:|:-----:|
# | 500 μatm |    fed    | 11 |      6.056       | 2.884 | 0.8694 | 1.937 |
# | 800 μatm |    fed    | 12 |       8.82       | 5.238 | 1.512  | 3.328 |
```

```{r 20210914 CR ANALYSIS, echo = T}

# ply :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::


# Ply - one-way anova
Ply_AOVmod_0914 <-aov(CR_mL.hr.bfactor ~ pCO2,
                      data=Ply_FR_914_df.bfactor) #nlme
shapiro.test(resid(Ply_AOVmod_0914)) # 0.1574
leveneTest(Ply_AOVmod_0914) # 0.8947
pander(anova(Ply_AOVmod_0914), style='rmarkdown') # anova table of lme
# |    &nbsp;     | Df | Sum Sq | Mean Sq | F value | Pr(>F) |
# |:-------------:|:--:|:------:|:-------:|:-------:|:------:|
# |   **pCO2**    | 1  | 6.958  |  6.958  | 0.1771  | 0.6803 |
# | **Residuals** | 14 | 550.1  |  39.29  |   NA    |   NA   |
kable(as.data.frame(anova(Ply_AOVmod_0914))) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/ClearanceRates/20210914_figs_tables/20210914_Ply_CR_OneWayANOVA_Table.png", zoom = 1.5)






# chaet  ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::



# Chaet - one-way anova
Chaet_AOVmod_0914 <-aov(CR_mL.hr.bfactor ~ pCO2,
                      data=Chaet_FR_914_df.bfactor) #nlme
shapiro.test(resid(Chaet_AOVmod_0914)) # 0.19
leveneTest(Chaet_AOVmod_0914) # 0.03809 *
# run the non[parametric Kruskal Wallis 
Chaet_KWmod_0914 <- kruskal.test(CR_mL.hr.bfactor ~pCO2, data = Chaet_FR_914_df.bfactor) # run mod
pander(print(Chaet_KWmod_0914), style='rmarkdown') # table for SRH test
# | Test statistic | df | P value |
# |:--------------:|:--:|:-------:|
# |     3.186      | 1  | 0.07429 | # marginal effect
# pCO2 diff - report this percent difference alonside the MARGINAL effect
Chaet_FR_914_df.bfactor %>% summarySE(measurevar="CR_mL.hr.bfactor", groupvars="pCO2")
perc_diff <- (11.519315 - 6.545472)/11.519315*100
perc_diff #43.17829 %


# seston  ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::


# Seston - one-way anova
Seston_AOVmod_0914 <-aov(CR_mL.hr.bfactor ~ pCO2,
                      data=Seston_FR_914_df.bfactor) #nlme
shapiro.test(resid(Seston_AOVmod_0914)) # 0.7196
leveneTest(Seston_AOVmod_0914) # 0.09577 .
pander(aov(Seston_AOVmod_0914), style='rmarkdown') # table for SRH test
# |    &nbsp;     | Df | Sum Sq | Mean Sq | F value | Pr(>F) |
# |:-------------:|:--:|:------:|:-------:|:-------:|:------:|
# |   **pCO2**    | 1  | 43.85  |  43.85  |  2.392  | 0.1369 |
# | **Residuals** | 21 |  385   |  18.33  |   NA    |   NA   |
kable(as.data.frame(anova(Seston_AOVmod_0914))) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/ClearanceRates/20210914_figs_tables/20210914_Seston_CR_OneWayANOVA_Table.png", zoom = 1.5)








# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#  Plots                      ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::



# simple size corrected data 
Master_914_plotting         <- rbind(Chaet_FR_914_df, Ply_FR_914_df, Seston_FR_914_df)
Master_914_plotting$pHxfood <- paste(Master_914_plotting$pH, Master_914_plotting$Fed_Unfed, sep = '_')

CR_914_boxplot <- Master_914_plotting %>% 
  ggplot(aes(pCO2 , CR_mL.hr.mmlength , fill = pCO2)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
  scale_fill_manual(values=c("white","grey50")) +
  geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=10)) +
  stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white") +
  ggtitle("Clearance rate (size corrected), F1 Scallops 20210914") +
  facet_wrap(~type)
CR_914_boxplot

# b factor normalized data 
Master_914_plotting.bfactor         <- rbind(Chaet_FR_914_df.bfactor, Ply_FR_914_df.bfactor, Seston_FR_914_df.bfactor)
Master_914_plotting.bfactor$pHxfood <- paste(Master_914_plotting.bfactor$pH, Master_914_plotting.bfactor$Fed_Unfed, sep = '_')

CR_914_boxplot.bfactor <- Master_914_plotting.bfactor %>% 
  ggplot(aes(pCO2 , CR_mL.hr.bfactor , fill = pCO2)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
  scale_fill_manual(values=c("white","grey50")) +
  geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=10)) +
  stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white") +
  ggtitle("Clearance rate (bfactor normalized), F1 Scallops 20210914") +
  facet_wrap(~type)
CR_914_boxplot.bfactor


# Save plots :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/ClearanceRates/20210914_figs_tables/2010914_CR_Boxplots.pdf"))
ggarrange( )
dev.off()


pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/ClearanceRates/20210914_figs_tables/2010914_CR_Boxplots_bfactor.pdf"))
ggarrange(CR_914_boxplot.bfactor)
dev.off()

```




## 20210930 Clearance Rate data 


```{r 20210930 CR DATA SUMMARY, echo = T}

# Data - simple size corrected

Ply_FR_930_df      <- ClearancRates_calc %>% 
  filter(Date %in% '20210930') %>%  
  filter(Ply_mL.hr.mmlength > 0) %>% 
  mutate(type = 'ply') %>% 
  dplyr::rename(CR_mL.hr.mmlength = Ply_mL.hr.mmlength) %>% 
  dplyr::select(!c('Chaet_mL.hr.mmlength','Seston_mL.hr.mmlength'))%>% 
  dplyr::mutate(pH = as.factor(pH))

Chaet_FR_930_df    <- ClearancRates_calc %>% 
  filter(Date %in% '20210930') %>%   
  filter(Chaet_mL.hr.mmlength > 0) %>% 
  mutate(type = 'chaet') %>% 
  dplyr::rename(CR_mL.hr.mmlength = Chaet_mL.hr.mmlength) %>% 
  dplyr::select(!c('Ply_mL.hr.mmlength','Seston_mL.hr.mmlength'))%>% 
  dplyr::mutate(pH = as.factor(pH))

Seston_FR_930_df   <- ClearancRates_calc %>% 
  filter(Date %in% '20210930') %>%  
  filter(Seston_mL.hr.mmlength > 0) %>% 
  mutate(type = 'seston') %>% 
  dplyr::rename(CR_mL.hr.mmlength = Seston_mL.hr.mmlength) %>% 
  dplyr::select(!c('Chaet_mL.hr.mmlength','Ply_mL.hr.mmlength'))%>% 
  dplyr::mutate(pH = as.factor(pH))



pander(Ply_FR_930_df %>% 
         summarySE(measurevar="CR_mL.hr.mmlength", groupvars=c("pCO2", "Fed_Unfed")), style='rmarkdown')
# |   pCO2   | Fed_Unfed | N  | CR_mL.hr.mmlength |  sd   |  se   |  ci   |
# |:--------:|:---------:|:--:|:-----------------:|:-----:|:-----:|:-----:|
# | 500 μatm |    fed    | 4  |       6.507       | 7.332 | 3.666 | 11.67 |
# | 500 μatm |   unfed   | 1  |       4.219       |  NA   |  NA   |  NA   |
# | 800 μatm |    fed    | 11 |       6.803       | 5.429 | 1.637 | 3.647 |
# | 800 μatm |   unfed   | 4  |       2.187       | 2.42  | 1.21  | 3.851 |
pander(Chaet_FR_930_df %>% 
         summarySE(measurevar="CR_mL.hr.mmlength", groupvars=c("pCO2", "Fed_Unfed")), style='rmarkdown')
# |   pCO2   | Fed_Unfed | N  | CR_mL.hr.mmlength |  sd   |   se   |   ci   |
# |:--------:|:---------:|:--:|:-----------------:|:-----:|:------:|:------:|
# | 500 μatm |    fed    | 20 |       6.276       | 6.496 | 1.453  |  3.04  |
# | 500 μatm |   unfed   | 18 |       2.63        | 1.823 | 0.4296 | 0.9064 |
# | 800 μatm |    fed    | 19 |       6.377       | 8.419 | 1.932  | 4.058  |
# | 800 μatm |   unfed   | 11 |       2.349       | 2.319 | 0.6991 | 1.558  |
pander(Seston_FR_930_df %>% 
         summarySE(measurevar="CR_mL.hr.mmlength", groupvars=c("pCO2", "Fed_Unfed")), style='rmarkdown')
# |   pCO2   | Fed_Unfed | N  | CR_mL.hr.mmlength |  sd   |   se   |  ci   |
# |:--------:|:---------:|:--:|:-----------------:|:-----:|:------:|:-----:|
# | 500 μatm |    fed    | 11 |       5.22        | 3.935 | 1.187  | 2.644 |
# | 500 μatm |   unfed   | 15 |       2.773       | 2.687 | 0.6937 | 1.488 |
# | 800 μatm |    fed    | 13 |       3.83        | 4.54  | 1.259  | 2.743 |
# | 800 μatm |   unfed   | 11 |       4.18        | 5.228 | 1.576  | 3.512 |

# Data - b factor normalized
Ply_FR_930_df.bfactor      <- ClearancRates_calc %>% 
  filter(Date %in% '20210930') %>%  
  filter(Ply_mL.hr.mmlength > 0) %>% mutate(type = 'ply') %>% 
  dplyr::rename(CR_mL.hr.bfactor = Ply_mL.hr.bfactor) %>% 
  dplyr::select(!c('Chaet_mL.hr.bfactor','Seston_mL.hr.bfactor')) %>% 
  dplyr::mutate(pH = as.factor(pH))

Chaet_FR_930_df.bfactor    <-  ClearancRates_calc %>% 
  filter(Date %in% '20210930') %>%  
  filter(Chaet_mL.hr.mmlength > 0) %>% mutate(type = 'chaet') %>% 
  dplyr::rename(CR_mL.hr.bfactor = Chaet_mL.hr.bfactor) %>% 
  dplyr::select(!c('Ply_mL.hr.bfactor','Seston_mL.hr.bfactor')) %>% 
  dplyr::mutate(pH = as.factor(pH))

Seston_FR_930_df.bfactor   <-  ClearancRates_calc %>% 
  filter(Date %in% '20210930') %>%  
  filter(Seston_mL.hr.mmlength > 0) %>% mutate(type = 'seston') %>% 
  dplyr::rename(CR_mL.hr.bfactor = Seston_mL.hr.bfactor) %>% 
  dplyr::select(!c('Chaet_mL.hr.bfactor','Ply_mL.hr.bfactor')) %>% 
  dplyr::mutate(pH = as.factor(pH))

pander(Ply_FR_930_df.bfactor %>% 
         summarySE(measurevar="CR_mL.hr.bfactor", groupvars=c("pCO2", "Fed_Unfed")), style='rmarkdown')
# |   pCO2   | Fed_Unfed | N  | CR_mL.hr.bfactor |  sd   |  se   |  ci   |
# |:--------:|:---------:|:--:|:----------------:|:-----:|:-----:|:-----:|
# | 500 μatm |    fed    | 4  |      9.261       | 10.21 | 5.104 | 16.24 |
# | 500 μatm |   unfed   | 1  |      9.245       |  NA   |  NA   |  NA   |
# | 800 μatm |    fed    | 11 |      11.09       | 7.857 | 2.369 | 5.279 |
# | 800 μatm |   unfed   | 4  |      4.873       | 5.519 | 2.759 | 8.782 |
pander(Chaet_FR_930_df.bfactor %>% 
         summarySE(measurevar="CR_mL.hr.bfactor", groupvars=c("pCO2", "Fed_Unfed")), style='rmarkdown')
# |   pCO2   | Fed_Unfed | N  | CR_mL.hr.bfactor |  sd   |   se   |  ci   |
# |:--------:|:---------:|:--:|:----------------:|:-----:|:------:|:-----:|
# | 500 μatm |    fed    | 20 |      10.07       | 8.875 | 1.984  | 4.153 |
# | 500 μatm |   unfed   | 18 |      5.662       | 3.322 | 0.7829 | 1.652 |
# | 800 μatm |    fed    | 19 |       10.4       | 11.79 | 2.705  | 5.684 |
# | 800 μatm |   unfed   | 11 |      5.986       | 7.862 |  2.37  | 5.282 |
pander(Chaet_FR_930_df.bfactor %>% 
         summarySE(measurevar="CR_mL.hr.bfactor", groupvars=("Fed_Unfed")), style='rmarkdown')
# | Fed_Unfed | N  | CR_mL.hr.bfactor |  sd   |   se   |  ci   |
# |:---------:|:--:|:----------------:|:-----:|:------:|:-----:|
# |    fed    | 39 |      10.23       | 10.26 | 1.643  | 3.326 |
# |   unfed   | 29 |      5.785       | 5.366 | 0.9965 | 2.041 |
  
pander(Seston_FR_930_df.bfactor %>% 
         summarySE(measurevar="CR_mL.hr.bfactor", groupvars=c("pCO2", "Fed_Unfed")), style='rmarkdown')
# |   pCO2   | Fed_Unfed | N  | CR_mL.hr.bfactor |  sd   |  se   |  ci   |
# |:--------:|:---------:|:--:|:----------------:|:-----:|:-----:|:-----:|
# | 500 μatm |    fed    | 11 |      8.402       | 5.484 | 1.654 | 3.684 |
# | 500 μatm |   unfed   | 15 |      6.462       | 6.707 | 1.732 | 3.714 |
# | 800 μatm |    fed    | 13 |      6.228       | 6.476 | 1.796 | 3.913 |
# | 800 μatm |   unfed   | 11 |      11.42       | 17.34 | 5.229 | 11.65 |
```

```{r 20210930 CR analysis, echo = T}


# :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Two-way models (Kruskal Wallis for nonparametric if needed) :::::
# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::



# ply :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::


library(rcompanion)
# Ply - one-way anova
Ply_AOVmod_0930 <-aov(CR_mL.hr.bfactor ~ pCO2 * Fed_Unfed,
                      data=Ply_FR_930_df.bfactor) 
shapiro.test(resid(Ply_AOVmod_0930)) # 0.009967
leveneTest(Ply_AOVmod_0930) # 0.8947
pander(anova(Ply_AOVmod_0930), style='rmarkdown') # anova table of lme
# need to run the non parametric Scheirer-Ray-Hare Test
Ply_SRHmod_0930 <- scheirerRayHare(CR_mL.hr.bfactor ~ pCO2 * Fed_Unfed,
                      data=Ply_FR_930_df.bfactor)
pander(print(Ply_SRHmod_0930), style='rmarkdown') # table for SRH test
# |       &nbsp;       | Df | Sum Sq |   H    | p.value |
# |:------------------:|:--:|:------:|:------:|:-------:|
# |      **pCO2**      | 1  | 4.876  | 0.1393 |  0.709  |
# |   **Fed_Unfed**    | 1  | 36.88  | 1.054  | 0.3047  |
# | **pCO2:Fed_Unfed** | 1  | 35.36  |  1.01  | 0.3149  |
# |   **Residuals**    | 16 | 589.5  |   NA   |   NA    |
kable(as.data.frame(print(Ply_SRHmod_0930))) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/ClearanceRates/20210930_figs_tables/20210930_Ply_CR_SRH_Table.png", zoom = 1.5)



# chaet  ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::



# Chaet - one-way anova
Chaet_AOVmod_0930 <-aov(CR_mL.hr.bfactor ~ pCO2 * Fed_Unfed,
                      data=Chaet_FR_930_df.bfactor) 
shapiro.test(resid(Chaet_AOVmod_0930)) # 7.288e-10
leveneTest(Chaet_AOVmod_0930) # 0.3424 *
# need to run the non parametric Scheirer-Ray-Hare Test
Chaet_SRHmod_0930 <- scheirerRayHare(CR_mL.hr.bfactor ~ pCO2 * Fed_Unfed,
                      data=Chaet_FR_930_df.bfactor)
pander(print(Chaet_SRHmod_0930), style='rmarkdown') # table for SRH test
# |       &nbsp;       | Df | Sum Sq |    H    | p.value |
# |:------------------:|:--:|:------:|:-------:|:-------:|
# |      **pCO2**      | 1  | 523.4  |  1.338  | 0.2473  |
# |   **Fed_Unfed**    | 1  |  1513  |  3.871  | 0.04913 |
# | **pCO2:Fed_Unfed** | 1  | 32.51  | 0.08314 | 0.7731  |
# |   **Residuals**    | 64 | 24297  |   NA    |   NA    |
kable(as.data.frame(print(Chaet_SRHmod_0930))) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/ClearanceRates/20210930_figs_tables/20210930_Chaet_CR_SRH_Table.png", zoom = 1.5)

kable(as.data.frame(print(Chaet_FR_930_df.bfactor %>% 
        summarySE(measurevar="CR_mL.hr.bfactor", groupvars="Fed_Unfed")))) %>% 
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/ClearanceRates/20210930_figs_tables/20210930_Chaet_CR_SRH_Summary.png", zoom = 1.5)




# seston  :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::



# Seston - one-way anova
Seston_AOVmod_0930 <-aov(CR_mL.hr.bfactor ~ pCO2 * Fed_Unfed,
                      data=Seston_FR_930_df.bfactor) #nlme
shapiro.test(resid(Seston_AOVmod_0930))# 1.131e-08
leveneTest(Seston_AOVmod_0930) # 0.5302 .
pander(aov(Seston_AOVmod_0930), style='rmarkdown') # table for SRH test
# need to run the non parametric Scheirer-Ray-Hare Test
Seston_SRHmod_0930 <- scheirerRayHare(CR_mL.hr.bfactor ~ pCO2 * Fed_Unfed,
                      data=Seston_FR_930_df.bfactor)
pander(print(Seston_SRHmod_0930), style='rmarkdown') # table for SRH test
# |       &nbsp;       | Df | Sum Sq |   H    | p.value |
# |:------------------:|:--:|:------:|:------:|:-------:|
# |      **pCO2**      | 1  | 55.58  | 0.2615 | 0.6091  |
# |   **Fed_Unfed**    | 1  |  115   | 0.541  |  0.462  |
# | **pCO2:Fed_Unfed** | 1  | 464.8  | 2.187  | 0.1391  |
# |   **Residuals**    | 46 |  9794  |   NA   |   NA    |
kable(as.data.frame(print(Seston_SRHmod_0930))) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/ClearanceRates/20210930_figs_tables/20210930_Seston_CR_SRH_Table.png", zoom = 1.5)





# :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#  Plots  :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::




Master_930_plotting         <- rbind(Chaet_FR_930_df, Ply_FR_930_df, Seston_FR_930_df)
Master_930_plotting$pHxfood <- paste(Master_930_plotting$pH, Master_930_plotting$Fed_Unfed, sep = '_')
CR_930_boxplot <- Master_930_plotting %>% 
  ggplot(aes(pHxfood , CR_mL.hr.mmlength , fill = pHxfood)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, alpha=0.1, aes(fill=pHxfood)) +
  scale_fill_manual(values=c("grey50","grey50","white","white")) +
  geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=10)) +
  stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white") +
  ggtitle("Clearance rate, F1 Scallops 20210930") +
  facet_wrap(~type)
CR_930_boxplot


# b factor normalized data 
Master_930_plotting.bfactor         <- rbind(Chaet_FR_930_df.bfactor, 
                                             Ply_FR_930_df.bfactor, 
                                             Seston_FR_930_df.bfactor)
Master_930_plotting.bfactor$pHxfood <- paste(Master_930_plotting.bfactor$pH, Master_930_plotting.bfactor$Fed_Unfed, sep = '_')

CR_930_boxplot.bfactor <- Master_930_plotting.bfactor %>% 
  ggplot(aes(pHxfood , 
             CR_mL.hr.bfactor , 
             fill = pHxfood)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, 
               alpha=0.1, 
               aes(fill=pHxfood)) +
  scale_fill_manual(values=c("grey50","grey50","white","white")) +
  geom_point(shape = 21, 
             size = 2, 
             position = position_jitterdodge(jitter.width = 0.1)) +
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=10)) +
  stat_summary(fun.y=mean, 
               geom="point", 
               shape=18, 
               size=4, 
               color="black", 
               fill="white") +
  ggtitle("Clearance rate (bfactor normalized), F1 Scallops 20210930") +
  facet_wrap(~type)
CR_930_boxplot.bfactor


# Save plots :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/ClearanceRates/20210930_figs_tables/2010930_CR_Boxplots.pdf"))
ggarrange(CR_930_boxplot)
dev.off()


pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/ClearanceRates/20210930_figs_tables/2010930_CR_Boxplots_bfactor.pdf"))
ggarrange(CR_930_boxplot.bfactor)
dev.off()

```




## 20211026 Clearance Rate data 


```{r 20211026 CR DATA SUMMARY, echo = T}

# Data - simple size corrected

Ply_FR_1026_df      <- ClearancRates_calc %>% 
  filter(Date %in% '20211026') %>%  
  filter(Ply_mL.hr.mmlength > 0) %>% 
  mutate(type = 'ply') %>% 
  dplyr::rename(CR_mL.hr.mmlength = Ply_mL.hr.mmlength) %>% 
  dplyr::select(!c('Chaet_mL.hr.mmlength','Seston_mL.hr.mmlength'))%>% 
  dplyr::mutate(pH = as.factor(pH))

Chaet_FR_1026_df    <- ClearancRates_calc %>% 
  filter(Date %in% '20211026') %>%   
  filter(Chaet_mL.hr.mmlength > 0) %>% 
  mutate(type = 'chaet') %>% 
  dplyr::rename(CR_mL.hr.mmlength = Chaet_mL.hr.mmlength) %>% 
  dplyr::select(!c('Ply_mL.hr.mmlength','Seston_mL.hr.mmlength'))%>% 
  dplyr::mutate(pH = as.factor(pH))

Seston_FR_1026_df   <- ClearancRates_calc %>% 
  filter(Date %in% '20211026') %>%  
  filter(Seston_mL.hr.mmlength > 0) %>% 
  mutate(type = 'seston') %>% 
  dplyr::rename(CR_mL.hr.mmlength = Seston_mL.hr.mmlength) %>% 
  dplyr::select(!c('Chaet_mL.hr.mmlength','Ply_mL.hr.mmlength'))%>% 
  dplyr::mutate(pH = as.factor(pH))



pander(Ply_FR_1026_df %>% 
         summarySE(measurevar="CR_mL.hr.mmlength", groupvars=c("pCO2", "Fed_Unfed")), style='rmarkdown')
# |   pCO2   | Fed_Unfed | N  | CR_mL.hr.mmlength |  sd   |   se   |  ci   |
# |:--------:|:---------:|:--:|:-----------------:|:-----:|:------:|:-----:|
# | 500 μatm |    fed    | 8  |       41.3        | 19.73 | 6.975  | 16.49 |
# | 500 μatm |   unfed   | 6  |       4.917       | 3.732 | 1.524  | 3.917 |
# | 800 μatm |    fed    | 10 |       41.87       | 37.23 | 11.77  | 26.64 |
# | 800 μatm |   unfed   | 7  |       2.603       | 2.28  | 0.8619 | 2.109 |
pander(Chaet_FR_1026_df %>% 
         summarySE(measurevar="CR_mL.hr.mmlength", groupvars=c("pCO2", "Fed_Unfed")), style='rmarkdown')
# |   pCO2   | Fed_Unfed | N  | CR_mL.hr.mmlength |   sd   |   se   |   ci   |
# |:--------:|:---------:|:--:|:-----------------:|:------:|:------:|:------:|
# | 500 μatm |    fed    | 8  |       13.03       | 3.827  | 1.353  |  3.2   |
# | 500 μatm |   unfed   | 3  |       1.971       | 0.7464 | 0.4309 | 1.854  |
# | 800 μatm |    fed    | 10 |       18.4        | 13.64  | 4.312  | 9.755  |
# | 800 μatm |   unfed   | 7  |       2.068       |  1.05  | 0.397  | 0.9713 |
pander(Chaet_FR_1026_df %>% 
         summarySE(measurevar="CR_mL.hr.mmlength", groupvars=("Fed_Unfed")), style='rmarkdown')
# | Fed_Unfed | N  | CR_mL.hr.mmlength |   sd   |   se   |   ci   |
# |:---------:|:--:|:-----------------:|:------:|:------:|:------:|
# |    fed    | 18 |       16.01       | 10.58  | 2.495  | 5.264  |
# |   unfed   | 10 |       2.039       | 0.9281 | 0.2935 | 0.6639 |
  
pander(Seston_FR_1026_df %>% 
         summarySE(measurevar="CR_mL.hr.mmlength", groupvars=c("pCO2", "Fed_Unfed")), style='rmarkdown')
# |   pCO2   | Fed_Unfed | N | CR_mL.hr.mmlength |  sd   |   se   |  ci   |
# |:--------:|:---------:|:-:|:-----------------:|:-----:|:------:|:-----:|
# | 500 μatm |    fed    | 8 |       7.572       | 3.019 | 1.067  | 2.524 |
# | 500 μatm |   unfed   | 6 |       2.738       | 1.533 | 0.6257 | 1.608 |
# | 800 μatm |    fed    | 9 |       11.79       | 5.907 | 1.969  | 4.541 |
# | 800 μatm |   unfed   | 6 |       1.875       | 1.633 | 0.6667 | 1.714 |





# Data - b factor normalized
Ply_FR_1026_df.bfactor      <- ClearancRates_calc %>% 
  filter(Date %in% '20211026') %>%  
  filter(Ply_mL.hr.mmlength > 0) %>% mutate(type = 'ply') %>% 
  dplyr::rename(CR_mL.hr.bfactor = Ply_mL.hr.bfactor) %>% 
  dplyr::select(!c('Chaet_mL.hr.bfactor','Seston_mL.hr.bfactor')) %>% 
  dplyr::mutate(pH = as.factor(pH))

Chaet_FR_1026_df.bfactor    <-  ClearancRates_calc %>% 
  filter(Date %in% '20211026') %>%  
  filter(Chaet_mL.hr.mmlength > 0) %>% mutate(type = 'chaet') %>% 
  dplyr::rename(CR_mL.hr.bfactor = Chaet_mL.hr.bfactor) %>% 
  dplyr::select(!c('Ply_mL.hr.bfactor','Seston_mL.hr.bfactor')) %>% 
  dplyr::mutate(pH = as.factor(pH))

Seston_FR_1026_df.bfactor   <-  ClearancRates_calc %>% 
  filter(Date %in% '20211026') %>%  
  filter(Seston_mL.hr.mmlength > 0) %>% mutate(type = 'seston') %>% 
  dplyr::rename(CR_mL.hr.bfactor = Seston_mL.hr.bfactor) %>% 
  dplyr::select(!c('Chaet_mL.hr.bfactor','Ply_mL.hr.bfactor')) %>% 
  dplyr::mutate(pH = as.factor(pH))


pander(Ply_FR_1026_df.bfactor %>% 
         summarySE(measurevar="CR_mL.hr.bfactor", groupvars=c("pCO2", "Fed_Unfed")), style='rmarkdown')
# |   pCO2   | Fed_Unfed | N  | CR_mL.hr.bfactor |  sd   |  se   |  ci   |
# |:--------:|:---------:|:--:|:----------------:|:-----:|:-----:|:-----:|
# | 500 μatm |    fed    | 8  |      201.5       | 102.2 | 36.15 | 85.47 |
# | 500 μatm |   unfed   | 6  |      81.12       | 68.24 | 27.86 | 71.62 |
# | 800 μatm |    fed    | 10 |      238.3       | 213.8 | 67.61 | 152.9 |
# | 800 μatm |   unfed   | 7  |      33.12       | 29.3  | 11.07 | 27.09 |
pander(Chaet_FR_1026_df.bfactor %>% 
         summarySE(measurevar="CR_mL.hr.bfactor", groupvars=c("pCO2", "Fed_Unfed")), style='rmarkdown')
# |   pCO2   | Fed_Unfed | N  | CR_mL.hr.bfactor |  sd   |  se   |  ci   |
# |:--------:|:---------:|:--:|:----------------:|:-----:|:-----:|:-----:|
# | 500 μatm |    fed    | 8  |      64.74       | 24.11 | 8.525 | 20.16 |
# | 500 μatm |   unfed   | 3  |      33.45       | 16.23 | 9.371 | 40.32 |
# | 800 μatm |    fed    | 10 |      102.3       | 63.87 | 20.2  | 45.69 |
# | 800 μatm |   unfed   | 7  |      25.87       | 15.19 | 5.742 | 14.05 |
pander(Chaet_FR_1026_df.bfactor %>% 
         summarySE(measurevar="CR_mL.hr.bfactor", groupvars=("Fed_Unfed")), style='rmarkdown')
# | Fed_Unfed | N  | CR_mL.hr.bfactor |  sd   |  se   |  ci   |
# |:---------:|:--:|:----------------:|:-----:|:-----:|:-----:|
# |    fed    | 18 |      85.59       | 52.6  | 12.4  | 26.16 |
# |   unfed   | 10 |      28.14       | 15.03 | 4.752 | 10.75 |
  
pander(Seston_FR_1026_df.bfactor %>% 
         summarySE(measurevar="CR_mL.hr.bfactor", groupvars=c("pCO2", "Fed_Unfed")), style='rmarkdown')
# |   pCO2   | Fed_Unfed | N | CR_mL.hr.bfactor |  sd   |  se   |  ci   |
# |:--------:|:---------:|:-:|:----------------:|:-----:|:-----:|:-----:|
# | 500 μatm |    fed    | 8 |      38.09       | 18.68 | 6.604 | 15.62 |
# | 500 μatm |   unfed   | 6 |      38.61       | 19.13 | 7.81  | 20.08 |
# | 800 μatm |    fed    | 9 |      69.81       | 39.06 | 13.02 | 30.02 |
# | 800 μatm |   unfed   | 6 |       22.5       | 19.96 | 8.147 | 20.94 |
```

```{r 20211026 CR analysis, echo = T}

# :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Two-way models (Kruskal Wallis for nonparametric if needed) :::::
# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

# ply :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::


library(rcompanion)
# Ply - one-way anova
Ply_AOVmod_1026 <-aov(CR_mL.hr.bfactor ~ pCO2 * Fed_Unfed,
                      data=Ply_FR_1026_df.bfactor) 
shapiro.test(resid(Ply_AOVmod_1026)) # 0.3444
leveneTest(Ply_AOVmod_1026) # 0.0008148 ***
# need to run the non parametric Scheirer-Ray-Hare Test
Ply_SRHmod_1026 <- scheirerRayHare(CR_mL.hr.bfactor ~ pCO2 * Fed_Unfed,
                      data=Ply_FR_1026_df.bfactor)
pander(print(Ply_SRHmod_1026), style='rmarkdown') # table for SRH test
# |       &nbsp;       | Df | Sum Sq |   H    | p.value  |
# |:------------------:|:--:|:------:|:------:|:--------:|
# |      **pCO2**      | 1  | 70.73  | 0.8556 |  0.355   |
# |   **Fed_Unfed**    | 1  | 772.9  | 9.349  | 0.002231 |
# | **pCO2:Fed_Unfed** | 1  | 36.55  | 0.4422 |  0.5061  |
# |   **Residuals**    | 27 |  1608  |   NA   |    NA    |
kable(as.data.frame(print(Ply_SRHmod_1026))) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/ClearanceRates/20211026_figs_tables/20211026_Ply_CR_SRH_Table.png", zoom = 1.5)

kable(as.data.frame(print(Ply_FR_1026_df.bfactor %>% 
        summarySE(measurevar="CR_mL.hr.bfactor", groupvars="Fed_Unfed")))) %>% 
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/ClearanceRates/20211026_figs_tables/20211026_Ply_CR_SRH_Summary.png", zoom = 1.5)



# chaet  ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::



# Chaet - two-way anova
Chaet_AOVmod_1026 <-aov(CR_mL.hr.bfactor ~ pCO2 * Fed_Unfed,
                      data=Chaet_FR_1026_df.bfactor) 
shapiro.test(resid(Chaet_AOVmod_1026)) # 0.059
leveneTest(Chaet_AOVmod_1026) # 0.02634 *
# need to run the non parametric Scheirer-Ray-Hare Test
Chaet_SRHmod_1026 <- scheirerRayHare(CR_mL.hr.bfactor ~ pCO2 * Fed_Unfed,
                      data=Chaet_FR_1026_df.bfactor)
pander(print(Chaet_SRHmod_1026), style='rmarkdown') # table for SRH test
# |       &nbsp;       | Df | Sum Sq |   H    | p.value  |
# |:------------------:|:--:|:------:|:------:|:--------:|
# |      **pCO2**      | 1  | 17.64  | 0.2607 |  0.6096  |
# |   **Fed_Unfed**    | 1  | 654.5  | 9.672  | 0.001871 |
# | **pCO2:Fed_Unfed** | 1  | 35.82  | 0.5294 |  0.4669  |
# |   **Residuals**    | 24 |  1136  |   NA   |   v NA    |
kable(as.data.frame(print(Chaet_SRHmod_1026))) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/ClearanceRates/20211026_figs_tables/20211026_Chaet_CR_SRH_Table.png", zoom = 1.5)

kable(as.data.frame(print(Chaet_FR_1026_df.bfactor %>% 
        summarySE(measurevar="CR_mL.hr.bfactor", groupvars="Fed_Unfed")))) %>% 
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/ClearanceRates/20211026_figs_tables/20211026_Chaet_CR_SRH_Summary.png", zoom = 1.5)




# seston  :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::



# Seston - one-way anova
Seston_AOVmod_1026 <-lm(CR_mL.hr.bfactor ~ pCO2 * Fed_Unfed,
                      data=Seston_FR_1026_df.bfactor) #nlme
shapiro.test(resid(Seston_AOVmod_1026))# 0.1163
leveneTest(Seston_AOVmod_1026) # 0.553
pander(aov(Seston_AOVmod_1026), style='rmarkdown') # table for SRH test
# |       &nbsp;       | Df | Sum Sq | Mean Sq | F value | Pr(>F)  |
# |:------------------:|:--:|:------:|:-------:|:-------:|:-------:|
# |      **pCO2**      | 1  |  1145  |  1145   |  1.55   | 0.2247  |
# |   **Fed_Unfed**    | 1  |  4041  |  4041   |  5.47   | 0.02763 |
# | **pCO2:Fed_Unfed** | 1  |  4017  |  4017   |  5.438  | 0.02806 |
# |   **Residuals**    | 25 | 18470  |  738.8  |   NA    |   NA    |
kable(as.data.frame(anova(Seston_AOVmod_1026))) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/ClearanceRates/20211026_figs_tables/20211026_Seston_CR_AOV_Table.png", zoom = 1.5)

TukeyHSD(aov(Seston_AOVmod_1026))
# $`pCO2:Fed_Unfed`
#                                      diff        lwr       upr     p adj
# 800 μatm:fed-500 μatm:fed      31.7200471  -4.608842 68.048937 0.1027106
# 500 μatm:unfed-500 μatm:fed     0.5181631 -39.859140 40.895466 0.9999837
# 800 μatm:unfed-500 μatm:fed   -15.5902988 -55.967602 24.787004 0.7151471
# 500 μatm:unfed-800 μatm:fed   -31.2018840 -70.606097  8.202329 0.1569984
# 800 μatm:unfed-800 μatm:fed   -47.3103459 -86.714559 -7.906133 0.0143452
# 800 μatm:unfed-500 μatm:unfed -16.1084619 -59.273615 27.056691 0.7357263

library(emmeans) # posthoc letters!
emmeans(Seston_AOVmod_1026, pairwise ~ pCO2:Fed_Unfed)
# contrast                          estimate   SE df t.ratio p.value
#  500 μatm fed - 800 μatm fed      -31.720 13.2 25  -2.402  0.1027
#  500 μatm fed - 500 μatm unfed     -0.518 14.7 25  -0.035  1.0000
#  500 μatm fed - 800 μatm unfed     15.590 14.7 25   1.062  0.7151
#  800 μatm fed - 500 μatm unfed     31.202 14.3 25   2.178  0.1570
#  800 μatm fed - 800 μatm unfed     47.310 14.3 25   3.303  0.0143 **
#  500 μatm unfed - 800 μatm unfed   16.108 15.7 25   1.026  0.7357

kable(as.data.frame(print(Seston_FR_1026_df.bfactor %>% 
        summarySE(measurevar="CR_mL.hr.bfactor", groupvars=c("pCO2","Fed_Unfed") )))) %>% 
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/ClearanceRates/20211026_figs_tables/20211026_Seston_CR_AOV_Summary.png", zoom = 1.5)
  
# :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#  Plots  :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::




Master_1026_plotting         <- rbind(Chaet_FR_1026_df, 
                                      Ply_FR_1026_df, 
                                      Seston_FR_1026_df)
Master_1026_plotting$pHxfood <- paste(Master_1026_plotting$pCO2, Master_1026_plotting$Fed_Unfed, sep = '_')
CR_1026_boxplot <- Master_1026_plotting %>% 
  ggplot(aes(pHxfood , CR_mL.hr.mmlength , fill = pHxfood)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, alpha=0.1, aes(fill=pHxfood)) +
  scale_fill_manual(values=c("grey50","grey50","white","white")) +
  geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=10)) +
  stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white") +
  ggtitle("Clearance rate, F1 Scallops 20211026") +
  facet_wrap(~type)
CR_1026_boxplot


# b factor normalized data 
Master_1026_plotting.bfactor         <- rbind(Chaet_FR_1026_df.bfactor, 
                                             Ply_FR_1026_df.bfactor, 
                                             Seston_FR_1026_df.bfactor)
Master_1026_plotting.bfactor$pHxfood <- paste(Master_1026_plotting.bfactor$pCO2, Master_1026_plotting.bfactor$Fed_Unfed, sep = '_')

CR_1026_boxplot.bfactor <- Master_1026_plotting.bfactor %>% 
  ggplot(aes(pHxfood , 
             CR_mL.hr.bfactor , 
             fill = pHxfood)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, 
               alpha=0.1, 
               aes(fill=pHxfood)) +
  scale_fill_manual(values=c("grey50","grey50","white","white")) +
  geom_point(shape = 21, 
             size = 2, 
             position = position_jitterdodge(jitter.width = 0.1)) +
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=10)) +
  stat_summary(fun.y=mean, 
               geom="point", 
               shape=18, 
               size=4, 
               color="black", 
               fill="white") +
  ggtitle("Clearance rate (bfactor normalized), F1 Scallops 20211026") +
  facet_wrap(~type)
CR_1026_boxplot.bfactor


# Save plots :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/ClearanceRates/20211026_figs_tables/20211026_CR_Boxplots.pdf"))
ggarrange(CR_1026_boxplot)
dev.off()


pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/ClearanceRates/20211026_figs_tables/20211026_CR_Boxplots_bfactor.pdf"))
ggarrange(CR_1026_boxplot.bfactor)
dev.off()

```

```{r 20211026 CR analysis, echo = T}






# Data
Ply_FR_1026_df      <- ClearancRates_calc %>% 
  filter(Date %in% '20211026') %>% 
  filter(Ply_mL.hr.mmlength > 0) %>% 
  mutate(type = 'ply') %>% 
  dplyr::rename(CR_mL.hr.mmlength = Ply_mL.hr.mmlength) %>% 
  dplyr::select(!c('Chaet_mL.hr.mmlength','Seston_mL.hr.mmlength'))%>% 
  dplyr::mutate(pH = as.factor(pH))

Chaet_FR_1026_df    <- ClearancRates_calc %>% 
  filter(Date %in% '20211026') %>% 
  filter(Chaet_mL.hr.mmlength > 0) %>% 
  mutate(type = 'chaet') %>% 
  dplyr::rename(CR_mL.hr.mmlength = Chaet_mL.hr.mmlength) %>% 
  dplyr::select(!c('Ply_mL.hr.mmlength','Seston_mL.hr.mmlength'))%>% 
  dplyr::mutate(pH = as.factor(pH))

Seston_FR_1026_df   <- ClearancRates_calc %>% 
  filter(Date %in% '20211026') %>% 
  filter(Seston_mL.hr.mmlength > 0) %>% 
  mutate(type = 'seston') %>% 
  dplyr::rename(CR_mL.hr.mmlength = Seston_mL.hr.mmlength) %>% 
  dplyr::select(!c('Chaet_mL.hr.mmlength','Ply_mL.hr.mmlength'))%>% 
  dplyr::mutate(pH = as.factor(pH))









# ply ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::




# SUMMARY: one way anova lower AIC than including the random tank effect in KME model,
# model assumptions (normal residuals and heteroskedascity) all normal, no transformation to resolve
# no effect of pH treatment 

# Ply - Linear Mixed Effects Model
Ply_LMEmod_1026 <-lme(CR_mL.hr.mmlength ~ pH * Fed_Unfed, random=~1|random_fact, data=Ply_FR_1026_df) #nlme
shapiro.test(resid(Ply_LMEmod_1026)) # 0.06153
leveneTest(residuals(Ply_LMEmod_1026) ~ Ply_FR_1026_df$pH) # 0.05927 
pander(anova(Ply_LMEmod_1026), style='rmarkdown') # anova table of lmer
# |      &nbsp;      | numDF | denDF | F-value  |  p-value  |
# |:----------------:|:-----:|:-----:|:--------:|:---------:|
# | **(Intercept)**  |   1   |  15   |  36.13   | 2.384e-05 |
# |      **pH**      |   1   |  12   | 4.12e-07 |  0.9995   |
# |  **Fed_Unfed**   |   1   |  12   |  19.18   | 0.0008971 |
# | **pH:Fed_Unfed** |   1   |  12   | 0.02747  |  0.8711   |
Ply_LMERmod_1026 <- lmer(CR_mL.hr.mmlength ~ pH * Fed_Unfed + (1|random_fact), data=Ply_FR_1026_df, REML = FALSE) # lme4 (can run leenes test with this package output)
leveneTest(residuals(Ply_LMERmod_1026) ~ Ply_FR_1026_df$pH) # 0.05927 
shapiro.test(resid(Ply_LMERmod_1026)) # 0.06153
summary(Ply_LMERmod_1026) # view for the portion of random effecting the variance - zero
pander(anova(Ply_LMERmod_1026), style='rmarkdown') # anova table of lmer
# |      &nbsp;      | Sum Sq | Mean Sq | NumDF | DenDF | F value |  Pr(>F)   |
# |:----------------:|:------:|:-------:|:-----:|:-----:|:-------:|:---------:|
# |      **pH**      | 5.684  |  5.684  |   1   |  31   | 0.01151 |  0.9152   |
# |  **Fed_Unfed**   | 10705  |  10705  |   1   |  31   |  21.69  | 5.729e-05 | *
# | **pH:Fed_Unfed** | 15.57  |  15.57  |   1   |  31   | 0.03155 |  0.8602   |

# Ply - two-way anova
Ply_ANOVAmod_1026 <-aov(CR_mL.hr.mmlength ~ pH * Fed_Unfed, data=Ply_FR_1026_df)
leveneTest(Ply_ANOVAmod_1026) # 3.311e-06 ***
shapiro.test(resid(Ply_ANOVAmod_1026)) # 0.06153
hist(resid(Ply_ANOVAmod_1026)) #  looks normal but the variance  tho...
Ply_ANOVAmod_1026_TRANSFORMED <-aov(log(CR_mL.hr.mmlength) ~ pH * Fed_Unfed, data=Ply_FR_1026_df)
leveneTest(Ply_ANOVAmod_1026_TRANSFORMED) # 0.254 - resolved!
shapiro.test(resid(Ply_ANOVAmod_1026_TRANSFORMED)) # 0.00239 - but not we arent normal...
summary(Ply_ANOVAmod_1026_TRANSFORMED)
#              Df Sum Sq Mean Sq F value Pr(>F)
# pH            1  0.000   0.000   0.000  0.994
# Fed_Unfed     1  3.427   3.427   2.848  0.111
# pH:Fed_Unfed  1  0.775   0.775   0.644  0.434


# AIC - determine the use of the random factor in the linear mixed effects model
AIC(Ply_ANOVAmod_1026, Ply_LMERmod_1026) # the LME model is 1 point lower  in explaining the variance 


kable(as.data.frame(anova(Ply_LMERmod_1026))) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/ClearanceRates/20211026_figs_tables/20211026_PLY_CR_LME_Table.png", zoom = 1.5)
pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/ClearanceRates/20211026_figs_tables/20211026_PLY_CR_LME_Diagnostics.pdf"))
check_model(Ply_LMERmod_1026) # print the model diagnostics 
dev.off()







# chaet  ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::




# SUMMARY: one way anova lower AIC than including the random tank effect in KME model,
# model assumptions (normal residuals and heteroskedascity) all normal, no transformation to resolve
# no effect of pH treatment (marginal effect < 0.1)

# chaet - Linear Mixed Effects Model
Chaet_LMEmod_1026 <-lme(CR_mL.hr.mmlength ~ pH * Fed_Unfed, random=~1|random_fact, data=Chaet_FR_1026_df) #nlme
shapiro.test(resid(Chaet_LMEmod_1026)) #9.188e-05
leveneTest(residuals(Chaet_LMEmod_1026) ~ Chaet_FR_1026_df$pH) # 0.1017
pander(anova(Chaet_LMEmod_1026), style='rmarkdown') # anova table of lmer
# |      &nbsp;      | numDF | denDF | F-value |  p-value  |
# |:----------------:|:-----:|:-----:|:-------:|:---------:|
# | **(Intercept)**  |   1   |  14   |  45.77  | 9.091e-06 |
# |      **pH**      |   1   |  10   | 0.2495  |  0.6282   |
# |  **Fed_Unfed**   |   1   |  10   |  17.84  | 0.001763  |
# | **pH:Fed_Unfed** |   1   |  10   | 0.5351  |  0.4813   | 
Chaet_LMEmod_1026_T <-lme(asin(sqrt(CR_mL.hr.mmlength/100)) ~ pH * Fed_Unfed, random=~1|random_fact, data=Chaet_FR_1026_df) #nlme
shapiro.test(resid(Chaet_LMEmod_1026_T)) #9.188e-05
leveneTest(residuals(Chaet_LMEmod_1026_T) ~ Chaet_FR_1026_df$pH) # 0.1017
pander(anova(Chaet_LMEmod_1026_T), style='rmarkdown') # anova table of lmer

# perhaps an outlier> there is a value over twice greater than the second highest 
max(Chaet_FR_1026_df$CR_mL.hr.mmlength) # 47.66838 
Chaet_FR_1026_df_OM <- Chaet_FR_1026_df %>% dplyr::filter(CR_mL.hr.mmlength < (47.66838 - 0.001)) 
Chaet_LMEmod_1026_OM <-lme(asin(sqrt(CR_mL.hr.mmlength/100)) ~ pH * Fed_Unfed, random=~1|random_fact, data=Chaet_FR_1026_df_OM) #nlme
shapiro.test(resid(Chaet_LMEmod_1026_OM)) #9.188e-05
leveneTest(residuals(Chaet_LMEmod_1026_OM) ~ Chaet_FR_1026_df_OM$pH) # 0.1017
pander(anova(Chaet_LMEmod_1026_OM), style='rmarkdown') # anova table of lmer

Chaet_LMERmod_1026_OM <- lmer((CR_mL.hr.mmlength) ~ pH * Fed_Unfed + (1|random_fact), data=Chaet_FR_1026_df_OM, REML = FALSE) # lme4 (can run leenes test with this package output), TRUE when NOT addressing AIC for model selection
leveneTest(residuals(Chaet_LMERmod_1026_OM) ~ Chaet_FR_1026_df_OM$pH) # 0.1279
shapiro.test(resid(Chaet_LMERmod_1026_OM)) # 0.002004 - NON NORMAL
qqnorm(resid(Chaet_LMERmod_1026_OM))
summary(Chaet_LMERmod_1026_TRANSFORMED) # random factor accounts fo 0 percent of the variance
pander(anova(Chaet_LMERmod_1026), style='rmarkdown') # anova table of lmer
# |      &nbsp;      | Sum Sq | Mean Sq | NumDF | DenDF | F value  |  Pr(>F)  |
# |:----------------:|:------:|:-------:|:-----:|:-----:|:--------:|:--------:|
# |      **pH**      | 0.1305 | 0.1305  |   1   |  68   | 0.004056 |  0.9494  |
# |  **Fed_Unfed**   | 236.4  |  236.4  |   1   |  68   |  7.348   | 0.008493 |
# | **pH:Fed_Unfed** | 0.5861 | 0.5861  |   1   |  68   | 0.01821  |  0.893   |

# Chaet - two-way anova
Chaet_ANOVAmod_1026 <-aov(CR_mL.hr.mmlength ~ pH * Fed_Unfed, data=Chaet_FR_1026_df)
leveneTest(Chaet_ANOVAmod_1026) # 0.06993 
shapiro.test(resid(Chaet_ANOVAmod_1026)) # 3.877e-10
hist(resid(Chaet_ANOVAmod_1026)) # positive skew
Chaet_ANOVAmod_1026_TRANSFORMED <-aov(sqrt(CR_mL.hr.mmlength) ~ pH * Fed_Unfed, data=Chaet_FR_1026_df)
leveneTest(Chaet_ANOVAmod_1026_TRANSFORMED) # 0.3323  
shapiro.test(resid(Chaet_ANOVAmod_1026_TRANSFORMED)) # 0.0003287
summary(Chaet_ANOVAmod_1026_TRANSFORMED)
#              Df Sum Sq Mean Sq F value  Pr(>F)   
# pH            1   0.49   0.489   0.509 0.47830   
# Fed_Unfed     1   6.89   6.890   7.169 0.00941 **
# pH:Fed_Unfed  1   0.00   0.001   0.001 0.97241   
# Residuals    64  61.51   0.961 

# AIC - determine the use of the random factor in the linear mixed effects model
AIC(Chaet_ANOVAmod_1026, Chaet_LMERmod_1026) # the one way anova is the better fit model - NOTE: meet with team regarding this, may want to report the LME since values are so close

kable(as.data.frame(anova(Chaet_ANOVAmod_1026))) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/ClearanceRates/20211026_figs_tables/20211026_CHAET_CR_OneWayANOVA_Table.png", zoom = 1.5)
pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/ClearanceRates/20211026_figs_tables/20211026_CHAET_CR_OneWayANOVA_Diagnostics.pdf"))
check_model(Chaet_ANOVAmod_1026) # print the model diagnostics 
dev.off()


# seston  ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::




# SUMMARY: one way anova lower AIC than including the random tank effect in KME model,
# model assumptions (normal residuals and heteroskedascity) all normal, no transformation to resolve
# no effect of pH treatment (marginal effect < 0.1)




# Seston - Linear Mixed Effects Model
Seston_LMEmod_1026 <-lme(CR_mL.hr.mmlength ~ pH * Fed_Unfed, random=~1|random_fact, data=Seston_FR_1026_df) #nlme
leveneTest(residuals(Seston_LMEmod_1026) ~ Seston_FR_1026_df$pH) # 0.6573
shapiro.test(resid(Seston_LMEmod_1026)) #  0.1157
pander(anova(Seston_LMEmod_1026), style='rmarkdown') # anova table of lmer
# |      &nbsp;      | numDF | denDF | F-value |  p-value  |
# |:----------------:|:-----:|:-----:|:-------:|:---------:|
# | **(Intercept)**  |   1   |  14   |  61.2   | 1.775e-06 |
# |      **pH**      |   1   |  11   |  1.138  |  0.3089   |
# |  **Fed_Unfed**   |   1   |  11   |  19.33  | 0.001068  |
# | **pH:Fed_Unfed** |   1   |  11   |  2.006  |  0.1843   |
Seston_LMERmod_1026 <- lmer(CR_mL.hr.mmlength ~ pH * Fed_Unfed + (1|random_fact), data=Seston_FR_1026_df, REML = FALSE) # lme4 (can run leenes test with this package output), TRUE when NOT addressing AIC for model selection
leveneTest(residuals(Seston_LMERmod_1026) ~ Seston_FR_1026_df$pH) # 0.3292
shapiro.test(resid(Seston_LMERmod_1026)) # 3.709e-07 - NON NORMAL
hist(resid(Seston_LMERmod_1026)) # strongly positive skew
Seston_LMERmod_1026_TRANSFORMED <- lmer(log(CR_mL.hr.mmlength) ~ pH * Fed_Unfed + (1|random_fact), data=Seston_FR_1026_df, REML = FALSE) # lme4 (can run leenes test with this package output), TRUE when NOT addressing AIC for model selection
leveneTest(residuals(Seston_LMERmod_1026_TRANSFORMED) ~ Seston_FR_1026_df$pH) # 0.0726 
shapiro.test(resid(Seston_LMERmod_1026_TRANSFORMED)) #0.9171
summary(Seston_LMERmod_1026_TRANSFORMED) # view for the portion of random effecting the variance
(0.002531   /(0.002531   + 1.128288   ) )* 100 # random factor accounts fo 0.2238201 percent of the variance
pander(anova(Seston_LMERmod_1026_TRANSFORMED), style='rmarkdown') # anova table of lmer
# |      &nbsp;      | Sum Sq | Mean Sq | NumDF | DenDF | F value | Pr(>F)  |
# |:----------------:|:------:|:-------:|:-----:|:-----:|:-------:|:-------:|
# |      **pH**      | 0.7943 | 0.7943  |   1   | 13.67 |  0.704  | 0.4159  |
# |  **Fed_Unfed**   | 0.8955 | 0.8955  |   1   | 13.67 | 0.7936  | 0.3884  |
# | **pH:Fed_Unfed** | 4.295  |  4.295  |   1   | 13.67 |  3.806  | 0.07186 |

# Seston - one-way anova
Seston_ANOVAmod_1026 <-aov(CR_mL.hr.mmlength ~ pH * Fed_Unfed, data=Seston_FR_1026_df)
leveneTest(Seston_ANOVAmod_1026) # 0.7281
shapiro.test(resid(Seston_ANOVAmod_1026)) # 3.709e-07 - NON NORMAL
hist(resid(Seston_ANOVAmod_1026)) # positive skew
Seston_ANOVAmod_1026_TRANSFORMED <-aov(log(CR_mL.hr.mmlength) ~ pH * Fed_Unfed, data=Seston_FR_1026_df)
leveneTest(Seston_ANOVAmod_1026_TRANSFORMED) # 0.1502
shapiro.test(resid(Seston_ANOVAmod_1026_TRANSFORMED)) # 0.9191
summary(Seston_ANOVAmod_1026_TRANSFORMED)
#              Df Sum Sq Mean Sq F value Pr(>F)  
# pH            1   0.51   0.512   0.416 0.5219  
# Fed_Unfed     1   1.03   1.033   0.840 0.3642  
# pH:Fed_Unfed  1   4.33   4.330   3.522 0.0669 .
# Residuals    46  56.54   1.229 

# AIC - determine the use of the random factor in the linear mixed effects model
AIC(Seston_ANOVAmod_1026, Seston_LMERmod_1026) # the one way anova is the better fit model

kable(as.data.frame(anova(Seston_ANOVAmod_1026))) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/ClearanceRates/20211026_figs_tables/20211026_SESTON_CR_OneWayANOVA_Table.png", zoom = 1.5)
pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/ClearanceRates/20211026_figs_tables/20211026_SESTON_CR_OneWayANOVA_Diagnostics.pdf"))
check_model(Seston_ANOVAmod_1026) # print the model diagnostics 
dev.off()







# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#  Plots                      ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::




Master_1026_plotting         <- rbind(Chaet_FR_1026_df, Ply_FR_1026_df, Seston_FR_1026_df)
Master_1026_plotting$pHxfood <- paste(Master_1026_plotting$pH, Master_1026_plotting$Fed_Unfed, sep = '_')
CR_1026_boxplot <- Master_1026_plotting %>% 
  ggplot(aes(pHxfood , CR_mL.hr.mmlength , fill = pHxfood)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, alpha=0.1, aes(fill=pHxfood)) +
  scale_fill_manual(values=c("grey50","grey50","white","white")) +
  geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=10)) +
  stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white") +
  ggtitle("Clearance rate, F1 Scallops 20211026") +
  facet_wrap(~type)
CR_1026_boxplot


# Save plots :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

pdf(paste0("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/ClearanceRates/20211026_figs_tables/2011026_CR_Boxplots.pdf"), width = 10)
ggarrange(CR_1026_boxplot)
dev.off()


```


## Plotting

```{r, Chaet ClearanceRate Figure All} 


chaet_clearance_master <- rbind(Chaet_FR_914_df,Chaet_FR_930_df, Chaet_FR_1026_df)



# Length_um
SumTable_ChaetClear <- chaet_clearance_master[!is.na(chaet_clearance_master$CR_mL.hr.mmlength),] %>%  
            summarySE(measurevar="CR_mL.hr.mmlength", groupvars=c("Date", "pCO2", "Fed_Unfed")) %>% 
            dplyr::mutate(Age = case_when(Date == '20210914' ~ 50, Date == '20210930' ~ 66, Date == '20211026' ~ 92)) 
SumTable_ChaetClear$pCO2 <- factor(SumTable_ChaetClear$pCO2, c("500 μatm","800 μatm"))
## Use geom_line and geom_point to plot over time
ChaetClear_time    <- ggplot(data=SumTable_ChaetClear, aes(x=Age, y=CR_mL.hr.mmlength, color=pCO2)) +
            geom_line(aes(linetype = factor(Fed_Unfed)), size = 0.5) +  
            geom_point()+ 
            scale_color_manual(values=c("forestgreen","darkorange2"))+
            geom_errorbar(aes(ymin=CR_mL.hr.mmlength-se, ymax=CR_mL.hr.mmlength+se), width=.2,
                          position=position_dodge(.1))+
            theme_bw() +  
            theme(panel.grid.major = element_blank(), 
                  panel.grid.minor = element_blank(), 
                  plot.title = element_text(size=10)) + 
            labs(y = expression(mL^{-1}~mm^{-1}%.%hr^{-1})) +
            scale_x_continuous(name ="Age (d)") +
            labs(title =  "Clearance of Chaetocerous over time..", 
                 y = "Shell length (mm)") +
            scale_linetype_manual(values = c("fed" = "solid", "unfed" = "dashed"))  +
            theme(legend.position="none") +
            # facet_wrap(~factor(Fed_Unfed, level = c('Low food', 'High food'))) 
            facet_wrap(~pCO2)
ChaetClear_time


ChaetClear_time    <- SumTable_ChaetClear %>% 
                  ggplot(aes(x = factor(Age), 
                             y = CR_mL.hr.mmlength, 
                             fill = pCO2)) +
                  geom_boxplot(alpha = 0.5, # color hue
                             width=0.6, # boxplot width
                             outlier.size=0) # make outliers small
                  scale_color_manual(values=c("forestgreen","darkorange2"))+
                  geom_errorbar(aes(ymin=CR_mL.hr.mmlength-se, ymax=CR_mL.hr.mmlength+se), width=.2,
                                position=position_dodge(.1))+
                  theme_bw() +  
                  theme(panel.grid.major = element_blank(), 
                        panel.grid.minor = element_blank(), 
                        plot.title = element_text(size=10)) + 
                  labs(y = expression(mL^{-1}~mm^{-1}%.%hr^{-1})) +
                  scale_x_continuous(name ="Age (d)") +
                  labs(title =  "Clearance of Chaetocerous over time..", 
                       y = "Shell length (mm)") +
                  scale_linetype_manual(values = c("fed" = "solid", "unfed" = "dashed"))  +
                  theme(legend.position="none") +
                  # facet_wrap(~factor(Fed_Unfed, level = c('Low food', 'High food'))) 
                  facet_wrap(~pCO2)
ChaetClear_time

pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/ClearanceRates/Chaet_ClearanceRate_length.pdf"), width = 8, height = 6)
ChaetClear_time
dev.off()
```


```{r, Ply ClearanceRate Figure All} 


Ply_clearance_master <- rbind(Ply_FR_914_df,Ply_FR_930_df, Ply_FR_1026_df)



# Length_um
SumTable_PlyClear <- Ply_clearance_master[!is.na(Ply_clearance_master$CR_mL.hr.mmlength),] %>%  
            summarySE(measurevar="CR_mL.hr.mmlength", groupvars=c("Date", "pCO2", "Fed_Unfed")) %>% 
            dplyr::mutate(Age = case_when(Date == '20210914' ~ 50, Date == '20210930' ~ 66, Date == '20211026' ~ 92)) 
SumTable_PlyClear$pCO2 <- factor(SumTable_PlyClear$pCO2, c("500 μatm","800 μatm"))
## Use geom_line and geom_point to plot over time
PlyClear_time    <- ggplot(data=SumTable_PlyClear, aes(x=Age, y=CR_mL.hr.mmlength, color=pCO2)) +
            geom_line(aes(linetype = factor(Fed_Unfed)), size = 0.5) +  
            geom_point()+ 
            scale_color_manual(values=c("forestgreen","darkorange2"))+
            geom_errorbar(aes(ymin=CR_mL.hr.mmlength-se, ymax=CR_mL.hr.mmlength+se), width=.2,
                          position=position_dodge(.1))+
            theme_bw() +  
            theme(panel.grid.major = element_blank(), 
                  panel.grid.minor = element_blank(), 
                  plot.title = element_text(size=10)) + 
            labs(y = expression(mL^{-1}~mm^{-1}%.%hr^{-1})) +
            scale_x_continuous(name ="Age (d)") +
            labs(title =  "Clearance of Plyocerous over time..", 
                 y = "Shell length (mm)") +
            scale_linetype_manual(values = c("fed" = "solid", "unfed" = "dashed"))  +
            theme(legend.position="none") +
            # facet_wrap(~factor(Fed_Unfed, level = c('Low food', 'High food'))) 
            facet_wrap(~pCO2)
PlyClear_time


pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/ClearanceRates/Ply_ClearanceRate_length.pdf"), width = 8, height = 6)
PlyClear_time
dev.off()
```


```{r, Seston ClearanceRate Figure All} 


Seston_clearance_master <- rbind(Seston_FR_914_df,Seston_FR_930_df, Seston_FR_1026_df)



# Length_um
SumTable_SestonClear <- Seston_clearance_master[!is.na(Seston_clearance_master$CR_mL.hr.mmlength),] %>%  
            summarySE(measurevar="CR_mL.hr.mmlength", groupvars=c("Date", "pCO2", "Fed_Unfed")) %>% 
            dplyr::mutate(Age = case_when(Date == '20210914' ~ 50, Date == '20210930' ~ 66, Date == '20211026' ~ 92)) 
SumTable_SestonClear$pCO2 <- factor(SumTable_SestonClear$pCO2, c("500 μatm","800 μatm"))
## Use geom_line and geom_point to plot over time
SestonClear_time    <- ggplot(data=SumTable_SestonClear, aes(x=Age, y=CR_mL.hr.mmlength, color=pCO2)) +
            geom_line(aes(linetype = factor(Fed_Unfed)), size = 0.5) +  
            geom_point()+ 
            scale_color_manual(values=c("forestgreen","darkorange2"))+
            geom_errorbar(aes(ymin=CR_mL.hr.mmlength-se, ymax=CR_mL.hr.mmlength+se), width=.2,
                          position=position_dodge(.1))+
            theme_bw() +  
            theme(panel.grid.major = element_blank(), 
                  panel.grid.minor = element_blank(), 
                  plot.title = element_text(size=10)) + 
            labs(y = expression(mL^{-1}~mm^{-1}%.%hr^{-1})) +
            scale_x_continuous(name ="Age (d)") +
            labs(title =  "Clearance of Sestonocerous over time..", 
                 y = "Shell length (mm)") +
            scale_linetype_manual(values = c("fed" = "solid", "unfed" = "dashed"))  +
            theme(legend.position="none") +
            # facet_wrap(~factor(Fed_Unfed, level = c('Low food', 'High food'))) 
            facet_wrap(~pCO2)
SestonClear_time


pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/ClearanceRates/Seston_ClearanceRate_length.pdf"), width = 8, height = 6)
SestonClear_time
dev.off()
```


## Density plots

```{r, 20210930 Density plots }
library(dplyr)
library(tidyr)

Master_930_plotting <- ClearancRates_calc %>% dplyr::filter(Date %in% '20210930') %>% mutate(pHxfood = paste(pH, Fed_Unfed, sep = "_"))
CHAET_plotting      <- Master_930_plotting %>% dplyr::filter(type %in% 'chaet')
PLY_plotting        <- Master_930_plotting %>% dplyr::filter(type %in% 'ply')
SESTON_plotting     <- Master_930_plotting %>% dplyr::filter(type %in% 'seston')



# :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Chaetoceros                  ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
Master_930_plotting$pHxfood <- as.factor(Master_930_plotting$pHxfood)

# simply corrected for shell length
df_mean_CHAET <- Master_930_plotting %>%
  dplyr::group_by(pHxfood) %>% 
  dplyr::summarize(average = mean(Chaet_mL.hr.mmlength)) %>%
  dplyr::ungroup()
p.box_CHAET <- ggplot(Master_930_plotting, aes(x = pHxfood, y = Chaet_mL.hr.mmlength)) + geom_boxplot() + geom_point(data= df_mean_CHAET, mapping = aes(x = pHxfood, y = average),
             color="red") 
p.box.data.CHAET <- layer_data(p.box_CHAET) %>%
  select(x, ymin, lower, middle, upper, ymax, outliers, flipped_aes) %>%
  dplyr::rename(mean = flipped_aes) %>% 
  dplyr::mutate(mean  = df_mean_CHAET$average) %>% 
  mutate(pHxfood = factor(x, labels = levels(Master_930_plotting$pHxfood), ordered = TRUE)) %>%
  select(-x)

p.box.data.CHAET %>% unnest(outliers)


density.plot_CR_CHAET_930 <-ggplot(p.box.data.CHAET) +
                                # manually plot flipped boxplot
                                geom_segment(aes(x = ymin, xend = ymax, y = -0.15, yend = -0.15)) +
                                geom_rect(aes(xmin = lower, xmax = upper, ymin = -0.3, ymax = 0,  fill = pHxfood),color = "black") +
                                geom_point(data = . %>% unnest(outliers), aes(x = outliers, y = -0.15), color = "grey60", size = 1) +
                                # vertical lines at Q1 / Q2 / Q3
                                geom_vline(data = . %>% select(pHxfood, lower, mean, upper) %>% gather(key, value, -pHxfood), aes(xintercept = value)) +
                                # density plot
                                geom_density(data = Master_930_plotting, aes(x = Chaet_mL.hr.mmlength, group=pHxfood, fill=pHxfood, ..scaled..), alpha=.4, adjust=1.5) +
                                #  theme
                                theme_classic() +
                                facet_grid(pHxfood ~ .) +
                                theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "none", plot.title = element_text(size=10))+
                                labs(title = "F1 Scallops: Clearance rates (Chaetoceros) 92 DPF", 
                                     x = expression(Clearance~rate~"("~Chaetoceros~cells~mL^{-1}%.%~mm~shell~length^{-1}%.%hr^{-1}~")"),
                                     y = "Scaled density") +
                                scale_fill_manual(values=c("grey40", "grey40", "grey85", "grey85"))
density.plot_CR_CHAET_930




# corrected for b factor 

df_mean_CHAET <- Master_930_plotting %>%
  dplyr::group_by(pHxfood) %>% 
  dplyr::summarize(average = mean(Chaet_mL.hr.bfactor)) %>%
  dplyr::ungroup()
p.box_CHAET <- ggplot(Master_930_plotting, aes(x = pHxfood, y = Chaet_mL.hr.bfactor)) + geom_boxplot() + geom_point(data= df_mean_CHAET, mapping = aes(x = pHxfood, y = average),
             color="red") 
p.box.data.CHAET <- layer_data(p.box_CHAET) %>%
  select(x, ymin, lower, middle, upper, ymax, outliers, flipped_aes) %>%
  dplyr::rename(mean = flipped_aes) %>% 
  dplyr::mutate(mean  = df_mean_CHAET$average) %>% 
  mutate(pHxfood = factor(x, labels = levels(Master_930_plotting$pHxfood), ordered = TRUE)) %>%
  select(-x)

p.box.data.CHAET %>% unnest(outliers)


density.plot_CR_CHAET_930 <-ggplot(p.box.data.CHAET) +
                                # manually plot flipped boxplot
                                geom_segment(aes(x = ymin, xend = ymax, y = -0.15, yend = -0.15)) +
                                geom_rect(aes(xmin = lower, xmax = upper, ymin = -0.3, ymax = 0,  fill = pHxfood),color = "black") +
                                geom_point(data = . %>% unnest(outliers), aes(x = outliers, y = -0.15), color = "grey60", size = 1) +
                                # vertical lines at Q1 / Q2 / Q3
                                geom_vline(data = . %>% select(pHxfood, lower, mean, upper) %>% gather(key, value, -pHxfood), aes(xintercept = value)) +
                                # density plot
                                geom_density(data = Master_930_plotting, aes(x = Chaet_mL.hr.bfactor, group=pHxfood, fill=pHxfood, ..scaled..), alpha=.4, adjust=1.5) +
                                #  theme
                                theme_classic() +
                                facet_grid(pHxfood ~ .) +
                                theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "none", plot.title = element_text(size=10))+
                                labs(title = "F1 Scallops: Clearance rates (Chaetoceros) 92 DPF", 
                                     x = expression(Clearance~rate~"("~Chaetoceros~cells~mL^{-1}%.%~mm~shell~length^{-1}%.%hr^{-1}~")"),
                                     y = "Scaled density") +
                                scale_fill_manual(values=c("grey40", "grey40", "grey85", "grey85"))
density.plot_CR_CHAET_930



pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/ClearanceRates/20210930_figs_tables/20210930_CR_CHAET_density_plot.pdf"), width = 5, height = 5)
density.plot_CR_CHAET_930 # print the model diagnostics 
dev.off()



```

```{r, 20211026 Density plots }
library(dplyr)
library(tidyr)

Master_1026_plotting$pHxfood <- as.factor(Master_1026_plotting$pHxfood)
CHAET_plotting <- Master_1026_plotting %>% dplyr::filter(type %in% 'chaet')
PLY_plotting <- Master_1026_plotting %>% dplyr::filter(type %in% 'ply')
SESTON_plotting <- Master_1026_plotting %>% dplyr::filter(type %in% 'seston')



# :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Chaetoceros                  ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

df_mean_CHAET <- CHAET_plotting %>%
  dplyr::group_by(pHxfood) %>% 
  dplyr::summarize(average = mean(CR_mL.hr.mmlength)) %>%
  dplyr::ungroup()
p.box_CHAET <- ggplot(CHAET_plotting, aes(x = pHxfood, y = CR_mL.hr.mmlength)) + geom_boxplot() + geom_point(data= df_mean_CHAET, mapping = aes(x = pHxfood, y = average),
             color="red") 
p.box.data.CHAET <- layer_data(p.box_CHAET) %>%
  select(x, ymin, lower, middle, upper, ymax, outliers, flipped_aes) %>%
  dplyr::rename(mean = flipped_aes) %>% 
  dplyr::mutate(mean  = df_mean_CHAET$average) %>% 
  mutate(pHxfood = factor(x, labels = levels(CHAET_plotting$pHxfood), ordered = TRUE)) %>%
  select(-x)

p.box.data.CHAET %>% unnest(outliers)


density.plot_CR_CHAET_1026 <-ggplot(p.box.data.CHAET) +
                                # manually plot flipped boxplot
                                geom_segment(aes(x = ymin, xend = ymax, y = -0.15, yend = -0.15)) +
                                geom_rect(aes(xmin = lower, xmax = upper, ymin = -0.3, ymax = 0,  fill = pHxfood),color = "black") +
                                geom_point(data = . %>% unnest(outliers), aes(x = outliers, y = -0.15), color = "grey60", size = 1) +
                                # vertical lines at Q1 / Q2 / Q3
                                geom_vline(data = . %>% select(pHxfood, lower, mean, upper) %>% gather(key, value, -pHxfood), aes(xintercept = value)) +
                                # density plot
                                geom_density(data = CHAET_plotting, aes(x = CR_mL.hr.mmlength, group=pHxfood, fill=pHxfood, ..scaled..), alpha=.4, adjust=1.5) +
                                #  theme
                                theme_classic() +
                                facet_grid(pHxfood ~ .) +
                                theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "none", plot.title = element_text(size=10))+
                                labs(title = "F1 Scallops: Clearance rates (Chaetoceros) 92 DPF", 
                                     x = expression(Clearance~rate~"("~Chaetoceros~cells~mL^{-1}%.%~mm~shell~length^{-1}%.%hr^{-1}~")"),
                                     y = "Scaled density") +
                                scale_fill_manual(values=c("grey40", "grey40", "grey85", "grey85"))
density.plot_CR_CHAET_1026



# b factor 
df_mean_CHAET <- CHAET_plotting %>%
  dplyr::group_by(pHxfood) %>% 
  dplyr::summarize(average = mean(Chaet_mL.hr.bfactor)) %>%
  dplyr::ungroup()
p.box_CHAET <- ggplot(CHAET_plotting, aes(x = pHxfood, y = Chaet_mL.hr.bfactor)) + geom_boxplot() + geom_point(data= df_mean_CHAET, mapping = aes(x = pHxfood, y = average),
             color="red") 
p.box.data.CHAET <- layer_data(p.box_CHAET) %>%
  select(x, ymin, lower, middle, upper, ymax, outliers, flipped_aes) %>%
  dplyr::rename(mean = flipped_aes) %>% 
  dplyr::mutate(mean  = df_mean_CHAET$average) %>% 
  mutate(pHxfood = factor(x, labels = levels(CHAET_plotting$pHxfood), ordered = TRUE)) %>%
  select(-x)

p.box.data.CHAET %>% unnest(outliers)


density.plot_CR_CHAET_1026 <-ggplot(p.box.data.CHAET) +
                                # manually plot flipped boxplot
                                geom_segment(aes(x = ymin, xend = ymax, y = -0.15, yend = -0.15)) +
                                geom_rect(aes(xmin = lower, xmax = upper, ymin = -0.3, ymax = 0,  fill = pHxfood),color = "black") +
                                geom_point(data = . %>% unnest(outliers), aes(x = outliers, y = -0.15), color = "grey60", size = 1) +
                                # vertical lines at Q1 / Q2 / Q3
                                geom_vline(data = . %>% select(pHxfood, lower, mean, upper) %>% gather(key, value, -pHxfood), aes(xintercept = value)) +
                                # density plot
                                geom_density(data = CHAET_plotting, aes(x = Chaet_mL.hr.bfactor, group=pHxfood, fill=pHxfood, ..scaled..), alpha=.4, adjust=1.5) +
                                #  theme
                                theme_classic() +
                                facet_grid(pHxfood ~ .) +
                                theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "none", plot.title = element_text(size=10))+
                                labs(title = "F1 Scallops: Clearance rates (Chaetoceros) 92 DPF", 
                                     x = expression(Clearance~rate~"("~Chaetoceros~cells~mL^{-1}%.%~mm~shell~length^{-1}%.%hr^{-1}~")"),
                                     y = "Scaled density") +
                                scale_fill_manual(values=c("grey40", "grey40", "grey85", "grey85"))
density.plot_CR_CHAET_1026


pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/ClearanceRates/20211026_figs_tables/20211026_CR_CHAET_density_plot.pdf"), width = 5, height = 5)
density.plot_CR_CHAET_1026 # print the model diagnostics 
dev.off()


# :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Tetraselmis (Ply)                  ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::


df_mean_PLY <- PLY_plotting %>%
  dplyr::group_by(pHxfood) %>% 
  dplyr::summarize(average = mean(Ply_mL.hr.bfactor)) %>%
  dplyr::ungroup()
p.box_PLY <- ggplot(PLY_plotting, aes(x = pHxfood, y = Ply_mL.hr.bfactor)) + geom_boxplot() + geom_point(data= df_mean_PLY, mapping = aes(x = pHxfood, y = average),
             color="red") 
p.box.data.PLY <- layer_data(p.box_PLY) %>%
  select(x, ymin, lower, middle, upper, ymax, outliers, flipped_aes) %>%
  dplyr::rename(mean = flipped_aes) %>% 
  dplyr::mutate(mean  = df_mean_PLY$average) %>% 
  mutate(pHxfood = factor(x, labels = levels(PLY_plotting$pHxfood), ordered = TRUE)) %>%
  select(-x)

p.box.data.PLY %>% unnest(outliers)


density.plot_CR_PLY_1026 <-ggplot(p.box.data.PLY) +
                                # manually plot flipped boxplot
                                geom_segment(aes(x = ymin, xend = ymax, y = -0.15, yend = -0.15)) +
                                geom_rect(aes(xmin = lower, xmax = upper, ymin = -0.3, ymax = 0,  fill = pHxfood),color = "black") +
                                geom_point(data = . %>% unnest(outliers), aes(x = outliers, y = -0.15), color = "grey60", size = 1) +
                                # vertical lines at Q1 / Q2 / Q3
                                geom_vline(data = . %>% select(pHxfood, lower, mean, upper) %>% gather(key, value, -pHxfood), aes(xintercept = value)) +
                                # density plot
                                geom_density(data = PLY_plotting, aes(x = Ply_mL.hr.bfactor, group=pHxfood, fill=pHxfood, ..scaled..), alpha=.4, adjust=1.5) +
                                #  theme
                                theme_classic() +
                                facet_grid(pHxfood ~ .) +
                                theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "none", plot.title = element_text(size=10))+
                                labs(title = "F1 Scallops: Clearance rates (Tetraselmis/PLY) 92 DPF", 
                                     x = expression(Clearance~rate~"("~Tetraselmis~cells~mL^{-1}%.%~mm~shell~length^{-1}%.%hr^{-1}~")"),
                                     y = "Scaled density") +
                                scale_fill_manual(values=c("grey40", "grey40", "grey85", "grey85"))
density.plot_CR_PLY_1026

pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/ClearanceRates/20211026_figs_tables/20211026_CR_PLY_density_plot.pdf"), width = 5, height = 5)
density.plot_CR_PLY_1026 # print the model diagnostics 
dev.off()

# :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Seston                             ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::


df_mean_SESTON <- SESTON_plotting %>%
  dplyr::group_by(pHxfood) %>% 
  dplyr::summarize(average = mean(Seston_mL.hr.bfactor)) %>%
  dplyr::ungroup()
p.box_SESTON <- ggplot(SESTON_plotting, aes(x = pHxfood, y = Seston_mL.hr.bfactor)) + geom_boxplot() + geom_point(data= df_mean_SESTON, mapping = aes(x = pHxfood, y = average),
             color="red") 
p.box.data.SESTON <- layer_data(p.box_SESTON) %>%
  select(x, ymin, lower, middle, upper, ymax, outliers, flipped_aes) %>%
  dplyr::rename(mean = flipped_aes) %>% 
  dplyr::mutate(mean  = df_mean_SESTON$average) %>% 
  mutate(pHxfood = factor(x, labels = levels(SESTON_plotting$pHxfood), ordered = TRUE)) %>%
  select(-x)

p.box.data.SESTON %>% unnest(outliers)


density.plot_CR_SESTON_1026 <-ggplot(p.box.data.SESTON) +
                                # manually plot flipped boxplot
                                geom_segment(aes(x = ymin, xend = ymax, y = -0.15, yend = -0.15)) +
                                geom_rect(aes(xmin = lower, xmax = upper, ymin = -0.3, ymax = 0,  fill = pHxfood),color = "black") +
                                geom_point(data = . %>% unnest(outliers), aes(x = outliers, y = -0.15), color = "grey60", size = 1) +
                                # vertical lines at Q1 / Q2 / Q3
                                geom_vline(data = . %>% select(pHxfood, lower, mean, upper) %>% gather(key, value, -pHxfood), aes(xintercept = value)) +
                                # density plot
                                geom_density(data = SESTON_plotting, aes(x = Seston_mL.hr.bfactor, group=pHxfood, fill=pHxfood, ..scaled..), alpha=.4, adjust=1.5) +
                                #  theme
                                theme_classic() +
                                facet_grid(pHxfood ~ .) +
                                theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "none", plot.title = element_text(size=10))+
                                labs(title = "F1 Scallops: Clearance rates (seston) 92 DPF", 
                                     x = expression(Clearance~rate~"("~SESTONoceros~cells~mL^{-1}%.%~mm~shell~length^{-1}%.%hr^{-1}~")"),
                                     y = "Scaled density") +
                                scale_fill_manual(values=c("grey40", "grey40", "grey85", "grey85"))
density.plot_CR_SESTON_1026

pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/ClearanceRates/20211026_figs_tables/20211026_CR_SESTON_density_plot.pdf"), width = 5, height = 5)
density.plot_CR_SESTON_1026 # print the model diagnostics 
dev.off()

```