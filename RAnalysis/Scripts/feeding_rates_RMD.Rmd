---
title: "ClearanceRate_F1Scallops"
author: "Samuel Gurr"
date: "10/12/2021"
output: pdf_document
---

```{r setup, include=FALSE}
# Purpose: Bay Scallop Project - Feeding Rates
# analysis of respiration rate data

# Written by: Sam J Gurr (last edit 10/12/2021)

# Review Riisgard 2001 defining the clearance rate of bivalves 
# NOTE: clearance rate is defined as the volume of water cleared of suspended particles per unit time, and only equals filtration rate when 
# 100% of suspended particles are efficiently retained

# LOAD PACKAGES :::::::::::::::::::::::::::::::::::::::::::::::::::::::

library(dplyr)
library(ggplot2)
library(forcats)
library(lme4)
library(lmerTest)
library(see)
library(performance)
library(car)
library(reshape2)
library(lubridate)
library(SciViews)
library(reshape2)
library(SciViews)
library(kableExtra)
library(latex2exp)
library(pander)
library(performance)
library(ggpubr)
library(Rmisc)

# SET WORKING DIRECTORY :::::::::::::::::::::::::::::::::::::::::::::::

# setwd("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA/RAnalysis") # Work computer
 setwd("C:/Users/samjg/Documents/Github_repositories/Airradians_OA/RAnalysis") # personal computer

# LOAD DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
Master_data       <- read.csv(file="Data/Feeding_rates/Feeding_MasterData.csv", header=T) # master data file

clear.rate_914    <- Master_data  %>% dplyr::filter(Date %in% 20210914)  %>% 
  dplyr::mutate(Chamber_tank = paste(pH, Replicate, sep='_'))

clear.rate_930    <- Master_data  %>% dplyr::filter(Date %in% 20210930)  %>% 
  dplyr::mutate(Chamber_tank = paste(pH, Replicate, sep='_'))

clear.rate_1026    <- Master_data  %>% dplyr::filter(Date %in% 20211026)  %>% 
  dplyr::mutate(Chamber_tank = paste(pH, Replicate, sep='_'))



length.resp.clear <- read.csv(file="Data/Respiration/Lengths_Condition_resp_clearance.csv", header=T) %>% 
  dplyr::mutate(Date = paste("20",(format(as.Date(Date, "%m/%d/%Y"), "%y%m%d")), sep ='')) %>%
  dplyr::rename(Fed_Unfed = Food) 
length.resp.clear <- length.resp.clear[!is.na(length.resp.clear$Length_um),]

```
## Merge to master file 'ClearRate_Master'

Date from: 
- 20210914
- 20210930 

```{r merge master file, echo = TRUE}

# 20210914 DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# formatting for merge
# call the 20210914 data and remove blanks
clear.rate_914_Scallops <- merge( # note - merging with th elengths removed the blanks from the clearance rate data (no lengths for them! )
  (clear.rate_914),
  (length.resp.clear %>% 
     dplyr::filter(Date %in% 20210914)) ) 

# 20210930 DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# formatting for merge
# call the 20210930 data and remove blanks
clear.rate_930_Scallops <- merge( # note - merging with th elengths removed the blanks from the clearance rate data (no lengths for them! )
  (clear.rate_930),
  (length.resp.clear %>% 
     dplyr::filter(Date %in% 20210930)) ) 

# 20210930 DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# formatting for merge
# call the 20210930 data and remove blanks
clear.rate_1026_Scallops <- merge( # note - merging with th elengths removed the blanks from the clearance rate data (no lengths for them! )
  (clear.rate_1026),
  (length.resp.clear %>% 
     dplyr::filter(Date %in% 20211026)) ) 


ClearRate_Master             <- rbind(clear.rate_914_Scallops, clear.rate_930_Scallops, clear.rate_1026_Scallops)
ClearRate_Master$tet.ply     <- (as.numeric(gsub(",", "", ClearRate_Master$tet.ply )))*(1000/33)
ClearRate_Master$chaet       <- (as.numeric(gsub(",", "", ClearRate_Master$chaet )))*(1000/33)
ClearRate_Master$total_algae <- (as.numeric(gsub(",", "", ClearRate_Master$total_algae )))*(1000/33)
ClearRate_Master$seston      <- (as.numeric(gsub(",", "", ClearRate_Master$seston )))*(1000/33)

print(head(ClearRate_Master))
```

# Visualize raw data & simple slopes/algae loss time-1
## Plot the raw Flow cytometry output

- note: some data points were omitted in the worksheet, review the 'raw' vs 'worksheet_R' data files

``` {r raw data plots, echo = TRUE}


# 20210914 DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

SlopePlots_914 <- ClearRate_Master[!is.na(ClearRate_Master$total_algae),] %>% 
  dplyr::filter(!Replicate %in% 'blank') %>%
  dplyr::filter(Date %in% "20210914") %>% 
  dplyr::mutate(Time._min = as.numeric(as.character(minutes))) %>% 
  ggplot(aes(minutes, total_algae, color=Replicate)) + 
  geom_point(shape=1, color = "black")+ 
  ggtitle("RAW DATA: F1 Scallops, Clearance Rate 20210914")+
  labs(y = expression(Live~algae~cells~"("~cells~mL^{-1}~")"), 
       x = expression(Time~"("~minutes~")")) + 
  theme(plot.title= element_text(size =16, face ="bold", 
                                 lineheight = 8, vjust=1), aspect.ratio=1)+
  stat_smooth(method="lm", se = F) + 
  theme_bw() +
  scale_shape_identity() + 
  facet_wrap( ~ pH, scales = "free_x" )

SlopePlots_914

# Clearance rate anlaysis for 9/30 data
ClearRate_Master.914 <- ClearRate_Master %>% 
  dplyr::filter(Date %in% 20210914) %>% 
  dplyr::mutate(uniq_Identifier = paste(pH, "Run", Run, "Rep",Replicate, "Num", Number, sep='_'))

loop_914 <- as.data.frame(unique(ClearRate_Master.914$uniq_Identifier)) %>% dplyr::rename(ID = "unique(ClearRate_Master.914$uniq_Identifier)")

SlopeTable_914 <- data.frame() # run this before the loop
for(i in 1:nrow(loop_914)){
  dat <- ClearRate_Master.914 %>%  filter(uniq_Identifier %in% loop_914[i,])
    slope<- summary(lm((dat$total_algae) ~ as.numeric(dat$minutes)))$coef[2,"Estimate"]
    SLOPE  <- summary(lm((dat$total_algae) ~ as.numeric(dat$minutes)))$r.squared
    pval <- summary(lm((dat$total_algae) ~ as.numeric(dat$minutes)))$coef[2,"Pr(>|t|)"]
    mod  <- lm(as.numeric(dat$minutes) ~ dat$total_algae)
    norm_assum <- shapiro.test(resid(mod))
    shapiro_pval <- norm_assum$p.value
    # assign the data table 
    SLOPE.loop <- data.frame(matrix(nrow = 1, ncol = 5)) # create a new data table
    colnames(SLOPE.loop) <- c('pH', 'Replicate', 'slope', 'SLOPE', 'pval') # assign headers
    SLOPE.loop$pH        <- gsub("_.*", "\\1", loop_914[i,])
    SLOPE.loop$Replicate <- gsub("^(?:[^_]+_){4}([^_]+).*", "\\1", loop_914[i,])
    SLOPE.loop$slope     <- slope * 60  # cells per mL per hour  
    SLOPE.loop$Number    <- gsub("^(?:[^_]+_){6}([^_]+).*", "\\1", loop_914[i,])
    SLOPE.loop$SLOPE       <- SLOPE
    SLOPE.loop$pval      <- pval
    SLOPE.loop$shapiro_pval <- shapiro_pval
    # loop additions 
    df <- data.frame(SLOPE.loop) # name dataframe for this single row
    SlopeTable_914 <- rbind(SlopeTable_914,df) # bind to a cumulative list dataframe
   # print(SlopeTable_914) # show loop progress in the console
}# outside loo

SLOPE_mod_914 <- aov(lm(slope ~ pH, data= SlopeTable_914))
DF   <- paste( (summary(SLOPE_mod_914)[[1]][["Df"]])[1], (summary(SLOPE_mod_914)[[1]][["Df"]])[2], sep = '/')
Fval <- (summary(SLOPE_mod_914)[[1]][["F value"]])[1]
pval <- (summary(SLOPE_mod_914)[[1]][["Pr(>F)"]])[1]

SlopeFig914_geombox <- ggplot(SlopeTable_914, aes(pH , abs(slope) , fill = pH)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, alpha=0.1, aes(fill=pH)) +
  scale_fill_manual(values=c("grey50","white")) +
  geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
  theme_classic() +
  scale_x_discrete(labels= c('Elevated (H)', 'Ambient (L)')) +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold")) +
  labs(title = "F1 Scallops: Slope algae cells/time - feeding rate trials 20210914", 
       y = expression(Slope~"="~absolute~value~"("~Live~algae~cells~mL^{-1}~hour^{-1}~")"), 
       x = expression(italic(p)*CO[2]~Treatment~"("~mu*atm~")")) + 
  annotate("text", x=2, y= 25000, size = 4, label = "aov(slope~pH Treatment)") +
  annotate("text", x=2, y= 24300, size = 4, label= paste('DF =',DF,'F =', signif(Fval, digits=3), 'p value =', signif(pval, digits=3), sep=" ")) 

SlopeFig914_geombox # 0.0531


# 20210930 DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
SlopePlots_930 <- ClearRate_Master[!is.na(ClearRate_Master$total_algae),] %>% 
  dplyr::filter(!Replicate %in% 'blank') %>%
  dplyr::filter(Date %in% 20210930) %>% 
  dplyr::mutate(pH_feed = paste(pH, Fed_Unfed, sep='_')) %>% 
  dplyr::mutate(minutes = as.numeric(as.character(minutes))) %>% 
  ggplot(aes(minutes, total_algae, color=Replicate)) + 
  geom_point(shape=1, fill = "white", color = "black")+ 
  ggtitle("RAW DATA: F1 Scallops, Clearance Rate 20210930")+
  labs(y = expression(Live~algae~cells~"("~cells~mL^{-1}~")"), 
       x = expression(Time~"("~minutes~")")) + 
  theme(plot.title= element_text(size =16, face ="bold", 
                                 lineheight = 8, vjust=1), aspect.ratio=1)+
  stat_smooth(method="lm", se = F) + 
  theme_bw() +
  scale_shape_identity() + 
  facet_wrap( ~ pH_feed, scales = "free_x" )

SlopePlots_930

# Clearance rate anlaysis for 9/30 data
ClearRate_Master.930       <- ClearRate_Master %>% 
  dplyr::filter(Date %in% 20210930) %>% 
  dplyr::mutate(uniq_Identifier = paste(pH, Fed_Unfed, "Run", Run, "Rep",Replicate, "Num", Number, sep='_'))

loop_930 <- as.data.frame(unique(ClearRate_Master.930$uniq_Identifier)) %>% dplyr::rename(ID = "unique(ClearRate_Master.930$uniq_Identifier)")

SlopeTable_930 <- data.frame() # run this before the loop
for(i in 1:nrow(loop_930)){
  dat <- ClearRate_Master.930 %>%  filter(uniq_Identifier %in% loop_930[i,])
  slope<- summary(lm((dat$total_algae) ~ as.numeric(dat$minutes)))$coef[2,"Estimate"]
  SLOPE  <- summary(lm((dat$total_algae) ~ as.numeric(dat$minutes)))$r.squared
  pval <- summary(lm((dat$total_algae) ~ as.numeric(dat$minutes)))$coef[2,"Pr(>|t|)"]
  mod  <- lm(as.numeric(dat$minutes) ~ dat$total_algae)
  norm_assum <- shapiro.test(resid(mod))
  shapiro_pval <- norm_assum$p.value
  # assign the data table 
  SLOPE.loop <- data.frame(matrix(nrow = 1, ncol = 6)) # create a new data table
  colnames(SLOPE.loop) <- c('pH', 'Replicate', 'Fed_Unfed','slope', 'SLOPE', 'pval') # assign headers
  SLOPE.loop$pH        <- gsub("_.*", "\\1", loop_930[i,])
  SLOPE.loop$Replicate <- gsub("^(?:[^_]+_){5}([^_]+).*", "\\1", loop_930[i,])
  SLOPE.loop$Fed_Unfed <- gsub("^(?:[^_]+_){1}([^_]+).*", "\\1", loop_930[i,])
  SLOPE.loop$slope     <- slope * 60  # cells per mL per hour  
  SLOPE.loop$Number    <- gsub("^(?:[^_]+_){7}([^_]+).*", "\\1", loop_930[i,])
  SLOPE.loop$SLOPE       <- SLOPE
  SLOPE.loop$pval      <- pval
  SLOPE.loop$shapiro_pval <- shapiro_pval
  # loop additions 
  df <- data.frame(SLOPE.loop) # name dataframe for this single row
  SlopeTable_930 <- rbind(SlopeTable_930,df) # bind to a cumulative list dataframe
  #print(SlopeTable_930) # show loop progress in the console
}# outside loo

SLOPE_mod_930 <- aov(lm(slope ~ pH*Fed_Unfed, data= SlopeTable_930))
summary(SLOPE_mod_930) # Fed_Unfed     2.39e-05 ***
DF.930   <- paste( (summary(SLOPE_mod_930)[[1]][["Df"]])[1], (summary(SLOPE_mod_930)[[1]][["Df"]])[2], sep = '/')
Fval.930 <- (summary(SLOPE_mod_930)[[1]][["F value"]])[1]
pval.930 <- (summary(SLOPE_mod_930)[[1]][["Pr(>F)"]])[1]

SlopeFig930_geombox <- SlopeTable_930 %>%  
  mutate(pH_feed = paste(pH, Fed_Unfed, sep = '_')) %>% 
  ggplot(aes(pH , abs(slope) , fill = pH)) +
    theme(panel.grid=element_blank()) +
    geom_boxplot(size=0.2, alpha=0.1, aes(fill=pH)) +
    scale_fill_manual(values=c("grey50","white")) +
    geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
    theme_classic() +
    scale_x_discrete(labels= c('Elevated (H)', 'Ambient (L)')) +
    theme(axis.text=element_text(size=12),
          axis.title=element_text(size=14,face="bold")) +
    labs(title = "F1 Scallops: Slope algae cells/time - feeding rate trials 20210930", 
         y = expression(Slope~"="~absolute~value~"("~Live~algae~cells~mL^{-1}~hour^{-1}~")"), 
         x = expression(italic(p)*CO[2]~Treatment~"("~mu*atm~")")) + 
    facet_wrap(~ Fed_Unfed)

SlopeFig930_geombox # 




# 20211026 DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
SlopePlots_1026 <- ClearRate_Master[!is.na(ClearRate_Master$total_algae),] %>% 
  dplyr::filter(!Replicate %in% 'blank') %>%
  dplyr::filter(Date %in% 20211026) %>% 
  dplyr::mutate(pH_feed = paste(pH, Fed_Unfed, sep='_')) %>% 
  dplyr::mutate(minutes = as.numeric(as.character(minutes))) %>% 
  ggplot(aes(minutes, total_algae, color=Replicate)) + 
  geom_point(shape=1, fill = "white", color = "black")+ 
  ggtitle("RAW DATA: F1 Scallops, Clearance Rate 20211026")+
  labs(y = expression(Live~algae~cells~"("~cells~mL^{-1}~")"), 
       x = expression(Time~"("~minutes~")")) + 
  theme(plot.title= element_text(size =16, face ="bold", 
                                 lineheight = 8, vjust=1), aspect.ratio=1)+
  stat_smooth(method="lm", se = F) + 
  theme_bw() +
  scale_shape_identity() + 
  facet_wrap( ~ pH_feed, scales = "free_x" )

SlopePlots_1026

# Clearance rate anlaysis for 9/30 data
ClearRate_Master.1026       <- ClearRate_Master %>% 
  dplyr::filter(Date %in% 20211026) %>% 
  dplyr::mutate(uniq_Identifier = paste(pH, Fed_Unfed, "Run", Run, "Rep",Replicate, "Num", Number, sep='_'))

loop_1026 <- as.data.frame(unique(ClearRate_Master.1026$uniq_Identifier)) %>% dplyr::rename(ID = "unique(ClearRate_Master.1026$uniq_Identifier)")

SlopeTable_1026 <- data.frame() # run this before the loop
for(i in 1:nrow(loop_1026)){
  dat <- ClearRate_Master.1026 %>%  filter(uniq_Identifier %in% loop_1026[i,])
  slope<- summary(lm((dat$total_algae) ~ as.numeric(dat$minutes)))$coef[2,"Estimate"]
  SLOPE  <- summary(lm((dat$total_algae) ~ as.numeric(dat$minutes)))$r.squared
  pval <- summary(lm((dat$total_algae) ~ as.numeric(dat$minutes)))$coef[2,"Pr(>|t|)"]
  mod  <- lm(as.numeric(dat$minutes) ~ dat$total_algae)
  norm_assum <- shapiro.test(resid(mod))
  shapiro_pval <- norm_assum$p.value
  # assign the data table 
  SLOPE.loop <- data.frame(matrix(nrow = 1, ncol = 6)) # create a new data table
  colnames(SLOPE.loop) <- c('pH', 'Replicate', 'Fed_Unfed','slope', 'SLOPE', 'pval') # assign headers
  SLOPE.loop$pH        <- gsub("_.*", "\\1", loop_1026[i,])
  SLOPE.loop$Replicate <- gsub("^(?:[^_]+_){5}([^_]+).*", "\\1", loop_1026[i,])
  SLOPE.loop$Fed_Unfed <- gsub("^(?:[^_]+_){1}([^_]+).*", "\\1", loop_1026[i,])
  SLOPE.loop$slope     <- slope * 60  # cells per mL per hour  
  SLOPE.loop$Number    <- gsub("^(?:[^_]+_){7}([^_]+).*", "\\1", loop_1026[i,])
  SLOPE.loop$SLOPE       <- SLOPE
  SLOPE.loop$pval      <- pval
  SLOPE.loop$shapiro_pval <- shapiro_pval
  # loop additions 
  df <- data.frame(SLOPE.loop) # name dataframe for this single row
  SlopeTable_1026 <- rbind(SlopeTable_1026,df) # bind to a cumulative list dataframe
  #print(SlopeTable_1026) # show loop progress in the console
}# outside loo

SLOPE_mod_1026 <- aov(lm(slope ~ pH*Fed_Unfed, data= SlopeTable_1026))
summary(SLOPE_mod_1026) # Fed_Unfed    2.62e-08 ***
DF.1026   <- paste( (summary(SLOPE_mod_1026)[[1]][["Df"]])[1], (summary(SLOPE_mod_1026)[[1]][["Df"]])[2], sep = '/')
Fval.1026 <- (summary(SLOPE_mod_1026)[[1]][["F value"]])[1]
pval.1026 <- (summary(SLOPE_mod_1026)[[1]][["Pr(>F)"]])[1]

SlopeFig1026_geombox <- SlopeTable_1026 %>%  
  mutate(pH_feed = paste(pH, Fed_Unfed, sep = '_')) %>% 
  ggplot(aes(pH , abs(slope) , fill = pH)) +
    theme(panel.grid=element_blank()) +
    geom_boxplot(size=0.2, alpha=0.1, aes(fill=pH)) +
    scale_fill_manual(values=c("grey50","white")) +
    geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
    theme_classic() +
    scale_x_discrete(labels= c('Elevated (H)', 'Ambient (L)')) +
    theme(axis.text=element_text(size=12),
          axis.title=element_text(size=14,face="bold")) +
    labs(title = "F1 Scallops: Slope algae cells/time - feeding rate trials 20211026", 
         y = expression(Slope~"="~absolute~value~"("~Live~algae~cells~mL^{-1}~hour^{-1}~")"), 
         x = expression(italic(p)*CO[2]~Treatment~"("~mu*atm~")")) + 
    facet_wrap(~ Fed_Unfed)

SlopeFig1026_geombox
# Save plots :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/FeedingRates/FlowCytometry_rawdata_20210914.pdf"))
pdf(paste0("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/FeedingRates/FlowCytometry_rawdata_20210914.pdf"))
ggarrange(SlopePlots_914, SlopeFig914_geombox,
          labels = c("A", "B"),
          ncol = 1, nrow = 2)
dev.off()

pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/FeedingRates/FlowCytometry_rawdata_20210930.pdf"))
pdf(paste0("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/FeedingRates/FlowCytometry_rawdata_20210930.pdf"))
ggarrange(SlopePlots_930, SlopeFig930_geombox,
          labels = c("A", "B"),
          ncol = 1, nrow = 2)
dev.off()


pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/FeedingRates/FlowCytometry_rawdata_20211026.pdf"))
pdf(paste0("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/FeedingRates/FlowCytometry_rawdata_20211026.pdf"))
ggarrange(SlopePlots_1026, SlopeFig1026_geombox,
          labels = c("A", "B"),
          ncol = 1, nrow = 2)
dev.off()
```


# Calculate Clearance Rate 

### Note: the following clusters calculate CR for the start/end Algae counts (i.e. 20210914 time 0 and time 90 minutes; 20210930 time 0 and time 60 minutes)


### CLEARANCE RATE EQUATION

**FR =( V/t * (ln(C_0/C_t ) - A) )/ L**

- **V** == the volume of the vessel
- **t** == time of the trial interval (i.e. 60 minutes or 1 hour)
- **ln(C_0/C_t)** == ratio of the live algae concentration (cells ml-1) at time 0 (C0) and at the elapsed time interval(s) (Ct) - take the natural log of this number
- **A** == ln(C_0/C_t) for the 'blank' values in each treatment, accounts for the sink or stuck algae cells 
- **L** == normalization factor between individuals - here we will use the shell length in mm



## 'A' Calculate the blank values for each trial


```{r Calculate BLANKS and write csv, echo = FALSE}

Blanks.Master <- Master_data %>% 
                                dplyr::filter(Replicate %in% 'blank') %>% 
                                dplyr::mutate(unique_identifier = paste(Date, pH, "Run", Run, sep ='_'))
Blanks.Master$tet.ply     <- (as.numeric(gsub(",", "", Blanks.Master$tet.ply )))*(1000/33)
Blanks.Master$chaet       <- (as.numeric(gsub(",", "", Blanks.Master$chaet )))*(1000/33)
Blanks.Master$total_algae <- (as.numeric(gsub(",", "", Blanks.Master$total_algae )))*(1000/33)
Blanks.Master$seston      <- (as.numeric(gsub(",", "", Blanks.Master$seston )))*(1000/33)

loop_BLANKS       <- as.data.frame(unique(Blanks.Master$unique_identifier)) %>%
                            dplyr::rename(ID = "unique(Blanks.Master$unique_identifier)") # call unique identifier tfor the for loop calc of blanks 

meanBLANKS.Master       <- data.frame() 
for (i in 1:nrow(loop_BLANKS)) { # for each unique identifier....
  dat <- Blanks.Master %>% 
          dplyr::filter(unique_identifier == loop_BLANKS[i,]) %>% # subset the data out for that ID
          dplyr::arrange(minutes)
  # C0_tet         <- (dat %>% dplyr::filter(minutes == 0))$tet.ply
  # C0_chaet       <- (dat %>% dplyr::filter(minutes == 0))$chaet
    C0_total_algae <- dat[1,]$total_algae # first row - typically time 0 but may be time 15 or 10 for missing values
    C0_seston      <- dat[1,]$seston      # first row - typically time 0 but may be time 15 or 10 for missing values
  # C0 <- max(dat$Cells_ml[1:2])
    for (j in 2:nrow(dat)) { # for each row 
      Algae_Seston_dat <- dat %>%  
        dplyr::mutate(TotalLiveAlgaeLossRatio = C0_total_algae / as.numeric(dat$total_algae) ) %>%  # calc the ration of algae lost to the time 0 number 
        dplyr::mutate(SestonLossRatio = C0_seston / as.numeric(dat$seston) ) %>%  # calc the ration of algae lost to the time 0 number 
        # dplyr::mutate(Tet_AlgaeLossRatio = C0_tet / as.numeric(dat$tet.ply) ) %>%  # calc the ration of algae lost to the time 0 number 
        #dplyr::filter(!Tet_AlgaeLossRatio < 1) %>% 
        dplyr::mutate(ln_TotalLiveAlgaeLossRatio = ln(TotalLiveAlgaeLossRatio)) %>% 
        dplyr::mutate(ln_SestonLossRatio = ln(SestonLossRatio)) %>% 
        dplyr::mutate(Time_period = paste((as.numeric(substr(minutes,1,1)) -1), "0-", minutes, sep =''))
      Algae_Seston_datOM <- Algae_Seston_dat %>% dplyr::filter(!minutes == 0)
    }
  if (nrow(Algae_Seston_datOM) > 0) {
    df                <- data.frame(Algae_Seston_datOM) # name dataframe for this single row
    meanBLANKS.Master <- rbind(meanBLANKS.Master,df) #bind to a cumulative list dataframe
    # print(meanBLANKS.914) # print to monitor progress
  } else {}
}



meanBLANKS.Summary <- data.frame( meanBLANKS.Master[!is.na(meanBLANKS.Master$ln_TotalLiveAlgaeLossRatio),] %>% 
                     dplyr::filter(!ln_TotalLiveAlgaeLossRatio < 0) %>% 
                     dplyr::group_by(Date, pH, Time_point) %>% 
                     dplyr::summarise(
                       meanBlank_ln_AlgaeLoss  = mean(ln_TotalLiveAlgaeLossRatio),
                       sdBlank_ln_AlgaeLoss    = sd(ln_TotalLiveAlgaeLossRatio),
                       seBlank_ln_AlgaeLoss    = sd(ln_TotalLiveAlgaeLossRatio) / sqrt(length(ln_TotalLiveAlgaeLossRatio)), 
                       meanBlank_ln_SestonLoss = mean(ln_SestonLossRatio),
                       sdBlank_ln_SestonLoss   = sd(ln_SestonLossRatio),
                       seBlank_ln_SestonLoss   = sd(ln_SestonLossRatio) / sqrt(length(ln_SestonLossRatio)), 
                       n= n())) 


write.csv(meanBLANKS.Summary, "C:/Users/samjg/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/FeedingRates/Blanks_Master.csv")

```



## 'A' Call the blank values for each trial - continued....

 - Call the blank value **specifically for the final timepoint** of the clearance rate trial(s)!
 - this value will be called in the for loop when calculating CR in following cluster(s)


```{r blank values, echo = T}
meanBLANKS.Summary$meanBlank_ln_AlgaeLoss
# 20210914 DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
AlgaeBlank_914_pH7.5 <- (meanBLANKS.Summary %>% dplyr::filter(Date %in% 20210914) %>% dplyr::filter(pH == 7.5) %>% dplyr::arrange(desc(Time_point)))$meanBlank_ln_AlgaeLoss[1]
AlgaeBlank_914_pH8.0  <- (meanBLANKS.Summary %>% dplyr::filter(Date %in% 20210914) %>% dplyr::filter(pH == 8) %>% dplyr::arrange(desc(Time_point)))$meanBlank_ln_AlgaeLoss[1]
SestonBlank_914_pH7.5 <- (meanBLANKS.Summary %>% dplyr::filter(Date %in% 20210914) %>% dplyr::filter(pH == 7.5) %>% dplyr::arrange(desc(Time_point)))$meanBlank_ln_SestonLoss[1]
SestonBlank_914_pH8.0 <- (meanBLANKS.Summary %>% dplyr::filter(Date %in% 20210914) %>% dplyr::filter(pH == 8) %>% dplyr::arrange(desc(Time_point)))$meanBlank_ln_SestonLoss[1]

# 20210930 DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
AlgaeBlank_930_pH7.5  <- (meanBLANKS.Summary %>% dplyr::filter(Date %in% 20210930) %>% dplyr::filter(pH == 7.5) %>% dplyr::arrange(desc(Time_point)))$meanBlank_ln_AlgaeLoss[1]
AlgaeBlank_930_pH8.0  <- (meanBLANKS.Summary %>% dplyr::filter(Date %in% 20210930) %>% dplyr::filter(pH == 8) %>% dplyr::arrange(desc(Time_point)))$meanBlank_ln_AlgaeLoss[1]
SestonBlank_930_pH7.5 <- (meanBLANKS.Summary %>% dplyr::filter(Date %in% 20210930) %>% dplyr::filter(pH == 7.5) %>% dplyr::arrange(desc(Time_point)))$meanBlank_ln_SestonLoss[2]
SestonBlank_930_pH8.0 <- (meanBLANKS.Summary %>% dplyr::filter(Date %in% 20210930) %>% dplyr::filter(pH == 8) %>% dplyr::arrange(desc(Time_point)))$meanBlank_ln_SestonLoss[1]

# 20211026 DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
AlgaeBlank_1026_pH7.5  <- (meanBLANKS.Summary %>% dplyr::filter(Date %in% 20211026) %>% dplyr::filter(pH == 7.5) %>% dplyr::arrange(desc(Time_point)))$meanBlank_ln_AlgaeLoss[1]
AlgaeBlank_1026_pH8.0  <- (meanBLANKS.Summary %>% dplyr::filter(Date %in% 20211026) %>% dplyr::filter(pH == 8) %>% dplyr::arrange(desc(Time_point)))$meanBlank_ln_AlgaeLoss[1]
SestonBlank_1026_pH7.5 <- (meanBLANKS.Summary %>% dplyr::filter(Date %in% 20211026) %>% dplyr::filter(pH == 7.5) %>% dplyr::arrange(desc(Time_point)))$meanBlank_ln_SestonLoss[2]
SestonBlank_1026_pH8.0 <- (meanBLANKS.Summary %>% dplyr::filter(Date %in% 20211026) %>% dplyr::filter(pH == 8) %>% dplyr::arrange(desc(Time_point)))$meanBlank_ln_SestonLoss[1]

# 
# # 20210914 DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Blank_914_pH7.5 <- (A_914_BlankMeans %>% dplyr::filter(pH == 7.5) %>% dplyr::arrange(desc(Time._min)))$meanBlank_ln_AlgaeLoss[1]
# Blank_914_pH8.0 <- (A_914_BlankMeans %>% dplyr::filter(pH == 8.0) %>% dplyr::arrange(desc(Time._min)))$meanBlank_ln_AlgaeLoss[1]
# 
# # 20210930 DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Blank_930_pH7.5 <- (A_930_BlankMeans %>% dplyr::filter(pH == 7.5) %>% dplyr::arrange(desc(Time._min)))$meanBlank_ln_AlgaeLoss[1]
# Blank_930_pH8.0 <- (A_930_BlankMeans %>% dplyr::filter(pH == 8.0) %>% dplyr::arrange(desc(Time._min)))$meanBlank_ln_AlgaeLoss[1]

```

## 20210914 Clearance Rate data 

```{r 20210914 CR, echo = T}

df_total.914              <- data.frame() # start dataframe 
for (i in 1:nrow(loop_914)) {
  dat <- ClearRate_Master.914 %>% 
    dplyr::filter(uniq_Identifier == loop_914[i,]) %>% 
    dplyr::arrange(minutes)
  C0_total_algae <- max(c(dat[1,]$total_algae, dat[2,]$total_algae)) # call the max number in the first two time points - allows for error 
  dat2 <- dat %>% 
    do(tail(., 2)) %>%
    #dplyr::mutate(diff = as.numeric(Time._min) - lag(as.numeric(Time._min), default = first(as.numeric(Time._min)))) %>% 
    dplyr::filter(total_algae %in% min(total_algae)) %>% 
    dplyr::mutate(Blank = if(pH == 7.5) AlgaeBlank_914_pH7.5 else AlgaeBlank_914_pH8.0 ) %>% 
    dplyr::mutate(TotalAlgaeLossRatio = C0_total_algae / as.numeric(total_algae) ) %>% 
    dplyr::filter(!TotalAlgaeLossRatio < 1) %>% 
    dplyr::mutate(ln_TotalAlgaeLossRatio = ln(TotalAlgaeLossRatio)) %>% 
   # dplyr::mutate(ClearanceRate =  ( (25/1000) / (diff/60)  * # V / t == Volume of the vessel (in Liters as 25 ml / 1000 ml L-1) and t = time in hours as the diff between the interval sin minutes / 60 mins hour-1
   #                                   ( ln_AlgaeLossRatio ) / Length.um. ) ) %>% 
    dplyr::mutate(ClearanceRate_L_hour_mm = ( (25/1000) * # V / t == Volume of the vessel (in Liters as 25 ml / 1000 ml L-1) and t = time in hours as the diff between the interval sin minutes / 60 mins hour-1
                                       (( ln_TotalAlgaeLossRatio /  (as.numeric(minutes)/60) - Blank))) / (Length_um/1000) ) %>% 
    dplyr::mutate(Time_period = paste( (dat[1,]$minutes),as.numeric(minutes), sep ='-'))
    dat2OM <- dat2 %>% dplyr::filter(!minutes == 0)
    
  if (nrow(dat2OM) > 0) {
    ClearRate.table           <- data.frame(matrix(nrow = nrow(dat2OM), ncol = 10)) # create dataframe to save cumunalitively during for loop
    colnames(ClearRate.table) <- c('Date', 'ID', 'pH', 'Replicate', 'Num','Run', 'Fed_Unfed', 'Time_period', 'TotalAlgaeLossRatio', 'ClearanceRate_L_hour_mm') # names for comuns in the for loop
    
    ClearRate.table$Date                       <- dat2OM$Date
    ClearRate.table$ID                         <- loop_914[i,]
    ClearRate.table$pH                         <- gsub("_.*", "\\1", ClearRate.table$ID)
    ClearRate.table$Fed_Unfed                  <- NA
    ClearRate.table$Replicate                  <- gsub("^(?:[^_]+_){4}([^_]+).*", "\\1", ClearRate.table$ID)
    ClearRate.table$Num                        <- gsub("^(?:[^_]+_){6}([^_]+).*", "\\1", ClearRate.table$ID)
    ClearRate.table$Run                        <- gsub("^(?:[^_]+_){2}([^_]+).*", "\\1", ClearRate.table$ID)
    ClearRate.table$Time_period                <- dat2OM$Time_period
    ClearRate.table$TotalAlgaeLossRatio             <- dat2OM$TotalAlgaeLossRatio
    ClearRate.table$ClearanceRate_L_hour_mm <- dat2OM$ClearanceRate_L_hour_mm
    
    df       <- data.frame(ClearRate.table) # name dataframe for this single row
    df_total.914 <- rbind(df_total.914,df) #bind to a cumulative list dataframe
    #print(df_total.914) # print to monitor progress
  }
  else {}
}
df_total.914 <- df_total.914  %>% 
  dplyr::mutate(pCO2 = case_when(pH == 8.0 ~ "500 μatm", pH == 7.5 ~ "800 μatm"))


ClearRates_914_Means <- df_total.914 %>% 
  #dplyr::filter(!ClearanceRate_L_hour_meter %in% '-Inf') %>% 
  dplyr::group_by(pCO2) %>% 
  dplyr::summarise(
    meanCR = mean(ClearanceRate_L_hour_mm),
    sdCR   = sd(ClearanceRate_L_hour_mm), 
    seCR   = sd(ClearanceRate_L_hour_mm) / sqrt(length(ClearanceRate_L_hour_mm)), 
    n = n()) %>% 
  na.omit()

print(ClearRates_914_Means)
# summary(lmer(meanCR~pH+ (1|Time_period), data=ClearRates_914_Means))
# summary(aov(lm(meanCR~pH*Time_period, data=ClearRates_914_Means)))


mod914CR <- aov(lm(ClearanceRate_L_hour_mm~ pCO2 , data = (df_total.914 %>%  dplyr::filter(!ClearanceRate_L_hour_mm  < 0)) ) )
# data = (df_total.930 %>%  dplyr::filter(!ClearanceRate_L_hour_mm  < 0)) ) ) 
pander(summary(mod914CR), style='rmarkdown')
check_model(mod914CR) # observe the diagnostics of the model
shapiro.test(residuals(mod914CR)) #  normal 0.07245
leveneTest(mod914CR) # good 0.347


CR_914_barplot <- ClearRates_914_Means %>% 
  #dplyr::filter(!Time_period %in% c('40-50', '50-60')) %>% 
  ggplot(aes(x=pCO2 , y=meanCR, fill = pCO2)) +
  geom_bar(position=position_dodge(), aes(y=meanCR), stat="identity", alpha=0.5) +
  #scale_fill_manual("Treatment", values = c("8" = "grey50", "7.5" = "black")) +
  scale_fill_manual(values=c("grey85","grey50")) +
 # scale_x_discrete(labels=c('~500 μatm', '~800 μatm')) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=meanCR+seCR, ymax=meanCR+seCR), width=0.2, colour="black", alpha=0.9, size=0.2) +
  geom_linerange(aes(ymin = meanCR, ymax = meanCR+seCR)) + 
  geom_point(position=position_dodge(width=0.9), aes(y=meanCR)) +
  theme_classic() +
  ggtitle("Clearance Rate, F1 Scallops 20210914 (0-90 minutes)") # + 
  # facet_wrap(~Time_period)
CR_914_barplot

CR_914_boxplot <- df_total.914 %>% 
  #dplyr::filter(!ClearanceRate_L_hour_mm %in% '-Inf') %>% 
  #dplyr::filter(!Time_period %in% c('40-50', '50-60')) %>% 
  ggplot(aes(pCO2 , ClearanceRate_L_hour_mm , fill = pCO2)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
  scale_fill_manual(values=c("white","grey50")) +
 # scale_x_discrete(labels=c('~800 μatm', ' ~500 μatm')) +
  geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold")) +
  # labs(title = "F1 Scallops: Slope algae cells/time - feeding rate trials 20210930", 
  #      y = expression(Slope~"="~absolute~value~"("~Live~algae~cells~mL^{-1}~hour^{-1}~")"), 
  #      x = expression(italic(p)*CO[2]~Treatment~"("~mu*atm~")")) +
  ggtitle("Clearance Rate, F1 Scallops 20210914 (0-90 minutes)")
CR_914_boxplot


# Save plots :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/FeedingRates/ClearanceRate_2010914.pdf"))
ggarrange(CR_914_barplot, CR_914_boxplot,
          labels = c("A", "B"),
          ncol = 1, nrow = 2)
dev.off()


```


## 20210930 Clearance Rate data 

```{r 20210930 CR, echo = T}


df_total.930              <- data.frame() # start dataframe 
for (i in 1:nrow(loop_930)) {
  dat <- ClearRate_Master.930 %>% 
    dplyr::filter(uniq_Identifier == loop_930[i,]) %>% 
    dplyr::arrange(minutes) # order by least to greatest (first to last flow cytometry measurement)
  C0_total_algae <- max(c(dat[1,]$total_algae, dat[2,]$total_algae)) # call the max number in the first two time points - allows for error 
  dat2 <- dat %>% 
    do(tail(., 2)) %>%
    #dplyr::mutate(diff = as.numeric(Time._min) - lag(as.numeric(Time._min), default = first(as.numeric(Time._min)))) %>% 
    dplyr::filter(total_algae %in% min(total_algae)) %>% 
    dplyr::mutate(Blank = if(pH == "7.5") AlgaeBlank_930_pH7.5 else AlgaeBlank_930_pH8.0 ) %>% 
    dplyr::mutate(TotalAlgaeLossRatio = C0_total_algae / as.numeric(total_algae) ) %>% 
    dplyr::filter(!TotalAlgaeLossRatio < 1) %>% 
    dplyr::mutate(ln_TotalAlgaeLossRatio = ln(TotalAlgaeLossRatio)) %>% 
   # dplyr::mutate(ClearanceRate =  ( (25/1000) / (diff/60)  * # V / t == Volume of the vessel (in Liters as 25 ml / 1000 ml L-1) and t = time in hours as the diff between the interval sin minutes / 60 mins hour-1
   #                                   ( ln_AlgaeLossRatio ) / Length.um. ) ) %>% 
    dplyr::mutate(ClearanceRate_L_hour_mm = ( (25/1000) * # V / t == Volume of the vessel (in Liters as 25 ml / 1000 ml L-1) and t = time in hours as the diff between the interval sin minutes / 60 mins hour-1
                                       (( ln_TotalAlgaeLossRatio /  (as.numeric(minutes)/60) - Blank))) / (Length_um/1000) ) %>% 
    dplyr::mutate(Time_period = paste( (dat[1,]$minutes),as.numeric(minutes), sep ='-'))
    dat2OM <- dat2 %>% dplyr::filter(!minutes == 0)
    
  if (nrow(dat2OM) > 0) {
    ClearRate.table           <- data.frame(matrix(nrow = nrow(dat2OM), ncol = 10)) # create dataframe to save cumunalitively during for loop
    colnames(ClearRate.table) <- c('Date', 'ID', 'pH', 'Replicate', 'Num','Run', 'Fed_Unfed', 'Time_period', 'TotalAlgaeLossRatio', 'ClearanceRate_L_hour_mm') # names for comuns in the for loop
    
    ClearRate.table$Date                       <- dat2OM$Date
    ClearRate.table$ID                         <- loop_930[i,]
    ClearRate.table$pH                         <- gsub("_.*", "\\1", ClearRate.table$ID)
    ClearRate.table$Fed_Unfed                  <- dat2OM$Fed_Unfed
    ClearRate.table$Replicate                  <- gsub("^(?:[^_]+_){4}([^_]+).*", "\\1", ClearRate.table$ID)
    ClearRate.table$Num                        <- gsub("^(?:[^_]+_){6}([^_]+).*", "\\1", ClearRate.table$ID)
    ClearRate.table$Run                        <- gsub("^(?:[^_]+_){2}([^_]+).*", "\\1", ClearRate.table$ID)
    ClearRate.table$Time_period                <- dat2OM$Time_period
    ClearRate.table$TotalAlgaeLossRatio             <- dat2OM$TotalAlgaeLossRatio
    ClearRate.table$ClearanceRate_L_hour_mm <- dat2OM$ClearanceRate_L_hour_mm
    
    df       <- data.frame(ClearRate.table) # name dataframe for this single row
    df_total.930 <- rbind(df_total.930,df) #bind to a cumulative list dataframe
    #print(df_total.930) # print to monitor progress
  }
  else {}
}
df_total.930 <- df_total.930  %>% 
  dplyr::mutate(pCO2 = case_when(pH == 8.0 ~ "500 μatm", pH == 7.5 ~ "800 μatm"))


ClearRates_930_Means <- df_total.930 %>% 
  dplyr::filter(!ClearanceRate_L_hour_mm  < 0) %>% 
  dplyr::group_by(pCO2, Fed_Unfed) %>% 
  dplyr::summarise(
    meanCR = mean(ClearanceRate_L_hour_mm),
    sdCR   = sd(ClearanceRate_L_hour_mm), 
    seCR   = sd(ClearanceRate_L_hour_mm) / sqrt(length(ClearanceRate_L_hour_mm)), 
    n = n()) %>% 
  na.omit()
ClearRates_930_Means

# summary(lmer(meanCR~pH*Fed_Unfed + (1|Time_period), data=ClearRates_930_Means))
# summary(aov(lm(meanCR~pH*Fed_Unfed, data=ClearRates_930_Means)))

mod930CR <- aov(lm(log(ClearanceRate_L_hour_mm)~ pCO2 * Fed_Unfed, data = (df_total.930 %>%  dplyr::filter(!ClearanceRate_L_hour_mm  < 0)) ) ) 
pander(summary(mod930CR), style='rmarkdown') # fed_unfed 4.948e-06  
check_model(mod930CR) # observe the diagnostics of the model
shapiro.test(residuals(mod930CR)) #  normal 0.1581
leveneTest(mod930CR) # fine 0.05872 .

# summary(lmer(ClearanceRate_L_hour_mm~ pH * Fed_Unfed + (1|Replicate), data = (df_total.930 %>%  dplyr::filter(!ClearanceRate_L_hour_mm  < 0)) ) ) 



ClearRates_930_Means$pH_feed <- paste(ClearRates_930_Means$pCO2, ClearRates_930_Means$Fed_Unfed, sep='_')
CR_930_barplot <- ClearRates_930_Means %>% 
#dplyr::filter(!Time_period %in% c('40-50', '50-60')) %>% 
ggplot(aes(x=pCO2 , y=meanCR, fill = pCO2)) +
  geom_bar(position=position_dodge(), aes(y=meanCR), stat="identity", alpha=0.5) +
  scale_fill_manual(values=c("grey50", "black")) +  
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=meanCR+seCR, ymax=meanCR+seCR), width=0.2, colour="black", alpha=0.9, size=0.2) +
  geom_linerange(aes(ymin = meanCR, ymax = meanCR+seCR)) + 
  geom_point(position=position_dodge(width=0.9), aes(y=meanCR)) +
  theme_classic() +
  ggtitle("Clearance Rate, F1 Scallops 20210930 (0-60 minutes)") +
  facet_wrap(~ Fed_Unfed)
CR_930_barplot

df_total.930$Fed_Unfed <- as.factor(df_total.930$Fed_Unfed)
levels(df_total.930$Fed_Unfed) <- c("High food", "Low food")


CR_930_boxplot <- df_total.930 %>% 
  dplyr::filter(!ClearanceRate_L_hour_mm  < 0) %>% 
  #dplyr::filter(!ClearanceRate_L_hour_mm %in% '-Inf') %>% 
  #dplyr::filter(!Time_period %in% c('40-50', '50-60')) %>% 
  ggplot(aes(pCO2 , ClearanceRate_L_hour_mm , fill = pCO2)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
  scale_fill_manual(values=c("white","grey50")) +
  #scale_x_discrete(labels=c('~500 μatm', '~800 μatm')) +
  geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold")) +
  stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white") +
  labs(title = "Clearance rate; F1 Scallops (juveniles) 66 days post-fertilization", 
       y = expression(Clearance~rate~"("~L^{-1}~live~algae%.%mm^{-1}%.%hr^{-1}~")"), 
       x = expression(italic(p)*CO[2]~Treatment~"("~μatm~")")) + 
  ggtitle("Clearance rate; F1 Scallops (juveniles) 66 days post-fertilization") +
  facet_wrap(~factor(Fed_Unfed, level = c('Low food', 'High food'))) # + 
CR_930_boxplot

# Save plots :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/FeedingRates/ClearanceRate_2010930.pdf"))
pdf(paste0("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/FeedingRates/ClearanceRate_2010930.pdf"))

ggarrange(CR_930_barplot, CR_930_boxplot,
          labels = c("A", "B"),
          ncol = 1, nrow = 2)
dev.off()

pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/FeedingRates/ClearanceRate_2010930_boxplot.pdf"))
CR_930_boxplot
dev.off()

```


## 20211026 Clearance Rate data 

```{r 20211026 CR, echo = T}


df_total.1026              <- data.frame() # start dataframe 
for (i in 1:nrow(loop_1026)) {
  dat <- ClearRate_Master.1026 %>% 
    dplyr::filter(uniq_Identifier == loop_1026[i,]) %>% 
    dplyr::arrange(minutes)
  C0_total_algae <- max(c(dat[1,]$total_algae, dat[2,]$total_algae)) # call the max number in the first two time points - allows for error 
  dat2 <- dat %>% 
    do(tail(., 2)) %>%
    #dplyr::mutate(diff = as.numeric(Time._min) - lag(as.numeric(Time._min), default = first(as.numeric(Time._min)))) %>% 
    dplyr::filter(total_algae %in% min(total_algae)) %>% 
    dplyr::mutate(Blank = if(pH == 7.5) AlgaeBlank_1026_pH7.5 else AlgaeBlank_1026_pH8.0 ) %>% 
    dplyr::mutate(TotalAlgaeLossRatio = C0_total_algae / as.numeric(total_algae) ) %>% 
    dplyr::filter(!TotalAlgaeLossRatio < 1) %>% 
    dplyr::mutate(ln_TotalAlgaeLossRatio = ln(TotalAlgaeLossRatio)) %>% 
   # dplyr::mutate(ClearanceRate =  ( (25/1000) / (diff/60)  * # V / t == Volume of the vessel (in Liters as 25 ml / 1000 ml L-1) and t = time in hours as the diff between the interval sin minutes / 60 mins hour-1
   #                                   ( ln_AlgaeLossRatio ) / Length.um. ) ) %>% 
    dplyr::mutate(ClearanceRate_L_hour_mm = ( (25/1000) * # V / t == Volume of the vessel (in Liters as 25 ml / 1000 ml L-1) and t = time in hours as the diff between the interval sin minutes / 60 mins hour-1
                                       (( ln_TotalAlgaeLossRatio /  (as.numeric(minutes)/60) - Blank))) / (Length_um/1000) ) %>% 
    dplyr::mutate(Time_period = paste( (dat[1,]$minutes),as.numeric(minutes), sep ='-'))
    dat2OM <- dat2 %>% dplyr::filter(!minutes == 0)
    
  if (nrow(dat2OM) > 0) {
    ClearRate.table           <- data.frame(matrix(nrow = nrow(dat2OM), ncol = 10)) # create dataframe to save cumunalitively during for loop
    colnames(ClearRate.table) <- c('Date', 'ID', 'pH', 'Replicate', 'Num','Run', 'Fed_Unfed', 'Time_period', 'TotalAlgaeLossRatio', 'ClearanceRate_L_hour_mm') # names for comuns in the for loop
    
    ClearRate.table$Date                       <- dat2OM$Date
    ClearRate.table$ID                         <- loop_1026[i,]
    ClearRate.table$pH                         <- gsub("_.*", "\\1", ClearRate.table$ID)
    ClearRate.table$Fed_Unfed                  <- dat2OM$Fed_Unfed
    ClearRate.table$Replicate                  <- gsub("^(?:[^_]+_){4}([^_]+).*", "\\1", ClearRate.table$ID)
    ClearRate.table$Num                        <- gsub("^(?:[^_]+_){6}([^_]+).*", "\\1", ClearRate.table$ID)
    ClearRate.table$Run                        <- gsub("^(?:[^_]+_){2}([^_]+).*", "\\1", ClearRate.table$ID)
    ClearRate.table$Time_period                <- dat2OM$Time_period
    ClearRate.table$TotalAlgaeLossRatio             <- dat2OM$TotalAlgaeLossRatio
    ClearRate.table$ClearanceRate_L_hour_mm <- dat2OM$ClearanceRate_L_hour_mm
    
    df       <- data.frame(ClearRate.table) # name dataframe for this single row
    df_total.1026 <- rbind(df_total.1026,df) #bind to a cumulative list dataframe
    #print(df_total.1026) # print to monitor progress
  }
  else {}
}
df_total.1026 <- df_total.1026  %>% 
  dplyr::mutate(pCO2 = case_when(pH == 8.0 ~ "500 μatm", pH == 7.5 ~ "800 μatm"))


ClearRates_1026_Means <- df_total.1026 %>% 
  dplyr::filter(!ClearanceRate_L_hour_mm  < 0) %>% 
  dplyr::group_by(pCO2, Fed_Unfed) %>% 
  dplyr::summarise(
    meanCR = mean(ClearanceRate_L_hour_mm),
    sdCR   = sd(ClearanceRate_L_hour_mm), 
    seCR   = sd(ClearanceRate_L_hour_mm) / sqrt(length(ClearanceRate_L_hour_mm)), 
    n = n()) %>% 
  na.omit()
ClearRates_1026_Means

# summary(lmer(meanCR~pH*Fed_Unfed + (1|Time_period), data=ClearRates_1026_Means))
# summary(aov(lm(meanCR~pH*Fed_Unfed, data=ClearRates_1026_Means)))

mod1026CR <- aov(lm(ClearanceRate_L_hour_mm~ pCO2 * Fed_Unfed, data = (df_total.1026 %>%  dplyr::filter(!ClearanceRate_L_hour_mm  < 0)) ) ) 
pander(summary(mod1026CR), style='rmarkdown') # fed_unfed 0.0001131   
check_model(mod1026CR) # observe the diagnostics of the model
shapiro.test(residuals(mod1026CR)) #  non normal 0.02723
leveneTest(mod1026CR) # good 0.09419 .

# summary(lmer(ClearanceRate_L_hour_mm~ pH * Fed_Unfed + (1|Replicate), data = (df_total.1026 %>%  dplyr::filter(!ClearanceRate_L_hour_mm  < 0)) ) ) 



ClearRates_1026_Means$pH_feed <- paste(ClearRates_1026_Means$pCO2, ClearRates_1026_Means$Fed_Unfed, sep='_')
CR_1026_barplot <- ClearRates_1026_Means %>% 
#dplyr::filter(!Time_period %in% c('40-50', '50-60')) %>% 
ggplot(aes(x=pCO2 , y=meanCR, fill = pCO2)) +
  geom_bar(position=position_dodge(), aes(y=meanCR), stat="identity", alpha=0.5) +
  scale_fill_manual(values=c("grey50", "black")) +  
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=meanCR+seCR, ymax=meanCR+seCR), width=0.2, colour="black", alpha=0.9, size=0.2) +
  geom_linerange(aes(ymin = meanCR, ymax = meanCR+seCR)) + 
  geom_point(position=position_dodge(width=0.9), aes(y=meanCR)) +
  theme_classic() +
  ggtitle("Clearance Rate, F1 Scallops 20211026 (0-60 minutes)") +
  facet_wrap(~ Fed_Unfed)
CR_1026_barplot

df_total.1026$Fed_Unfed <- as.factor(df_total.1026$Fed_Unfed)
levels(df_total.1026$Fed_Unfed) <- c("High food", "Low food")

CR_1026_boxplot <- df_total.1026 %>% 
  dplyr::filter(!ClearanceRate_L_hour_mm  < 0) %>% 
  #dplyr::filter(!ClearanceRate_L_hour_mm %in% '-Inf') %>% 
  #dplyr::filter(!Time_period %in% c('40-50', '50-60')) %>% 
  ggplot(aes(pCO2 , ClearanceRate_L_hour_mm , fill = pCO2)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
  scale_fill_manual(values=c("white","grey50")) +
  #scale_x_discrete(labels=c('~500 μatm', '~800 μatm')) +
  geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold")) +
  stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white") +
  labs(title = "Clearance rate; F1 Scallops (juveniles) 92 days post-fertilization", 
       y = expression(Clearance~rate~"("~L^{-1}~live~algae%.%mm^{-1}%.%hr^{-1}~")"), 
       x = expression(italic(p)*CO[2]~Treatment~"("~μatm~")")) + 
  ggtitle("Clearance rate; F1 Scallops (juveniles) 92 days post-fertilization") +
  facet_wrap(~factor(Fed_Unfed, level = c('Low food', 'High food'))) # + 
CR_1026_boxplot

# Save plots :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/FeedingRates/ClearanceRate_2011026.pdf"))
pdf(paste0("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/FeedingRates/ClearanceRate_2011026.pdf"))

ggarrange(CR_1026_barplot, CR_1026_boxplot,
          labels = c("A", "B"),
          ncol = 1, nrow = 2)
dev.off()

pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/FeedingRates/ClearanceRate_2011026_boxplot.pdf"))
CR_1026_boxplot
dev.off()

```


``` {r CR master file write csv, echo = FALSE}

# write csv ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
All_CR_Master <- rbind(df_total.914, df_total.930, df_total.1026)


CR_MasterSumTab <- All_CR_Master %>% 
  dplyr::filter(!ClearanceRate_L_hour_mm < 0) %>%
  Rmisc::summarySE(measurevar="ClearanceRate_L_hour_mm", groupvars=c("Date", "pCO2", "Fed_Unfed"))   %>% 
  dplyr::mutate(Age = case_when(Date == "20210914" ~ 50, Date == "20210930" ~ 64,Date == "20211026" ~ 92)) %>%
  replace_na(list(Fed_Unfed = 'High food')) # replaces the NAs for 20210914 Fed_Unfed as 'High food' - this was before split for the food deprivation  

## Use geom_line and geom_point to plot over time
CR_TotalAlgae_geomline <-ggplot(data=CR_MasterSumTab, aes(x=Age, y=ClearanceRate_L_hour_mm, color=pCO2)) +
                            geom_line(aes(linetype = factor(Fed_Unfed)), size = 0.5) +  
                            geom_point()+ 
                            scale_color_manual(values=c("forestgreen","darkorange2"))+
                            geom_errorbar(aes(ymin=ClearanceRate_L_hour_mm-se, ymax=ClearanceRate_L_hour_mm+se), width=.2,
                                          position=position_dodge(.1))+
                            theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                            scale_x_continuous(name ="Age (days)") +
                            labs(title = "Clearance rate; F1 Scallops (juveniles) FoodxOAexperiment", 
                                  y = expression(Clearance~rate~"("~L^{-1}~live~algae%.%mm^{-1}%.%hr^{-1}~")")) +
                            scale_linetype_manual(values = c("High food" = "solid", "Low food" = "dashed"))  +
                            theme(legend.position="none") +
                            # facet_wrap(~factor(Fed_Unfed, level = c('Low food', 'High food'))) 
                            facet_wrap(~pCO2)

#pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/Respiration/Juvenile_respiration_FoodxOA.pdf"))
pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/FeedingRates/Juvenile_clearance_FoodxOA.pdf"))
CR_TotalAlgae_geomline
dev.off()


```
