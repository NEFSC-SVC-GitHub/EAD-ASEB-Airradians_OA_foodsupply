---
title: "FeedingRate_F1Scallops"
author: "Samuel Gurr"
date: "10/12/2021"
output: pdf_document
---

```{r setup, include=FALSE}
# Purpose: Bay Scallop Project - Feeding Rates
# analysis of respiration rate data

# Written by: Sam J Gurr (last edit 10/12/2021)

# Review Riisgard 2001 defining the clearance rate of bivalves 
# NOTE: clearance rate is defined as the volume of water cleared of suspended particles per unit time, and only equals filtration rate when 
# 100% of suspended particles are efficiently retained

# LOAD PACKAGES :::::::::::::::::::::::::::::::::::::::::::::::::::::::

library(dplyr)
library(ggplot2)
library(forcats)
library(lme4)
library(lmerTest)
library(see)
library(performance)
library(car)
library(reshape2)
library(lubridate)
library(SciViews)
library(reshape2)
library(SciViews)
library(kableExtra)
library(latex2exp)
library(pander)
library(performance)
library(ggpubr)
library(Rmisc)

# SET WORKING DIRECTORY :::::::::::::::::::::::::::::::::::::::::::::::

# setwd("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA/RAnalysis") # Work computer
 setwd("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis") # personal computer

# LOAD DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
Master_data       <- read.csv(file="Data/Feeding_rates/Feeding_MasterData.csv", header=T) # master data file

feed.rate_914    <- Master_data  %>% dplyr::filter(Date %in% 20210914)  %>% 
  dplyr::mutate(Chamber_tank = paste(pH, Replicate, sep='_'))

feed.rate_930    <- Master_data  %>% dplyr::filter(Date %in% 20210930)  %>% 
  dplyr::mutate(Chamber_tank = paste(pH, Replicate, sep='_'))

feed.rate_1026    <- Master_data  %>% dplyr::filter(Date %in% 20211026)  %>% 
  dplyr::mutate(Chamber_tank = paste(pH, Replicate, sep='_'))



length.resp.feed <- read.csv(file="Data/Respiration/Lengths_Condition_resp_clearance.csv", header=T) %>% 
  dplyr::mutate(Date = paste("20",(format(as.Date(Date, "%m/%d/%Y"), "%y%m%d")), sep ='')) %>%
  dplyr::rename(Fed_Unfed = Food) 
length.resp.feed <- length.resp.feed[!is.na(length.resp.feed$Length_um),]

```
## Merge to master file 'FeedRate_Master'

Date from: 
- 20210914
- 20210930 

```{r merge master file, echo = TRUE}

# 20210914 DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# formatting for merge
# call the 20210914 data and remove blanks
feed.rate_914_Scallops <- merge( # note - merging with th elengths removed the blanks from the clearance rate data (no lengths for them! )
  (feed.rate_914),
  (length.resp.feed %>% 
     dplyr::filter(Date %in% 20210914)) ) 

# 20210930 DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# formatting for merge
# call the 20210930 data and remove blanks
feed.rate_930_Scallops <- merge( # note - merging with th elengths removed the blanks from the clearance rate data (no lengths for them! )
  (feed.rate_930),
  (length.resp.feed %>% 
     dplyr::filter(Date %in% 20210930)) ) 

# 20210930 DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# formatting for merge
# call the 20210930 data and remove blanks
feed.rate_1026_Scallops <- merge( # note - merging with th elengths removed the blanks from the clearance rate data (no lengths for them! )
  (feed.rate_1026),
  (length.resp.feed %>% 
     dplyr::filter(Date %in% 20211026)) ) 


FeedRate_Master             <- rbind(feed.rate_914_Scallops, feed.rate_930_Scallops, feed.rate_1026_Scallops)
FeedRate_Master$tet.ply     <- (as.numeric(gsub(",", "", FeedRate_Master$tet.ply )))*(1000/33)
FeedRate_Master$chaet       <- (as.numeric(gsub(",", "", FeedRate_Master$chaet )))*(1000/33)
FeedRate_Master$total_algae <- (as.numeric(gsub(",", "", FeedRate_Master$total_algae )))*(1000/33)
FeedRate_Master$seston      <- (as.numeric(gsub(",", "", FeedRate_Master$seston )))*(1000/33)

print(head(FeedRate_Master))
```

# Visualize raw data & simple slopes/algae loss time-1
## Plot the raw Flow cytometry output

- note: some data points were omitted in the worksheet, review the 'raw' vs 'worksheet_R' data files

``` {r raw data plots, echo = TRUE}


# 20210914 DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

SlopePlots_914 <- FeedRate_Master[!is.na(FeedRate_Master$total_algae),] %>% 
  dplyr::filter(!Replicate %in% 'blank') %>%
  dplyr::filter(Date %in% "20210914") %>% 
  dplyr::mutate(Time._min = as.numeric(as.character(minutes))) %>% 
  ggplot(aes(minutes, total_algae, color=Replicate)) + 
  geom_point(shape=1, color = "black")+ 
  ggtitle("RAW DATA: F1 Scallops, Feeding Rate 20210914")+
  labs(y = expression(Live~algae~cells~"("~cells~mL^{-1}~")"), 
       x = expression(Time~"("~minutes~")")) + 
  theme(plot.title= element_text(size =16, face ="bold", 
                                 lineheight = 8, vjust=1), aspect.ratio=1)+
  stat_smooth(method="lm", se = F) + 
  theme_bw() +
  scale_shape_identity() + 
  facet_wrap( ~ pH, scales = "free_x" )
SlopePlots_914

FeedRate_Master.914 <- FeedRate_Master %>% 
  dplyr::filter(Date %in% 20210914) %>% 
  dplyr::mutate(uniq_Identifier = paste(pH, "Run", Run, "Rep",Replicate, "Num", Number, sep='_'))

loop_914 <- as.data.frame(unique(FeedRate_Master.914$uniq_Identifier)) %>% dplyr::rename(ID = "unique(FeedRate_Master.914$uniq_Identifier)")

SlopeTable_914 <- data.frame() # run this before the loop
for(i in 1:nrow(loop_914)){
  dat <- FeedRate_Master.914 %>%  filter(uniq_Identifier %in% loop_914[i,])
    slope<- summary(lm((dat$total_algae) ~ as.numeric(dat$minutes)))$coef[2,"Estimate"]
    SLOPE  <- summary(lm((dat$total_algae) ~ as.numeric(dat$minutes)))$r.squared
    pval <- summary(lm((dat$total_algae) ~ as.numeric(dat$minutes)))$coef[2,"Pr(>|t|)"]
    mod  <- lm(as.numeric(dat$minutes) ~ dat$total_algae)
    norm_assum <- shapiro.test(resid(mod))
    shapiro_pval <- norm_assum$p.value
    # assign the data table 
    SLOPE.loop <- data.frame(matrix(nrow = 1, ncol = 5)) # create a new data table
    colnames(SLOPE.loop) <- c('pH', 'Replicate', 'slope', 'SLOPE', 'pval') # assign headers
    SLOPE.loop$pH        <- gsub("_.*", "\\1", loop_914[i,])
    SLOPE.loop$Replicate <- gsub("^(?:[^_]+_){4}([^_]+).*", "\\1", loop_914[i,])
    SLOPE.loop$slope     <- slope * 60  # cells per mL per hour  
    SLOPE.loop$Number    <- gsub("^(?:[^_]+_){6}([^_]+).*", "\\1", loop_914[i,])
    SLOPE.loop$SLOPE       <- SLOPE
    SLOPE.loop$pval      <- pval
    SLOPE.loop$shapiro_pval <- shapiro_pval
    # loop additions 
    df <- data.frame(SLOPE.loop) # name dataframe for this single row
    SlopeTable_914 <- rbind(SlopeTable_914,df) # bind to a cumulative list dataframe
   # print(SlopeTable_914) # show loop progress in the console
}# outside loo

SLOPE_mod_914 <- aov(lm(slope ~ pH, data= SlopeTable_914))
DF   <- paste( (summary(SLOPE_mod_914)[[1]][["Df"]])[1], (summary(SLOPE_mod_914)[[1]][["Df"]])[2], sep = '/')
Fval <- (summary(SLOPE_mod_914)[[1]][["F value"]])[1]
pval <- (summary(SLOPE_mod_914)[[1]][["Pr(>F)"]])[1]

SlopeFig914_geombox <- ggplot(SlopeTable_914, aes(pH , abs(slope) , fill = pH)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, alpha=0.1, aes(fill=pH)) +
  scale_fill_manual(values=c("grey50","white")) +
  geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
  theme_classic() +
  scale_x_discrete(labels= c('Elevated (H)', 'Ambient (L)')) +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold")) +
  labs(title = "F1 Scallops: Slope algae cells/time - feeding rate trials 20210914", 
       y = expression(Slope~"="~absolute~value~"("~Live~algae~cells~mL^{-1}~hour^{-1}~")"), 
       x = expression(italic(p)*CO[2]~Treatment~"("~mu*atm~")")) + 
  annotate("text", x=2, y= 25000, size = 4, label = "aov(slope~pH Treatment)") +
  annotate("text", x=2, y= 24300, size = 4, label= paste('DF =',DF,'F =', signif(Fval, digits=3), 'p value =', signif(pval, digits=3), sep=" ")) 

SlopeFig914_geombox # 0.0531


# 20210930 DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
SlopePlots_930 <- FeedRate_Master[!is.na(FeedRate_Master$total_algae),] %>% 
  dplyr::filter(!Replicate %in% 'blank') %>%
  dplyr::filter(Date %in% 20210930) %>% 
  dplyr::mutate(pH_feed = paste(pH, Fed_Unfed, sep='_')) %>% 
  dplyr::mutate(minutes = as.numeric(as.character(minutes))) %>% 
  ggplot(aes(minutes, total_algae, color=Replicate)) + 
  geom_point(shape=1, fill = "white", color = "black")+ 
  ggtitle("RAW DATA: F1 Scallops, Feeding Rate 20210930")+
  labs(y = expression(Live~algae~cells~"("~cells~mL^{-1}~")"), 
       x = expression(Time~"("~minutes~")")) + 
  theme(plot.title= element_text(size =16, face ="bold", 
                                 lineheight = 8, vjust=1), aspect.ratio=1)+
  stat_smooth(method="lm", se = F) + 
  theme_bw() +
  scale_shape_identity() + 
  facet_wrap( ~ pH_feed, scales = "free_x" )
SlopePlots_930

# Clearance rate anlaysis for 9/30 data
FeedRate_Master.930       <- FeedRate_Master %>% 
  dplyr::filter(Date %in% 20210930) %>% 
  dplyr::mutate(uniq_Identifier = paste(pH, Fed_Unfed, "Run", Run, "Rep",Replicate, "Num", Number, sep='_'))

loop_930 <- as.data.frame(unique(FeedRate_Master.930$uniq_Identifier)) %>% dplyr::rename(ID = "unique(FeedRate_Master.930$uniq_Identifier)")

SlopeTable_930 <- data.frame() # run this before the loop
for(i in 1:nrow(loop_930)){
  dat <- FeedRate_Master.930 %>%  filter(uniq_Identifier %in% loop_930[i,])
  slope<- summary(lm((dat$total_algae) ~ as.numeric(dat$minutes)))$coef[2,"Estimate"]
  SLOPE  <- summary(lm((dat$total_algae) ~ as.numeric(dat$minutes)))$r.squared
  pval <- summary(lm((dat$total_algae) ~ as.numeric(dat$minutes)))$coef[2,"Pr(>|t|)"]
  mod  <- lm(as.numeric(dat$minutes) ~ dat$total_algae)
  norm_assum <- shapiro.test(resid(mod))
  shapiro_pval <- norm_assum$p.value
  # assign the data table 
  SLOPE.loop <- data.frame(matrix(nrow = 1, ncol = 6)) # create a new data table
  colnames(SLOPE.loop) <- c('pH', 'Replicate', 'Fed_Unfed','slope', 'SLOPE', 'pval') # assign headers
  SLOPE.loop$pH        <- gsub("_.*", "\\1", loop_930[i,])
  SLOPE.loop$Replicate <- gsub("^(?:[^_]+_){5}([^_]+).*", "\\1", loop_930[i,])
  SLOPE.loop$Fed_Unfed <- gsub("^(?:[^_]+_){1}([^_]+).*", "\\1", loop_930[i,])
  SLOPE.loop$slope     <- slope * 60  # cells per mL per hour  
  SLOPE.loop$Number    <- gsub("^(?:[^_]+_){7}([^_]+).*", "\\1", loop_930[i,])
  SLOPE.loop$SLOPE       <- SLOPE
  SLOPE.loop$pval      <- pval
  SLOPE.loop$shapiro_pval <- shapiro_pval
  # loop additions 
  df <- data.frame(SLOPE.loop) # name dataframe for this single row
  SlopeTable_930 <- rbind(SlopeTable_930,df) # bind to a cumulative list dataframe
  #print(SlopeTable_930) # show loop progress in the console
}# outside loo

SLOPE_mod_930 <- aov(lm(slope ~ pH*Fed_Unfed, data= SlopeTable_930))
summary(SLOPE_mod_930) # Fed_Unfed     2.39e-05 ***
DF.930   <- paste( (summary(SLOPE_mod_930)[[1]][["Df"]])[1], (summary(SLOPE_mod_930)[[1]][["Df"]])[2], sep = '/')
Fval.930 <- (summary(SLOPE_mod_930)[[1]][["F value"]])[1]
pval.930 <- (summary(SLOPE_mod_930)[[1]][["Pr(>F)"]])[1]

SlopeFig930_geombox <- SlopeTable_930 %>%  
  mutate(pH_feed = paste(pH, Fed_Unfed, sep = '_')) %>% 
  ggplot(aes(pH , abs(slope) , fill = pH)) +
    theme(panel.grid=element_blank()) +
    geom_boxplot(size=0.2, alpha=0.1, aes(fill=pH)) +
    scale_fill_manual(values=c("grey50","white")) +
    geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
    theme_classic() +
    scale_x_discrete(labels= c('Elevated (H)', 'Ambient (L)')) +
    theme(axis.text=element_text(size=12),
          axis.title=element_text(size=14,face="bold")) +
    labs(title = "F1 Scallops: Slope algae cells/time - feeding rate trials 20210930", 
         y = expression(Slope~"="~absolute~value~"("~Live~algae~cells~mL^{-1}~hour^{-1}~")"), 
         x = expression(italic(p)*CO[2]~Treatment~"("~mu*atm~")")) + 
    facet_wrap(~ Fed_Unfed)

SlopeFig930_geombox # 




# 20211026 DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
SlopePlots_1026 <- FeedRate_Master[!is.na(FeedRate_Master$total_algae),] %>% 
  dplyr::filter(!Replicate %in% 'blank') %>%
  dplyr::filter(Date %in% 20211026) %>% 
  dplyr::mutate(pH_feed = paste(pH, Fed_Unfed, sep='_')) %>% 
  dplyr::mutate(minutes = as.numeric(as.character(minutes))) %>% 
  ggplot(aes(minutes, total_algae, color=Replicate)) + 
  geom_point(shape=1, fill = "white", color = "black")+ 
  ggtitle("RAW DATA: F1 Scallops, Feeding Rate 20211026")+
  labs(y = expression(Live~algae~cells~"("~cells~mL^{-1}~")"), 
       x = expression(Time~"("~minutes~")")) + 
  theme(plot.title= element_text(size =16, face ="bold", 
                                 lineheight = 8, vjust=1), aspect.ratio=1)+
  stat_smooth(method="lm", se = F) + 
  theme_bw() +
  scale_shape_identity() + 
  facet_wrap( ~ pH_feed, scales = "free_x" )

SlopePlots_1026

# Clearance rate anlaysis for 9/30 data
FeedRate_Master.1026       <- FeedRate_Master %>% 
  dplyr::filter(Date %in% 20211026) %>% 
  dplyr::mutate(Run = case_when(Run == "1_B" ~ "1B", Run == "1" ~ "1", Run =='2' ~ '2', Run == '3' ~ '3')) %>% 
  dplyr::mutate(uniq_Identifier = paste(pH, Fed_Unfed, "Run", Run, "Rep",Replicate, "Num", Number, sep='_'))

loop_1026 <- as.data.frame(unique(FeedRate_Master.1026$uniq_Identifier)) %>% dplyr::rename(ID = "unique(FeedRate_Master.1026$uniq_Identifier)")

SlopeTable_1026 <- data.frame() # run this before the loop
for(i in 1:nrow(loop_1026)){
  dat <- FeedRate_Master.1026 %>%  filter(uniq_Identifier %in% loop_1026[i,])
  slope<- summary(lm((dat$total_algae) ~ as.numeric(dat$minutes)))$coef[2,"Estimate"]
  SLOPE  <- summary(lm((dat$total_algae) ~ as.numeric(dat$minutes)))$r.squared
  pval <- summary(lm((dat$total_algae) ~ as.numeric(dat$minutes)))$coef[2,"Pr(>|t|)"]
  mod  <- lm(as.numeric(dat$minutes) ~ dat$total_algae)
  norm_assum <- shapiro.test(resid(mod))
  shapiro_pval <- norm_assum$p.value
  # assign the data table 
  SLOPE.loop <- data.frame(matrix(nrow = 1, ncol = 6)) # create a new data table
  colnames(SLOPE.loop) <- c('pH', 'Replicate', 'Fed_Unfed','slope', 'SLOPE', 'pval') # assign headers
  SLOPE.loop$pH        <- gsub("_.*", "\\1", loop_1026[i,])
  SLOPE.loop$Replicate <- gsub("^(?:[^_]+_){5}([^_]+).*", "\\1", loop_1026[i,])
  SLOPE.loop$Fed_Unfed <- gsub("^(?:[^_]+_){1}([^_]+).*", "\\1", loop_1026[i,])
  SLOPE.loop$slope     <- slope * 60  # cells per mL per hour  
  SLOPE.loop$Number    <- gsub("^(?:[^_]+_){7}([^_]+).*", "\\1", loop_1026[i,])
  SLOPE.loop$SLOPE       <- SLOPE
  SLOPE.loop$pval      <- pval
  SLOPE.loop$shapiro_pval <- shapiro_pval
  # loop additions 
  df <- data.frame(SLOPE.loop) # name dataframe for this single row
  SlopeTable_1026 <- rbind(SlopeTable_1026,df) # bind to a cumulative list dataframe
  #print(SlopeTable_1026) # show loop progress in the console
}# outside loo

SLOPE_mod_1026 <- aov(lm(slope ~ pH*Fed_Unfed, data= SlopeTable_1026))
summary(SLOPE_mod_1026) # Fed_Unfed    2.62e-08 ***
DF.1026   <- paste( (summary(SLOPE_mod_1026)[[1]][["Df"]])[1], (summary(SLOPE_mod_1026)[[1]][["Df"]])[2], sep = '/')
Fval.1026 <- (summary(SLOPE_mod_1026)[[1]][["F value"]])[1]
pval.1026 <- (summary(SLOPE_mod_1026)[[1]][["Pr(>F)"]])[1]

SlopeFig1026_geombox <- SlopeTable_1026 %>%  
  mutate(pH_feed = paste(pH, Fed_Unfed, sep = '_')) %>% 
  ggplot(aes(pH , abs(slope) , fill = pH)) +
    theme(panel.grid=element_blank()) +
    geom_boxplot(size=0.2, alpha=0.1, aes(fill=pH)) +
    scale_fill_manual(values=c("grey50","white")) +
    geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
    theme_classic() +
    scale_x_discrete(labels= c('Elevated (H)', 'Ambient (L)')) +
    theme(axis.text=element_text(size=12),
          axis.title=element_text(size=14,face="bold")) +
    labs(title = "F1 Scallops: Slope algae cells/time - feeding rate trials 20211026", 
         y = expression(Slope~"="~absolute~value~"("~Live~algae~cells~mL^{-1}~hour^{-1}~")"), 
         x = expression(italic(p)*CO[2]~Treatment~"("~mu*atm~")")) + 
    facet_wrap(~ Fed_Unfed)

SlopeFig1026_geombox
# Save plots :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/FeedingRates/20210914_figs_tables/20210914_FlowCytometry_rawdata.pdf"))
pdf(paste0("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/FeedingRates/20210914_figs_tables/20210914_FlowCytometry_rawdata.pdf"))
ggarrange(SlopePlots_914, SlopeFig914_geombox,
          labels = c("A", "B"),
          ncol = 1, nrow = 2)
dev.off()

pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/FeedingRates/20210930_figs_tables/20210930_FlowCytometry_rawdata.pdf"))
pdf(paste0("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/FeedingRates/20210930_figs_tables/20210930_FlowCytometry_rawdata.pdf"))
ggarrange(SlopePlots_930, SlopeFig930_geombox,
          labels = c("A", "B"),
          ncol = 1, nrow = 2)
dev.off()


pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/FeedingRates/20211026_figs_tables/20211026_FlowCytometry_rawdata.pdf"))
pdf(paste0("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/FeedingRates/20211026_figs_tables/20211026_FlowCytometry_rawdata.pdf"))
ggarrange(SlopePlots_1026, SlopeFig1026_geombox,
          labels = c("A", "B"),
          ncol = 1, nrow = 2)
dev.off()
```


# Calculate Clearance Rate 

### Note: the following clusters calculate CR for the start/end Algae counts (i.e. 20210914 time 0 and time 90 minutes; 20210930 time 0 and time 60 minutes)


### CLEARANCE RATE EQUATION

**FR =( V/t * (ln(C_0/C_t ) - A) )/ L**

- **V** == the volume of the vessel
- **t** == time of the trial interval (i.e. 60 minutes or 1 hour)
- **ln(C_0/C_t)** == ratio of the live algae concentration (cells ml-1) at time 0 (C0) and at the elapsed time interval(s) (Ct) - take the natural log of this number
- **A** == ln(C_0/C_t) for the 'blank' values in each treatment, accounts for the sink or stuck algae cells 
- **L** == normalization factor between individuals - here we will use the shell length in mm



## 'A' Calculate the blank values for each trial


```{r Calculate BLANKS and write csv, echo = FALSE}

Blanks.Master <- Master_data %>% 
                                dplyr::filter(Replicate %in% 'blank') %>% 
                                dplyr::mutate(unique_identifier = paste(Date, pH, "Run", Run, sep ='_'))
Blanks.Master$tet.ply     <- (as.numeric(gsub(",", "", Blanks.Master$tet.ply )))*(1000/33)
Blanks.Master$chaet       <- (as.numeric(gsub(",", "", Blanks.Master$chaet )))*(1000/33)
Blanks.Master$total_algae <- (as.numeric(gsub(",", "", Blanks.Master$total_algae )))*(1000/33)
Blanks.Master$seston      <- (as.numeric(gsub(",", "", Blanks.Master$seston )))*(1000/33)

loop_BLANKS       <- as.data.frame(unique(Blanks.Master$unique_identifier)) %>%
                            dplyr::rename(ID = "unique(Blanks.Master$unique_identifier)") # call unique identifier tfor the for loop calc of blanks 

meanBLANKS.Master       <- data.frame() 
for (i in 1:nrow(loop_BLANKS)) { # for each unique identifier....
  dat <- Blanks.Master %>% 
          dplyr::filter(unique_identifier == loop_BLANKS[i,]) %>% # subset the data out for that ID
          dplyr::arrange(minutes)
  # C0_tet         <- (dat %>% dplyr::filter(minutes == 0))$tet.ply
  # C0_chaet       <- (dat %>% dplyr::filter(minutes == 0))$chaet
    C0_total_algae <- dat[1,]$total_algae # first row - typically time 0 but may be time 15 or 10 for missing values
    C0_seston      <- dat[1,]$seston      # first row - typically time 0 but may be time 15 or 10 for missing values
  # C0 <- max(dat$Cells_ml[1:2])
    for (j in 2:nrow(dat)) { # for each row 
      Algae_Seston_dat <- dat %>%  
        dplyr::mutate(TotalLiveAlgaeLossRatio = C0_total_algae / as.numeric(dat$total_algae) ) %>%  # calc the ration of algae lost to the time 0 number 
        dplyr::mutate(SestonLossRatio = C0_seston / as.numeric(dat$seston) ) %>%  # calc the ration of algae lost to the time 0 number 
        # dplyr::mutate(Tet_AlgaeLossRatio = C0_tet / as.numeric(dat$tet.ply) ) %>%  # calc the ration of algae lost to the time 0 number 
        #dplyr::filter(!Tet_AlgaeLossRatio < 1) %>% 
        dplyr::mutate(ln_TotalLiveAlgaeLossRatio = ln(TotalLiveAlgaeLossRatio)) %>% 
        dplyr::mutate(ln_SestonLossRatio = ln(SestonLossRatio)) %>% 
        dplyr::mutate(Time_period = paste((as.numeric(substr(minutes,1,1)) -1), "0-", minutes, sep =''))
      Algae_Seston_datOM <- Algae_Seston_dat %>% dplyr::filter(!minutes == 0)
    }
  if (nrow(Algae_Seston_datOM) > 0) {
    df                <- data.frame(Algae_Seston_datOM) # name dataframe for this single row
    meanBLANKS.Master <- rbind(meanBLANKS.Master,df) #bind to a cumulative list dataframe
    # print(meanBLANKS.914) # print to monitor progress
  } else {}
}



meanBLANKS.Summary <- data.frame( meanBLANKS.Master[!is.na(meanBLANKS.Master$ln_TotalLiveAlgaeLossRatio),] %>% 
                     dplyr::filter(!ln_TotalLiveAlgaeLossRatio < 0) %>% 
                     dplyr::group_by(Date, pH, Time_point) %>% 
                     dplyr::summarise(
                       meanBlank_ln_AlgaeLoss  = mean(ln_TotalLiveAlgaeLossRatio),
                       sdBlank_ln_AlgaeLoss    = sd(ln_TotalLiveAlgaeLossRatio),
                       seBlank_ln_AlgaeLoss    = sd(ln_TotalLiveAlgaeLossRatio) / sqrt(length(ln_TotalLiveAlgaeLossRatio)), 
                       meanBlank_ln_SestonLoss = mean(ln_SestonLossRatio),
                       sdBlank_ln_SestonLoss   = sd(ln_SestonLossRatio),
                       seBlank_ln_SestonLoss   = sd(ln_SestonLossRatio) / sqrt(length(ln_SestonLossRatio)), 
                       n= n())) 


write.csv(meanBLANKS.Summary, "C:/Users/samjg/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/FeedingRates/Blanks_Master.csv")

```



## 'A' Call the blank values for each trial - continued....

 - Call the blank value **specifically for the final timepoint** of the clearance rate trial(s)!
 - this value will be called in the for loop when calculating CR in following cluster(s)


```{r blank values, echo = T}
meanBLANKS.Summary$meanBlank_ln_AlgaeLoss
# 20210914 DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
AlgaeBlank_914_pH7.5 <- (meanBLANKS.Summary %>% dplyr::filter(Date %in% 20210914) %>% dplyr::filter(pH == 7.5) %>% dplyr::arrange(desc(Time_point)))$meanBlank_ln_AlgaeLoss[1]
AlgaeBlank_914_pH8.0  <- (meanBLANKS.Summary %>% dplyr::filter(Date %in% 20210914) %>% dplyr::filter(pH == 8) %>% dplyr::arrange(desc(Time_point)))$meanBlank_ln_AlgaeLoss[1]
SestonBlank_914_pH7.5 <- (meanBLANKS.Summary %>% dplyr::filter(Date %in% 20210914) %>% dplyr::filter(pH == 7.5) %>% dplyr::arrange(desc(Time_point)))$meanBlank_ln_SestonLoss[1]
SestonBlank_914_pH8.0 <- (meanBLANKS.Summary %>% dplyr::filter(Date %in% 20210914) %>% dplyr::filter(pH == 8) %>% dplyr::arrange(desc(Time_point)))$meanBlank_ln_SestonLoss[1]

# 20210930 DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
AlgaeBlank_930_pH7.5  <- (meanBLANKS.Summary %>% dplyr::filter(Date %in% 20210930) %>% dplyr::filter(pH == 7.5) %>% dplyr::arrange(desc(Time_point)))$meanBlank_ln_AlgaeLoss[1]
AlgaeBlank_930_pH8.0  <- (meanBLANKS.Summary %>% dplyr::filter(Date %in% 20210930) %>% dplyr::filter(pH == 8) %>% dplyr::arrange(desc(Time_point)))$meanBlank_ln_AlgaeLoss[1]
SestonBlank_930_pH7.5 <- (meanBLANKS.Summary %>% dplyr::filter(Date %in% 20210930) %>% dplyr::filter(pH == 7.5) %>% dplyr::arrange(desc(Time_point)))$meanBlank_ln_SestonLoss[2]
SestonBlank_930_pH8.0 <- (meanBLANKS.Summary %>% dplyr::filter(Date %in% 20210930) %>% dplyr::filter(pH == 8) %>% dplyr::arrange(desc(Time_point)))$meanBlank_ln_SestonLoss[1]

# 20211026 DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
AlgaeBlank_1026_pH7.5  <- (meanBLANKS.Summary %>% dplyr::filter(Date %in% 20211026) %>% dplyr::filter(pH == 7.5) %>% dplyr::arrange(desc(Time_point)))$meanBlank_ln_AlgaeLoss[1]
AlgaeBlank_1026_pH8.0  <- (meanBLANKS.Summary %>% dplyr::filter(Date %in% 20211026) %>% dplyr::filter(pH == 8) %>% dplyr::arrange(desc(Time_point)))$meanBlank_ln_AlgaeLoss[1]
SestonBlank_1026_pH7.5 <- (meanBLANKS.Summary %>% dplyr::filter(Date %in% 20211026) %>% dplyr::filter(pH == 7.5) %>% dplyr::arrange(desc(Time_point)))$meanBlank_ln_SestonLoss[2]
SestonBlank_1026_pH8.0 <- (meanBLANKS.Summary %>% dplyr::filter(Date %in% 20211026) %>% dplyr::filter(pH == 8) %>% dplyr::arrange(desc(Time_point)))$meanBlank_ln_SestonLoss[1]

# 
# # 20210914 DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Blank_914_pH7.5 <- (A_914_BlankMeans %>% dplyr::filter(pH == 7.5) %>% dplyr::arrange(desc(Time._min)))$meanBlank_ln_AlgaeLoss[1]
# Blank_914_pH8.0 <- (A_914_BlankMeans %>% dplyr::filter(pH == 8.0) %>% dplyr::arrange(desc(Time._min)))$meanBlank_ln_AlgaeLoss[1]
# 
# # 20210930 DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Blank_930_pH7.5 <- (A_930_BlankMeans %>% dplyr::filter(pH == 7.5) %>% dplyr::arrange(desc(Time._min)))$meanBlank_ln_AlgaeLoss[1]
# Blank_930_pH8.0 <- (A_930_BlankMeans %>% dplyr::filter(pH == 8.0) %>% dplyr::arrange(desc(Time._min)))$meanBlank_ln_AlgaeLoss[1]

```

## 20210914 Clearance Rate data 

```{r 20210914 CR, echo = T}

df_total.914              <- data.frame() # start dataframe 
for (i in 1:nrow(loop_914)) {
  dat <- FeedRate_Master.914 %>% 
    dplyr::filter(uniq_Identifier == loop_914[i,]) %>% 
    dplyr::arrange(minutes)
  C0_total_algae <- max(c(dat[1,]$total_algae, dat[2,]$total_algae)) # call the max number in the first two time points - allows for error 
  dat2 <- dat %>% 
    do(tail(., 2)) %>%
    #dplyr::mutate(diff = as.numeric(Time._min) - lag(as.numeric(Time._min), default = first(as.numeric(Time._min)))) %>% 
    dplyr::filter(total_algae %in% min(total_algae)) %>% 
    dplyr::mutate(Blank = if(pH == 7.5) AlgaeBlank_914_pH7.5 else AlgaeBlank_914_pH8.0 ) %>% 
    dplyr::mutate(TotalAlgaeLossRatio = C0_total_algae / as.numeric(total_algae) ) %>% 
    dplyr::filter(!TotalAlgaeLossRatio < 1) %>% 
    dplyr::mutate(ln_TotalAlgaeLossRatio = ln(TotalAlgaeLossRatio)) %>% 
   # dplyr::mutate(FeedingRate =  ( (25/1000) / (diff/60)  * # V / t == Volume of the vessel (in Liters as 25 ml / 1000 ml L-1) and t = time in hours as the diff between the interval sin minutes / 60 mins hour-1
   #                                   ( ln_AlgaeLossRatio ) / Length.um. ) ) %>% 
    dplyr::mutate(FeedingRate_L_hour_m = ( (25/1000) * # V / t == Volume of the vessel (in Liters as 25 ml / 1000 ml L-1) and t = time in hours as the diff between the interval sin minutes / 60 mins hour-1
                                       (( ln_TotalAlgaeLossRatio /  (as.numeric(minutes)/60) - Blank))) / (Length_um/1000000) ) %>% 
    dplyr::mutate(Time_period = paste( (dat[1,]$minutes),as.numeric(minutes), sep ='-'))
    dat2OM <- dat2 %>% dplyr::filter(!minutes == 0)
    
  if (nrow(dat2OM) > 0) {
    FeedRate.table           <- data.frame(matrix(nrow = nrow(dat2OM), ncol = 10)) # create dataframe to save cumunalitively during for loop
    colnames(FeedRate.table) <- c('Date', 'ID', 'pH', 'Replicate', 'Num','Run', 'Fed_Unfed', 'Time_period', 'TotalAlgaeLossRatio', 'FeedingRate_L_hour_mm') # names for comuns in the for loop
    
    FeedRate.table$Date                       <- dat2OM$Date
    FeedRate.table$ID                         <- loop_914[i,]
    FeedRate.table$pH                         <- gsub("_.*", "\\1", FeedRate.table$ID)
    FeedRate.table$Fed_Unfed                  <- NA
    FeedRate.table$Replicate                  <- gsub("^(?:[^_]+_){4}([^_]+).*", "\\1", FeedRate.table$ID)
    FeedRate.table$Num                        <- gsub("^(?:[^_]+_){6}([^_]+).*", "\\1", FeedRate.table$ID)
    FeedRate.table$Run                        <- gsub("^(?:[^_]+_){2}([^_]+).*", "\\1", FeedRate.table$ID)
    FeedRate.table$Time_period                <- dat2OM$Time_period
    FeedRate.table$TotalAlgaeLossRatio             <- dat2OM$TotalAlgaeLossRatio
    FeedRate.table$FeedingRate_L_hour_m <- dat2OM$FeedingRate_L_hour_m
    
    df       <- data.frame(FeedRate.table) # name dataframe for this single row
    df_total.914 <- rbind(df_total.914,df) #bind to a cumulative list dataframe
    #print(df_total.914) # print to monitor progress
  }
  else {}
}
df_total.914 <- df_total.914  %>% 
  dplyr::mutate(pCO2 = case_when(pH == 8.0 ~ "500 μatm", pH == 7.5 ~ "800 μatm")) %>% 
  dplyr::mutate(Chamber_tank = paste(Replicate, pH, sep = '_'))


FeedRates_914_Means <- df_total.914 %>% 
  #dplyr::filter(!FeedingRate_L_hour_meter %in% '-Inf') %>% 
  dplyr::group_by(pCO2) %>% 
  dplyr::summarise(
    meanCR = mean(FeedingRate_L_hour_m),
    sdCR   = sd(FeedingRate_L_hour_m), 
    seCR   = sd(FeedingRate_L_hour_m) / sqrt(length(FeedingRate_L_hour_m)), 
    n = n()) %>% 
  na.omit()

print(FeedRates_914_Means)
# summary(lmer(meanCR~pH+ (1|Time_period), data=FeedRates_914_Means))
# summary(aov(lm(meanCR~pH*Time_period, data=FeedRates_914_Means)))


# plot the replicates (visual diagnostics of random factor)
Resp914_FR <- ggboxplot(df_total.914, x = "pH", y = "FeedingRate_L_hour_m", color = "Replicate",
                              add = c("mean_se", "dotplot"),
                              palette = c("#00AFBB", "#E7B800", "brown", "grey"))
Resp914_FR


# Linear mixed-effects model
require(nlme)
# Linear mixed effects model with random effect of Replicate 
df_total.914$Chamber_tank <- paste(df_total.914$Replicate, df_total.914$pH, sep = "_" )
LMEmod_0914_FR<-lme(FeedingRate_L_hour_m ~ pH, random=~1|Chamber_tank, data=df_total.914)
# |     &nbsp;      | numDF | denDF | F-value | p-value  |
# |:---------------:|:-----:|:-----:|:-------:|:--------:|
# | **(Intercept)** |   1   |  16   |  69.39  | 3.27e-07 |
# |    **pCO2**     |   1   |   6   |  1.26   |  0.3046  |
pander(anova(LMEmod_0914_FR), style='rmarkdown') # anova table of lmer
kable(as.data.frame(anova(LMEmod_0914_FR))) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/FeedingRates/20210914_figs_tables/20210914_FR_LME_Table.png", zoom = 1.5)
pdf(paste0(filename = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/FeedingRates/20210914_figs_tables/20210914_FR_LME_Diagnostics.pdf"))
check_model(LMEmod_0914_FR) # print the model diagnostics 
dev.off()

# call the results of LMER to add to boxplot below 
DF   <- paste( (anova(LMEmod_0914_FR)[[1]])[2], (anova(LMEmod_0914_FR)[[2]])[2], sep = '/') # call DF
Fval <- (anova(LMEmod_0914_FR)[[3]])[2] # call f
pval <- (anova(LMEmod_0914_FR)[[4]])[2] # call p value


FR_914_boxplot <- df_total.914 %>% 
  ggplot(aes(pCO2 , FeedingRate_L_hour_m , fill = pCO2)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
  scale_fill_manual(values=c("white","grey50")) +
  geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=10)) +
  stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white") +
  ggtitle("Clearance Rate, F1 Scallops 20210914 (0-90 minutes)")
FR_914_boxplot


# Save plots :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

pdf(paste0("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/FeedingRates/20210914_figs_tables/2010914_FR_LME.pdf"))
ggarrange(FR_914_boxplot, Resp914_FR,
          labels = c("A", "B"),
          ncol = 1, nrow = 2)
dev.off()


```


## 20210930 Clearance Rate data 

```{r 20210930 CR, echo = T}


df_total.930              <- data.frame() # start dataframe 
for (i in 1:nrow(loop_930)) {
  dat <- FeedRate_Master.930 %>% 
    dplyr::filter(uniq_Identifier == loop_930[i,]) %>% 
    dplyr::arrange(minutes) # order by least to greatest (first to last flow cytometry measurement)
  C0_total_algae <- max(c(dat[1,]$total_algae, dat[2,]$total_algae)) # call the max number in the first two time points - allows for error 
  dat2 <- dat %>% 
    do(tail(., 2)) %>%
    #dplyr::mutate(diff = as.numeric(Time._min) - lag(as.numeric(Time._min), default = first(as.numeric(Time._min)))) %>% 
    dplyr::filter(total_algae %in% min(total_algae)) %>% 
    dplyr::mutate(Blank = if(pH == "7.5") AlgaeBlank_930_pH7.5 else AlgaeBlank_930_pH8.0 ) %>% 
    dplyr::mutate(TotalAlgaeLossRatio = C0_total_algae / as.numeric(total_algae) ) %>% 
    dplyr::filter(!TotalAlgaeLossRatio < 1) %>% 
    dplyr::mutate(ln_TotalAlgaeLossRatio = ln(TotalAlgaeLossRatio)) %>% 
   # dplyr::mutate(FeedingRate =  ( (25/1000) / (diff/60)  * # V / t == Volume of the vessel (in Liters as 25 ml / 1000 ml L-1) and t = time in hours as the diff between the interval sin minutes / 60 mins hour-1
   #                                   ( ln_AlgaeLossRatio ) / Length.um. ) ) %>% 
    dplyr::mutate(FeedingRate_L_hour_m = ( (25/1000) * # V / t == Volume of the vessel (in Liters as 25 ml / 1000 ml L-1) and t = time in hours as the diff between the interval sin minutes / 60 mins hour-1
                                       (( ln_TotalAlgaeLossRatio /  (as.numeric(minutes)/60) - Blank))) / (Length_um/1000000) ) %>% 
    dplyr::mutate(Time_period = paste( (dat[1,]$minutes),as.numeric(minutes), sep ='-'))
    dat2OM <- dat2 %>% dplyr::filter(!minutes == 0)
    
  if (nrow(dat2OM) > 0) {
    FeedRate.table           <- data.frame(matrix(nrow = nrow(dat2OM), ncol = 10)) # create dataframe to save cumunalitively during for loop
    colnames(FeedRate.table) <- c('Date', 'ID', 'pH', 'Replicate', 'Num','Run', 'Fed_Unfed', 'Time_period', 'TotalAlgaeLossRatio', 'FeedingRate_L_hour_mm') # names for comuns in the for loop
    
    FeedRate.table$Date                       <- dat2OM$Date
    FeedRate.table$ID                         <- loop_930[i,]
    FeedRate.table$pH                         <- gsub("_.*", "\\1", FeedRate.table$ID)
    FeedRate.table$Fed_Unfed                  <- dat2OM$Fed_Unfed
    FeedRate.table$Replicate                  <- gsub("^(?:[^_]+_){5}([^_]+).*", "\\1", FeedRate.table$ID)
    FeedRate.table$Num                        <- gsub("^(?:[^_]+_){6}([^_]+).*", "\\1", FeedRate.table$ID)
    FeedRate.table$Run                        <- gsub("^(?:[^_]+_){2}([^_]+).*", "\\1", FeedRate.table$ID)
    FeedRate.table$Time_period                <- dat2OM$Time_period
    FeedRate.table$TotalAlgaeLossRatio             <- dat2OM$TotalAlgaeLossRatio
    FeedRate.table$FeedingRate_L_hour_m <- dat2OM$FeedingRate_L_hour_m
    
    df       <- data.frame(FeedRate.table) # name dataframe for this single row
    df_total.930 <- rbind(df_total.930,df) #bind to a cumulative list dataframe
    #print(df_total.930) # print to monitor progress
  }
  else {}
}
df_total.930 <- df_total.930  %>% 
  dplyr::mutate(pCO2 = case_when(pH == 8.0 ~ "500 μatm", pH == 7.5 ~ "800 μatm"))


FeedRates_930_Means <- df_total.930 %>% 
  dplyr::filter(!FeedingRate_L_hour_m  < 0) %>% 
  dplyr::group_by(pCO2, Fed_Unfed) %>% 
  dplyr::summarise(
    meanCR = mean(FeedingRate_L_hour_m),
    sdCR   = sd(FeedingRate_L_hour_m), 
    seCR   = sd(FeedingRate_L_hour_m) / sqrt(length(FeedingRate_L_hour_m)), 
    n = n()) %>% 
  na.omit()
FeedRates_930_Means


# plot the replicates (visual diagnostics of random factor)
df_total.930$pHxFood   <- paste(df_total.930$pH, df_total.930$Fed_Unfed, sep = "_")
Resp930_FR <- ggboxplot(df_total.930, x = "pHxFood", y = "FeedingRate_L_hour_m", color = "Replicate",
                              add = c("mean_se", "dotplot"),
                              palette = c("#00AFBB", "#E7B800", "brown", "grey"))
Resp930_FR


# Linear mixed-effects model
require(nlme)
# Linear mixed effects model with random effect of Replicate 
df_total.930$Chamber_tank <- paste(df_total.930$Replicate, df_total.930$pH, sep = "_" )
LMEmod_0930_FR<-lme(FeedingRate_L_hour_m ~ pH * Fed_Unfed, random=~1|Chamber_tank, data=df_total.930)
# |      &nbsp;      | numDF | denDF | F-value |  p-value  |
# |:----------------:|:-----:|:-----:|:-------:|:---------:|
# | **(Intercept)**  |   1   |  60   |  52.27  | 1.014e-09 |
# |      **pH**      |   1   |   6   | 0.1085  |  0.7531   |
# |  **Fed_Unfed**   |   1   |  60   |  19.84  | 3.738e-05 |
# | **pH:Fed_Unfed** |   1   |  60   | 0.2207  |  0.6402   |
pander(anova(LMEmod_0930_FR), style='rmarkdown') # anova table of lmer
kable(as.data.frame(anova(LMEmod_0930_FR))) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/FeedingRates/20210930_figs_tables/20210930_FR_LME_Table.png", zoom = 1.5)
pdf(paste0(filename = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/FeedingRates/20210930_figs_tables/20210930_FR_LME_Diagnostics.pdf"))
check_model(LMEmod_0930_FR) # print the model diagnostics 
dev.off()

# call the results of LMER to add to boxplot below 
DF   <- paste( (anova(LMEmod_0930_FR)[[1]])[2], (anova(LMEmod_0930_FR)[[2]])[2], sep = '/') # call DF
Fval <- (anova(LMEmod_0930_FR)[[3]])[2] # call f
pval <- (anova(LMEmod_0930_FR)[[4]])[2] # call p value


FR_930_boxplot <- df_total.930 %>% 
  ggplot(aes(pCO2 , FeedingRate_L_hour_m , fill = pCO2)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
  scale_fill_manual(values=c("white","grey50")) +
  geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=10)) +
  stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white") +
  ggtitle("Clearance Rate, F1 Scallops 20210914 (0-90 minutes)") +
  facet_wrap(~Fed_Unfed)
FR_930_boxplot


# Save plots :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

pdf(paste0("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/FeedingRates/20210930_figs_tables/2010930_FR_LME.pdf"))
ggarrange(FR_930_boxplot, Resp930_FR,
          labels = c("A", "B"),
          ncol = 1, nrow = 2)
dev.off()
```


## 20211026 Clearance Rate data 

```{r 20211026 CR, echo = T}

df_total.1026              <- data.frame() # start dataframe 
for (i in 1:nrow(loop_1026)) {
  dat <- FeedRate_Master.1026 %>% 
    dplyr::filter(uniq_Identifier == loop_1026[i,]) %>% 
    dplyr::arrange(minutes)
  C0_total_algae <- max(c(dat[1,]$total_algae, dat[2,]$total_algae)) # call the max number in the first two time points - allows for error 
  dat2 <- dat %>% 
    do(tail(., 2)) %>%
    #dplyr::mutate(diff = as.numeric(Time._min) - lag(as.numeric(Time._min), default = first(as.numeric(Time._min)))) %>% 
    dplyr::filter(total_algae %in% min(total_algae)) %>% 
    dplyr::mutate(Blank = if(pH == 7.5) AlgaeBlank_1026_pH7.5 else AlgaeBlank_1026_pH8.0 ) %>% 
    dplyr::mutate(TotalAlgaeLossRatio = C0_total_algae / as.numeric(total_algae) ) %>% 
    dplyr::filter(!TotalAlgaeLossRatio < 1) %>% 
    dplyr::mutate(ln_TotalAlgaeLossRatio = ln(TotalAlgaeLossRatio)) %>% 
   # dplyr::mutate(FeedingRate =  ( (25/1000) / (diff/60)  * # V / t == Volume of the vessel (in Liters as 25 ml / 1000 ml L-1) and t = time in hours as the diff between the interval sin minutes / 60 mins hour-1
   #                                   ( ln_AlgaeLossRatio ) / Length.um. ) ) %>% 
    dplyr::mutate(FeedingRate_L_hour_m = ( (25/1000) * # V / t == Volume of the vessel (in Liters as 25 ml / 1000 ml L-1) and t = time in hours as the diff between the interval sin minutes / 60 mins hour-1
                                       (( ln_TotalAlgaeLossRatio /  (as.numeric(minutes)/60) - Blank))) / (Length_um/1000000) ) %>% 
    dplyr::mutate(Time_period = paste( (dat[1,]$minutes),as.numeric(minutes), sep ='-'))
    dat2OM <- dat2 %>% dplyr::filter(!minutes == 0)
    
  if (nrow(dat2OM) > 0) {
    FeedRate.table           <- data.frame(matrix(nrow = nrow(dat2OM), ncol = 10)) # create dataframe to save cumunalitively during for loop
    colnames(FeedRate.table) <- c('Date', 'ID', 'pH', 'Replicate', 'Num','Run', 'Fed_Unfed', 'Time_period', 'TotalAlgaeLossRatio', 'FeedingRate_L_hour_mm') # names for comuns in the for loop
    
    FeedRate.table$Date                       <- dat2OM$Date
    FeedRate.table$ID                         <- loop_1026[i,]
    FeedRate.table$pH                         <- gsub("_.*", "\\1", FeedRate.table$ID)
    FeedRate.table$Fed_Unfed                  <- dat2OM$Fed_Unfed
    FeedRate.table$Replicate                  <- gsub("^(?:[^_]+_){5}([^_]+).*", "\\1", FeedRate.table$ID)
    FeedRate.table$Num                        <- gsub("^(?:[^_]+_){6}([^_]+).*", "\\1", FeedRate.table$ID)
    FeedRate.table$Run                        <- gsub("^(?:[^_]+_){2}([^_]+).*", "\\1", FeedRate.table$ID)
    FeedRate.table$Time_period                <- dat2OM$Time_period
    FeedRate.table$TotalAlgaeLossRatio             <- dat2OM$TotalAlgaeLossRatio
    FeedRate.table$FeedingRate_L_hour_m <- dat2OM$FeedingRate_L_hour_m
    
    df       <- data.frame(FeedRate.table) # name dataframe for this single row
    df_total.1026 <- rbind(df_total.1026,df) #bind to a cumulative list dataframe
    #print(df_total.1026) # print to monitor progress
  }
  else {}
}
df_total.1026 <- df_total.1026  %>% 
  dplyr::mutate(pCO2 = case_when(pH == 8.0 ~ "500 μatm", pH == 7.5 ~ "800 μatm"))


FeedRates_1026_Means <- df_total.1026 %>% 
  dplyr::filter(!FeedingRate_L_hour_m  < 0) %>% 
  dplyr::group_by(pCO2, Fed_Unfed) %>% 
  dplyr::summarise(
    meanCR = mean(FeedingRate_L_hour_m),
    sdCR   = sd(FeedingRate_L_hour_m), 
    seCR   = sd(FeedingRate_L_hour_m) / sqrt(length(FeedingRate_L_hour_m)), 
    n = n()) %>% 
  na.omit()
FeedRates_1026_Means

# plot the replicates (visual diagnostics of random factor)
df_total.1026$pHxFood   <- paste(df_total.1026$pH, df_total.1026$Fed_Unfed, sep = "_")
Resp1026_FR <- ggboxplot(df_total.1026, x = "pHxFood", y = "FeedingRate_L_hour_m", color = "Replicate",
                              add = c("mean_se", "dotplot"),
                              palette = c("#00AFBB", "#E7B800", "brown", "grey"))
Resp1026_FR


# Linear mixed-effects model
require(nlme)
# Linear mixed effects model with random effect of Replicate 
df_total.1026$Chamber_tank <- paste(df_total.1026$Replicate, df_total.1026$pH, sep = "_" )
LMEmod_1026_FR<-lme(FeedingRate_L_hour_m ~ pH * Fed_Unfed, random=~1|Chamber_tank, data=df_total.1026)
# |      &nbsp;      | numDF | denDF | F-value |  p-value  |
# |:----------------:|:-----:|:-----:|:-------:|:---------:|
# | **(Intercept)**  |   1   |  24   |  60.53  | 5.152e-08 |
# |      **pH**      |   1   |   6   | 0.03345 |  0.8609   |
# |  **Fed_Unfed**   |   1   |  24   |  53.45  | 1.497e-07 |
# | **pH:Fed_Unfed** |   1   |  24   | 0.02382 |  0.8786   |
pander(anova(LMEmod_1026_FR), style='rmarkdown') # anova table of lmer
kable(as.data.frame(anova(LMEmod_1026_FR))) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/FeedingRates/20211026_figs_tables/20211026_FR_LME_Table.png", zoom = 1.5)
pdf(paste0(filename = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/FeedingRates/20211026_figs_tables/20211026_FR_LME_Diagnostics.pdf"))
check_model(LMEmod_1026_FR) # print the model diagnostics 
dev.off()


FR_1026_boxplot <- df_total.1026 %>% 
  ggplot(aes(pCO2 , FeedingRate_L_hour_m , fill = pCO2)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
  scale_fill_manual(values=c("white","grey50")) +
  geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=10)) +
  stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white") +
  ggtitle("Clearance Rate, F1 Scallops 20210914 (0-90 minutes)") +
  facet_wrap(~Fed_Unfed)
FR_1026_boxplot


# Save plots :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

pdf(paste0("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/FeedingRates/20211026_figs_tables/2011026_FR_LME.pdf"))
ggarrange(FR_1026_boxplot, Resp1026_FR,
          labels = c("A", "B"),
          ncol = 1, nrow = 2)
dev.off()

```


``` {r CR master file write csv, echo = FALSE}

# write csv ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
df_total.914 <- df_total.914 %>% dplyr::mutate(pHxFood = "none") %>%  dplyr::mutate(Fed_Unfed = "fed") # make te column to maetch and rbind below 
All_FR_Master <- rbind(df_total.914, df_total.930, df_total.1026)


FR_MasterSumTab <- All_FR_Master %>% 
  dplyr::filter(!FeedingRate_L_hour_m < 0) %>%
  Rmisc::summarySE(measurevar="FeedingRate_L_hour_m", groupvars=c("Date", "pCO2", "Fed_Unfed"))   %>% 
  dplyr::mutate(Age = case_when(Date == "20210914" ~ 50, Date == "20210930" ~ 64,Date == "20211026" ~ 92)) %>%
  replace_na(list(Fed_Unfed = 'High food')) # replaces the NAs for 20210914 Fed_Unfed as 'High food' - this was before split for the food deprivation  

## Use geom_line and geom_point to plot over time
FR_TotalAlgae_geomline <-ggplot(data=FR_MasterSumTab, aes(x=Age, y=FeedingRate_L_hour_m, color=pCO2)) +
                            geom_line(aes(linetype = factor(Fed_Unfed)), size = 0.5) +  
                            geom_point()+ 
                            scale_color_manual(values=c("forestgreen","darkorange2"))+
                            geom_errorbar(aes(ymin=FeedingRate_L_hour_m-se, ymax=FeedingRate_L_hour_m+se), width=.2,
                                          position=position_dodge(.1))+
                            theme_bw() +  
                            theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                            scale_x_continuous(name ="Age (days)") +
                            labs(title = "Feeding rate; F1 Scallops (juveniles) FoodxOAexperiment", 
                                  y = expression(Feeding~rate~"("~live~cells~L^{-1}%.%m^{-1}%.%hr^{-1}~")")) +
                            scale_linetype_manual(values = c("fed" = "solid", "unfed" = "dashed"))  +
                            theme(legend.position="none") +
                            # facet_wrap(~factor(Fed_Unfed, level = c('Low food', 'High food'))) 
                            facet_wrap(~pCO2)

#pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/Respiration/Juvenile_respiration_FoodxOA.pdf"))
pdf(paste0("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/FeedingRates/Juvenile_FeedingRate_FoodxOA.pdf"))
FR_TotalAlgae_geomline
dev.off()


```
