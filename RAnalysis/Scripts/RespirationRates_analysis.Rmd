---
  title: "Respiration Analysis F1 Scallops 2021"
author: "Samuel Gurr"
date: "1/29/2023"
output:
  html_document:
  df_print: paged
pdf_document:
  latex_engine: xelatex
---
  
  
```{r setup, include=FALSE}

# LOAD PACKAGES :::::::::::::::::::::::::::::::::::::::::::::::::::::::

library(dplyr)
library(ggplot2)
library(forcats)
library(lme4)
library(lmerTest)
library(see)
library(performance)
library(car)
library(kableExtra)
library(pander)
library(data.table)
library(stringr)
library(latex2exp)
library(Rmisc)
# library(devtools)
library(ggpubr)
library(hrbrthemes)
library(nlme)
# SET WORKING DIRECTORY :::::::::::::::::::::::::::::::::::::::::::::::

setwd("C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis") # personal computer

# Resp.Master_OM    <- read.csv(file="C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Respiration/Calculated_Resp_Master.csv", header=T) # personnel computer 
Resp.Master  <- read.csv(file="C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Respiration/Calculated_Resp_Master.csv", header=T) # work computer
```



# Analysis 





# 9/14/2021 F1 juvenile scallops (50 DPF; Day 0)

**About**

- two pCO2 treatments 

- **before** we culled and started the food limitation trials

#### number of replicates for analysis...

```{r Day 0 replicates and mean resp, echo=FALSE}

# model effect of treatment on resp rate 20210507
Resp_0914 <- Resp.Master %>% 
              dplyr::filter(Date %in% '9/14/2021')  %>% # call only 9/14
              dplyr::filter(!Chamber_tank  %in% 'blank')

Resp_0914 %>% dplyr::group_by(Chamber_tank) %>% dplyr::summarise(n()) # tank replication
# 7.5_A	3			
# 7.5_B	3			
# 7.5_C	3			
# 7.5_D	3			
# 8_A	2	   *2 rep			
# 8_B	3			
# 8_C	2		 *2 rep	
# 8_D	2	   *2 rep

Resp_0914 %>% summarySE(measurevar="resp_umol_hr_bFactorNormLength", groupvars=c("pCO2"))



```

### 9/14/2021 linear model, diagnostics, and plots

```{r Day 0 b factor ALL, echo=TRUE, message = FALSE, warning = FALSE}

# Objective: run AOV and LME for the data, rationale being that we have mutliple samples per replicate tank
# thus important that we address this random effect. Performing AOV and LME allows us to run model selection using AIC 
# to determine the model with the better fit 



# b FACTOR ALL ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# note: day 0 of initiating the food treatment thus ONLY b factor ALL is used in this chuck for 9/14



# plot the replicates (visual diagnostics of random factor)
Resp_0914 %>% summarySE(measurevar="resp_umol_hr_bFactorNormLength", groupvars=("pCO2"))
Resp914_bLengthALL_reps<- ggboxplot(Resp_0914, 
                                    x = "pCO2", 
                                    y = "resp_umol_hr_bFactorNormLength", 
                                    color = "Replicate",
                              add = c("mean_se", "dotplot"),
                              palette = c("#00AFBB", "#E7B800", "brown", "grey"))
Resp914_bLengthALL_reps

# One-way ANOVA (without the random effect) 
AOV914.bfactALL <- aov(resp_umol_hr_bFactorNormLength ~ 
                       pCO2, 
                     data=Resp_0914) # run mod
# check model assumptions
shapiro.test(residuals(AOV914.bfactALL)) # normal - 0.6853
leveneTest(AOV914.bfactALL) # homogeneity of variance (equal variance) - 0.4684
# all is good, lets see the results
pander(anova(AOV914.bfactALL), style='rmarkdown') # anova table of lm
# |    &nbsp;     | Df |  Sum Sq   |  Mean Sq  | F value | Pr(>F) |
# |:-------------:|:--:|:---------:|:---------:|:-------:|:------:|
# |   **pCO2**    | 1  | 0.0006111 | 0.0006111 | 0.5286  | 0.476  |
# | **Residuals** | 19 |  0.02197  | 0.001156  |   NA    |   NA   |
# output results 
kable(data.frame(unclass(summary(AOV914.bfactALL)), 
                   check.names = FALSE, 
                   stringsAsFactors = FALSE)  ) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Respiration/20210914_figs_tables/20210914_AOV_RR_bfactor_ALL.png", zoom = 1.5)

# Linear mixed effects model with random effect of Replicate 
LME914.bfactALL<-lme(resp_umol_hr_bFactorNormLength.ALL ~ 
                     pCO2, 
                     random=~1|Chamber_tank, # with the random effect as an LME model (Chamber_tank = replicate as 7.5_A, 7.5_B)
                     data=Resp_0914) 
# check model assumptions
shapiro.test(residuals(LME914.bfactALL)) # normal - 0.9466
leveneTest(residuals(LME914.bfactALL) ~ Resp_0914$pCO2) # 0.2723 
# all is good, lets see the results
pander(anova(LME914.bfactALL), style='rmarkdown') # anova table of lmer
# |     &nbsp;      | numDF | denDF | F-value |  p-value  |
# |:---------------:|:-----:|:-----:|:-------:|:---------:|
# | **(Intercept)** |   1   |  13   |  48.14  | 1.024e-05 |
# |    **pCO2**     |   1   |   6   | 0.02091 |  0.8898   |
# output results 
kable(as.data.frame(anova(LME914.bfactALL))) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Respiration/20210914_figs_tables/20210914_LME_RR_bfactor_ALL.png", zoom = 1.5)

# AIC model selection
pander(AIC(LME914.bfactALL, AOV914.bfactALL), style='rmarkdown') # anova table of lmer
# |       &nbsp;        | df |  AIC   |
# |:-------------------:|:--:|:------:|
# | **LME914.bfactALL** | 4  | -58.44 |
# | **AOV914.bfactALL** | 3  | -70.3  |  # for negative AIC, the lower the AIC the best fit the model - the simple AOV is better 

# plot
Resp914_Length <- ggplot(Resp_0914, 
                         aes(x = factor(pCO2, level = c('500 μatm', '800 μatm')), 
                             resp_umol_hr_bFactorNormLength , 
                             fill = pCO2)) +
                    theme(panel.grid=element_blank()) +
                    geom_boxplot(size=0.2, width=0.5, alpha=0.1, aes(fill=pCO2)) +
                    scale_fill_manual(values=c("white","grey50")) +
                    geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
                    theme_classic() +
                    scale_x_discrete(labels= c('~500 μatm', '~800 μatm')) +
                   # scale_y_continuous(expand = c(0, 0), limits = c(0, 2)) +
                    labs(title = "F1 Scallops: respiration rates on 20210914 (b factor 2.13)", 
                         y = expression(Respiration~rate~"("~μmol~L^{-1}~O[2]%.%mm~shell~length^{-1}%.% hr^{-1}~")"),
                         x = expression(italic(p)*CO[2]~Treatment~"("~μ*atm~")")) + 
                    theme(axis.text=element_text(size=8),
                          axis.title=element_text(size=8,face="bold")) +
                     stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white") 
Resp914_Length # print this figure...


# Export the figures to pdf
ggarrange(Resp914_Length,Resp914_bLengthALL_reps,nrow = 2) %>%
  ggexport(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Respiration/20210914_figs_tables/20210914_RR_bfactor_ALL.pdf")

```








# 9/30/2021 F1 juvenile scallops (64 DPF; Day 14)

**About**

- two pCO2 treatments 

- *before* we culled and started the food limitation trials

#### number of replicates for analysis...

```{r Day 14 replicates, echo=FALSE}

Resp_0930 <- Resp.Master %>% 
  dplyr::filter(Date %in% '9/30/2021')  %>% # call only 9/14
  dplyr::mutate(pHxFood = paste(pH,Fed_Unfed, sep = "_")) %>% 
  dplyr::mutate(random_fact = as.factor(paste(Chamber_tank, Fed_Unfed, sep="_")))

kable(Resp_0930 %>% dplyr::group_by(Chamber_tank, Food) %>% dplyr::summarise(n())) # tank replication - lowest value was 2 for 7.5_D unfed

Resp_0930 %>% summarySE(measurevar="resp_umol_hr_bFactorNormLength", groupvars=c("pCO2"))


```

### Statistical models

```{r Day 14 Stats b factor, echo=TRUE, message = FALSE, warning = FALSE}

# Objective: run AOV and LME for the data, rationale being that we have mutliple samples per replicate tank
# thus important that we address this random effect. Performing AOV and LME allows us to run model selection using AIC 
# to determine the model with the better fit 


# NOTE: 
# this chunk demonstrates that our data is non-normally distributed, thus we will need 
# to either transform to resolve or resort to a nonparametric test
# given we have a two-way factorial design (in our simple linear model) we can use the Scheirer-Ray-Hare Test 
# https://rcompanion.org/handbook/F_14.html
library(rcompanion) # install.packages('rcompanion')
library(FSA)
install.packages('FSA')









# b FACTOR ALL  'resp_umol_hr_bFactorNormLength.ALL' ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# note: day 0 of initiating the food treatment thus ONLY b factor ALL is used in this chuck for 9/14

# Visualize the data with the random effect of tank replicate 
Resp930_bLengthALL_reps <- ggboxplot(Resp_0930, 
                                 x = "pHxFood", 
                                 y = "resp_umol_hr_bFactorNormLength", 
                                 color = "Replicate",
          add = c("mean_se", "dotplot"),
          palette = c("#00AFBB", "#E7B800", "brown", "grey"))
Resp930_bLengthALL_reps

# One-way ANOVA (without the random effect) 
AOV930.bfactALL <- aov(resp_umol_hr_bFactorNormLength ~ 
                       pCO2 * Fed_Unfed, 
                     data=Resp_0930) # run mod
# check model assumptions
shapiro.test(residuals(AOV930.bfactALL)) # non-normal - 0.0001165
leveneTest(AOV930.bfactALL) # homogeneity of variance (equal variance) - 0.354
pander(aov(AOV930.bfactALL), style='rmarkdown') # table for anova test
# |       &nbsp;       | Df |  Sum Sq   |  Mean Sq  | F value | Pr(>F) |
# |:------------------:|:--:|:---------:|:---------:|:-------:|:------:|
# |      **pCO2**      | 1  |  0.00456  |  0.00456  |  3.061  | 0.0852 |
# |   **Fed_Unfed**    | 1  | 0.002573  | 0.002573  |  1.727  | 0.1937 |
# | **pCO2:Fed_Unfed** | 1  | 0.0008976 | 0.0008976 | 0.6027  | 0.4406 |
# |   **Residuals**    | 61 |  0.09085  | 0.001489  |   NA    |   NA   |
SRH930.bfactALL <- scheirerRayHare(resp_umol_hr_bFactorNormLength ~ 
                       pCO2 * Fed_Unfed, 
                     data=Resp_0930) # run mod
# all is good, lets see the results
pander(print(SRH930.bfactALL), style='rmarkdown') # table for SRH test
# |       &nbsp;       | Df | Sum Sq |   H    | p.value |
# |:------------------:|:--:|:------:|:------:|:-------:|
# |      **pCO2**      | 1  | 305.7  | 0.8551 | 0.3551  |
# |   **Fed_Unfed**    | 1  |  1167  | 3.264  | 0.07083 |
# | **pCO2:Fed_Unfed** | 1  | 411.5  | 1.151  | 0.2833  |
# |   **Residuals**    | 61 | 20974  |   NA   |   NA    |
# output results 
kable(data.frame(unclass(print(SRH930.bfactALL)), 
                   check.names = FALSE, 
                   stringsAsFactors = FALSE)  ) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Respiration/20210930_figs_tables/20210930_SRH_RR_bfactor_ALL.png", zoom = 1.5)

# Linear mixed effects model with random effect of Replicate 
LME930.bfactALL<-lme(resp_umol_hr_bFactorNormLength ~ 
                     pCO2*Fed_Unfed, 
                     random=~1|Chamber_tank, # with the random effect as an LME model (Chamber_tank = replicate as 7.5_A, 7.5_B)
                     data=Resp_0930) 
# check model assumptions
shapiro.test(residuals(LME930.bfactALL)) # non-normal - 0.0003778 
leveneTest(residuals(LME930.bfactALL) ~ Resp_0930$pCO2) # 0.1021 
leveneTest(residuals(LME930.bfactALL) ~ Resp_0930$Fed_Unfed) # 0.8869 
# AIC model selection
pander(AIC(AOV930.bfactALL, LME930.bfactALL), style='rmarkdown') # anova table of lmer
# |       &nbsp;        | df |  AIC   |
# |:-------------------:|:--:|:------:|
# | **AOV930.bfactALL** | 5  | -232.8 |
# | **LME930.bfactALL** | 6  | -201.3 |



# In summary, we looked at our non-normal LME and AOV and again found the simple model outweighs the variance 
# explained when the random factor was addressedin the LME, thus we will moved forward with the simple model 
# as opposed to transforming the data, used the Scheirer-Ray-Hare Test as a nonparametric two-factor test 
# the outcome of which did not change relative to the non-normal AOV 
# result: report the SRH test 

# food supply diff - report this percent difference alonside the significant effect
Resp_0930 %>% summarySE(measurevar="resp_umol_hr_bFactorNormLength", groupvars="Fed_Unfed")
perc_diff <- (0.10504454 - 0.08012453)/0.10504454*100
perc_diff #23.72328 %


# plot
Resp930_Length <- ggplot(Resp_0930, 
                         aes(x = factor(pCO2, level = c('500 μatm', '800 μatm')), 
                             resp_umol_hr_bFactorNormLength , 
                             fill = pCO2)) +
                    theme(panel.grid=element_blank()) +
                    geom_boxplot(size=0.2, width=0.5, alpha=0.1, aes(fill=pCO2)) +
                    scale_fill_manual(values=c("white","grey50")) +
                    geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
                    theme_classic() +
                    scale_x_discrete(labels= c('~500 μatm', '~800 μatm')) +
                   # scale_y_continuous(expand = c(0, 0), limits = c(0, 2)) +
                    labs(title = "F1 Scallops: respiration rates on 20210930 (b factor 2.0)", 
                         y = expression(Respiration~rate~"("~μmol~L^{-1}~O[2]%.%mm~shell~length^{-1}%.% hr^{-1}~")"),
                         x = expression(italic(p)*CO[2]~Treatment~"("~μ*atm~")")) + 
                    theme(axis.text=element_text(size=8),
                          axis.title=element_text(size=8,face="bold")) +
                    stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white") + 
                    facet_wrap(~Fed_Unfed)  
Resp930_Length # print this figure...


# Export the figures to pdf
ggarrange(Resp930_Length,Resp930_bLengthALL_reps,nrow = 2) %>%
  ggexport(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Respiration/20210930_figs_tables/20210930_RR_bfactor_ALL.pdf")





```

### density plot - Day 64; b factor all 

```{r, Day 14 density plot - b factor ALL}
library(dplyr)
library(tidyr)
Resp_0930$pHxFood <- as.factor(Resp_0930$pHxFood)

df_mean <- Resp_0930 %>% 
  dplyr::group_by(pHxFood) %>% 
  dplyr::summarize(average = mean(resp_umol_hr_bFactorNormLength)) %>%
  dplyr::ungroup()
p.box <- ggplot(Resp_0930, aes(x = pHxFood, y = resp_umol_hr_bFactorNormLength)) + geom_boxplot() + geom_point(data= df_mean, mapping = aes(x = pHxFood, y = average),
             color="red") 
p.box.data <- layer_data(p.box) %>%
  select(x, ymin, lower, middle, upper, ymax, outliers, flipped_aes) %>%
  dplyr::rename(mean = flipped_aes) %>% 
  dplyr::mutate(mean  = df_mean$average) %>% 
  mutate(pHxFood = factor(x, labels = levels(Resp_0930$pHxFood), ordered = TRUE)) %>%
  select(-x)


p.box.data %>% unnest(outliers)

library(tidyverse)
denisty_box_resp_64DPF <-ggplot(p.box.data) +
                            # manually plot flipped boxplot
                            geom_segment(aes(x = ymin, xend = ymax, y = -0.15, yend = -0.15)) +
                            geom_rect(aes(xmin = lower, xmax = upper, ymin = -0.3, ymax = 0,  fill = pHxFood),color = "black") +
                            # geom_point(data = . %>% unnest(outliers), aes(x = outliers, y = -0.15), color = "grey60", size = 1) +
                            # vertical lines at Q1 / Q2 / Q3
                            geom_vline(data = . %>% select(pHxFood, lower, mean, upper) %>% gather(key, value, -pHxFood), aes(xintercept = value)) +
                            # density plot
                            geom_density(data = Resp_0930, aes(x = resp_umol_hr_bFactorNormLength, group=pHxFood, fill=pHxFood, ..scaled..), alpha=.4, adjust=1.5) +
                            #  theme
                            theme_classic() +
                            xlim(0, 0.22) +
                            facet_grid(pHxFood ~ .) +
                            theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "none", plot.title = element_text(size=10))+
                            labs(title = "F1 Scallops: respiration rates 64 DPF - b factor ALL", 
                                 x = expression(Respiration~rate~"("~μmol~L^{-1}~O[2]%.%mm^{-1}~shell~length%.% hr^{-1}~")"),
                                 y = "Scaled density") +
                            scale_fill_manual(values=c("grey40", "grey40", "grey85", "grey85"))
denisty_box_resp_64DPF


pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Respiration/20210930_figs_tables/20210930_RRbfactorALL_density_plot.pdf"), width = 5, height = 5)
denisty_box_resp_64DPF # print the model diagnostics 
dev.off()

```










# 10/26/2021 F1 juvenile scallops  (92 DPF; Day 42)

**About**

- two pCO2 treatments 

- *before* we culled and started the food limitation trials


#### number of replicates for analysis...

```{r Day 42 replicates, echo=FALSE}

Resp_1026 <- Resp.Master %>% 
  dplyr::filter(Date %in% '10/26/2021')  %>% # call only 10/14
  dplyr::mutate(pHxFood = paste(pH,Fed_Unfed, sep = "_")) %>% 
  dplyr::mutate(random_fact = as.factor(paste(Chamber_tank, Fed_Unfed, sep="_")))

kable(Resp_1026 %>% dplyr::group_by(Chamber_tank, Fed_Unfed) %>% dplyr::summarise(n())) # tank replication

Resp_1026 %>% summarySE(measurevar="resp_umol_hr_bFactorNormLength", groupvars=c("pCO2","Fed_Unfed"))


```

## Statistical models

```{r Day 42 Stats b factor, echo=TRUE, message = FALSE, warning = FALSE}


# Objective: run AOV and LME for the data, rationale being that we have mutliple samples per replicate tank
# thus important that we address this random effect. Performing AOV and LME allows us to run model selection using AIC 
# to determine the model with the better fit 


# NOTE: 
# this chunk demonstrates that our data is non-normally distributed, thus we will need 
# to either transform to resolve or resort to a nonparametric test
# given we have a two-way factorial design (in our simple linear model) we can use the Scheirer-Ray-Hare Test 
# https://rcompanion.org/handbook/F_14.html
library(rcompanion) # install.packages('rcompanion')
library(FSA)
install.packages('FSA')









# b FACTOR ALL  'resp_umol_hr_bFactorNormLength.ALL' ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# note: day 0 of initiating the food treatment thus ONLY b factor ALL is used in this chuck for 9/14

# Visualize the data with the random effect of tank replicate 
Resp1026_bLengthALL_reps <- ggboxplot(Resp_1026, 
                                 x = "pHxFood", 
                                 y = "resp_umol_hr_bFactorNormLength", 
                                 color = "Replicate",
          add = c("mean_se", "dotplot"),
          palette = c("#00AFBB", "#E7B800", "brown", "grey"))
Resp1026_bLengthALL_reps

# One-way ANOVA (without the random effect) 
AOV1026.bfactALL <- aov(resp_umol_hr_bFactorNormLength ~ 
                       pCO2 * Fed_Unfed, 
                     data=Resp_1026) # run mod
# check model assumptions
shapiro.test(residuals(AOV1026.bfactALL)) # normal - .8932
leveneTest(AOV1026.bfactALL) # homogeneity of variance (equal variance) - 0.1017
pander(aov(AOV1026.bfactALL), style='rmarkdown') # table for anova test
# |       &nbsp;       | Df |  Sum Sq   |  Mean Sq  | F value |  Pr(>F)  |
# |:------------------:|:--:|:---------:|:---------:|:-------:|:--------:|
# |      **pCO2**      | 1  | 6.793e-05 | 6.793e-05 | 0.4361  |  0.5144  |
# |   **Fed_Unfed**    | 1  | 0.003074  | 0.003074  |  19.74  | 0.000127 |
# | **pCO2:Fed_Unfed** | 1  | 2.537e-06 | 2.537e-06 | 0.01628 |  0.8994  |
# |   **Residuals**    | 28 | 0.004361  | 0.0001558 |   NA    |    NA    |
SRH1026.bfactALL <- scheirerRayHare(resp_umol_hr_bFactorNormLength ~ 
                       pCO2 * Fed_Unfed, 
                     data=Resp_1026) # run mod
# all is good, lets see the results
pander(print(SRH1026.bfactALL), style='rmarkdown') # table for SRH test
# |       &nbsp;       | Df | Sum Sq |   H    | p.value |
# |:------------------:|:--:|:------:|:------:|:-------:|
# |      **pCO2**      | 1  | 35.19  | 0.4854 |  0.486  |
# |   **Fed_Unfed**    | 1  | 204.4  | 2.819  | 0.09317 |
# | **pCO2:Fed_Unfed** | 1  | 17.19  | 0.2371 | 0.6263  |
# |   **Residuals**    | 25 |  1789  |   NA   |   NA    |
# output results 
kable(data.frame(unclass(print(SRH1026.bfactALL)), 
                   check.names = FALSE, 
                   stringsAsFactors = FALSE)  ) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Respiration/20211026_figs_tables/20211026_SRH_RR_bfactor_ALL.png", zoom = 1.5)



# In summary, we looked at our non-normal LME and AOV and again found the simple model outweighs the variance 
# explained when the random factor was addressedin the LME, thus we will moved forward with the simple model 
# as opposed to transforming the data, used the Scheirer-Ray-Hare Test as a nonparametric two-factor test 
# the outcome of which did not change relative to the non-normal AOV 
# result: report the SRH test 


# plot
Resp1026_Length <- ggplot(Resp_1026, 
                         aes(x = factor(pCO2, level = c('500 μatm', '800 μatm')), 
                             resp_umol_hr_bFactorNormLength , 
                             fill = pCO2)) +
                    theme(panel.grid=element_blank()) +
                    geom_boxplot(size=0.2, width=0.5, alpha=0.1, aes(fill=pCO2)) +
                    scale_fill_manual(values=c("white","grey50")) +
                    geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
                    theme_classic() +
                    scale_x_discrete(labels= c('~500 μatm', '~800 μatm')) +
                   # scale_y_continuous(expand = c(0, 0), limits = c(0, 2)) +
                    labs(title = "F1 Scallops: respiration rates on 202101026 (b factor 2.0)", 
                         y = expression(Respiration~rate~"("~μmol~L^{-1}~O[2]%.%mm~shell~length^{-1}%.% hr^{-1}~")"),
                         x = expression(italic(p)*CO[2]~Treatment~"("~μ*atm~")")) + 
                    theme(axis.text=element_text(size=8),
                          axis.title=element_text(size=8,face="bold")) +
                    stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white") + 
                    facet_wrap(~Fed_Unfed)  
Resp1026_Length # print this figure...


# Export the figures to pdf
ggarrange(Resp1026_Length,Resp1026_bLengthALL_reps,nrow = 2) %>%
  ggexport(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Respiration/20211026_figs_tables/202101026_RR_bfactor_ALL.pdf")


```


### density plot - Day 92; b factor all 

```{r, Day 42 density respiration plot }
library(dplyr)
library(tidyr)
Resp_1026$pHxFood <- as.factor(Resp_1026$pHxFood)

df_mean <- Resp_1026 %>% 
  dplyr::group_by(pHxFood) %>% 
  dplyr::summarize(average = mean(resp_umol_hr_bFactorNormLength)) %>%
  dplyr::ungroup()
p.box <- ggplot(Resp_1026, aes(x = pHxFood, y = resp_umol_hr_bFactorNormLength)) + geom_boxplot() + geom_point(data= df_mean, mapping = aes(x = pHxFood, y = average),
             color="red") 
p.box.data <- layer_data(p.box) %>%
  select(x, ymin, lower, middle, upper, ymax, outliers, flipped_aes) %>%
  dplyr::rename(mean = flipped_aes) %>% 
  dplyr::mutate(mean  = df_mean$average) %>% 
  mutate(pHxFood = factor(x, labels = levels(Resp_1026$pHxFood), ordered = TRUE)) %>%
  select(-x)


p.box.data %>% unnest(outliers)

library(tidyverse)
denisty_box_resp_92DPF <-ggplot(p.box.data) +
                            # manually plot flipped boxplot
                            geom_segment(aes(x = ymin, xend = ymax, y = -0.15, yend = -0.15)) +
                            geom_rect(aes(xmin = lower, xmax = upper, ymin = -0.3, ymax = 0,  fill = pHxFood),color = "black") +
                            # geom_point(data = . %>% unnest(outliers), aes(x = outliers, y = -0.15), color = "grey60", size = 1) +
                            # vertical lines at Q1 / Q2 / Q3
                            geom_vline(data = . %>% select(pHxFood, lower, mean, upper) %>% gather(key, value, -pHxFood), aes(xintercept = value)) +
                            # density plot
                            geom_density(data = Resp_1026, aes(x = resp_umol_hr_bFactorNormLength, group=pHxFood, fill=pHxFood, ..scaled..), alpha=.4, adjust=1.5) +
                            #  theme
                            theme_classic() +
                            xlim(0, 0.22) +
                            facet_grid(pHxFood ~ .) +
                            theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "none", plot.title = element_text(size=10))+
                            labs(title = "F1 Scallops: respiration rates 92 DPF - b factor ALL", 
                                 x = expression(Respiration~rate~"("~μmol~L^{-1}~O[2]%.%mm^{-1}~shell~length%.% hr^{-1}~")"),
                                 y = "Scaled density") +
                            scale_fill_manual(values=c("grey40", "grey40", "grey85", "grey85"))
denisty_box_resp_92DPF


pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Respiration/20211026_figs_tables/20211026_RRbfactorALL_density_plot.pdf"), width = 5, height = 5)
denisty_box_resp_92DPF # print the model diagnostics 
dev.off()


```

