---
title: "Respiration Calc F1 Scallops 2021"
author: "Samuel Gurr"
date: "10/6/2021"
output:
  html_document:
    df_print: paged
  pdf_document:
    latex_engine: xelatex
---


```{r setup, include=FALSE}

# LOAD PACKAGES :::::::::::::::::::::::::::::::::::::::::::::::::::::::

library(dplyr)
library(ggplot2)
library(forcats)
library(lme4)
library(lmerTest)
library(see)
library(performance)
library(car)
library(kableExtra)
library(pander)
library(data.table)
library(stringr)
library(latex2exp)
library(Rmisc)
library(ggpubr)
library(hrbrthemes)
library(nlme)
# SET WORKING DIRECTORY :::::::::::::::::::::::::::::::::::::::::::::::

 setwd("C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis") # personal computer
# setwd("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis") # Work computer
# setwd("C:/Users/samjg/Documents/Github_repositories/Airradians_OA/RAnalysis") # Work computer

# LOAD DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

resp.data       <- read.csv(file="Output/Respiration/Cumulative_resp_alpha0.4_15sectrunc1hour.csv", header=T) %>% 
                      dplyr::filter(!Date %in% "9/14/2021" | !Filename %in% 'Run_1_raw.txt') # read the calculate raw rates from 'resp_LoLin' script - contains the calculated rate (not normalized for blanks) for each sensor-channel
exp_metadata    <- read.csv(file="Data/ExperimentMetadata.csv", header=T) # treatment assignments to 'Chamber_Tank'
lengths         <- read.csv(file="Data/Respiration/Lengths_Condition_resp_clearance.csv", header=T)
resp.ref        <- read.csv(file="Data/Respiration/Reference_master.csv", header=T) %>% dplyr::filter(!Date %in% "9/14/2021" | !Filename %in% 'Run_1_raw.txt')
DWs_Len_1026    <- read.csv(file="Data/Survival_Size/20211026_lengths_dryweights.csv", header=T)
DWs_Len_914.930 <- read.csv(file="Data/Survival_Size/2021914_930_dryweights.csv", header=T)

```


### Merge master resp data frame with lengths

```{r merge resp with length data and treatment IDs, echo=FALSE}

# merge the exp_metadata with the resp.data
resp.ref_length_merged                 <- merge(resp.ref, lengths) # all TRUE allows us to keep the blanks
resp.data_merged                       <- merge(resp.data, resp.ref_length_merged) %>% # out master file moving forward....
                                            dplyr::mutate(filetype = str_sub(Filename, -3,-1)) %>% 
                                            dplyr::mutate(filetype = factor(ifelse(filetype == "csv", "SDR_data", "LoLigo_data")))
kable(head(resp.data_merged))

```

#### Visual diagnostic plots to correct poor data (3 data points to change..)

- View on github: Airradians_OA/RAnalysis/Output/Respiration/plots_alpha0.4_increm15sec/

- found three calls that inaccurately represent the rates of oxygen consumption 

(1) https://github.com/SamGurr/Airradians_OA/blob/master/RAnalysis/Output/Respiration/plots_alpha0.4_increm15sec/20210930_Plate_2_Run_2_C5_regression.pdf
- solution = call 'Lz' instead of the default Leq

(2) https://github.com/SamGurr/Airradians_OA/blob/master/RAnalysis/Output/Respiration/plots_alpha0.4_increm15sec/20210930_Plate_2_Run_1_C1_regression.pdf
- solution = call 'Lz' instead of the default Leq

(3) https://github.com/SamGurr/Airradians_OA/blob/master/RAnalysis/Output/Respiration/plots_alpha0.4_increm15sec/20210930_Plate_1_Run_2_C1_regression.pdf
- solution = we reran this at the end of the LoLin script  for 0-20 minutes and got an Lpc  -0.0296, insert this 

```{r IMPORTANT correct poor data, echo=TRUE, message = FALSE, warning = FALSE}

# VISAUL INSPECCTION:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#  914 runs...
resp.data_merged[48 ,c(1:6)]  #  CH5	Run_2_raw.txt	-0.005252180	-0.004583581	-0.004583581
resp.data_merged[44 ,c(1:6)]  #  CH3	Run_2_raw.txt	-0.010489214	-0.008507836	-0.008507836
resp.data_merged[36 ,c(1:6)]  #  CH1	Run_2_raw.txt	0.000995514	0.002014487	0.002014487
#resp.data_merged[23 ,c(1:6)]  #  CH5	Run_1_raw.txt	-0.00704407	-0.005910146	-0.005910146 
resp.data_merged[37 ,c(1:6)]  #  CH1	Run_3_raw.txt	-0.01067604	-0.01067604	-0.01067604
resp.data_merged[41 ,c(1:6)]  #  CH2	Run_3_raw.txt	-0.002221288	-0.00212516	-0.00212516
resp.data_merged[45 ,c(1:6)]  #  CH3	Run_3_raw.txt	-0.001386829	-0.00246828	-0.00246828
resp.data_merged[49 ,c(1:6)]  #  CH5	Run_3_raw.txt	-0.01019991	-0.01748781	-0.01748781

# 930 runs...

resp.data_merged[71 ,c(1:6)]  # A5	RR_9.30.21_AM_Plate_1_Run_1.csv	-0.002463294	-0.003383279	-0.003383279
resp.data_merged[95 ,c(1:6)]  #  C1 RR_9.30.21_AM_Plate_2_Run_1.csv # -0.02890813	-0.0608251	-0.0608251 - Lz and Leq  better 
resp.data_merged[111,c(1:6)]  #  C5 RR_9.30.21_PM_Plate_2_Run_2.csv	0.029052351	-0.076034441	-0.076034441
resp.data_merged[96 ,c(1:6)]  #  C1 RR_9.30.21_PM_Plate_1_Run_2.csv	0.011656487	0.011656487	0.011656487 


# CHANGES (based on rerun or whether Lz/Leq better explains) :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

# 914 changes..

resp.data_merged[48 ,4]  <- as.numeric(-0.0154) # RERUN
resp.data_merged[44 ,4]  <- as.numeric(-0.0205) # RERUN
resp.data_merged[36 ,4]  <- as.numeric(-0.0164) # RERUN
#resp.data_merged[23 ,4]  <- as.numeric(-0.0275) # RERUN
resp.data_merged[37 ,4]  <- as.numeric(-0.00123) # RERUN
resp.data_merged[41 ,4]  <- as.numeric(-0.0036)  # RERUN
resp.data_merged[45 ,4]  <- as.numeric(-0.0034)  # RERUN 
resp.data_merged[49 ,4]  <- as.numeric(-0.0207)  # RERUN

# 930 changes..

resp.data_merged[71 ,4]  <- as.numeric(-0.0128) # RERUN
resp.data_merged[95 ,4]  <- resp.data_merged[95,5] # 20210930_Plate_2_Run_2_C5_regression - Lz and Leq regression than Lpc
resp.data_merged[111,4]  <- resp.data_merged[111,5] # 20210930_Plate_2_Run_1_C1_regression - Lz and Leq  regression than Lpc
resp.data_merged[96 ,4]  <- as.numeric(-0.0296) # RERUN
#resp.data_merged[23 ,4]  <- as.numeric(-0.0275) # RERUN


# look at the data for sanity check...

resp.data_merged[44 ,c(1:6)] # -0.0205
resp.data_merged[36 ,c(1:6)] # -0.0164
resp.data_merged[23 ,c(1:6)] # -0.0275
#resp.data_merged[23 ,c(1:6)] # -0.0275
resp.data_merged[37 ,c(1:6)] # -0.00123 
resp.data_merged[41 ,c(1:6)] # -0.0036  
resp.data_merged[45 ,c(1:6)] # -0.0034
resp.data_merged[49 ,c(1:6)] # -0.0207
resp.data_merged[95 ,c(1:6)] # -0.0608251
resp.data_merged[111,c(1:6)] # -0.07603444
resp.data_merged[96 ,c(1:6)] # -0.0296	

# View(resp.data_merged)
```

#### Calculate blank rates, view means by day pH_treatment and instrument

* note: respiration rates were recorded using both SDR dish (24 channel) and Loligo 8-channel sensors - different blanks for each

```{r call blanks, echo=FALSE}

blanks_total <- data.frame() # start dataframe 
blanks.table <- data.frame(matrix(nrow = 1,ncol = 5)) # make a table template
colnames(blanks.table)<-c('Date', 'Channel', 'mean_Lpc', 'mean_Leq' , 'mean_Lz') # names for comuns in the for loop

blanks_all_raw <- data.frame(merge(resp.ref, resp.data, by = c('Date', 'Channel', 'Filename')) %>% 
                  dplyr::filter(!Date ==  '9/14/2021'   | !Filename == 'Run_1_raw.txt') %>%  # run 1 was restarted due to poor data
                  dplyr::mutate(filetype = str_sub(Filename, -3,-1)) %>% 
                  dplyr::mutate(filetype = factor(ifelse(filetype == "csv", "SDR_data", "LoLigo_data"))) %>% 
                  dplyr::filter(Chamber_tank  == 'blank') %>% 
                  # dplyr::filter(Lpc <0) %>% 
                  dplyr::filter(!Date == '9/30/2021' | !Lpc < -0.035) %>% #omits C6 RR_9.30.21_AM_Plate_1_Run_1.csv	8.0	blank - View the Lolin plot, looks noisy and a fast outlier from the others
                  dplyr::filter(!Date == '10/26/2021'  | !Channel == "CH8" | !Run == "2" ) %>%  # omit a bad blank that contained a bad seal, noted on the respiration sampling day during the trial 
                  dplyr::filter(!Date == '10/26/2021'  | !Channel == "CH8" | !Run == "3" ) %>%  # omit a bad blank that contained a bad seal, noted on the respiration sampling day during the trial 
                  dplyr::filter(!Date ==  '9/30/2021'   | !pH == "7.5" | !Channel == "B2" | !Run == "1" | !Plate == "1" ) %>% 
                  dplyr::select(c(Date, pH, Run, Plate, Lpc, Leq ,Lz, Channel, Food, Filename, filetype, Chamber_tank)) %>% 
                  dplyr::arrange(Date, Run, pH))
kable(blanks_all_raw)



blanks_means <- blanks_all_raw %>% 
     dplyr::group_by(Date, pH, Run, filetype) %>% 
     dplyr::filter(Chamber_tank == "blank") %>% 
     dplyr::filter(Lpc <0) %>% # ommit blank calls that d/n represent oxygen consumption
     dplyr::summarise(BLANK.mean_Lpc = mean(abs(Lpc)),
                      BLANK.sd.Lpc   = sd(abs(Lpc)),
                      BLANK.mean_Leq = mean(abs(Leq)), 
                      BLANK.mean_Lz = mean(abs(Lz)),
                      n = n()) %>% 
    dplyr::arrange(Date, Run)
kable(blanks_means)

dups_to_add <- blanks_means[c(5:7),] %>% mutate(pH = 7.5) # only pH 8 contains a positive blank on 9/14 Run 1 and 10/26 Run 2- duplicate and save as pH 7.5 
blanks_means <- rbind(blanks_means, dups_to_add) %>% dplyr::arrange(Date, Run) 
kable(blanks_means) # you can now see that each Date, Run, has a pH 8 and pH 7.5 blank
```


#### Merge blanks with the master file by Date, pCO2 treatment, and filetype

* 'filteype' is only important here on 20211026 when both Loligo and SDR were used due to difference in size for fed (larger) and unfed animals 

```{r merge blanks_means for a master file, echo=FALSE}

Resp.Master <- merge(resp.data_merged, 
                     blanks_means, by=c("Date", "pH", "Run", "filetype")) %>% # NOTE: this repeats for every distinct length value
               dplyr::mutate(resp_blankStand = 
                                abs(Lpc) - BLANK.mean_Lpc) # ommits respiration rate values showing an increase in O2 over time 

Resp.less.than.blank <- Resp.Master %>% 
                          dplyr::filter(resp_blankStand < 0) %>% 
                          dplyr::select(c(1:7,15,18,29)) %>% 
                          mutate(Lpc = abs(Lpc)) # call the values with positive resp rates, measing they were slower than the blank!
print(Resp.less.than.blank) # 14 total samples were less than the blank after the correction... (Lpc < BLANK.mean_LPC)

```


## Master Resp file 'Resp.Master_OM', with volumes and file types, etc. saved as 'Calculated_Resp_Master.csv'

######  dplyr::mutate for the following:

* 'volume' of the different vessels throughout the fed*OA challenge
* 'Age'
* 'Fed_unfed'
* 'pCO2'

```{r master resp file, echo=FALSE}

Resp.Master_OM <- Resp.Master[!is.na(Resp.Master$Length_um),] %>% 
  # omit resp values less than the blank
  dplyr::filter(!resp_blankStand < 0) %>% # omit respiration values subtracted by blank (resp_blankStand) that are negative (less than the blank)
  # new colums with the experimental conditions                   
  dplyr::mutate(Age = case_when(Date == '9/14/2021' ~ 50, Date == '9/30/2021' ~ 66, Date == '10/26/2021' ~ 92)) %>% 
  dplyr::mutate(Fed_Unfed = case_when(
    Fed_Unfed == 'F' ~ "High food", is.na(Fed_Unfed) ~ "High food", 
    Fed_Unfed == 'U' ~ "Low food")) %>% 
  dplyr::mutate(pCO2 = case_when(
    pH == 8.0 ~ "500 μatm", 
    pH == 7.5 ~ "800 μatm")) %>% 
  # the volume of the cahmbers 
  dplyr::mutate(volume = case_when(
     filetype == "LoLigo_data" & Date == '9/14/2021' ~ 1.7, # small vessels for loligo system - 22 ml vessels
     filetype == "LoLigo_data" & Date %in% c('10/26/2021') & Channel == 'CH1' ~ 23.1, # F1 data
     filetype == "LoLigo_data" & Date %in% c('10/26/2021') & Channel == 'CH2' ~ 23.05, 
     filetype == "LoLigo_data" & Date %in% c('10/26/2021') & Channel == 'CH4' ~ 22.55,
     filetype == "LoLigo_data" & Date %in% c('10/26/2021') & Channel == 'CH5' ~ 23.18,
     filetype == "LoLigo_data" & Date %in% c('10/26/2021') & Channel == 'CH6' ~ 23.24,
     filetype == "LoLigo_data" & Date %in% c('10/26/2021') & Channel == 'CH7' ~ 22.63, 
     filetype == "LoLigo_data" & Date %in% c('10/26/2021') & Channel == 'CH8' ~ 22.95,
     filetype == "LoLigo_data" & Date %in% c('10/26/2021') & Channel == 'CH3' ~ 23.31, #larger custom vessels measured individually...
     filetype == "SDR_data" ~ 1.7)) %>% # 24-well plate - 1700ul used for the unfed and fed on 9/30 and the unfed only on 10/26
  # factor in the biovolume (volume displaced from the animal) to get the actual calculated volume of the chambers
  dplyr::mutate(Length_mm = Length_um/1000) %>% # Length in millimeters
  dplyr::mutate(Biovol_length3 = (0.000198*(Length_mm^3)))  %>% # biovoume calc using length (mm) ^3 0.000198 derived from a regression run with all F1 data 
  dplyr::mutate(calculated_volume = (volume - Biovol_length3)) %>%  # actual volume of the vessel accounting for the volume displaced (length^3 equivelent to the measured biovolume)
  # REspiration units mg minute -> mg L hr
  dplyr::mutate(resp_mg_L_hr =(resp_blankStand *  # resp corrected for blank (remember within Date, Run and treatment!) - currently as raw units of mg O2 per minute (output from LoLinR script)
                                      (calculated_volume/1000) * # mult by volume of the resp vessel corrected in Liters - now units in  mg per L per min
                                       60))  %>% # mult by 60 to convert to hours - now units in mg L per hour
  dplyr::mutate(resp_umol_L_hr = ( (resp_mg_L_hr * 1000) / 32) ) #  convert mg L per hr to umol L hr- first by mg to ug (mg*1000 = ug) and then ug to umol (1 umol = 32 ug -  ug O2 div 32 ug/umol)          

Resp.Master %>% dplyr::filter(resp_blankStand < 0) # 14 rows omitted 
```

# ALOMETRIC COEFFICIENT (b factor) 

## by SHELL AND INDIVIDUAL LENGTH (only for biovolume calculated using length^3)

* why? - we want to compare resp data across time however we did not measure dry tissue nor biovolume in samll animals, thus 
to calculate resp using the sample methods across time, we used length^3 correction for biovolume and will further use a bfactor for shell length in these data 

* note: this is in contrast to resp values used for SFG, O:N, and any overlaid phys with ecretion and biodeposition becasue animals were large enough to have tissue dry weights and biovolumes 

```{r b factor SHELL LENGTH outlier omitted, echo=TRUE, echo = FALSE,message = FALSE, warning = FALSE, results='hide'}

# FOR SHELL ENGTH WE WILL USE THE 'resp_umol_hr_biovolcalc' data to employ all resp data files across time! 
# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# GET B FACTOR FOR ALL AVAILABLE INDIVIDUALS WITH LENGTH AND MO2 ::::::::::::::::::::::::::::::
nrow(Resp.Master_OM) # 118

Resp.Master_bfactor_plotting <- Resp.Master_OM %>% 
dplyr::mutate(log10_VO2     = log10(as.numeric(Resp.Master_OM$resp_umol_L_hr)) ) %>%  # assign resp value
dplyr::mutate(log10_Length  = log10(as.numeric(Resp.Master_OM$Length_um)) ) %>% # assign length value 
dplyr::mutate(Food_OA       = paste(Resp.Master_OM$pCO2, Resp.Master_OM$Fed_Unfed, sep = "_")) # two-way factor to facet plots by  

Resp.Master_bfactor_plottingOM <- Resp.Master_bfactor_plotting %>% 
  # one outlier value that is omitted for parallet graphical outputsn with the non-omitted data 
  dplyr::filter(!(log10_Length > 3.8 & log10_VO2 < -3))  # outliers ommited (a ingle data point)

MO2_b.factorLENGTH_PLOT <- Resp.Master_bfactor_plotting %>% 
                           ggplot(aes(x=log10_Length, y=log10_VO2)) +
                              geom_point() +
                              theme(panel.grid.major = element_blank(), 
                                    panel.grid.minor = element_blank())+ 
                              scale_x_continuous(name ="log10_Length; in mm") +
                              scale_y_continuous(name ="log10_MO2; RR in umol L-1 hr-1)") +
                              theme_classic() +
                              theme(legend.position="none",axis.title.y=element_text(size=7)) +
                              ggtitle("Metabolic scaling: log10_MO2 = log10_a + 
                                      (b.factor * log10_Length)") +
                              geom_smooth(method = lm, color = 'red') +
                              ggpmisc::stat_poly_eq(parse=T, 
                                                    aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
                                                    label.x.npc = "left")
MO2_b.factorLENGTH_PLOT_facetted <- Resp.Master_bfactor_plotting %>% 
                                     ggplot(aes(x=log10_Length, y=log10_VO2, color = pCO2)) +
                                        geom_point() +
                                        scale_color_manual(values=c("blue","orange")) +
                                        theme(panel.grid.major = element_blank(), 
                                              panel.grid.minor = element_blank())+ 
                                        scale_x_continuous(name ="log10_Length; in mm") +
                                        scale_y_continuous(name ="log10_MO2; RR in umol L-1 hr-1)") +
                                        theme_classic() +
                                        theme(legend.position="none",axis.title.y=element_text(size=7)) +
                                        ggtitle("Metabolic scaling: log10_MO2 = log10_a + 
                                                (b.factor * log10_Length)") +
                                        geom_smooth(method = lm, color = 'red') +
                                        ggpmisc::stat_poly_eq(parse=T, 
                                                              aes(label = paste(..eq.label..,
                                                                                ..rr.label.., sep = "~~~")),
                                                              label.x.npc = "left") +
                                        facet_wrap(~Food_OA)
MO2_b.factorLENGTH_PLOT_facetted_food <- Resp.Master_bfactor_plotting %>% 
                                     ggplot(aes(x=log10_Length, y=log10_VO2)) + # omitted , color = pCO2
                                        geom_point() +
                                        #scale_color_manual(values=c("blue","orange")) +
                                        theme(panel.grid.major = element_blank(), 
                                              panel.grid.minor = element_blank())+ 
                                        scale_x_continuous(name ="log10_Length; in mm") +
                                        scale_y_continuous(name ="log10_MO2; RR in umol L-1 hr-1)") +
                                        theme_classic() +
                                        theme(legend.position="none",axis.title.y=element_text(size=7)) +
                                        ggtitle("Metabolic scaling: log10_MO2 = log10_a + 
                                                (b.factor * log10_Length)") +
                                        geom_smooth(method = lm, color = 'red') +
                                        ggpmisc::stat_poly_eq(parse=T, 
                                                              aes(label = paste(..eq.label..,
                                                                                ..rr.label.., sep = "~~~")),
                                                              label.x.npc = "left") +
                                        facet_wrap(~Fed_Unfed)
MO2_b.factorLENGTH_PLOT_facetted_pCO2 <- Resp.Master_bfactor_plotting %>% 
                                     ggplot(aes(x=log10_Length, y=log10_VO2)) +
                                        geom_point() +
                                        #scale_color_manual(values=c("blue","orange")) +
                                        theme(panel.grid.major = element_blank(), 
                                              panel.grid.minor = element_blank())+ 
                                        scale_x_continuous(name ="log10_Length; in mm") +
                                        scale_y_continuous(name ="log10_MO2; RR in umol L-1 hr-1)") +
                                        theme_classic() +
                                        theme(legend.position="none",axis.title.y=element_text(size=7)) +
                                        ggtitle("Metabolic scaling: log10_MO2 = log10_a + 
                                                (b.factor * log10_Length)") +
                                        geom_smooth(method = lm, color = 'red') +
                                        ggpmisc::stat_poly_eq(parse=T, 
                                                              aes(label = paste(..eq.label..,
                                                                                ..rr.label.., sep = "~~~")),
                                                              label.x.npc = "left") +
                                        facet_wrap(~pCO2)


 # OUTPUT PLOTS 
pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Respiration/metabolic_scaling/MetabolicScaling_bFactor_Length_ALL.pdf"), width = 8, height = 25)
print(ggarrange(MO2_b.factorLENGTH_PLOT, 
                MO2_b.factorLENGTH_PLOT_facetted, 
                MO2_b.factorLENGTH_PLOT_facetted_pCO2,
                MO2_b.factorLENGTH_PLOT_facetted_food,
                nrow = 4, ncol = 1)) # print the model diagnostics
dev.off()




#  NOW WITH THE SINGLE OUTLIER OMITTED 


MO2_b.factorLENGTH_PLOT_OM <- Resp.Master_bfactor_plottingOM %>% 
                           ggplot(aes(x=log10_Length, y=log10_VO2)) +
                              geom_point() +
                              theme(panel.grid.major = element_blank(), 
                                    panel.grid.minor = element_blank())+ 
                              scale_x_continuous(name ="log10_Length; in mm") +
                              scale_y_continuous(name ="log10_MO2; RR in umol L-1 hr-1)") +
                              theme_classic() +
                              theme(legend.position="none",axis.title.y=element_text(size=7)) +
                              ggtitle("Metabolic scaling: log10_MO2 = log10_a + 
                                      (b.factor * log10_Length)") +
                              geom_smooth(method = lm, color = 'red') +
                              ggpmisc::stat_poly_eq(parse=T, 
                                                    aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
                                                    label.x.npc = "left")
MO2_b.factorLENGTH_PLOT_facetted_OM <- Resp.Master_bfactor_plottingOM %>% 
                                     ggplot(aes(x=log10_Length, y=log10_VO2, color = pCO2)) +
                                        geom_point() +
                                        scale_color_manual(values=c("blue","orange")) +
                                        theme(panel.grid.major = element_blank(), 
                                              panel.grid.minor = element_blank())+ 
                                        scale_x_continuous(name ="log10_Length; in mm") +
                                        scale_y_continuous(name ="log10_MO2; RR in umol L-1 hr-1)") +
                                        theme_classic() +
                                        theme(legend.position="none",axis.title.y=element_text(size=7)) +
                                        ggtitle("Metabolic scaling: log10_MO2 = log10_a + 
                                                (b.factor * log10_Length)") +
                                        geom_smooth(method = lm, color = 'red') +
                                        ggpmisc::stat_poly_eq(parse=T, 
                                                              aes(label = paste(..eq.label..,
                                                                                ..rr.label.., sep = "~~~")),
                                                              label.x.npc = "left") +
                                        facet_wrap(~Food_OA)
MO2_b.factorLENGTH_PLOT_facetted_food_OM <- Resp.Master_bfactor_plottingOM %>% 
                                     ggplot(aes(x=log10_Length, y=log10_VO2)) + # omitted , color = pCO2
                                        geom_point() +
                                        #scale_color_manual(values=c("blue","orange")) +
                                        theme(panel.grid.major = element_blank(), 
                                              panel.grid.minor = element_blank())+ 
                                        scale_x_continuous(name ="log10_Length; in mm") +
                                        scale_y_continuous(name ="log10_MO2; RR in umol L-1 hr-1)") +
                                        theme_classic() +
                                        theme(legend.position="none",axis.title.y=element_text(size=7)) +
                                        ggtitle("Metabolic scaling: log10_MO2 = log10_a + 
                                                (b.factor * log10_Length)") +
                                        geom_smooth(method = lm, color = 'red') +
                                        ggpmisc::stat_poly_eq(parse=T, 
                                                              aes(label = paste(..eq.label..,
                                                                                ..rr.label.., sep = "~~~")),
                                                              label.x.npc = "left") +
                                        facet_wrap(~Fed_Unfed)
MO2_b.factorLENGTH_PLOT_facetted_pCO2_OM <- Resp.Master_bfactor_plottingOM %>% 
                                     ggplot(aes(x=log10_Length, y=log10_VO2)) +
                                        geom_point() +
                                        #scale_color_manual(values=c("blue","orange")) +
                                        theme(panel.grid.major = element_blank(), 
                                              panel.grid.minor = element_blank())+ 
                                        scale_x_continuous(name ="log10_Length; in mm") +
                                        scale_y_continuous(name ="log10_MO2; RR in umol L-1 hr-1)") +
                                        theme_classic() +
                                        theme(legend.position="none",axis.title.y=element_text(size=7)) +
                                        ggtitle("Metabolic scaling: log10_MO2 = log10_a + 
                                                (b.factor * log10_Length)") +
                                        geom_smooth(method = lm, color = 'red') +
                                        ggpmisc::stat_poly_eq(parse=T, 
                                                              aes(label = paste(..eq.label..,
                                                                                ..rr.label.., sep = "~~~")),
                                                              label.x.npc = "left") +
                                        facet_wrap(~pCO2)


 # OUTPUT PLOTS 
pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Respiration/metabolic_scaling/MetabolicScaling_bFactor_Length_ALL_outlierOM.pdf"), width = 8, height = 25)
print(ggarrange(MO2_b.factorLENGTH_PLOT_OM, 
                MO2_b.factorLENGTH_PLOT_facetted_OM, 
                MO2_b.factorLENGTH_PLOT_facetted_pCO2_OM,
                MO2_b.factorLENGTH_PLOT_facetted_food_OM,
                nrow = 4, ncol = 1)) # print the model diagnostics
dev.off()


# b factor == 1.46

```

# In summunary from the b factors above...

- listed below all combinations (the single outlier omitted)
  * b factor ALL = 1.41
  
  * b factor low food  = 2.86 # very different
  * b factor high food = 1.16
  
  * b factor low pCO2  = 1.41 # very similar
  * b factor high pCO2 = 1.43
  
  * b factor lowpCO2  x high food = 1.21 # similar based on food NOT pCO2
  * b factor highpCO2 x high food = 1.14
  * b factor lowpCO2  x low food  = 2.72 
  * b factor highpCO2 x low food  = 3.03
 

- move forward with the following: 

  * b factor 'all'
  * b factor 'foodsupply' as high food & low food
  
```{r Calculate Resp Rates , echo=TRUE, message = FALSE, warning = FALSE}

# NORMALIZED for Shell length
# as (RR) * ([mean_length / individual length]^b_factor)
bLength_all      = 1.41 # review the outlier-omitted b factor plot in previous chunk
bLength_highfood = 1.16 # review the outlier-omitted b factor plot in previous chunk
bLength_lowfood  = 2.86 # review the outlier-omitted b factor plot in previous chunk


meanLengthALL        <- mean(Resp.Master_OM$Length_mm) #4.292843 - the mean for the normalization 
meanLengthHighFood   <- mean((Resp.Master_OM %>% 
                                filter(Fed_Unfed %in% 'High food'))$Length_mm) #4.943896 - the mean for the normalization 
meanLengthLowFood    <- mean((Resp.Master_OM %>% 
                                filter(Fed_Unfed %in% 'Low food'))$Length_mm) #3.114749 - the mean for the normalization 

Resp.Masterfinal <- Resp.Master_OM %>% 
                       # the 'all' b factor 
                       dplyr::mutate(resp_umol_hr_bFactorNormLength.ALL = 
                                    (resp_umol_L_hr)*
                                    ((meanLength/Length_mm)^bLength_all) ) %>% 
                       #  contingency statement for b factors based on food type
                       dplyr::mutate(resp_umol_hr_bFactorNormLength.FOOD = 
                                      case_when(Fed_Unfed  == "High food" ~ # when high food / supplementary fed animals
                                          ((resp_umol_L_hr)* ((meanLengthHighFood/Length_mm)^bLength_highfood)), # 'bLength_highfood'
                                          Fed_Unfed  == "Low food" ~ # when low food / supplementary fed animals
                                          ((resp_umol_L_hr)* ((meanLengthLowFood/Length_mm)^bLength_lowfood)) ) ) %>% # 'bLength_lowfood'
                      #   the non-bfactor correction simply dividing by individual shell length
                       dplyr::mutate(resp_µmol_L_mm_Length_hr = 
                                       (resp_umol_L_hr /(Length_um/1000)) ) %>% 
                       dplyr::select(c(Date,
                                      Age,
                                      pH,
                                      pCO2,
                                      Fed_Unfed,
                                      Replicate,
                                      Chamber_tank,
                                      Number,
                                      Run,
                                      Channel,
                                      Length_um,
                                      Length_mm,
                                      # Dry_Shell_weight,
                                      # Dry_Tissue_weight,
                                      # whole_Dry_weight,
                                      volume,
                                      Biovol_length3,
                                      calculated_volume, # as vessel volume - (biovol calc from length^3)
                                      Lpc,
                                      BLANK.mean_Lpc,
                                      resp_blankStand,
                                      resp_mg_L_hr, 
                                      resp_umol_L_hr,
                                      resp_umol_hr_bFactorNormLength.ALL,
                                      resp_umol_hr_bFactorNormLength.FOOD)) %>% 
                      dplyr::rename(raw_resp_rate = Lpc)

# write.csv(Resp.Master_OM, "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Respiration/Calculated_Resp_Master.csv")
 write.csv(Resp.Masterfinal, "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Respiration/Calculated_Resp_Master.csv")

 
View(Resp.Masterfinal)
```



### Plot the RAW rates by the size metrics 

####  (1) Shell length vs. Raw respiration rate (umol O2 L- hr-1)...
``` {r Shell length vs. raw respiration rate, echo=TRUE, message = FALSE, warning = FALSE}

# by Length ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

P_Length_resp_all <- Resp.Masterfinal%>% 
                        ggplot(aes(
                          x = Length_mm, 
                          y = resp_umol_L_hr, 
                          color = as.factor(pCO2))) +
                         scale_color_manual(values=c("forestgreen","darkorange2"))+
                          geom_smooth(method = "lm", 
                                      se=FALSE, 
                                      color="black", 
                                      formula = resp_umol_L_hr ~ Length_mm) +
                          theme_classic() +
                          theme(panel.grid.major = element_blank(), 
                                panel.grid.minor = element_blank(), 
                                plot.title = element_text(size=10))+ 
                          labs(title = "Raw Resp v. Shell length (mm)", 
                               y = expression(μmol~O[2]%.%hr^{-1})) +
                          xlab("Shell length (mm)") +
                          theme(legend.position="none") +
                          geom_point()

P_Length_resp_facet <- Resp.Masterfinal %>% 
                        ggplot(aes(x = Length_mm, 
                                   y = resp_umol_L_hr, 
                                   color = as.factor(pCO2))) +
                         scale_color_manual(values=c("forestgreen",
                                                     "darkorange2"))+
                          geom_smooth(method = "lm", 
                                      se=FALSE, 
                                      color="black", 
                                      formula = resp_umol_L_hr ~ Length_mm) +
                          theme_classic() +
                           theme(panel.grid.major = element_blank(), 
                                 panel.grid.minor = element_blank(), 
                                 legend.position = "none", 
                                 plot.title = element_text(size=10))+ 
                          labs(y = expression(μmol~O[2]%.%hr^{-1})) +
                          xlab("Shell length (mm)") +
                          geom_point() + 
                          facet_wrap(~Age*Fed_Unfed, scales = "free")
# print in markdown file 
ggarrange(P_Length_resp_all, P_Length_resp_facet, nrow = 2)



# by b factor length all  == 1.41 :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

P_bfactorLength_all <- Resp.Masterfinal %>% 
                        ggplot(aes(
                          x = Length_mm, 
                          y = resp_umol_hr_bFactorNormLength.ALL, 
                          color = as.factor(pCO2))) +
                         scale_color_manual(values=c("forestgreen","darkorange2"))+
                          geom_smooth(method = "lm", 
                                      se=FALSE, 
                                      color="black", 
                                      formula = resp_umol_hr_bFactorNormLength.ALL ~ Length_mm) +
                          theme_classic() +
                          theme(panel.grid.major = element_blank(), 
                                panel.grid.minor = element_blank(), 
                                plot.title = element_text(size=10))+ 
                          labs(title = "Resp bfactor ALL v. Shell length (mm)", 
                               y = expression(b~factor~ALL~μmol~O[2]%.%hr^{-1})) +
                          xlab("Shell length (mm)") +
                          theme(legend.position="none") +
                          geom_point()

P_bfactorLength_all_facet <- Resp.Masterfinal %>% 
                        ggplot(aes(x = Length_mm, 
                                   y = resp_umol_hr_bFactorNormLength.ALL, 
                                   color = as.factor(pCO2))) +
                         scale_color_manual(values=c("forestgreen",
                                                     "darkorange2"))+
                          geom_smooth(method = "lm", 
                                      se=FALSE, 
                                      color="black", 
                                      formula = resp_umol_hr_bFactorNormLength.ALL ~ Length_mm) +
                          theme_classic() +
                           theme(panel.grid.major = element_blank(), 
                                 panel.grid.minor = element_blank(), 
                                 legend.position = "none", 
                                 plot.title = element_text(size=10))+ 
                          labs(y = expression(b~factor~ALL~μmol~O[2]%.%hr^{-1})) +
                          xlab("Shell length (mm)") +
                          geom_point() + 
                          facet_wrap(~Age*Fed_Unfed, scales = "free")
# print in markdown file 
ggarrange(P_bfactorLength_all, P_bfactorLength_all_facet,nrow = 2)







P_bfactorLength_food <- Resp.Masterfinal %>% 
                        ggplot(aes(
                          x = Length_mm, 
                          y = resp_umol_hr_bFactorNormLength.FOOD, 
                          color = as.factor(pCO2))) +
                         scale_color_manual(values=c("forestgreen","darkorange2"))+
                          geom_smooth(method = "lm", 
                                      se=FALSE, 
                                      color="black", 
                                      formula = resp_umol_hr_bFactorNormLength.FOOD ~ Length_mm) +
                          theme_classic() +
                          theme(panel.grid.major = element_blank(), 
                                panel.grid.minor = element_blank(), 
                                plot.title = element_text(size=10))+ 
                          labs(title = "Resp bfactor FOOD v. Shell length (mm)", 
                               y = expression(b~factor~FOOD~μmol~O[2]%.%hr^{-1})) +
                          xlab("Shell length (mm)") +
                          theme(legend.position="none") +
                          geom_point()

P_bfactorLength_food_facet <- Resp.Masterfinal %>% 
                        ggplot(aes(x = Length_mm, 
                                   y = resp_umol_hr_bFactorNormLength.FOOD, 
                                   color = as.factor(pCO2))) +
                         scale_color_manual(values=c("forestgreen",
                                                     "darkorange2"))+
                          geom_smooth(method = "lm", 
                                      se=FALSE, 
                                      color="black", 
                                      formula = resp_umol_hr_bFactorNormLength.FOOD ~ Length_mm) +
                          theme_classic() +
                           theme(panel.grid.major = element_blank(), 
                                 panel.grid.minor = element_blank(), 
                                 legend.position = "none", 
                                 plot.title = element_text(size=10))+ 
                          labs(y = expression(b~factor~FOOD~μmol~O[2]%.%hr^{-1})) +
                          xlab("Shell length (mm)") +
                          geom_point() + 
                          facet_wrap(~Age*Fed_Unfed, scales = "free")








# Export to pdf

# raw vs. shell length
pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Respiration/Shell_length_resp_raw.pdf"), width = 10, height = 6)
ggarrange(P_Length_resp_all, P_Length_resp_facet,ncol = 2)
dev.off()


# b factor corrected (ALL) vs. shell length
pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Respiration/Shell_length_resp_bfactorALL.pdf"), width = 10, height = 6)
ggarrange(P_bfactorLength_all, P_bfactorLength_all_facet,ncol = 2)
dev.off()

# b factor corrected (Food type) vs. shell length
pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Respiration/Shell_length_resp_bfactorFOOD.pdf"), width = 10, height = 6)
ggarrange(P_bfactorLength_food, P_bfactorLength_food_facet,ncol = 2)
dev.off()

```





### Skip to here to load the resp master file (if already completed above chunks!!)



```{r load master resp file, echo=FALSE}

# Resp.Master_OM    <- read.csv(file="C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Respiration/Calculated_Resp_Master.csv", header=T) # personnel computer 
Resp.Master  <- read.csv(file="C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Respiration/Calculated_Resp_Master.csv", header=T) # work computer

```



# Analysis 



### 9/14/2021 F1 juvenile scallops

**About**
- two pCO2 treatments 
- **before** we culled and started the food limitation trials


##### number of replicates for analysis...

```{r 9/14 replicates and mean resp, echo=FALSE}

# model effect of treatment on resp rate 20210507
Resp_0914 <- Resp.Master %>% 
              dplyr::filter(Date %in% '9/14/2021')  %>% # call only 9/14
              dplyr::filter(!Chamber_tank  %in% 'blank')

Resp_0914 %>% dplyr::group_by(Chamber_tank) %>% dplyr::summarise(n()) # tank replication
# 7.5_A	3			
# 7.5_B	3			
# 7.5_C	3			
# 7.5_D	3			
# 8_A	2	   *2 rep			
# 8_B	3			
# 8_C	2		 *2 rep	
# 8_D	2	   *2 rep

Resp_0914 %>% summarySE(measurevar="resp_umol_hr_bFactorNormLength.ALL", groupvars=c("pCO2"))

Resp_0914 %>% summarySE(measurevar="resp_umol_hr_bFactorNormLength.FOOD", groupvars=c("pCO2"))


```

### 9/14/2021 linear model, diagnostics, and plots

```{r 9/14 f factor ALL, echo=TRUE, message = FALSE, warning = FALSE}

# Objective: run AOV and LME for the data, rationale being that we have mutliple samples per replicate tank
# thus important that we address this random effect. Performing AOV and LME allows us to run model selection using AIC 
# to determine the model with the better fit 



# b FACTOR ALL ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# note: day 0 of initiating the food treatment thus ONLY b factor ALL is used in this chuck for 9/14



# plot the replicates (visual diagnostics of random factor)
Resp_0914 %>% summarySE(measurevar="resp_umol_hr_bFactorNormLength.ALL", groupvars=("pCO2"))
Resp914_bLengthALL_reps<- ggboxplot(Resp_0914, x = "pCO2", y = "resp_umol_hr_bFactorNormLength.ALL", color = "Replicate",
                              add = c("mean_se", "dotplot"),
                              palette = c("#00AFBB", "#E7B800", "brown", "grey"))
Resp914_bLengthALL_reps

# One-way ANOVA (without the random effect) 
AOV914.bfactALL <- aov(resp_umol_hr_bFactorNormLength.ALL ~ 
                       pCO2, 
                     data=Resp_0914) # run mod
# check model assumptions
shapiro.test(residuals(AOV914.bfactALL)) # normal - 0.8823
leveneTest(AOV914.bfactALL) # homogeneity of variance (equal variance) - 0.8757
# all is good, lets see the results
pander(anova(AOV914.bfactALL), style='rmarkdown') # anova table of lm
# |    &nbsp;     | Df |  Sum Sq   |  Mean Sq  | F value | Pr(>F) |
# |:-------------:|:--:|:---------:|:---------:|:-------:|:------:|
# |   **pCO2**    | 1  | 0.0003541 | 0.0003541 | 0.1971  | 0.6621 |
# | **Residuals** | 19 |  0.03413  | 0.001796  |   NA    |   NA   |
# output results 
kable(data.frame(unclass(summary(AOV914.bfactALL)), 
                   check.names = FALSE, 
                   stringsAsFactors = FALSE)  ) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Respiration/20210914_figs_tables/20210914_AOV_RR_bfactor_ALL.png", zoom = 1.5)

# Linear mixed effects model with random effect of Replicate 
LME914.bfactALL<-lme(resp_umol_hr_bFactorNormLength.ALL ~ 
                     pCO2, 
                     random=~1|Chamber_tank, # with the random effect as an LME model (Chamber_tank = replicate as 7.5_A, 7.5_B)
                     data=Resp_0914) 
# check model assumptions
shapiro.test(residuals(LME914.bfactALL)) # normal - 0.9216
leveneTest(residuals(LME914.bfactALL) ~ Resp_0914$pCO2) # 0.3248 
# all is good, lets see the results
pander(anova(LME914.bfactALL), style='rmarkdown') # anova table of lmer
# |     &nbsp;      | numDF | denDF | F-value |  p-value  |
# |:---------------:|:-----:|:-----:|:-------:|:---------:|
# | **(Intercept)** |   1   |  13   |  48.65  | 9.693e-06 |
# |    **pCO2**     |   1   |   6   | 0.02535 |  0.8787   |
# output results 
kable(as.data.frame(anova(LME914.bfactALL))) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Respiration/20210914_figs_tables/20210914_LME_RR_bfactor_ALL.png", zoom = 1.5)

# AIC model selection
pander(AIC(LME914.bfactALL, AOV914.bfactALL), style='rmarkdown') # anova table of lmer
# |       &nbsp;        | df |  AIC   |
# |:-------------------:|:--:|:------:|
# | **LME914.bfactALL** | 4  | -57.46 | 
# | **AOV914.bfactALL** | 3  | -69.27 | # for negative AIC, the lower the AIC the best fit the model - the simple AOV is better 

# plot
Resp914_Length <- ggplot(Resp_0914, 
                         aes(x = factor(pCO2, level = c('500 μatm', '800 μatm')), 
                             resp_umol_hr_bFactorNormLength.ALL , 
                             fill = pCO2)) +
                    theme(panel.grid=element_blank()) +
                    geom_boxplot(size=0.2, width=0.5, alpha=0.1, aes(fill=pCO2)) +
                    scale_fill_manual(values=c("white","grey50")) +
                    geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
                    theme_classic() +
                    scale_x_discrete(labels= c('~500 μatm', '~800 μatm')) +
                   # scale_y_continuous(expand = c(0, 0), limits = c(0, 2)) +
                    labs(title = "F1 Scallops: respiration rates on 20210914 (b factor ALL)", 
                         y = expression(Respiration~rate~"("~μmol~L^{-1}~O[2]%.%mm~shell~length^{-1}%.% hr^{-1}~")"),
                         x = expression(italic(p)*CO[2]~Treatment~"("~μ*atm~")")) + 
                    theme(axis.text=element_text(size=8),
                          axis.title=element_text(size=8,face="bold")) +
                     stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white") 
Resp914_Length # print this figure...


# Export the figures to pdf
ggarrange(Resp914_Length,Resp914_bLengthALL_reps,nrow = 2) %>%
  ggexport(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Respiration/20210914_figs_tables/20210914_RR_bfactor_ALL.pdf")

```


# 9/30/2021 F1 juvenile scallops

**About**

- two pCO2 treatments 

- *before* we culled and started the food limitation trials


#### number of replicates for analysis...

```{r 9/30 replicates, echo=FALSE}

Resp_0930 <- Resp.Master %>% 
  dplyr::filter(Date %in% '9/30/2021')  %>% # call only 9/14
  dplyr::mutate(pHxFood = paste(pH,Fed_Unfed, sep = "_")) %>% 
  dplyr::mutate(random_fact = as.factor(paste(Chamber_tank, Fed_Unfed, sep="_")))

kable(Resp_0930 %>% dplyr::group_by(Chamber_tank, Food) %>% dplyr::summarise(n())) # tank replication - lowest value was 2 for 7.5_D unfed

Resp_0930 %>% summarySE(measurevar="resp_umol_hr_bFactorNormLength.ALL", groupvars=c("pCO2"))

Resp_0930 %>% summarySE(measurevar="resp_umol_hr_bFactorNormLength.FOOD", groupvars=c("pCO2"))

```


## 9/30/2021 linear model, diagnostics, and plots

#### Length standardized

```{r 9/30 Length standardized, echo=TRUE, message = FALSE, warning = FALSE}

# Objective: run AOV and LME for the data, rationale being that we have mutliple samples per replicate tank
# thus important that we address this random effect. Performing AOV and LME allows us to run model selection using AIC 
# to determine the model with the better fit 


# NOTE: 
# this chunk demonstrates that our data is non-normally distributed, thus we will need 
# to either transform to resolve or resort to a nonparametric test
# given we have a two-way factorial design (in our simple linear model) we can use the Scheirer-Ray-Hare Test 
# https://rcompanion.org/handbook/F_14.html
library(rcompanion) # install.packages('rcompanion')
library(FSA)
install.packages('FSA')









# b FACTOR ALL  'resp_umol_hr_bFactorNormLength.ALL' ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# note: day 0 of initiating the food treatment thus ONLY b factor ALL is used in this chuck for 9/14

# Visualize the data with the random effect of tank replicate 
Resp930_bLengthALL_reps <- ggboxplot(Resp_0930, 
                                 x = "pHxFood", 
                                 y = "resp_umol_hr_bFactorNormLength.ALL", 
                                 color = "Replicate",
          add = c("mean_se", "dotplot"),
          palette = c("#00AFBB", "#E7B800", "brown", "grey"))
Resp930_bLengthALL_reps

# One-way ANOVA (without the random effect) 
AOV930.bfactALL <- aov(resp_umol_hr_bFactorNormLength.ALL ~ 
                       pCO2 * Fed_Unfed, 
                     data=Resp_0930) # run mod
# check model assumptions
shapiro.test(residuals(AOV930.bfactALL)) # non-normal - 0.002926
leveneTest(AOV930.bfactALL) # homogeneity of variance (equal variance) - 0.3667
pander(aov(AOV930.bfactALL), style='rmarkdown') # table for anova test
# |       &nbsp;       | Df |  Sum Sq  | Mean Sq  | F value | Pr(>F)  |
# |:------------------:|:--:|:--------:|:--------:|:-------:|:-------:|
# |      **pCO2**      | 1  | 0.009064 | 0.009064 |  2.414  | 0.1254  |
# |   **Fed_Unfed**    | 1  | 0.01979  | 0.01979  |  5.272  | 0.02513 | # significant
# | **pCO2:Fed_Unfed** | 1  | 0.002959 | 0.002959 | 0.7881  | 0.3782  |
# |   **Residuals**    | 61 |  0.229   | 0.003755 |   NA    |   NA    |
SRH930.bfactALL <- scheirerRayHare(resp_umol_hr_bFactorNormLength.ALL ~ 
                       pCO2 * Fed_Unfed, 
                     data=Resp_0930) # run mod
# all is good, lets see the results
pander(print(SRH930.bfactALL), style='rmarkdown') # table for SRH test
# |       &nbsp;       | Df | Sum Sq |   H    | p.value |
# |:------------------:|:--:|:------:|:------:|:-------:|
# |      **pCO2**      | 1  | 218.5  | 0.6113 | 0.4343  |
# |   **Fed_Unfed**    | 1  |  2142  | 5.993  | 0.01436 | # significant, no change to the non normal anova
# | **pCO2:Fed_Unfed** | 1  | 378.9  |  1.06  | 0.3032  |
# |   **Residuals**    | 61 | 20114  |   NA   |   NA    |
# output results 
kable(data.frame(unclass(print(SRH930.bfactALL)), 
                   check.names = FALSE, 
                   stringsAsFactors = FALSE)  ) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Respiration/20210930_figs_tables/20210930_SRH_RR_bfactor_ALL.png", zoom = 1.5)

# Linear mixed effects model with random effect of Replicate 
LME930.bfactALL<-lme(resp_umol_hr_bFactorNormLength.ALL ~ 
                     pCO2*Fed_Unfed, 
                     random=~1|Chamber_tank, # with the random effect as an LME model (Chamber_tank = replicate as 7.5_A, 7.5_B)
                     data=Resp_0930) 
# check model assumptions
shapiro.test(residuals(LME930.bfactALL)) # non-normal - 0.006321 !!!!!!!!!
leveneTest(residuals(LME930.bfactALL) ~ Resp_0930$pCO2) # 0.1546 
leveneTest(residuals(LME930.bfactALL) ~ Resp_0930$Fed_Unfed) # 0.4334 
# AIC model selection
pander(AIC(AOV930.bfactALL, LME930.bfactALL), style='rmarkdown') # anova table of lmer
# |       &nbsp;        | df |  AIC   |
# |:-------------------:|:--:|:------:|
# | **AOV930.bfactALL** | 5  | -172.7 | # for negative AIC, the lower the AIC the best fit the model - the simple AOV is better 
# | **LME930.bfactALL** | 6  | -144.9 |


# In summary, we looked at our non-normal LME and AOV and again found the simple model outweighs the variance 
# explained when the random factor was addressedin the LME, thus we will moved forward with the simple model 
# as opposed to transforming the data, used the Scheirer-Ray-Hare Test as a nonparametric two-factor test 
# the outcome of which did not change relative to the non-normal AOV 
# result: report the SRH test 

# food supply diff - report this percent difference alonside the significant effect
Resp_0930 %>% summarySE(measurevar="resp_umol_hr_bFactorNormLength.ALL", groupvars="Fed_Unfed")
perc_diff <- (0.10579268 - 0.06994931)/0.10579268*100
perc_diff #33.88077 %


# plot
Resp930_Length <- ggplot(Resp_0930, 
                         aes(x = factor(pCO2, level = c('500 μatm', '800 μatm')), 
                             resp_umol_hr_bFactorNormLength.ALL , 
                             fill = pCO2)) +
                    theme(panel.grid=element_blank()) +
                    geom_boxplot(size=0.2, width=0.5, alpha=0.1, aes(fill=pCO2)) +
                    scale_fill_manual(values=c("white","grey50")) +
                    geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
                    theme_classic() +
                    scale_x_discrete(labels= c('~500 μatm', '~800 μatm')) +
                   # scale_y_continuous(expand = c(0, 0), limits = c(0, 2)) +
                    labs(title = "F1 Scallops: respiration rates on 20210930 (b factor ALL)", 
                         y = expression(Respiration~rate~"("~μmol~L^{-1}~O[2]%.%mm~shell~length^{-1}%.% hr^{-1}~")"),
                         x = expression(italic(p)*CO[2]~Treatment~"("~μ*atm~")")) + 
                    theme(axis.text=element_text(size=8),
                          axis.title=element_text(size=8,face="bold")) +
                    stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white") + 
                    facet_wrap(~Fed_Unfed)  
Resp930_Length # print this figure...


# Export the figures to pdf
ggarrange(Resp930_Length,Resp930_bLengthALL_reps,nrow = 2) %>%
  ggexport(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Respiration/20210930_figs_tables/20210930_RR_bfactor_ALL.pdf")














# b FACTOR FOOD 'resp_umol_hr_bFactorNormLength.FOOD'  ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# note: day 0 of initiating the food treatment thus ONLY b factor ALL is used in this chuck for 9/14

# Visualize the data with the random effect of tank replicate 
Resp930_bLengthFOOD_reps <- ggboxplot(Resp_0930, 
                                 x = "pHxFood", 
                                 y = "resp_umol_hr_bFactorNormLength.FOOD", 
                                 color = "Replicate",
          add = c("mean_se", "dotplot"),
          palette = c("#00AFBB", "#E7B800", "brown", "grey"))
Resp930_bLengthFOOD_reps

# One-way ANOVA (without the random effect) 
AOV930.bfactFOOD <- aov(resp_umol_hr_bFactorNormLength.FOOD ~ 
                       pCO2 * Fed_Unfed, 
                     data=Resp_0930) # run mod
# check model assumptions
shapiro.test(residuals(AOV930.bfactFOOD)) # normal - 0.07444
leveneTest(AOV930.bfactFOOD) # hetergeneity of variance  - 0.01184 
pander(aov(AOV930.bfactFOOD), style='rmarkdown') # table for anova test
# |       &nbsp;       | Df |  Sum Sq  | Mean Sq  | F value |  Pr(>F)   |
# |:------------------:|:--:|:--------:|:--------:|:-------:|:---------:|
# |      **pCO2**      | 1  | 0.01183  | 0.01183  |  3.088  |  0.08391  |
# |   **Fed_Unfed**    | 1  | 0.08515  | 0.08515  |  22.23  | 1.451e-05 |
# | **pCO2:Fed_Unfed** | 1  | 0.002842 | 0.002842 | 0.7418  |  0.3925   |
# |   **Residuals**    | 61 |  0.2337  | 0.003831 |   NA    |    NA     |
SRH930.bfactFOOD <- scheirerRayHare(resp_umol_hr_bFactorNormLength.FOOD ~ 
                       pCO2 * Fed_Unfed, 
                     data=Resp_0930) # run mod
# all is good, lets see the results
pander(print(SRH930.bfactFOOD), style='rmarkdown') # table for SRH test
# |       &nbsp;       | Df | Sum Sq |   H    |  p.value  |
# |:------------------:|:--:|:------:|:------:|:---------:|
# |      **pCO2**      | 1  | 384.5  | 1.075  |  0.2997   |
# |   **Fed_Unfed**    | 1  |  6549  | 18.32  | 1.868e-05 |
# | **pCO2:Fed_Unfed** | 1  | 202.8  | 0.5673 |  0.4513   |
# |   **Residuals**    | 61 | 15683  |   NA   |    NA     |
# output results 
kable(data.frame(unclass(print(SRH930.bfactFOOD)), 
                   check.names = FALSE, 
                   stringsAsFactors = FALSE)  ) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Respiration/20210930_figs_tables/20210930_SRH_RR_bfactor_FOOD.png", zoom = 1.5)

# Linear mixed effects model with random effect of Replicate 
LME930.bfactFOOD<-lme(resp_umol_hr_bFactorNormLength.FOOD ~ 
                     pCO2*Fed_Unfed, 
                     random=~1|Chamber_tank, # with the random effect as an LME model (Chamber_tank = replicate as 7.5_A, 7.5_B)
                     data=Resp_0930) 
# check model assumptions
shapiro.test(residuals(LME930.bfactFOOD)) # normal - 0.2483
leveneTest(residuals(LME930.bfactFOOD) ~ Resp_0930$pCO2) # 0.2775  
leveneTest(residuals(LME930.bfactFOOD) ~ Resp_0930$Fed_Unfed) # 0.002249 **
# AIC model selection
pander(AIC(AOV930.bfactFOOD, LME930.bfactFOOD), style='rmarkdown') # anova table of lmer
# |        &nbsp;        | df |  AIC   |
# |:--------------------:|:--:|:------:|
# | **AOV930.bfactFOOD** | 5  | -171.4 |# for negative AIC, the lower the AIC the best fit the model - the simple AOV is better 
# | **LME930.bfactFOOD** | 6  | -144.2 |



# In summary, we looked at our non-normal LME and AOV and again found the simple model outweighs the variance 
# explained when the random factor was addressed in the LME, thus we will moved forward with the simple model 
# as opposed to transforming the data, used the Scheirer-Ray-Hare Test as a nonparametric two-factor test 
# the outcome of which did not change relative to the non-normal AOV 
# result: report the SRH test 

# plot
Resp930_Length_bfactFOOD <- ggplot(Resp_0930, 
                         aes(x = factor(pCO2, level = c('500 μatm', '800 μatm')), 
                             resp_umol_hr_bFactorNormLength.FOOD , 
                             fill = pCO2)) +
                    theme(panel.grid=element_blank()) +
                    geom_boxplot(size=0.2, width=0.5, alpha=0.1, aes(fill=pCO2)) +
                    scale_fill_manual(values=c("white","grey50")) +
                    geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
                    theme_classic() +
                    scale_x_discrete(labels= c('~500 μatm', '~800 μatm')) +
                   # scale_y_continuous(expand = c(0, 0), limits = c(0, 2)) +
                    labs(title = "F1 Scallops: respiration rates on 20210930 (b factor FOOD)", 
                         y = expression(Respiration~rate~"("~μmol~L^{-1}~O[2]%.%mm~shell~length^{-1}%.% hr^{-1}~")"),
                         x = expression(italic(p)*CO[2]~Treatment~"("~μ*atm~")")) + 
                    theme(axis.text=element_text(size=8),
                          axis.title=element_text(size=8,face="bold")) +
                    stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white") + 
                    facet_wrap(~Fed_Unfed)  
Resp930_Length_bfactFOOD # print this figure...

# Export the figures to pdf
ggarrange(Resp930_Length_bfactFOOD,Resp930_bLengthFOOD_reps,nrow = 2) %>%
  ggexport(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Respiration/20210930_figs_tables/20210930_RR_bfactor_FOOD.pdf")

```


# density plot - Day 64

```{r, Day 64 density respiration plot }
library(dplyr)
library(tidyr)
Resp_0930$pHxFood <- as.factor(Resp_0930$pHxFood)

df_mean <- Resp_0930 %>% 
  dplyr::group_by(pHxFood) %>% 
  dplyr::summarize(average = mean(resp_umol_hr_bFactorNormLength.ALL)) %>%
  dplyr::ungroup()
p.box <- ggplot(Resp_0930, aes(x = pHxFood, y = resp_umol_hr_bFactorNormLength.ALL)) + geom_boxplot() + geom_point(data= df_mean, mapping = aes(x = pHxFood, y = average),
             color="red") 
p.box.data <- layer_data(p.box) %>%
  select(x, ymin, lower, middle, upper, ymax, outliers, flipped_aes) %>%
  dplyr::rename(mean = flipped_aes) %>% 
  dplyr::mutate(mean  = df_mean$average) %>% 
  mutate(pHxFood = factor(x, labels = levels(Resp_0930$pHxFood), ordered = TRUE)) %>%
  select(-x)


p.box.data %>% unnest(outliers)

library(tidyverse)
denisty_box_resp_64DPF <-ggplot(p.box.data) +
                            # manually plot flipped boxplot
                            geom_segment(aes(x = ymin, xend = ymax, y = -0.15, yend = -0.15)) +
                            geom_rect(aes(xmin = lower, xmax = upper, ymin = -0.3, ymax = 0,  fill = pHxFood),color = "black") +
                            # geom_point(data = . %>% unnest(outliers), aes(x = outliers, y = -0.15), color = "grey60", size = 1) +
                            # vertical lines at Q1 / Q2 / Q3
                            geom_vline(data = . %>% select(pHxFood, lower, mean, upper) %>% gather(key, value, -pHxFood), aes(xintercept = value)) +
                            # density plot
                            geom_density(data = Resp_0930, aes(x = resp_umol_hr_bFactorNormLength.ALL, group=pHxFood, fill=pHxFood, ..scaled..), alpha=.4, adjust=1.5) +
                            #  theme
                            theme_classic() +
                            xlim(0, 0.22) +
                            facet_grid(pHxFood ~ .) +
                            theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "none", plot.title = element_text(size=10))+
                            labs(title = "F1 Scallops: respiration rates 64 DPF)", 
                                 x = expression(Respiration~rate~"("~μmol~L^{-1}~O[2]%.%mm^{-1}~shell~length%.% hr^{-1}~")"),
                                 y = "Scaled density") +
                            scale_fill_manual(values=c("grey40", "grey40", "grey85", "grey85"))
denisty_box_resp_64DPF


pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Respiration/20210930_figs_tables/20210930_RRbfactorALL_density_plot.pdf"), width = 5, height = 5)
denisty_box_resp_64DPF # print the model diagnostics 
dev.off()

```

# 10/26/2021 F1 juvenile scallops

**About**

- two pCO2 treatments 

- *before* we culled and started the food limitation trials


#### number of replicates for analysis...

```{r 10/26 replicates, echo=FALSE}

Resp_1026 <- Resp.Master_OM %>% 
  dplyr::filter(Date %in% '10/26/2021')  %>% # call only 10/14
  dplyr::select(-Center) %>% 
  dplyr::mutate(pHxFood = paste(pH,Food, sep = "_")) %>% 
  dplyr::mutate(random_fact = as.factor(paste(Chamber_tank, Food, sep="_")))

kable(Resp_1026 %>% dplyr::group_by(Chamber_tank, Food) %>% dplyr::summarise(n())) # tank replication

Resp_1026 %>% summarySE(measurevar="resp_µmol_L_mm_Length_hr", groupvars=(c("Food","pH"))) %>% 
      dplyr::mutate(pCO2 = case_when(pH == 8  ~ "500 μatm", pH == 7.5 ~ "800 μatm"))
```


### 10/26/2021 Linear mixed-effects models, diagnostics, and plots


#### Length standardized

```{r 10/26 Length standardized, echo=TRUE, message = FALSE, warning = FALSE}

# Shell length standardized (SL) ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

# Visualize the data with the random effet as treplicate 
Res1026_Length_reps <- ggboxplot(Resp_1026, x = "pHxFood", y = "resp_µmol_L_mm_Length_hr", color = "Replicate",
                          add = c("mean_se", "dotplot"),
                          palette = c("#00AFBB", "#E7B800", "brown", "grey"))
Res1026_Length_reps

# ANOVA (wihtout the random effect
summary(aov(resp_µmol_L_mm_Length_hr ~ pCO2 * Food, data=Resp_1026)) # 0.0392 * (pCO2) 0.0499 * (food) - without the random effect of tank)
#             Df Sum Sq Mean Sq F value Pr(>F)  
# pCO2         1 0.0089 0.00888   0.606 0.4428  
# Food         1 0.0815 0.08148   5.562 0.0256 *
# pCO2:Food    1 0.0056 0.00561   0.383 0.5410  
# Residuals   28 0.4102 0.01465  

require(nlme)
# Linear mixed effects model with random effect of Replicate 
LMEmod_1026_SL<-lme(resp_µmol_L_mm_Length_hr ~ pCO2 * Food, random=~1|random_fact, data=Resp_1026)
# |     &nbsp;      | numDF | denDF | F-value |  p-value  |
# |:---------------:|:-----:|:-----:|:-------:|:---------:|
# | **(Intercept)** |   1   |  15   |  72.15  | 4.086e-07 |
# |    **pCO2**     |   1   |  12   | 0.2441  |  0.6302   |
# |    **Food**     |   1   |  12   |  23.56  | 0.0003955 | **
# |  **pCO2:Food**  |   1   |  12   | 0.5343  |  0.4788   |
pander(anova(LMEmod_1026_SL), style='rmarkdown')
kable(as.data.frame(anova(LMEmod_1026_SL))) %>% 
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Respiration/20211026_figs_tables/20211026_resp_LME_Table.png", zoom = 1.5)
pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Respiration/20211026_figs_tables/20211026_resp_LME_Diagnostics.pdf"))
check_model(LMEmod_1026_SL) 
dev.off()

# shapiro wilk normality test
shapiro.test(residuals(LMEmod_1026_SL)) #  normal - 0.9677
# levene's test
leveneTest(residuals(LMEmod_1026_SL) ~ Resp_1026$pCO2*Resp_1026$Food) # 2.08e-06 *** no pass

# food supply diff
Resp_1026 %>% summarySE(measurevar="resp_µmol_L_mm_Length_hr", groupvars="Food")
perc_diff <- (0.08566193 - 0.02248406)/0.08566193*100
perc_diff #42.7 %

# call the results of LMER to add to boxplot below 
DF   <- paste( (anova(LMEmod_01026_SL)[[1]])[3], (anova(LMEmod_01026_SL)[[2]])[3], sep = '/') # call DF
Fval <- (anova(LMEmod_01026_SL)[[3]])[3] # call f
pval <- (anova(LMEmod_01026_SL)[[4]])[3] # call p value

# plot
Resp1026_Length <- ggplot(Resp_1026, aes(x = factor(pCO2, level = c('500 μatm', '800 μatm')), resp_µmol_L_mm_Length_hr , fill = pCO2)) +
              theme(panel.grid=element_blank()) +
              geom_boxplot(size=0.2, width=0.5, alpha=0.1, aes(fill=pCO2)) +
              scale_fill_manual(values=c("white","grey50")) +
              geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
              theme_classic() +
              scale_x_discrete(labels= c('~500 μatm', '~800 μatm')) +
              # scale_y_continuous(expand = c(0, 0), limits = c(0, 250)) +
              theme(axis.text=element_text(size=8),
                    axis.title=element_text(size=8,face="bold")) +
              labs(title = "F1 Scallops: respiration rates on 20211026 (shell length stand.)", 
                   y = expression(Respiration~rate~"("~μmol~L^{-1}~O[2]%.%mm^{-1}~shell~length%.% hr^{-1}~")"),
                   x = expression(italic(p)*CO[2]~Treatment~"("~μ*atm~")"))  + 
              facet_wrap(~factor(Fed_Unfed, level = c('Low food', 'High food'))) # +
Resp1026_Length # the CH5 Run 1 (10/26 data) appears to be an outlier - this was rerun and inserted in a cluster above - the raw plots data shows that this very rapid rate was delayed, possibly a resp vessel malfunction??


# Export to pdf
ggarrange(Resp1026_Length, Res1026_Length_reps,nrow = 2) %>% 
  ggexport(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Respiration/20211026_figs_tables/20211026_resp_Figures.pdf")

```


# density plot - Day 92

```{r, Day 92 density respiration plot }
library(dplyr)
library(tidyr)
Resp_1026$pHxFood <- as.factor(Resp_1026$pHxFood)
Resp_1026$resp_µmol_L_mm_Length_hr.noSCI     <- format(as.numeric(Resp_1026$resp_µmol_L_mm_Length_hr), scientific = FALSE, digits = 3)
Resp_1026$resp_µmol_L_mm_Length_hr.NUM       <- as.numeric(sprintf("%s", Resp_1026$resp_µmol_L_mm_Length_hr.noSCI))

df_mean <- Resp_1026 %>% 
  dplyr::group_by(pHxFood) %>% 
  dplyr::summarize(average = mean(resp_µmol_L_mm_Length_hr.NUM)) %>%
  dplyr::ungroup()
p.box <- ggplot(Resp_1026, aes(x = pHxFood, y = resp_µmol_L_mm_Length_hr.NUM)) + geom_boxplot() + geom_point(data= df_mean, mapping = aes(x = pHxFood, y = average),
             color="red") 
p.box.data <- layer_data(p.box) %>%
  select(x, ymin, lower, middle, upper, ymax, outliers, flipped_aes) %>%
  dplyr::rename(mean = flipped_aes) %>% 
  dplyr::mutate(mean  = df_mean$average) %>% 
  mutate(pHxFood = factor(x, labels = levels(Resp_1026$pHxFood), ordered = TRUE)) %>%
  select(-x)


p.box.data %>% unnest(outliers)


denisty_box_resp_92DPF <-ggplot(p.box.data) +
                            # manually plot flipped boxplot
                            geom_segment(aes(x = ymin, xend = ymax, y = -0.15, yend = -0.15)) +
                            geom_rect(aes(xmin = lower, xmax = upper, ymin = -0.3, ymax = 0,  fill = pHxFood),color = "black") +
                            #geom_point(data = . %>% unnest(outliers), aes(x = outliers, y = -0.15), color = "grey60", size = 1) +
                            # vertical lines at Q1 / Q2 / Q3
                            geom_vline(data = . %>% select(pHxFood, lower, mean, upper) %>% gather(key, value, -pHxFood), aes(xintercept = value)) +
                            # density plot
                            geom_density(data = Resp_1026, aes(x = resp_µmol_L_mm_Length_hr.NUM, group=pHxFood, fill=pHxFood, ..scaled..), alpha=.4, adjust=1.5) +
                            #  theme
                            theme_classic() +
                            facet_grid(pHxFood ~ .) +
                            theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "none", plot.title = element_text(size=10))+
                            labs(title = "F1 Scallops: respiration rates 92 DPF)", 
                                 x = expression(Respiration~rate~"("~μmol~L^{-1}~O[2]%.%mm^{-1}~shell~length%.% hr^{-1}~")"),
                                 y = "Scaled density") +
                            scale_fill_manual(values=c("grey40", "grey40", "grey85", "grey85"))
denisty_box_resp_92DPF

pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_OA-foodsupply/RAnalysis/Output/Respiration/20211026_figs_tables/20211026_resp_density_plot.pdf"), width = 5, height = 5)
denisty_box_resp_92DPF # print the model diagnostics 
dev.off()

```
