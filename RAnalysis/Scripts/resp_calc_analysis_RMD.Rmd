---
title: "Respiration Analysis F1 Scallops 2021"
author: "Samuel Gurr"
date: "10/6/2021"
output:
  html_document:
    df_print: paged
  pdf_document:
    latex_engine: xelatex
---


```{r setup, include=FALSE}

# LOAD PACKAGES :::::::::::::::::::::::::::::::::::::::::::::::::::::::

library(dplyr)
library(ggplot2)
library(forcats)
library(lme4)
library(lmerTest)
library(see)
library(performance)
library(car)
library(kableExtra)
library(pander)
library(data.table)
library(stringr)
library(latex2exp)
library(Rmisc)
library(devtools)
library(ggpubr)
library(hrbrthemes)

# SET WORKING DIRECTORY :::::::::::::::::::::::::::::::::::::::::::::::

# setwd("C:/Users/samjg/Documents/Github_repositories/Airradians_OA/RAnalysis") # personal computer
 setwd("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA/RAnalysis") # Work computer
# setwd("C:/Users/samjg/Documents/Github_repositories/Airradians_OA/RAnalysis") # Work computer

# LOAD DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

resp.data       <- read.csv(file="Output/Respiration/Cumulative_resp_alpha0.4_15sectrunc1hour.csv", header=T) %>% 
                      dplyr::filter(!Date %in% "9/14/2021" | !Filename %in% 'Run_1_raw.txt') # read the calculate raw rates from 'resp_LoLin' script - contains the calculated rate (not normalized for blanks) for each sensor-channel
exp_metadata    <- read.csv(file="Data/ExperimentMetadata.csv", header=T) # treatment assignments to 'Chamber_Tank'
lengths         <- read.csv(file="Data/Respiration/Lengths_Condition_resp_clearance.csv", header=T)
resp.ref        <- read.csv(file="Data/Respiration/Reference_master.csv", header=T) %>% dplyr::filter(!Date %in% "9/14/2021" | !Filename %in% 'Run_1_raw.txt')
DWs_Len_1026    <- read.csv(file="Data/Survival_Size/20211026_lengths_dryweights.csv", header=T)
DWs_Len_914.930 <- read.csv(file="Data/Survival_Size/2021914_930_dryweights.csv", header=T)

```


```{r dry weight and length data, include=FALSE}


# 20210914 ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

<<<<<<< HEAD
# Tissue Dry Weight (DW) vs Shell length :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
=======

Length_914           <- lengths         %>% 
  dplyr::filter(Date %in% '9/14/2021')  %>% 
  dplyr::select(c("Replicate","pH","Number","Food", "Run", "Food", "Plate", "Length_um"))
Dryweight_914        <- DWs_Len_914.930 %>% 
  dplyr::filter(Date %in% '20210914')   %>% 
  dplyr::filter(Purpose %in% 'resp_filtration') %>% 
  dplyr::rename(Replicate = Rep)        %>% 
  dplyr::rename(pH = Treatment)         %>% 
  dplyr::rename(Number = Num)           %>% 
  dplyr::select(c("Replicate","pH","Number", "Plate","Run","Scallop_DW_mg"))
DW_Len_914 <- merge(Length_914, Dryweight_914)
DW_Len_914$Date <- "9/14/2021"
>>>>>>> d282f00666fe5031a77f73ae2d101bad03875c20


# DW_Len_914 %>% ggplot(aes(x = Length_um, y = Scallop_DW_mg)) +
#         geom_smooth(method = "lm", se=FALSE, color="black", formula = Scallop_DW_mg ~ Length_um) +
#         theme_classic() +
#         ylab("Whole animal dry weight (mg)") +
#         xlab("Shell length (um)") +
#         geom_point() + 
#         geom_smooth(method='lm')

<<<<<<< HEAD
Tissue_DW_1026_subset <- Tissue_DW_1026 %>% dplyr::filter(Shell.Length < 10)  # animals < 10 um shelllength
fit                   <- lm(weight ~ (Shell.Length)^2, data = Tissue_DW_1026_subset)

P_DW_v_ShellLen      <- ggplot(data = Tissue_DW_1026_subset, aes(x = (Shell.Length), y = weight)) +
                                geom_smooth(method = "lm", se=FALSE, color="black", formula = weight ~ Shell.Length) +
                                theme_classic() +
                                ylab("Tissue dry weight (mg)") +
                                xlab("Shell length (um)") +
                                # stat_function(fun=my_eq, colour="red") +
                                geom_point() + 
                                xlim(0,15) +
                                geom_smooth(method='lm') # y~0+x if you want it through the origin (0,0)
                           
P_DW_v_ShellLen    


P_DW_v_ShellLen2      <- ggplot(data = Tissue_DW_1026_subset, aes(x = (Shell.Length)^2, y = weight)) +
                                geom_smooth(method = "lm", se=FALSE, color="black", formula = weight ~ Shell.Length) +
                                theme_classic() +
                                ylab("Tissue dry weight (mg)") +
                                xlab("[ Shell length (um) ]^2") +
                                # stat_function(fun=my_eq, colour="red") +
                                geom_point() + 
                                xlim(0,100) +
                                annotate(label = sprintf("y = %.3f x\nR² = %.2f", coef(fit), summary(fit)$r.squared),
                                         geom = "text", x = 80, y = 0.0010, size = 5) +
                                geom_smooth(method='lm') # y~0+x if you want it through the origin (0,0)
                           
P_DW_v_ShellLen2     


DW

# 20210914 ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
WholeScal_DW_914     <- lengths %>% dplyr::filter(Date %in% '9/14/2021')
DWs_Len_914          <- DWs_Len_914.930 %>% dplyr::filter(Date %in% '20210914') %>% dplyr::filter(Purpose %in% 'resp_filtration')
Scallop_DW_mg




# 20210930 ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
WholeScal_DW_930     <- lengths %>% dplyr::filter(Date %in% '9/30/2021') %>% dplyr::rename(Rep = Replicate) %>% dplyr::rename(Fed_unfed = Food) %>% dplyr::rename(Treatment = pH)  %>% dplyr::rename(Num = Number)
DWs_Len_930          <- DWs_Len_914.930 %>% dplyr::filter(Date %in% '20210930') %>% dplyr::filter(Purpose %in% 'resp_filtration') 

MasterDWLength_930 <- merge(WholeScal_DW_930, DWs_Len_930, by = c('Treatment','Num','Rep','Plate','Run', 'Fed_unfed'))

ggplot(data = MasterDWLength_930, aes(x = (Length_um)/1000, y = Scallop_DW_mg)) +
                                geom_smooth(method = "loess", se=FALSE, color="black", formula = Scallop_DW_mg ~ Length_um) +
                                geom_point() + 
                                theme_classic() +
                                ylab("Whole animal dry weight (mg)") +
                                xlab("Shell length (mm)") +
                                # stat_function(fun=my_eq, colour="red") +
                                xlim(0,6) +
                                geom_smooth(method='loess') # y~0+x if you want it through the origin (0,0)

ggplot(data = MasterDWLength_930, aes(x = ((Length_um)/1000)^2, y = Scallop_DW_mg)) +
                                geom_smooth(method = "lm", se=FALSE, color="black", formula = Scallop_DW_mg ~ Length_um) +
                                geom_point() + 
                                theme_classic() +
                                ylab("Whole animal dry weight (mg)") +
                                xlab("[Shell length (mm)]^2") +
                                # stat_function(fun=my_eq, colour="red") +
                                xlim(0,35) +
                                geom_smooth(method='lm') # y~0+x if you want it through the origin (0,0)
=======



# 20210930 ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
>>>>>>> d282f00666fe5031a77f73ae2d101bad03875c20



Length_930           <- lengths         %>% 
  dplyr::filter(Date %in% '9/30/2021')  %>% 
  dplyr::select(c("Replicate","pH","Number", "Food", "Run", "Plate","Length_um"))
Dryweight_930        <- DWs_Len_914.930 %>% 
  dplyr::filter(Date %in% '20210930')   %>% 
  dplyr::filter(Purpose %in% 'resp_filtration') %>% 
  dplyr::rename(Number = Num)           %>% 
  dplyr::rename(Replicate = Rep)        %>% 
  dplyr::rename(pH = Treatment)         %>% 
  dplyr::rename(Food = Fed_unfed)       %>% 
  dplyr::select(c("Replicate","pH","Number", "Food", "Run", "Plate","Scallop_DW_mg"))
DW_Len_930 <- merge(Length_930, Dryweight_930)
DW_Len_930$Date <- "9/30/2021"

DW_Len_930 %>% ggplot(aes(x = Length_um, y = Scallop_DW_mg)) +
        geom_smooth(method = "lm", se=FALSE, color="black", formula = Scallop_DW_mg ~ Length_um) +
        theme_classic() +
        ylab("Whole animal dry weight (mg)") +
        xlab("Shell length (um)") +
        geom_point() + 
        geom_smooth(method='lm') + # y~0+x if you want it through the origin (0,0)
        facet_wrap(~Food)

# 20211026 ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
Length_1026_Unfed    <- lengths         %>% 
  dplyr::filter(Date %in% '10/26/2021') %>% 
  dplyr::select(c("Replicate","pH","Number", "Food", "Run", "Plate","Length_um"))
Dryweight_1026_Unfed <- DWs_Len_914.930 %>% 
  dplyr::filter(Date %in% '20211026')   %>% 
  dplyr::filter(Purpose %in% 'resp_filtration') %>% 
  dplyr::rename(Food = Fed_unfed)       %>% 
  dplyr::rename(Replicate = Rep)        %>% 
  dplyr::rename(pH = Treatment)         %>% 
  dplyr::rename(Number = Num)           %>% 
  dplyr::select(c("Replicate","pH","Number", "Food","Run", "Plate",  "Scallop_DW_mg"))
DW_Len_1026_unfed <- merge(Length_1026_Unfed, Dryweight_1026_Unfed)
DW_Len_1026_unfed$Date <- "10/26/2021"

# fed data - 'lengths' has the dry weight for shell and tissue in the 'fed' animals o 10/26/2021

DW_Len_1026_Fed    <- lengths           %>% 
  dplyr::filter(Date %in% '10/26/2021' & Food %in% 'fed') %>% 
  dplyr::select(c("Replicate","pH","Number", "Food", "Run", "Plate","Length_um", 'Dry_Shell_weight', 'Dry_Tissue_weight')) %>% # call the dry weights that were complete separately 
  dplyr::mutate(Scallop_DW_mg = (Dry_Shell_weight + Dry_Tissue_weight)*1000) %>% # calculate the total animal dry weight and covert to mg ( *1000)- this corresponds with the data we have for smaller animals on previous dates
  dplyr::select(!c('Dry_Tissue_weight','Dry_Shell_weight')) # omit these to merge to the master file ""
DW_Len_1026_Fed$Date <- "10/26/2021"


# Dry weights for the shell and tissue separately - note ONLY animals from 10/26 had their shell and tissue removed for separate dry weights
# Shell dry weight
 lengths           %>% 
  dplyr::filter(Date %in% '10/26/2021' & Food %in% 'fed') %>% 
  dplyr::select(c("Replicate","pH","Number", "Food", "Run", "Plate","Length_um", 'Dry_Shell_weight', 'Dry_Tissue_weight')) %>% 
  ggplot(aes(x = Length_um, y = Dry_Shell_weight)) +
        geom_smooth(method = "lm", se=FALSE, color="black", formula = Dry_Shell_weight ~ Length_um) +
        theme_classic() +
        ylab("Shell dry weight (mg)") +
        xlab("Shell length (um)") +
        geom_point() + 
        geom_smooth(method='lm') # y~0+x if you want it through the origin (0,0)# 
# Tissue dry weight
  lengths           %>% 
  dplyr::filter(Date %in% '10/26/2021' & Food %in% 'fed') %>% 
  dplyr::select(c("Replicate","pH","Number", "Food", "Run", "Plate","Length_um", 'Dry_Shell_weight', 'Dry_Tissue_weight')) %>% 
  ggplot(aes(x = Length_um, y = Dry_Tissue_weight)) +
        geom_smooth(method = "lm", se=FALSE, color="black", formula = Dry_Tissue_weight ~ Length_um) +
        theme_classic() +
        ylab("Tissue dry weight (mg)") +
        xlab("Shell length (um)") +
        geom_point() + 
        geom_smooth(method='lm') # y~0+x if you want it through the origin (0,0)
  
#Whole animal dry weight by shell size (10/26 only!) 
rbind(DW_Len_1026_Fed, DW_Len_1026_unfed) %>% 
ggplot(aes(x = Length_um, y = Scallop_DW_mg)) +
        geom_smooth(method = "lm", se=FALSE, color="black", formula = Scallop_DW_mg ~ Length_um) +
        theme_classic() +
        ylab("Whole animal dry weight (mg)") +
        xlab("Shell length (um)") +
        geom_point() + 
        geom_smooth(method='lm') + # y~0+x if you want it through the origin (0,0)
        facet_wrap(~Food)





# Explore the DW and shell length relationship in our data...
Master_SizeStand_dat      <- rbind(DW_Len_1026_unfed, DW_Len_1026_Fed, DW_Len_930, DW_Len_914)
WholeDW_Shelllength       <- Master_SizeStand_dat[!is.na(Master_SizeStand_dat$Length_um),] %>%  
                            ggplot(aes(x = Length_um, y = Scallop_DW_mg)) +
                                geom_smooth(method = "lm", se=FALSE, color="black", formula = Scallop_DW_mg ~ Length_um) +
                                theme_classic() +
                                ylab("Whole animal dry weight (mg)") +
                                xlab("Shell length (um)") +
                                # stat_function(fun=my_eq, colour="red") +
                                geom_point() + 
                                # xlim(0,100) +
                                # annotate(label = sprintf("y = %.3f x\nR² = %.2f", coef(fit), summary(fit)$r.squared),
                                #          geom = "text", x = 80, y = 0.0010, size = 5) +
                                geom_smooth(method='loess')
WholeDW_Shelllength %>% 
  ggexport(filename = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/Respiration/All_SizeRegression_WholeDW_ShellLength.pdf")

WholeDR_Length_sq_0_5um       <- Master_SizeStand_dat[!is.na(Master_SizeStand_dat$Length_um),] %>%  
                            dplyr::filter(Length_um < 5000) %>% 
                            ggplot(aes(x = Length_um^2, y = Scallop_DW_mg)) +
                                geom_smooth(method = "lm", se=FALSE, color="black", formula = Scallop_DW_mg ~ Length_um^2) +
                                theme_classic() +
                                ylab("Whole animal dry weight (mg)") +
                                xlab("Shell length (um)") +
                                # stat_function(fun=my_eq, colour="red") +
                                geom_point() + 
                                # xlim(0,100) +
                                # annotate(label = sprintf("y = %.3f x\nR² = %.2f", coef(fit), summary(fit)$r.squared),
                                #          geom = "text", x = 80, y = 0.0010, size = 5) +
                                geom_smooth(method='lm')
WholeDR_Length_sq_0_5um

WholeDR_Length_sq_5um       <- Master_SizeStand_dat[!is.na(Master_SizeStand_dat$Length_um),] %>%  
                            dplyr::filter(Length_um > 5000) %>% 
                            ggplot(aes(x = Length_um^2, y = Scallop_DW_mg)) +
                                geom_smooth(method = "lm", se=FALSE, color="black", formula = Scallop_DW_mg ~ Length_um^2) +
                                theme_classic() +
                                ylab("Whole animal dry weight (mg)") +
                                xlab("Shell length (um)") +
                                # stat_function(fun=my_eq, colour="red") +
                                geom_point() + 
                                # xlim(0,100) +
                                # annotate(label = sprintf("y = %.3f x\nR² = %.2f", coef(fit), summary(fit)$r.squared),
                                #          geom = "text", x = 80, y = 0.0010, size = 5) +
                                geom_smooth(method='lm')
WholeDR_Length_sq_5um
```



### Merge master resp data frame with lengths

```{r merge resp with length data and treatment IDs, echo=FALSE}

# merge the exp_metadata with the resp.data
resp.ref_length_merged                 <- merge(resp.ref, lengths) # all TRUE allows us to keep the blanks
resp.data_merged                       <- merge(resp.data, resp.ref_length_merged) %>% # out master file moving forward....
                                            dplyr::mutate(filetype = str_sub(Filename, -3,-1)) %>% 
                                            dplyr::mutate(filetype = factor(ifelse(filetype == "csv", "SDR_data", "LoLigo_data")))
kable(head(resp.data_merged))

```

#### Visual diagnostic plots to correct poor data (3 data points to change..)

- View on github: Airradians_OA/RAnalysis/Output/Respiration/plots_alpha0.4_increm15sec/

- found three calls that inaccurately represent the rates of oxygen consumption 

(1) https://github.com/SamGurr/Airradians_OA/blob/master/RAnalysis/Output/Respiration/plots_alpha0.4_increm15sec/20210930_Plate_2_Run_2_C5_regression.pdf
- solution = call 'Lz' instead of the default Leq

(2) https://github.com/SamGurr/Airradians_OA/blob/master/RAnalysis/Output/Respiration/plots_alpha0.4_increm15sec/20210930_Plate_2_Run_1_C1_regression.pdf
- solution = call 'Lz' instead of the default Leq

(3) https://github.com/SamGurr/Airradians_OA/blob/master/RAnalysis/Output/Respiration/plots_alpha0.4_increm15sec/20210930_Plate_1_Run_2_C1_regression.pdf
- solution = we reran this at the end of the LoLin script  for 0-20 minutes and got an Lpc  -0.0296, insert this 

```{r IMPORTANT correct poor data, echo=TRUE, message = FALSE, warning = FALSE}
resp.data_merged[95,c(1:6)]  # 	C1 RR_9.30.21_AM_Plate_2_Run_1.csv # -0.02890813	-0.0608251	-0.0608251 - Lz and Leq call better regression than Lpc
resp.data_merged[111,c(1:6)] #  C5 RR_9.30.21_PM_Plate_2_Run_2.csv	0.029052351	-0.076034441	-0.076034441
resp.data_merged[96,c(1:6)]  # 	C1 RR_9.30.21_PM_Plate_1_Run_2.csv	0.011656487	0.011656487	0.011656487  - ommit this

resp.data_merged[95,4] <- resp.data_merged[95,5] # 20210930_Plate_2_Run_2_C5_regression - Lz and Leq call better regression than Lpc
resp.data_merged[111,4] <- resp.data_merged[111,5] # 20210930_Plate_2_Run_1_C1_regression - Lz and Leq call better regression than Lpc
resp.data_merged[96,4] <- -0.0296 # 20210930_Plate_1_Run_2_C1_regression - plot shows noise after the 20 minutes mark, we reran this at the end of the LoLin script, insert here!

resp.data_merged[95,c(1:6)]
resp.data_merged[111,c(1:6)]
resp.data_merged[96,c(1:6)]
```

#### Calculate blank rates, view means by day pH_treatment and instrument

* note: respiration rates were recorded using both SDR dish (24 channel) and Loligo 8-channel sensors - different blanks for each

```{r call blanks, echo=FALSE}

blanks_total <- data.frame() # start dataframe 
blanks.table <- data.frame(matrix(nrow = 1,ncol = 5)) # make a table template
colnames(blanks.table)<-c('Date', 'Channel', 'mean_Lpc', 'mean_Leq' , 'mean_Lz') # names for comuns in the for loop

blanks_all_raw <- data.frame(merge(resp.ref, resp.data, by = c('Date', 'Channel', 'Filename')) %>% 
                  dplyr::mutate(filetype = str_sub(Filename, -3,-1)) %>% 
                  dplyr::mutate(filetype = factor(ifelse(filetype == "csv", "SDR_data", "LoLigo_data"))) %>% 
                  dplyr::filter(Chamber_tank  == 'blank') %>% 
                  dplyr::filter(Lpc <0) %>% 
                  dplyr::filter(!Date == '9/30/2021' | !Lpc < -0.035) %>% #omits C6 RR_9.30.21_AM_Plate_1_Run_1.csv	8.0	blank - View the Lolin plot, looks noisy and a fast outlier from the others
                  dplyr::filter(!Date == '10/26/2021'  | !Channel == "CH8" | !Run == "2" )) # omit a bad blank that contained a bad seal, noted on the respiration sampling day during the trial 
# kable((blanks_all_raw)[,c(1:3,6,8,12:14)])
blanks_means <- blanks_all_raw %>% 
     dplyr::group_by(Date, pH, filetype) %>% 
     dplyr::filter(Chamber_tank == "blank") %>% 
     dplyr::filter(Lpc <0) %>% # ommit blank calls that d/n represent oxygen consumption
     dplyr::summarise(BLANK.mean_Lpc = mean(abs(Lpc)),
                      BLANK.sd.Lpc   = sd(abs(Lpc)),
                      BLANK.mean_Leq = mean(abs(Leq)), 
                      BLANK.mean_Lz = mean(abs(Lz)),
                      n = n())
kable(blanks_means)


```


#### Merge blanks with the master file by Date, pCO2 treatment, and filetype

* 'filteype' is only important here on 20211026 when both Loligo and SDR were used due to difference in size for fed (larger) and unfed animals 

```{r merge blanks_means for a master file, echo=FALSE}

Resp.Master <- merge(resp.data_merged, blanks_means, by=c("Date", "pH",  "filetype")) %>% # NOTE: this repeats for every distinct length value
  dplyr::mutate(resp_blankStand = Lpc - BLANK.mean_Lpc) # ommits respiration rate values showing an increase in O2 over time 

```


## Master Resp file 'Resp.Master_OM', with volumes and file types, etc. saved as 'Calculated_Resp_Master.csv'

######  dplyr::mutate for the following:

* 'volume' of the different vessels throughout the fed*OA challenge
* 'Age'
* 'Fed_unfed'
* 'pCO2'

```{r master resp file, echo=FALSE}

Resp.Master_OM <- Resp.Master[!is.na(Resp.Master$Length_um),] %>% dplyr::filter(!resp_blankStand > 0) %>% # ommit respiration values that are positive  
  dplyr::mutate(volume = case_when(filetype == "LoLigo_data" & Date == '9/14/2021' ~ 2.2, # small vessels for loligo system - 22 ml vessels
                                   filetype == "LoLigo_data" & Date == '10/26/2021' & Channel == 'CH1' ~ 68.55323, # larger custom vessels measured individually...
                                   filetype == "LoLigo_data" & Date == '10/26/2021' & Channel == 'CH2' ~ 68.85583, # larger custom vessels measured individually...
                                   filetype == "LoLigo_data" & Date == '10/26/2021' & Channel == 'CH3' ~ 68.87473, # larger custom vessels measured individually...
                                   filetype == "LoLigo_data" & Date == '10/26/2021' & Channel == 'CH4' ~ 68.95481, # larger custom vessels measured individually...
                                   filetype == "LoLigo_data" & Date == '10/26/2021' & Channel == 'CH5' ~ 68.57288, # larger custom vessels measured individually...
                                   filetype == "LoLigo_data" & Date == '10/26/2021' & Channel == 'CH6' ~ 68.01878, # larger custom vessels measured individually...
                                   filetype == "LoLigo_data" & Date == '10/26/2021' & Channel == 'CH7' ~ 68.54551, # larger custom vessels measured individually...
                                   filetype == "LoLigo_data" & Date == '10/26/2021' & Channel == 'CH8' ~ 68.53297, # larger custom vessels measured individually...
                                   filetype == "SDR_data" ~ 1.7)) %>% # 24-well plate - 1700ul 
  dplyr::mutate(resp_umol_L_hr =( ( ((abs(resp_blankStand))* (1/32)) *  # convert mg O2 to umol O2 (note that the resp_blank_stand is negative raw data from LoLin.R)
                                      (volume/1000) ) * # convert to Liters
                                      60) ) %>% #  convert per minutes to per hours
  dplyr::mutate(Age = case_when(Date == '9/14/2021' ~ 50, Date == '9/30/2021' ~ 66, Date == '10/26/2021' ~ 92)) %>% 
  dplyr::mutate(Fed_Unfed = case_when(Fed_Unfed == 'F' ~ "High food", is.na(Fed_Unfed) ~ "High food", Fed_Unfed == 'U' ~ "Low food")) %>% 
  dplyr::mutate(pCO2 = case_when(pH == 8.0 ~ "500 μatm", pH == 7.5 ~ "800 μatm"))
Resp.outliers <- Resp.Master %>% dplyr::filter(resp_blankStand > 0) # call the values with positive resp rates, measing they were slower than the blank!
# print(Resp.outliers) # no outliers

```


### Relationship between Whole dry weight  v. Shell length 

```{r DW v shell length plot,  echo=TRUE, message = FALSE, warning = FALSE}
Resp.Master_OM %>% ggplot(aes(x = Length_um, y = whole_Dry_weight)) +
                                geom_smooth(method = "loess") +
                                theme_classic() +
                                ylab("Scallop_DW_mg") +
                                xlab("Length_um") +
                                geom_point() 
```


### Standardize rates as...

##### (1) shell length: umol L-1 O2 mm shell length hour-1
##### (2) whole dry weight: umol L-1 O2 g whole dry weight hour-1 

note: this chunk calls the data that used the 8-channel loligo system and the SDR system to correct for total respiration chamber (vial/vessel, well, etc.) volume separately 
- loligo 8-channel on 9/14/21 = 2.2 ml vessels 
- SDR 24-channel on 9/3-/21 = 1.7 ml wells 

```{r Calculate Resp Rates , echo=TRUE, message = FALSE, warning = FALSE}
# Resp.Master_OM <- Resp.Master_OM[!is.na(Resp.Master_OM$Length_um),]

# NORMALIZED for Shell length
Resp.Master_OM$resp_µmol_L_mm_Length_hr <- (Resp.Master_OM$resp_umol_L_hr / # multiple by 1000 to convert mmol/ O2 to umol/L O2
              (Resp.Master_OM$Length_um/1000)) # normalize by Dry tissue weight  as to mg O2 L-1 g dry tissue weight-1

# NORMALIZED for Whole animal dry weight (g)
Resp.Master_OM$resp_µmol_L_g_hr <- (Resp.Master_OM$resp_umol_L_hr / 
              (Resp.Master_OM$whole_Dry_weight/1000)) # normalize by Dry tissue weight  as to mg O2 L-1 g dry tissue weight-1


#write.csv(Resp.Master_OM, "C:/Users/samjg/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/Respiration/Calculated_Resp_Master.csv")
write.csv(Resp.Master_OM, "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/Respiration/Calculated_Resp_Master.csv")

```


### Plot the RAW rates by the size metrics here


#### Whole animal dry weight vs. raw respiration rate...

```{r Whole dry weight length vs. raw respiration rate, echo=TRUE, message = FALSE, warning = FALSE}

# by WHOLE animal dry weight  :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

P_WholeDW_resp_all  <- Resp.Master_OM[!is.na(Resp.Master_OM$resp_umol_L_hr),] %>% 
                          ggplot(aes(x = whole_Dry_weight, y = resp_umol_L_hr, color = as.factor(pCO2))) +
                            scale_color_manual(values=c("forestgreen","darkorange2"))+
                            geom_smooth(method = "lm", se=FALSE, color="black", formula = resp_umol_L_hr ~ whole_Dry_weight) +
                            theme_classic() +
                            theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(size=10))+ 
                            labs(title = "Raw Resp v. Whole dry weight (mg)", y = expression(μmol~L^{-1}~O[2]%.%hr^{-1})) +
                            xlab("Whole dry weight (mg)") +
                            geom_point()

P_WholeDW_resp_facet <- Resp.Master_OM[!is.na(Resp.Master_OM$resp_umol_L_hr),] %>% 
                          ggplot(aes(x = whole_Dry_weight, y = resp_umol_L_hr, color = as.factor(pCO2))) +
                            scale_color_manual(values=c("forestgreen","darkorange2"))+
                            geom_smooth(method = "lm", se=FALSE, color="black", formula = resp_umol_L_hr ~ whole_Dry_weight) +
                            theme_classic() +
                            theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "none",plot.title = element_text(size=10))+ 
                            labs(y = expression(μmol~L^{-1}~O[2]%.%hr^{-1})) +
                            xlab("Whole dry weight (mg)") +
                            geom_point() + 
                            facet_wrap(~Age*Food, scales = "free")


# print in markdown file 
ggarrange(P_WholeDW_resp_all, P_WholeDW_resp_facet,ncol = 2)
# Export to pdf
pdf(paste0(filename = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/Respiration/RawRespiration_by_WholeDW.pdf"), width = 10, height = 6)
ggarrange(P_WholeDW_resp_all, P_WholeDW_resp_facet,ncol = 2) 
dev.off()


```

#### Shell length vs. raw respiration rate...

```{r Shell length vs. raw respiration rate, echo=TRUE, message = FALSE, warning = FALSE}

# by Length :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

P_Length_resp_all <- Resp.Master_OM[!is.na(Resp.Master_OM$resp_umol_L_hr),] %>% 
                        ggplot(aes(x = Length_um, y = resp_umol_L_hr, color = as.factor(pCO2))) +
                         scale_color_manual(values=c("forestgreen","darkorange2"))+
                          geom_smooth(method = "lm", se=FALSE, color="black", formula = resp_umol_L_hr ~ Length_um) +
                          theme_classic() +
                          theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(size=10))+ 
                          labs(title = "Raw Resp v. Shell length (μm)", y = expression(μmol~L^{-1}~O[2]%.%hr^{-1})) +
                          xlab("Shell length") +
                          geom_point()

P_Length_resp_facet <- Resp.Master_OM[!is.na(Resp.Master_OM$resp_umol_L_hr),] %>% 
                        ggplot(aes(x = Length_um, y = resp_umol_L_hr, color = as.factor(pCO2))) +
                         scale_color_manual(values=c("forestgreen","darkorange2"))+
                          geom_smooth(method = "lm", se=FALSE, color="black", formula = resp_umol_L_hr ~ Length_um) +
                          theme_classic() +
                           theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "none", plot.title = element_text(size=10))+ 
                          labs(y = expression(μmol~L^{-1}~O[2]%.%hr^{-1})) +
                          xlab("Shell length (μm)") +
                          geom_point() + 
                          facet_wrap(~Age*Food, scales = "free")

# print in markdown file 
ggarrange(P_Length_resp_all, P_Length_resp_facet,nrow = 2)
# Export to pdf
pdf(paste0(filename = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/Respiration/RawRespiration_by_Length.pdf"), width = 10, height = 6)
ggarrange(P_Length_resp_all, P_Length_resp_facet,ncol = 2)
dev.off()

```


### All Respiration data  - Mean standard error plots


```{r Line plot , echo=TRUE, message = FALSE, warning = FALSE}

# Length :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

# Length_um
SumTab_Len      <- Resp.Master_OM[!is.na(Resp.Master_OM$Length_um),] %>%  
            summarySE(measurevar="Length_um", groupvars=c("Age", "pCO2", "Fed_Unfed"))
SumTab_Len$pCO2 <- factor(SumTab_Len$pCO2, c("500 μatm","800 μatm"))
## Use geom_line and geom_point to plot over time
Length_time    <- ggplot(data=SumTab_Len, aes(x=Age, y=Length_um, color=pCO2)) +
            geom_line(aes(linetype = factor(Fed_Unfed)), size = 0.5) +  
            geom_point()+ 
            scale_color_manual(values=c("forestgreen","darkorange2"))+
            geom_errorbar(aes(ymin=Length_um-se, ymax=Length_um+se), width=.2,
                          position=position_dodge(.1))+
            theme_bw() +  
            theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(size=10))+ 
            scale_x_continuous(name ="Age (d)") +
            labs(title =  "Shell length over time..", 
                 y = "Shell length (μm)") +
            scale_linetype_manual(values = c("High food" = "solid", "Low food" = "dashed"))  +
            theme(legend.position="none") +
            # facet_wrap(~factor(Fed_Unfed, level = c('Low food', 'High food'))) 
            facet_wrap(~pCO2)



# resp_µmol_L_mm_Length_hr
RespSumTab_Len      <- Resp.Master_OM[!is.na(Resp.Master_OM$resp_µmol_L_mm_Length_hr),] %>%  
            summarySE(measurevar="resp_µmol_L_mm_Length_hr", groupvars=c("Age", "pCO2", "Fed_Unfed"))
RespSumTab_Len$pCO2 <- factor(RespSumTab_Len$pCO2, c("500 μatm","800 μatm"))
## Use geom_line and geom_point to plot over time
Resp_LengthStand    <- ggplot(data=RespSumTab_Len, aes(x=Age, y=resp_µmol_L_mm_Length_hr, color=pCO2)) +
            geom_line(aes(linetype = factor(Fed_Unfed)), size = 0.5) +  
            geom_point()+ 
            scale_color_manual(values=c("forestgreen","darkorange2"))+
            geom_errorbar(aes(ymin=resp_µmol_L_mm_Length_hr-se, ymax=resp_µmol_L_mm_Length_hr+se), width=.2,
                          position=position_dodge(.1))+
            theme_bw() +  
            theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(size=10))+ 
            scale_x_continuous(name ="Age (d)") +
            labs(title = "Resp standardized (shell length)", 
                 y = expression(μmol~L^{-1}~O[2]%.%mm^{-1}~shell~length%.% hr^{-1})) +
            scale_linetype_manual(values = c("High food" = "solid", "Low food" = "dashed"))  +
            theme(legend.position="none") +
            # facet_wrap(~factor(Fed_Unfed, level = c('Low food', 'High food'))) 
            facet_wrap(~pCO2)


# Whole dry weight :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

# whole_Dry_weight
SumTab_WholeDW      <- Resp.Master_OM[!is.na(Resp.Master_OM$whole_Dry_weight),] %>%  
            summarySE(measurevar="whole_Dry_weight", groupvars=c("Age", "pCO2", "Fed_Unfed"))
SumTab_WholeDW$pCO2 <- factor(SumTab_WholeDW$pCO2, c("500 μatm","800 μatm"))
## Use geom_line and geom_point to plot over time
WholeDW_time    <- ggplot(data=SumTab_WholeDW, aes(x=Age, y=whole_Dry_weight, color=pCO2)) +
            geom_line(aes(linetype = factor(Fed_Unfed)), size = 0.5) +  
            geom_point()+ 
            scale_color_manual(values=c("forestgreen","darkorange2"))+
            geom_errorbar(aes(ymin=whole_Dry_weight-se, ymax=whole_Dry_weight+se), width=.2,
                          position=position_dodge(.1))+
            theme_bw() +  
            theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(size=10))+ 
            scale_x_continuous(name ="Age (d)") +
            labs(title = "Whole dry weight over time..", 
                 y = "Whole dry weight") +
            scale_linetype_manual(values = c("High food" = "solid", "Low food" = "dashed"))  +
            theme(legend.position="none") +
            # facet_wrap(~factor(Fed_Unfed, level = c('Low food', 'High food'))) 
            facet_wrap(~pCO2)

RespSumTab_DW      <- Resp.Master_OM[!is.na(Resp.Master_OM$resp_µmol_L_g_hr),] %>%  
          summarySE(measurevar="resp_µmol_L_g_hr", groupvars=c("Age", "pCO2", "Fed_Unfed"))
RespSumTab_DW$pCO2 <- factor(RespSumTab_DW$pCO2, c("500 μatm","800 μatm"))
## Use geom_line and geom_point to plot over time
Resp_DryWgtStand   <- ggplot(data=RespSumTab_DW, aes(x=Age, y=resp_µmol_L_g_hr, color=pCO2)) +
          geom_line(aes(linetype = factor(Fed_Unfed)), size = 0.5) +  
          geom_point()+ 
          scale_color_manual(values=c("forestgreen","darkorange2"))+
          geom_errorbar(aes(ymin=resp_µmol_L_g_hr-se, ymax=resp_µmol_L_g_hr+se), width=.2,
                        position=position_dodge(.1))+
          theme_bw() +  
          theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(size=10))+ 
          scale_x_continuous(name ="Age (d)") +
          labs(title = "Resp standardized (Whole animal dry weight)", 
               y = expression(μmol~L^{-1}~O[2]%.%g^{-1}~whole~DW%.% hr^{-1})) +
          scale_linetype_manual(values = c("High food" = "solid", "Low food" = "dashed"))  +
          theme(legend.position="none") +
          # facet_wrap(~factor(Fed_Unfed, level = c('Low food', 'High food'))) 
          facet_wrap(~pCO2)


ggarrange(Resp_LengthStand,
          Resp_DryWgtStand, ncol = 1,nrow = 2) %>% 
  ggexport(filename = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/Respiration/All_Respiration_normalized.pdf")


pdf(paste0(filename = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/Respiration/All_Respiration_normalized_summary.pdf"), width = 10, height = 6)
ggarrange(P_Length_resp_all ,Length_time, Resp_LengthStand,
          P_WholeDW_resp_all, WholeDW_time, Resp_DryWgtStand, ncol = 3, nrow = 2, heights=c(1,1))
dev.off()


```


# Analysis 

### 9/14/2021 F1 juvenile scallops

**About**
- two pCO2 treatments 
- **before** we culled and started the food limitation trials


##### number of replicates for analysis...

```{r 9/14 replicates, echo=FALSE}

# model effect of treatment on resp rate 20210507
Resp_0914 <- Resp.Master_OM %>% 
              dplyr::filter(Date %in% '9/14/2021')  %>% # call only 9/14
              dplyr::filter(!Chamber_tank  %in% 'blank')

Resp_0914 %>% dplyr::group_by(Chamber_tank) %>% dplyr::summarise(n()) # tank replication

```

### 9/14/2021 linear model, diagnostics, and plots

#### Length standardized

```{r 9/14 Length standardized, echo=TRUE, message = FALSE, warning = FALSE}

# Shell length standardized (SL) ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

library("ggpubr")
Resp914_Length_reps<- ggboxplot(Resp_0914, x = "pH", y = "resp_µmol_L_mm_Length_hr", color = "Replicate",
                              add = c("mean_se", "dotplot"),
                              palette = c("#00AFBB", "#E7B800", "brown", "grey"))
Resp914_Length_reps

# models..
require(nlme)
# Linear mixed effects model with random effect of Replicate 
LMEmod_0914_SL<-lme(resp_µmol_L_mm_Length_hr ~ pCO2, random=~1|Replicate, data=Resp_0914)
# |     &nbsp;      | numDF | denDF | F-value |  p-value  |
# |:---------------:|:-----:|:-----:|:-------:|:---------:|
# | **(Intercept)** |   1   |  19   |  38.42  | 5.912e-06 |
# |    **pCO2**     |   1   |  19   | 0.8712  |  0.3623   |
pander(anova(LMEmod_0914_SL), style='rmarkdown')


# linear model without the random effect of Replicate
LMmod_0914_SL <- aov(lm(resp_µmol_L_mm_Length_hr~pCO2,data=Resp_0914))
# |    &nbsp;     | Df | Sum Sq | Mean Sq | F value | Pr(>F) |
# |:-------------:|:--:|:------:|:-------:|:-------:|:------:|
# |   **pCO2**    | 1  | 67.77  |  67.77  | 0.6327  | 0.4348 |
# | **Residuals** | 22 |  2356  |  107.1  |   NA    |   NA   |
pander(summary(LMmod_0914_SL), style='rmarkdown') 



check_model(LMmod_0914_SL) # observe the diagnostics of the model
shapiro.test(residuals(LMmod_0914_SL)) #  normal - 0.3875
leveneTest(LMmod_0914_SL) # good - 0.6186

DF   <- paste( (summary(LMmod_0914_SL)[[1]][["Df"]])[1], (summary(LMmod_0914_SL)[[1]][["Df"]])[2], sep = '/')
Fval <- (summary(LMmod_0914_SL)[[1]][["F value"]])[1]
pval <- (summary(LMmod_0914_SL)[[1]][["Pr(>F)"]])[1]


Resp914_Length <- ggplot(Resp_0914, aes(x = factor(pCO2, level = c('500 μatm', '800 μatm')), resp_µmol_L_mm_Length_hr , fill = pCO2)) +
                    theme(panel.grid=element_blank()) +
                    geom_boxplot(size=0.2, width=0.5, alpha=0.1, aes(fill=pCO2)) +
                    scale_fill_manual(values=c("white","grey50")) +
                    geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
                    theme_classic() +
                    scale_x_discrete(labels= c('~500 μatm', '~800 μatm')) +
                   # scale_y_continuous(expand = c(0, 0), limits = c(0, 2)) +
                    labs(title = "F1 Scallops: respiration rates on 20210914 (shell length stand.)", 
                         y = expression(Respiration~rate~"("~μmol~L^{-1}~O[2]%.%m^{-1}~shell~length%.% hr^{-1}~")"),
                         x = expression(italic(p)*CO[2]~Treatment~"("~μ*atm~")")) + 
                    theme(axis.text=element_text(size=8),
                          axis.title=element_text(size=8,face="bold")) +
                     stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white") +
                     annotate("text", x=2, y=0.000005, size = 4, label = "shapiro wilk = 0.3875") +
                     annotate("text", x=2, y=0.0000075, size = 4, label = "levene's = 0.6186") +
                     annotate("text", x=2, y=0.0000115, size = 4, label= paste('DF =',DF,'F =', signif(Fval, digits=3), 'p value =', signif(pval, digits=3), sep=" ")) 
Resp914_Length


# Export to pdf
ggarrange(Resp914_Length,Resp914_Length_reps,nrow = 2) %>%
  ggexport(filename = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/Respiration/20210914_figs_tables/20210914_respiration_length.standardized.pdf")

```


#### Whole dry weight standardized

```{r 9/14 Whole dry weight standardized, echo=TRUE, message = FALSE, warning = FALSE}

# Whole animal Dry weight standardized (DW) ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
Resp914_WholeDW_reps<- ggboxplot(Resp_0914, x = "pH", y = "resp_µmol_L_g_hr", color = "Replicate",
                          add = c("mean_se", "dotplot"),
                          palette = c("#00AFBB", "#E7B800", "brown", "grey"))
Resp914_WholeDW_reps

require(nlme)
# Linear mixed effects model with random effect of Replicate 
LMEmod_0914_DW<-lme(resp_µmol_L_g_hr ~ pCO2, random=~1|Replicate, data=Resp_0914[!is.na(Resp_0914$resp_µmol_L_g_hr),])
# |     &nbsp;      | numDF | denDF | F-value |  p-value  |
# |:---------------:|:-----:|:-----:|:-------:|:---------:|
# | **(Intercept)** |   1   |  16   |  31.58  | 3.836e-05 |
# |    **pCO2**     |   1   |  16   | 0.1122  |   0.742   |
pander(anova(LMEmod_0914_DW), style='rmarkdown')



# linear model without the random effect 
LMmod_0914_DW <- aov(lm(resp_µmol_L_g_hr~pCO2,data=Resp_0914[!is.na(Resp_0914$resp_µmol_L_g_hr),]))
# |    &nbsp;     | Df |  Sum Sq  | Mean Sq  | F value | Pr(>F) |
# |:-------------:|:--:|:--------:|:--------:|:-------:|:------:|
# |   **pCO2**    | 1  | 0.000286 | 0.000286 | 0.1125  | 0.741  |
# | **Residuals** | 19 | 0.04829  | 0.002541 |   NA    |   NA   |
pander(summary(LMmod_0914_DW), style='rmarkdown') # 0.741  
  
  
check_model(LMmod_0914_DW) # observe the diagnostics of the model
shapiro.test(residuals(LMmod_0914_DW)) #  normal - 0.002138
leveneTest(LMmod_0914_DW) # good - 0.9079

DF   <- paste( (summary(LMmod_0914_DW)[[1]][["Df"]])[1], (summary(LMmod_0914_DW)[[1]][["Df"]])[2], sep = '/')
Fval <- (summary(LMmod_0914_DW)[[1]][["F value"]])[1]
pval <- (summary(LMmod_0914_DW)[[1]][["Pr(>F)"]])[1]

Resp914_WholeDW <- ggplot(Resp_0914[!is.na(Resp_0914$resp_µmol_L_g_hr),], aes(x = factor(pCO2, level = c('500 μatm', '800 μatm')), resp_µmol_L_g_hr , fill = pCO2)) +
              theme(panel.grid=element_blank()) +
              geom_boxplot(size=0.2, width=0.5, alpha=0.1, aes(fill=pCO2)) +
              scale_fill_manual(values=c("white","grey50")) +
              geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
              theme_classic() +
              scale_x_discrete(labels= c('~500 μatm', '~800 μatm')) +
              # scale_y_continuous(expand = c(0, 0), limits = c(0, 120)) +
              theme(axis.text=element_text(size=8),
                          axis.title=element_text(size=8,face="bold")) +
              stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white") +
              labs(title = "F1 Scallops: respiration rates on 20210914 (whole dry weight stand.)", 
                   y = expression(Respiration~rate~"("~μmol~L^{-1}~O[2]%.%g^{-1}~DW%.% hr^{-1}~")"),
                   x = expression(italic(p)*CO[2]~Treatment~"("~μ*atm~")"))
Resp914_WholeDW


# Export to pdf
ggarrange(Resp914_WholeDW,Resp914_WholeDW_reps,nrow = 2) %>%
  ggexport(filename = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/Respiration/20210914_respiration_DW.standardized.pdf")

```


# 9/30/2021 F1 juvenile scallops

**About**

- two pCO2 treatments 

- *before* we culled and started the food limitation trials


#### number of replicates for analysis...

```{r 9/30 replicates, echo=FALSE}

Resp_0930 <- Resp.Master_OM %>% 
  dplyr::filter(Date %in% '9/30/2021')  %>% # call only 9/14
  dplyr::select(-Center)

Resp_0930 %>% dplyr::group_by(Chamber_tank, Food ) %>% dplyr::summarise(n()) # tank replication

```


## 9/30/2021 linear model, diagnostics, and plots

#### Length standardized

```{r 9/30 Length standardized, echo=TRUE, message = FALSE, warning = FALSE}


# Shell length standardized (SL) ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

# Visualize the data with the random effet as treplicate 
Resp_0930$pHxFood   <- paste(Resp_0930$pH, Resp_0930$Food, sep = "_")
Resp914_Length_reps <- ggboxplot(Resp_0930, x = "pHxFood", y = "resp_µmol_L_mm_Length_hr", color = "Replicate",
          add = c("mean_se", "dotplot"),
          palette = c("#00AFBB", "#E7B800", "brown", "grey"))
Resp914_Length_reps

require(nlme)
# Linear mixed effects model with random effect of Replicate 
LMEmod_0930_SL<-lme(resp_µmol_L_mm_Length_hr ~ pCO2 * Food, random=~1|Replicate, data=Resp_0930)
# |     &nbsp;      | numDF | denDF | F-value | p-value |
# |:---------------:|:-----:|:-----:|:-------:|:-------:|
# | **(Intercept)** |   1   |  66   |  606.3  |    0    |
# |    **pCO2**     |   1   |  66   |  4.42   | 0.03934 |
# |    **Food**     |   1   |  66   |  3.984  | 0.05006 |
# |  **pCO2:Food**  |   1   |  66   | 0.01138 | 0.9154  |
pander(anova(LMEmod_0930_SL), style='rmarkdown')


# linear model without the random effect 
LMmod_0930_SL <- aov(lm(resp_µmol_L_mm_Length_hr~pCO2*Food,data=Resp_0930))
# |    &nbsp;     | Df | Sum Sq | Mean Sq | F value | Pr(>F)  |
# |:-------------:|:--:|:------:|:-------:|:-------:|:-------:|
# |   **pCO2**    | 1  |  1340  |  1340   |  4.42   | 0.03917 |
# |   **Food**    | 1  |  1208  |  1208   |  3.984  | 0.04988 |
# | **pCO2:Food** | 1  |  3.45  |  3.45   | 0.01138 | 0.9154  |
# | **Residuals** | 69 | 20923  |  303.2  |   NA    |   NA    |
pander(summary(LMmod_0930_SL), style='rmarkdown')


check_model(LMmod_0930_SL) # observe the diagnostics of the model
shapiro.test(residuals(LMmod_0930_SL)) #  normal - 0.08494
leveneTest(LMmod_0930_SL) # good - 0.1906

DF   <- paste( (summary(LMmod_0930_SL)[[1]][["Df"]])[1], (summary(LMmod_0930_SL)[[1]][["Df"]])[2], sep = '/')
Fval <- (summary(LMmod_0930_SL)[[1]][["F value"]])[1]
pval <- (summary(LMmod_0930_SL)[[1]][["Pr(>F)"]])[1]


Resp914_Length <- ggplot(Resp_0930, aes(x = factor(pCO2, level = c('500 μatm', '800 μatm')), resp_µmol_L_mm_Length_hr , fill = pCO2)) +
              theme(panel.grid=element_blank()) +
              geom_boxplot(size=0.2, width=0.5, alpha=0.1, aes(fill=pCO2)) +
              scale_fill_manual(values=c("white","grey50")) +
              geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
              theme_classic() +
              scale_x_discrete(labels= c('~500 μatm', '~800 μatm')) +
              #scale_y_continuous(expand = c(0, 0), limits = c(0, 120)) +
              theme(axis.text=element_text(size=8),
                          axis.title=element_text(size=8,face="bold")) +
              labs(title = "F1 Scallops: respiration rates on 20210930 (shell length stand.)", 
                   y = expression(Respiration~rate~"("~μmol~L^{-1}~O[2]%.%m^{-1}~shell~length%.% hr^{-1}~")"),
                   x = expression(italic(p)*CO[2]~Treatment~"("~μ*atm~")"))  + 
               stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white") +
              facet_wrap(~factor(Fed_Unfed, level = c('Low food', 'High food')))
Resp914_Length

# Export to pdf
ggarrange(Resp914_Length,Resp914_Length_reps,nrow = 2) %>%
  ggexport(filename = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/Respiration/20210930_respiration_length.standardized.pdf")

```

#### Whole dry weight standardized

```{r 9/30 Whole dry weight standardized, echo=TRUE, message = FALSE, warning = FALSE}

# Whole animal Dry weight standardized (DW) ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

# Visualize the data with the random effet as treplicate 
Resp_0930$pHxFood   <- paste(Resp_0930$pH, Resp_0930$Food, sep = "_")
Resp930_WholeDW_reps <- ggboxplot(Resp_0930, x = "pHxFood", y = "resp_µmol_L_g_hr", color = "Replicate",
          add = c("mean_se", "dotplot"),
          palette = c("#00AFBB", "#E7B800", "brown", "grey"))
Resp930_WholeDW_reps

require(nlme)
# Linear mixed effects model with random effect of Replicate 
LMEmod_0930_DW<-lme(resp_µmol_L_g_hr ~ pCO2 * Food, random=~1|Replicate, data=Resp_0930[!is.na(Resp_0930$resp_µmol_L_g_hr),])
# |     &nbsp;      | numDF | denDF | F-value |  p-value  |
# |:---------------:|:-----:|:-----:|:-------:|:---------:|
# | **(Intercept)** |   1   |  65   |  52.7   | 6.024e-10 |
# |    **pCO2**     |   1   |  65   |  4.646  |  0.03483  |
# |    **Food**     |   1   |  65   |  12.28  | 0.0008344 |
# |  **pCO2:Food**  |   1   |  65   |  1.135  |  0.2907   |
pander(anova(LMEmod_0930_DW), style='rmarkdown')


# linear model without the random effect 
LMmod_0930_DW <- aov(lm(resp_µmol_L_g_hr~pCO2*Food,data=Resp_0930[!is.na(Resp_0930$resp_µmol_L_g_hr),]))
# |    &nbsp;     | Df |  Sum Sq  | Mean Sq  | F value | Pr(>F)  |
# |:-------------:|:--:|:--------:|:--------:|:-------:|:-------:|
# |   **pCO2**    | 1  | 0.007001 | 0.007001 |  4.432  | 0.03896 |
# |   **Food**    | 1  | 0.01602  | 0.01602  |  10.14  | 0.00219 |
# | **pCO2:Food** | 1  | 0.001512 | 0.001512 |  0.957  | 0.3314  |
# | **Residuals** | 68 |  0.1074  | 0.00158  |   NA    |   NA    |
pander(summary(LMmod_0930_DW), style='rmarkdown')


check_model(LMmod_0930_DW) # observe the diagnostics of the model
shapiro.test(residuals(LMmod_0930_DW)) #  non normal - 2.42e-08
leveneTest(LMmod_0930_DW) # good - 0.2719

DF   <- paste( (summary(LMmod_0930_DW)[[1]][["Df"]])[1], (summary(LMmod_0930_DW)[[1]][["Df"]])[2], sep = '/')
Fval <- (summary(LMmod_0930_DW)[[1]][["F value"]])[1]
pval <- (summary(LMmod_0930_DW)[[1]][["Pr(>F)"]])[1]


Resp930_WholeDW <-  ggplot(Resp_0930, aes(x = factor(pCO2, level = c('500 μatm', '800 μatm')), resp_µmol_L_g_hr , fill = pCO2)) +
                      theme(panel.grid=element_blank()) +
                      geom_boxplot(size=0.2, width=0.5, alpha=0.1, aes(fill=pCO2)) +
                      scale_fill_manual(values=c("white","grey50")) +
                      geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
                      theme_classic() +
                      scale_x_discrete(labels= c('~500 μatm', '~800 μatm')) +
                      #scale_y_continuous(expand = c(0, 0), limits = c(0, 200)) +
                      theme(axis.text=element_text(size=8),
                                  axis.title=element_text(size=8,face="bold")) +
                      labs(title = "F1 Scallops: respiration rates on 20210930 (whole dry weight stand.)", 
                           y = expression(Respiration~rate~"("~μmol~L^{-1}~O[2]%.%g^{-1}~DW%.% hr^{-1}~")"),
                           x = expression(italic(p)*CO[2]~Treatment~"("~μ*atm~")"))  + 
                       stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white") +
                        facet_wrap(~factor(Fed_Unfed, level = c('Low food', 'High food'))) # +
Resp930_WholeDW


# Export to pdf
ggarrange(Resp930_WholeDW,Resp930_WholeDW_reps,nrow = 2) %>%
  ggexport(filename = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/Respiration/20210930_figs_tables/20210930_respiration_DW.standardized.pdf")

```


# 10/26/2021 F1 juvenile scallops

**About**

- two pCO2 treatments 

- *before* we culled and started the food limitation trials


#### number of replicates for analysis...

```{r 10/26 replicates, echo=FALSE}

Resp_1026 <- Resp.Master_OM %>% 
  dplyr::filter(Date %in% '10/26/2021')  %>% # call only 10/14
  dplyr::select(-Center)

Resp_1026 %>% dplyr::group_by(Chamber_tank, Food ) %>% dplyr::summarise(n()) # tank replication

```


### 10/26/2021 Linear mixed-effects models, diagnostics, and plots


#### Length standardized

```{r 10/26 Length standardized, echo=TRUE, message = FALSE, warning = FALSE}

# Shell length standardized (SL) ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

# Visualize the data with the random effet as treplicate 
Resp_1026$pHxFood <- paste(Resp_1026$pH, Resp_1026$Food, sep = "_")
Res1026_Length_reps <- ggboxplot(Resp_1026, x = "pHxFood", y = "resp_µmol_L_mm_Length_hr", color = "Replicate",
                          add = c("mean_se", "dotplot"),
                          palette = c("#00AFBB", "#E7B800", "brown", "grey"))
Res1026_Length_reps


require(nlme)
# Linear mixed effects model with random effect of Replicate 
LMEmod_1026_SL<-lme(resp_µmol_L_mm_Length_hr ~ pCO2 * Food, random=~1|Replicate, data=Resp_1026)
# |     &nbsp;      | numDF | denDF | F-value |  p-value  |
# |:---------------:|:-----:|:-----:|:-------:|:---------:|
# | **(Intercept)** |   1   |  27   |  765.4  |     0     |
# |    **pCO2**     |   1   |  27   |  32.19  | 5.018e-06 |
# |    **Food**     |   1   |  27   |  347.3  |     0     |
# |  **pCO2:Food**  |   1   |  27   |  19.92  | 0.000129  |
pander(anova(LMEmod_1026_SL), style='rmarkdown')


# linear model without the random effect 
LMmod_1026_SL <- aov(lm(resp_µmol_L_mm_Length_hr~pCO2*Food,data=Resp_1026))
# |    &nbsp;     | Df |  Sum Sq   |  Mean Sq  | F value |  Pr(>F)   |
# |:-------------:|:--:|:---------:|:---------:|:-------:|:---------:|
# |   **pCO2**    | 1  | 1.141e-08 | 1.141e-08 |  32.19  | 3.48e-06  |
# |   **Food**    | 1  | 1.231e-07 | 1.231e-07 |  347.3  | 4.817e-18 |
# | **pCO2:Food** | 1  | 7.061e-09 | 7.061e-09 |  19.92  | 0.0001057 |
# | **Residuals** | 30 | 1.064e-08 | 3.546e-10 |   NA    |    NA     |
pander(summary(LMmod_1026_SL), style='rmarkdown')

  
check_model(LMmod_1026_SL) # observe the diagnostics of the model
shapiro.test(residuals(LMmod_1026_SL)) #  normal - 0.3875 (0.01626)
leveneTest(LMmod_1026_SL) # good - 0.6186 (0.01844 *)

DF   <- paste( (summary(LMmod_1026_SL)[[1]][["Df"]])[1], (summary(LMmod_1026_SL)[[1]][["Df"]])[2], sep = '/')
Fval <- (summary(LMmod_1026_SL)[[1]][["F value"]])[1]
pval <- (summary(LMmod_1026_SL)[[1]][["Pr(>F)"]])[1]

Resp1026_Length <- ggplot(Resp_1026, aes(x = factor(pCO2, level = c('500 μatm', '800 μatm')), resp_µmol_L_mm_Length_hr , fill = pCO2)) +
              theme(panel.grid=element_blank()) +
              geom_boxplot(size=0.2, width=0.5, alpha=0.1, aes(fill=pCO2)) +
              scale_fill_manual(values=c("white","grey50")) +
              geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
              theme_classic() +
              scale_x_discrete(labels= c('~500 μatm', '~800 μatm')) +
              # scale_y_continuous(expand = c(0, 0), limits = c(0, 250)) +
              theme(axis.text=element_text(size=8),
                    axis.title=element_text(size=8,face="bold")) +
              labs(title = "F1 Scallops: respiration rates on 20211026 (shell length stand.)", 
                   y = expression(Respiration~rate~"("~μmol~L^{-1}~O[2]%.%m^{-1}~shell~length%.% hr^{-1}~")"),
                   x = expression(italic(p)*CO[2]~Treatment~"("~μ*atm~")"))  + 
              facet_wrap(~factor(Fed_Unfed, level = c('Low food', 'High food'))) # +
Resp1026_Length


# Export to pdf
ggarrange(Resp1026_Length, Res1026_Length_reps,nrow = 2) %>% 
  ggexport(filename = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/Respiration/20211026_figs_tables/20211026_respiration_length.standardized.pdf")

```


#### Whole dry weight standardized


```{r 10/26 Whole dry weight standardized, echo=TRUE, message = FALSE, warning = FALSE}

# Whole animal Dry weight standardized (DW) ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

# Visualize the data with the random effet as treplicate 
Resp_1026$pHxFood <- paste(Resp_1026$pH, Resp_1026$Food, sep = "_")
Res1026_WholeDW_reps <- ggboxplot(Resp_1026, x = "pHxFood", y = "resp_µmol_L_g_hr", color = "Replicate",
                          add = c("mean_se", "dotplot"),
                          palette = c("#00AFBB", "#E7B800", "brown", "grey"))
Res1026_WholeDW_reps


require(nlme)
# Linear mixed effects model with random effect of Replicate 
LMEmod_1026_DW<-lme(resp_µmol_L_g_hr ~ pCO2 * Food, random=~1|Replicate, data=Resp_1026)
# |     &nbsp;      | numDF | denDF | F-value |  p-value  |
# |:---------------:|:-----:|:-----:|:-------:|:---------:|
# | **(Intercept)** |   1   |  27   |  78.28  | 1.833e-09 |
# |    **pCO2**     |   1   |  27   | 0.01955 |  0.8898   |
# |    **Food**     |   1   |  27   |  10.16  | 0.003615  |
# |  **pCO2:Food**  |   1   |  27   |  10.52  | 0.003139  |
pander(anova(LMEmod_1026_DW), style='rmarkdown')



# linear model without the random effect 
LMmod_1026_DW <- aov(lm(resp_µmol_L_g_hr~pCO2*Food,data=Resp_1026))
# |    &nbsp;     | Df |  Sum Sq   |  Mean Sq  | F value |  Pr(>F)  |
# |:-------------:|:--:|:---------:|:---------:|:-------:|:--------:|
# |   **pCO2**    | 1  | 4.754e-06 | 4.754e-06 | 0.02044 |  0.8873  |
# |   **Food**    | 1  |  0.00218  |  0.00218  |  9.376  | 0.004608 |
# | **pCO2:Food** | 1  | 0.002285  | 0.002285  |  9.828  | 0.003827 |
# | **Residuals** | 30 | 0.006976  | 0.0002325 |   NA    |    NA    |
pander(summary(LMmod_1026_DW), style='rmarkdown')
  
  
check_model(LMmod_1026_DW) # observe the diagnostics of the model
shapiro.test(residuals(LMmod_1026_DW)) #  normal - 0.01843
leveneTest(LMmod_1026_DW) # 0.01179 *


DF   <- paste( (summary(LMmod_1026_DW)[[1]][["Df"]])[1], (summary(LMmod_1026_DW)[[1]][["Df"]])[2], sep = '/')
Fval <- (summary(LMmod_1026_DW)[[1]][["F value"]])[1]
pval <- (summary(LMmod_1026_DW)[[1]][["Pr(>F)"]])[1]

Res1026_WholeDW <- ggplot(Resp_1026, aes(x = factor(pCO2, level = c('500 μatm', '800 μatm')), resp_µmol_L_g_hr , fill = pCO2)) +
                            theme(panel.grid=element_blank()) +
                            geom_boxplot(size=0.2, width=0.5, alpha=0.1, aes(fill=pCO2)) +
                            scale_fill_manual(values=c("white","grey50")) +
                            geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
                            theme_classic() +
                            scale_x_discrete(labels= c('~500 μatm', '~800 μatm')) +
                            # scale_y_continuous(expand = c(0, 0), limits = c(0, 150)) +
                            theme(axis.text=element_text(size=8),
                                  axis.title=element_text(size=8,face="bold")) +
                            labs(title = "F1 Scallops: respiration rates on 20211026 (whole dry weight stand.)", 
                                 y = expression(Respiration~rate~"("~μmol~L^{-1}~O[2]%.%g^{-1}~DW%.% hr^{-1}~")"),
                                 x = expression(italic(p)*CO[2]~Treatment~"("~μ*atm~")"))  + 
                            facet_wrap(~factor(Fed_Unfed, level = c('Low food', 'High food'))) # +
Res1026_WholeDW

# Export to pdf
ggarrange(Res1026_WholeDW, Res1026_WholeDW_reps,nrow = 2) %>% 
  ggexport(filename = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/Respiration/20211026_figs_tables/20211026_respiration_DW.standardized.pdf")

```






# b factor plots 

#### Using Shell length!

All physiological rates were standardized for a _____ um shell length per individual. This length, corresponding to the median shell length of all individuals monitored during this experiment, was chosen to keep standardized rates consistent with  one  length and  minimize error.


#### EQ: Ys=(Ws/Wsc)^b(Ye)

* Ys   =  shell length-standardized physiological rate (respiration in this case..) 
* Ws   =  median shell length per individual in this experiment (fed v. unfed betwen 9/14 - 10/26)
* Wsc  =  shell length for each bay scallop 
* b    =  allometric coefficient estimated from the shell length and the physiolgoical process (in this case respiration rate) as Ye = (a)Wsc^b 
* Ye   =  the experimentally measured rate 

```{r b factor, echo=TRUE, message = FALSE, warning = FALSE}


summarySE(Resp.Master_OM, measurevar="Length_um")
print(paste( "Median shell length 9/14-10/26 = ", median(Resp.Master_OM$Length_um))) # 3148.36 

# calculate using an assumed (not calculated for A irradians) b factor
Ws  <- 3148.36
Wsc <- Resp.Master_OM$Length_um
b   <- 0.75
Ye  <- Resp.Master_OM$resp_umol_L_hr
Ys <- ((Ws/Wsc)^b)*Ye
# assign to the master data frame and plot 
Resp.Master_OM$resp_umol_L_mm_hr_bfactor <- Ys
Resp.Master_OM %>% ggplot(aes(x = Length_um, y = resp_umol_L_mm_hr_bfactor)) +
                                geom_smooth(method = "lm", se=FALSE, color="black", formula = resp_umol_L_mm_hr_bfactor ~ Length_um) +
                                theme_classic() +
                                ylab("resp_umol_L_mm_hr_bfactor") +
                                xlab("Length_um") +
                                geom_point() + 
                                geom_smooth(method='loess')


Rsp_bfact <- Resp.Master_OM %>% 
  #dplyr::filter(Date %in% '10/26/2021')  %>% # call only 10/14
  dplyr::filter(Date %in% '9/30/2021')  %>% # call only 10/14
  dplyr::select(-Center)

anova(lme(resp_umol_L_mm_hr_bfactor ~ pCO2 * Food, random=~1|Replicate, data=Rsp_bfact))
 ggplot(Rsp_bfact, aes(x = factor(pCO2, level = c('500 μatm', '800 μatm')), resp_umol_L_mm_hr_bfactor , fill = pCO2)) +
              theme(panel.grid=element_blank()) +
              geom_boxplot(size=0.2, width=0.5, alpha=0.1, aes(fill=pCO2)) +
              scale_fill_manual(values=c("white","grey50")) +
              geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
              theme_classic() +
              scale_x_discrete(labels= c('~500 μatm', '~800 μatm')) +
              # scale_y_continuous(expand = c(0, 0), limits = c(0, 250)) +
              theme(axis.text=element_text(size=8),
                    axis.title=element_text(size=8,face="bold")) +
              labs(title = "F1 Scallops: respiration rates on 20211026 (shell length stand.)", 
                   y = expression(Respiration~rate~"("~μmol~L^{-1}~O[2]%.%m^{-1}~shell~length%.% hr^{-1}~")"),
                   x = expression(italic(p)*CO[2]~Treatment~"("~μ*atm~")"))  + 
              facet_wrap(~factor(Fed_Unfed, level = c('Low food', 'High food'))) # +

```

