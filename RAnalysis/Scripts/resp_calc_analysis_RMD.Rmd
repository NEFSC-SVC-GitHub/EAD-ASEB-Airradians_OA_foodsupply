---
title: "Respiration Analysis F1 Scallops 2021"
author: "Samuel Gurr"
date: "10/6/2021"
output: pdf_document
---


```{r setup, include=FALSE}

# LOAD PACKAGES :::::::::::::::::::::::::::::::::::::::::::::::::::::::

library(dplyr)
library(ggplot2)
library(forcats)
library(lme4)
library(lmerTest)
library(see)
library(performance)
library(car)
library(kableExtra)
library(pander)
library(data.table)
library(stringr)
library(latex2exp)


# SET WORKING DIRECTORY :::::::::::::::::::::::::::::::::::::::::::::::

#setwd("C:/Users/samjg/Documents/Github_repositories/Airradians_OA/RAnalysis") # personal computer 
#setwd("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA/RAnalysis") # Work computer
setwd("C:/Users/samjg/Documents/Github_repositories/Airradians_OA/RAnalysis") # Work computer

# LOAD DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

resp.data    <- read.csv(file="Output/Respiration/Cumulative_resp_alpha0.4_15sectrunc40min.csv", header=T) %>% dplyr::filter(!Filename %in% 'Run_1_raw.txt') # read the calculate raw rates from 'resp_LoLin' script - contains the calculated rate (not normalized for blanks) for each sensor-channel
exp_metadata <- read.csv(file="Data/ExperimentMetadata.csv", header=T) # treatment assignments to 'Chamber_Tank'
lengths      <- read.csv(file="Data/Respiration/Lengths_resp.csv", header=T)
resp.ref     <- read.csv(file="Data/Respiration/Reference_master.csv", header=T) %>% dplyr::filter(!Filename == 'Run_1_raw.txt')

```

## merge master resp data frame 

```{r merge resp with length data and treatment IDs, echo=FALSE}

# merge the exp_metadata with the resp.data
resp.ref_length_merged                 <- merge(resp.ref, lengths) # all TRUE allows us to keep the blanks
resp.data_merged                       <- merge(resp.data, resp.ref_length_merged) # out master file moving forward....
kable(head(resp.data_merged))

```

## Visual diagnostics of plots to correct poor data 

- View on github: Airradians_OA/RAnalysis/Output/Respiration/plots_alpha0.4_increm15sec/

#### found three calls that inaccurately represent the rates of oxygen consumption 

(1) https://github.com/SamGurr/Airradians_OA/blob/master/RAnalysis/Output/Respiration/plots_alpha0.4_increm15sec/20210930_Plate_2_Run_2_C5_regression.pdf
- solution = call 'Lz' instead of the default Leq

(2) https://github.com/SamGurr/Airradians_OA/blob/master/RAnalysis/Output/Respiration/plots_alpha0.4_increm15sec/20210930_Plate_2_Run_1_C1_regression.pdf
- solution = call 'Lz' instead of the default Leq

(3) https://github.com/SamGurr/Airradians_OA/blob/master/RAnalysis/Output/Respiration/plots_alpha0.4_increm15sec/20210930_Plate_1_Run_2_C1_regression.pdf
- solution = omit 

```{r IMPORTANT correct poor data, echo=TRUE}
resp.data_merged[77,c(1:6)]
resp.data_merged[61,c(1:6)]
resp.data_merged[62,c(1:6)]

resp.data_merged[77,4] <- resp.data_merged[77,5] # 20210930_Plate_2_Run_2_C5_regression - Lz and Leq call better regression than Lpc
resp.data_merged[61,4] <- resp.data_merged[61,5] # 20210930_Plate_2_Run_1_C1_regression - Lz and Leq call better regression than Lpc
resp.data_merged[62,4] <- NA # 20210930_Plate_1_Run_2_C1_regression - Lz and Leq call better regression than Lpc

resp.data_merged[77,c(1:6)]
resp.data_merged[61,c(1:6)]
resp.data_merged[62,c(1:6)]
```

## call blanks

```{r call blanks, echo=FALSE}

blanks_total <- data.frame() # start dataframe 
blanks.table <- data.frame(matrix(nrow = 1,ncol = 5)) # make a table template
colnames(blanks.table)<-c('Date', 'Channel', 'mean_Lpc', 'mean_Leq' , 'mean_Lz') # names for comuns in the for loop

blanks_all_raw <- data.frame(merge(resp.ref, resp.data, by = c('Date', 'Channel', 'Filename')) %>% 
                  dplyr::filter(Chamber_tank  == 'blank') %>% 
                  dplyr::filter(Lpc <0) %>% 
                  dplyr::filter(!(Date == '9/30/2021' & Lpc < -0.035)))


blanks_means <- blanks_all_raw %>% 
     #dplyr::filter(Lpc > -0.04) %>% 
     dplyr::group_by(Date, pH) %>% 
     dplyr::filter(Chamber_tank == "blank") %>% 
     dplyr::filter(Lpc <0) %>% # ommit blank calls that d/n represent oxygen consumption
     dplyr::summarise(BLANK.mean_Lpc = mean(abs(Lpc)),
                      BLANK.mean_Leq = mean(abs(Leq)), 
                      BLANK.mean_Lz = mean(abs(Lz)),
                      n = n())
kable((blanks_all_raw)[,c(1:3,6,8,12:14)])
kable(blanks_means)


```


```{r merge blanks_means for a master file, echo=FALSE}

Resp.Master <- merge(resp.data_merged, blanks_means, by=c("Date", "pH")) %>% # NOTE: this repeats for every distinct length value
  dplyr::mutate(resp_norm = Lpc - BLANK.mean_Lpc) # ommits respiration rate values showing an increase in O2 over time 

```


```{r merge data to master file , echo=FALSE}

Resp.Master_OM <- Resp.Master %>% dplyr::filter(!resp_norm > 0) # ommit respiration values that are positive
Resp.outliers <- Resp.Master %>% dplyr::filter(resp_norm > 0) # call the values with positive resp rates, measing they were slower than the blank!
print(Resp.outliers)

```
## Calculate rates as ng L-1 O2 um shell length-1 hr-1

#### note: this chunk calls the data that used the 8-channel loligo system and the SDR system to correct for total respiration chamber (vial/vessel, well, etc.) volume separately 
- loligo 8-channel on 9/14/21 = 2.2 ml vessels 
- SDR 24-channel on 9/3-/21 = 1.7 ml wells 

```{r Calculate Resp Rates , echo=TRUE}


for (i in 1:nrow(Resp.Master_OM)) {
      if (Resp.Master_OM$Date[i] == '9/14/2021')  {
        Resp.Master_OM$resp_ng_L_umlLength_hr[i] <- ( 
          ( ( (abs(Resp.Master_OM$resp_norm[i])*1000000) * # call absolute value of resp in mg per minute - convert to ng min-1
                (2.2/1000) ) / # vial volume for loligo 8 channel runs was 2.2 mL!!! - correct ng minute-1 to ng liter-1 by multiplying by the resp vial in liters
              Resp.Master_OM$Length.um.[i]) * # normalize by individual or larvae count - as to ng L-1 individual-1
            (60)) # correct for the time; final value is ng Liter-1 individual-1 hour-1
          } else {
          Resp.Master_OM$resp_ng_L_umlLength_hr[i] <- ( 
            ( ( (abs(Resp.Master_OM$resp_norm[i])*1000000) * # call absolute value of resp in mg per minute - convert to ng min-1
                  (1.7/1000) ) / # vial volume for loligo 8 channel runs was 1.7 mL!!! - correct ng minute-1 to ng liter-1 by multiplying by the resp vial in liters
                Resp.Master_OM$Length.um.[i]) * # normalize by individual or larvae count - as to ng L-1 individual-1
              (60)) # correct for the time; final value is ng Liter-1 individual-1 hour-1
          }
}

```

# Analysis 

## 9/14/2021 F1 juvenile scallops

**About**
- two pCO2 treatments 
- **before** we culled and started the food limitation trials


#### number of replicates for analysis...

```{r 9/14 replicates, echo=FALSE}

# model effect of treatment on resp rate 20210507
Resp_0914 <- Resp.Master_OM %>% 
              dplyr::filter(Date %in% '9/14/2021')  %>% # call only 9/14
              dplyr::filter(!Chamber_tank  %in% 'blank') %>% 
              dplyr::mutate(pCO2 = case_when(pH == 8.0 ~ 'Low',
                                             pH == 7.5 ~ 'High'))

Resp_0914 %>% dplyr::group_by(Chamber_tank) %>% summarise(n()) # tank replication

```

#### linear model, diagnostics, and plots

```{r 9/14 lm diag and figs, echo=TRUE}
LMmod_0914 <- aov(lm(resp_ng_L_umlLength_hr~pCO2,data=Resp_0914))
pander(summary(LMmod_0914), style='rmarkdown')
check_model(LMmod_0914) # observe the diagnostics of the model
shapiro.test(residuals(LMmod_0914)) # non normal
leveneTest(LMmod_0914) # good

DF   <- paste( (summary(LMmod_0914)[[1]][["Df"]])[1], (summary(LMmod_0914)[[1]][["Df"]])[2], sep = '/')
Fval <- (summary(LMmod_0914)[[1]][["F value"]])[1]
pval <- (summary(LMmod_0914)[[1]][["Pr(>F)"]])[1]

ggplot(Resp_0914, aes(pCO2 , resp_ng_L_umlLength_hr , fill = pCO2)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
  scale_fill_manual(values=c("grey50","white")) +
  geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
  theme_classic() +
  scale_x_discrete(labels= c('Elevated (H)', 'Ambient (L)')) +
  ylim(0, 3) +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold")) +
  labs(title = "F1 Scallops: respiration rates on 20210914", 
       y = expression(Respiration~rate~"("~ng~L^{-1}~O[2]%.%mu*m^{-1}%.% hr^{-1}~")"), 
       x = expression(italic(p)*CO[2]~Treatment~"("~mu*atm~")")) + 
  annotate("text", x=1.2, y=2.8, size = 4, label = "aov(Resp~pCO2)") +
  annotate("text", x=1.2, y=2.6, size = 4, label= paste('DF =',DF,'F =', signif(Fval, digits=3), 'p value =', signif(pval, digits=3), sep=" ")) 

```



## 9/14/2021 F1 juvenile scallops

**About**

- two pCO2 treatments 

- *before* we culled and started the food limitation trials


#### number of replicates for analysis...

```{r 9/30 replicates, echo=FALSE}

Resp_0930 <- Resp.Master_OM %>% 
  dplyr::filter(Date %in% '9/30/2021')  %>% # call only 9/14
  dplyr::filter(!Chamber_tank  %in% 'blank') %>% 
  dplyr::select(-Center) %>% 
  dplyr::mutate(pCO2 = case_when(pH == 8.0 ~ 'Low',
                                 pH == 7.5 ~ 'High')) %>% 
  na.omit()

Resp_0930 %>% dplyr::group_by(Chamber_tank, Food ) %>% summarise(n()) # tank replication

```

#### linear model, diagnostics, and plots

```{r 9/30 lm diag and figs, echo=TRUE}

LMmod_0930 <- aov(lm(resp_ng_L_umlLength_hr~pCO2*Fed_Unfed ,data=Resp_0930))
pander(summary(LMmod_0930), style='rmarkdown')
check_model(LMmod_0930) # observe the diagnostics of the model
shapiro.test(residuals(LMmod_0930)) # non normal
leveneTest(LMmod_0930) # good



DF_pCO2   <- paste( (summary(LMmod_0930)[[1]][["Df"]])[1], (summary(LMmod_0930)[[1]][["Df"]])[4], sep = '/')
Fval_pCO2 <- (summary(LMmod_0930)[[1]][["F value"]])[1]
pval_pCO2 <- (summary(LMmod_0930)[[1]][["Pr(>F)"]])[1]

DF_Fed    <- paste( (summary(LMmod_0930)[[1]][["Df"]])[2], (summary(LMmod_0930)[[1]][["Df"]])[4], sep = '/')
Fval_Fed  <- (summary(LMmod_0930)[[1]][["F value"]])[2]
pval_Fed  <- (summary(LMmod_0930)[[1]][["Pr(>F)"]])[2]

arr <- list('High food'=TeX("x_1"), "Low food"=TeX("x_2"))
mylabel <- function(val) { return(lapply(val, function(x) arr[x])) }

Resp_0930$Fed_Unfed <- as.factor(Resp_0930$Fed_Unfed)

levels(Resp_0930$Fed_Unfed) <- c("High food", "Low food")

ggplot(Resp_0930, aes(pCO2 , resp_ng_L_umlLength_hr , fill = pCO2)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
  scale_fill_manual(values=c("grey50","white")) +
  geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
  theme_classic() +
  ylim(0, 3) +
  scale_x_discrete(labels= c('Elevated (H)', 'Ambient (L)')) +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold")) +
  labs(title = "F1 Scallops: respiration rates on 20210930", 
       y = expression(Respiration~rate~"("~ng~L^{-1}~O[2]%.%mu*m^{-1}%.% hr^{-1}~")"), 
       x = expression(italic(p)*CO[2]~Treatment~"("~mu*atm~")")) + 
  facet_wrap(~Fed_Unfed) # + 
```